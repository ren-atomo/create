<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Tracker</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=Noto+Sans+JP:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --black: #0a0a0a;
      --gray-900: #171717;
      --gray-800: #262626;
      --gray-700: #404040;
      --gray-600: #525252;
      --gray-500: #737373;
      --gray-400: #a3a3a3;
      --gray-300: #d4d4d4;
      --gray-200: #e5e5e5;
      --gray-100: #f5f5f5;
      --gray-50: #fafafa;
      --white: #ffffff;
      --success: #22c55e;
      --warning: #eab308;
      --danger: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-size: 15px;
    }

    body {
      font-family: 'DM Sans', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--white);
      color: var(--gray-900);
      min-height: 100vh;
      line-height: 1.5;
      letter-spacing: -0.01em;
      -webkit-font-smoothing: antialiased;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--gray-100);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.125rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--black);
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
      font-family: inherit;
      letter-spacing: -0.01em;
    }

    .btn-ghost {
      background: transparent;
      color: var(--gray-600);
    }

    .btn-ghost:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .btn-primary {
      background: var(--black);
      color: var(--white);
    }

    .btn-primary:hover {
      background: var(--gray-800);
    }

    .btn-outline {
      background: var(--white);
      color: var(--gray-900);
      border: 1px solid var(--gray-200);
    }

    .btn-outline:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }

    /* Main */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2.5rem 2rem 6rem;
    }

    /* Hero Section */
    .hero {
      margin-bottom: 3rem;
    }

    .hero-countdown {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .hero-days {
      font-size: 4.5rem;
      font-weight: 600;
      letter-spacing: -0.04em;
      line-height: 1;
      color: var(--black);
    }

    .hero-unit {
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--gray-500);
    }

    .hero-label {
      font-size: 0.9375rem;
      color: var(--gray-500);
    }

    /* Stats Row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1px;
      background: var(--gray-200);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 3rem;
    }

    @media (max-width: 768px) {
      .stats-row {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .stat-item {
      background: var(--white);
      padding: 1.5rem;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--black);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.8125rem;
      color: var(--gray-500);
    }

    /* Progress Section */
    .progress-section {
      margin-bottom: 3rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .section-title {
      font-size: 0.8125rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
    }

    .section-value {
      font-size: 0.875rem;
      color: var(--gray-600);
      font-variant-numeric: tabular-nums;
    }

    .progress-track {
      height: 4px;
      background: var(--gray-100);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--black);
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    /* Grid Layout */
    .grid-2 {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 2rem;
      margin-bottom: 3rem;
    }

    @media (max-width: 900px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    /* Card */
    .card {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .card-title {
      font-size: 0.8125rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
      margin-bottom: 1.25rem;
    }

    /* Chart */
    .chart-container {
      position: relative;
      height: 240px;
    }

    /* Goals */
    .goals-list {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .goal-item {
      display: flex;
      flex-direction: column;
      gap: 0.625rem;
    }

    .goal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .goal-name {
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--gray-900);
    }

    .goal-values {
      font-size: 0.8125rem;
      color: var(--gray-500);
      font-variant-numeric: tabular-nums;
    }

    .goal-bar {
      height: 6px;
      background: var(--gray-100);
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }

    .goal-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .goal-fill.kokugo { background: var(--gray-900); }
    .goal-fill.sugaku { background: var(--gray-600); }
    .goal-fill.eigo { background: var(--gray-400); }

    /* Records */
    .records-list {
      display: flex;
      flex-direction: column;
    }

    .record-item {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.875rem 0;
      border-bottom: 1px solid var(--gray-100);
    }

    .record-item:last-child {
      border-bottom: none;
    }

    .record-main {
      display: flex;
      align-items: center;
      gap: 1rem;
      width: 100%;
    }

    .record-details {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      padding-left: 0.5rem;
      border-left: 2px solid var(--gray-200);
      margin-left: 0.5rem;
    }

    .record-textbook {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .record-memo {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .record-date {
      font-size: 0.8125rem;
      color: var(--gray-400);
      min-width: 60px;
      font-variant-numeric: tabular-nums;
    }

    .record-subject {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-900);
      padding: 0.25rem 0.625rem;
      background: var(--gray-100);
      border-radius: 4px;
    }

    .record-subject-small {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .record-type {
      font-size: 0.6875rem;
      color: var(--gray-500);
      padding: 0.125rem 0.5rem;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 3px;
    }

    .record-time {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-900);
      margin-left: auto;
      font-variant-numeric: tabular-nums;
    }

    .record-time-small {
      font-size: 0.6875rem;
      color: var(--gray-400);
      font-variant-numeric: tabular-nums;
    }

    .record-mood {
      font-size: 1rem;
      opacity: 0.8;
    }

    .record-score {
      font-size: 0.9375rem;
      font-weight: 600;
      margin-left: auto;
      font-variant-numeric: tabular-nums;
    }

    .record-score.high { color: var(--success); }
    .record-score.mid { color: var(--warning); }
    .record-score.low { color: var(--danger); }

    .record-unit {
      font-size: 0.75rem;
      color: var(--gray-600);
    }

    .record-section {
      font-size: 0.75rem;
      color: var(--gray-600);
    }

    .record-weak {
      font-size: 0.75rem;
      color: var(--danger);
    }

    .empty-state {
      padding: 2rem;
      text-align: center;
      color: var(--gray-400);
      font-size: 0.875rem;
    }

    /* FAB */
    .fab-container {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      display: flex;
      flex-direction: column-reverse;
      align-items: flex-end;
      gap: 0.75rem;
      z-index: 1000;
    }

    .fab {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--black);
      color: var(--white);
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .fab:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .fab.active {
      transform: rotate(45deg);
    }

    .fab-menu {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: all 0.2s ease;
    }

    .fab-menu.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .fab-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-900);
      white-space: nowrap;
    }

    .fab-item:hover {
      background: var(--gray-50);
      transform: translateX(-4px);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      padding: 1rem;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--white);
      border-radius: 16px;
      width: 100%;
      max-width: 440px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px) scale(0.98);
      transition: all 0.2s ease;
    }

    .modal-overlay.active .modal {
      transform: translateY(0) scale(1);
    }

    .modal-header {
      padding: 1.5rem 1.5rem 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--gray-100);
      color: var(--gray-600);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      font-size: 1rem;
    }

    .modal-close:hover {
      background: var(--gray-200);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 0 1.5rem 1.5rem;
      display: flex;
      gap: 0.75rem;
    }

    .modal-footer .btn {
      flex: 1;
      padding: 0.75rem;
    }

    /* Form */
    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-600);
      margin-bottom: 0.5rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 0.9375rem;
      font-family: inherit;
      transition: all 0.15s ease;
      background: var(--white);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--gray-400);
    }

    .form-input::placeholder {
      color: var(--gray-400);
    }

    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23737373'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1rem;
      padding-right: 2.5rem;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* Button Group */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.375rem;
    }

    .btn-option {
      padding: 0.5rem 0.875rem;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      background: var(--white);
      font-size: 0.8125rem;
      font-family: inherit;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn-option:hover {
      border-color: var(--gray-300);
      background: var(--gray-50);
    }

    .btn-option.active {
      border-color: var(--black);
      background: var(--black);
      color: var(--white);
    }

    /* Mood Buttons */
    .mood-group {
      display: flex;
      gap: 0.5rem;
    }

    .mood-btn {
      width: 44px;
      height: 44px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      background: var(--white);
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .mood-btn:hover {
      border-color: var(--gray-300);
      transform: scale(1.05);
    }

    .mood-btn.active {
      border-color: var(--black);
      background: var(--gray-100);
    }

    /* AI Modal */
    .ai-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .ai-option {
      padding: 0.75rem 0.5rem;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      background: var(--white);
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: center;
    }

    .ai-option:hover {
      border-color: var(--gray-300);
    }

    .ai-option.active {
      border-color: var(--black);
      background: var(--gray-50);
    }

    .ai-option-icon {
      font-size: 1.25rem;
      margin-bottom: 0.375rem;
    }

    .ai-option-label {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    .prompt-preview {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 1rem;
      font-size: 0.75rem;
      font-family: 'SF Mono', 'Consolas', monospace;
      white-space: pre-wrap;
      max-height: 280px;
      overflow-y: auto;
      line-height: 1.6;
      color: var(--gray-700);
    }

    /* Loading */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid var(--gray-200);
      border-top-color: var(--black);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 6rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 4000;
    }

    .toast {
      padding: 0.75rem 1.25rem;
      background: var(--gray-900);
      color: var(--white);
      border-radius: 8px;
      font-size: 0.875rem;
      animation: fadeUp 0.2s ease;
    }

    .toast.error {
      background: var(--danger);
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive */
    @media (max-width: 640px) {
      html {
        font-size: 14px;
      }

      .header-content {
        padding: 0.875rem 1rem;
      }

      .main {
        padding: 1.5rem 1rem 5rem;
      }

      .hero-days {
        font-size: 3.5rem;
      }

      .stats-row {
        grid-template-columns: repeat(2, 1fr);
      }

      .stat-item {
        padding: 1rem;
      }

      .stat-value {
        font-size: 1.5rem;
      }

      .grid-2 {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .fab-container {
        bottom: 1.5rem;
        right: 1.5rem;
      }

      .fab {
        width: 52px;
        height: 52px;
      }

      .ai-options {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-400);
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">Study Tracker</div>
      <div class="header-actions">
        <button class="btn btn-ghost" onclick="openSettingsModal()">è¨­å®š</button>
        <button class="btn btn-ghost" onclick="refreshData()">æ›´æ–°</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <!-- Hero -->
    <section class="hero">
      <div class="hero-countdown">
        <span class="hero-days" id="mainCountdown">--</span>
        <span class="hero-unit">æ—¥</span>
      </div>
      <p class="hero-label">å…±é€šãƒ†ã‚¹ãƒˆã¾ã§</p>
    </section>

    <!-- Stats -->
    <section class="stats-row">
      <div class="stat-item">
        <div class="stat-value" id="todayMinutes">0åˆ†</div>
        <div class="stat-label">ä»Šæ—¥</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="weekMinutes">0æ™‚é–“</div>
        <div class="stat-label">ä»Šé€±</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="streakDays">0</div>
        <div class="stat-label">é€£ç¶šæ—¥æ•°</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="totalSessions">0</div>
        <div class="stat-label">å­¦ç¿’å›æ•°</div>
      </div>
    </section>

    <!-- Progress -->
    <section class="progress-section">
      <div class="section-header">
        <span class="section-title">é€±é–“ç›®æ¨™</span>
        <span class="section-value" id="progressValue">0 / 1800 åˆ†</span>
      </div>
      <div class="progress-track">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </section>

    <!-- Charts -->
    <section class="grid-2">
      <div class="card">
        <h3 class="card-title">æ—¥åˆ¥å­¦ç¿’æ™‚é–“</h3>
        <div class="chart-container">
          <canvas id="dailyChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 class="card-title">ç§‘ç›®åˆ¥å‰²åˆ</h3>
        <div class="chart-container">
          <canvas id="subjectChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Goals -->
    <section class="card" style="margin-bottom: 2rem;">
      <h3 class="card-title">ç›®æ¨™é€²æ—</h3>
      <div class="goals-list" id="goalsSection">
        <!-- Goals rendered here -->
      </div>
    </section>

    <!-- Records -->
    <section class="grid-2">
      <div class="card">
        <h3 class="card-title">æœ€è¿‘ã®å­¦ç¿’è¨˜éŒ²</h3>
        <div class="records-list" id="studyRecordsList">
          <div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
      <div class="card">
        <h3 class="card-title">èµ¤æœ¬æ¼”ç¿’å±¥æ­´</h3>
        <div class="records-list" id="redbookRecordsList">
          <div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
    </section>
  </main>

  <!-- FAB -->
  <div class="fab-container">
    <div class="fab-menu" id="fabMenu">
      <button class="fab-item" onclick="openAIModal()">
        <span>ğŸ¤–</span> AIã«ç›¸è«‡
      </button>
      <button class="fab-item" onclick="openRedbookModal()">
        <span>ğŸ“•</span> èµ¤æœ¬è¨˜éŒ²
      </button>
      <button class="fab-item" onclick="openStudyModal()">
        <span>ğŸ“–</span> å­¦ç¿’è¨˜éŒ²
      </button>
    </div>
    <button class="fab" id="fabButton" onclick="toggleFab()">ï¼‹</button>
  </div>

  <!-- Study Log Modal -->
  <div class="modal-overlay" id="studyModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">å­¦ç¿’è¨˜éŒ²ã‚’è¿½åŠ </h2>
        <button class="modal-close" onclick="closeStudyModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">æ—¥ä»˜</label>
          <input type="date" class="form-input" id="studyDate">
        </div>
        <div class="form-group">
          <label class="form-label">ç§‘ç›®</label>
          <div class="btn-group" id="subjectButtons">
            <button class="btn-option" data-value="ç¾ä»£æ–‡">ç¾ä»£æ–‡</button>
            <button class="btn-option" data-value="å¤æ–‡">å¤æ–‡</button>
            <button class="btn-option" data-value="æ¼¢æ–‡">æ¼¢æ–‡</button>
            <button class="btn-option" data-value="æ•°å­¦1A">æ•°å­¦1A</button>
            <button class="btn-option" data-value="æ•°å­¦2B">æ•°å­¦2B</button>
            <button class="btn-option" data-value="å˜èª">å˜èª</button>
            <button class="btn-option" data-value="æ–‡æ³•">æ–‡æ³•</button>
            <button class="btn-option" data-value="é•·æ–‡">é•·æ–‡</button>
            <button class="btn-option" data-value="éŸ³èª­">éŸ³èª­</button>
            <button class="btn-option" data-value="ãƒªã‚¹ãƒ‹ãƒ³ã‚°">ãƒªã‚¹ãƒ‹ãƒ³ã‚°</button>
            <button class="btn-option" data-value="ãã®ä»–">ãã®ä»–</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ¯ å­¦ç¿’ã‚¿ã‚¤ãƒ—</label>
          <div class="btn-group" id="studyTypeButtons">
            <button class="btn-option" data-value="æ–°è¦">æ–°è¦</button>
            <button class="btn-option" data-value="å¾©ç¿’">å¾©ç¿’</button>
            <button class="btn-option" data-value="æ¼”ç¿’">æ¼”ç¿’</button>
            <button class="btn-option" data-value="æš—è¨˜">æš—è¨˜</button>
            <button class="btn-option" data-value="éå»å•">éå»å•</button>
            <button class="btn-option" data-value="æ¨¡è©¦">æ¨¡è©¦</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">å­¦ç¿’æ™‚é–“</label>
          <div class="btn-group" id="timeButtons">
            <button class="btn-option" data-value="15">15åˆ†</button>
            <button class="btn-option" data-value="30">30åˆ†</button>
            <button class="btn-option" data-value="45">45åˆ†</button>
            <button class="btn-option" data-value="50">50åˆ†</button>
            <button class="btn-option" data-value="60">1æ™‚é–“</button>
            <button class="btn-option" data-value="90">1.5æ™‚é–“</button>
            <button class="btn-option" data-value="120">2æ™‚é–“</button>
            <button class="btn-option" data-value="150">2æ™‚é–“è¶…</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">æ‰‹å¿œãˆ</label>
          <div class="mood-group" id="moodButtons">
            <button class="mood-btn" data-value="ğŸ˜«">ğŸ˜«</button>
            <button class="mood-btn" data-value="ğŸ˜•">ğŸ˜•</button>
            <button class="mood-btn" data-value="ğŸ˜">ğŸ˜</button>
            <button class="mood-btn" data-value="ğŸ™‚">ğŸ™‚</button>
            <button class="mood-btn" data-value="ğŸ˜Š">ğŸ˜Š</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ“š å˜å…ƒãƒ»ç« ï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="studyUnit" placeholder="ä¾‹: ç¬¬3ç«  äºŒæ¬¡é–¢æ•°ã€Unit15-16">
        </div>
        <div class="form-group">
          <label class="form-label">å‚è€ƒæ›¸åï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="studyTextbook" placeholder="ä¾‹: é€Ÿèª­è‹±å˜èª">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <textarea class="form-input form-textarea" id="studyMemo" placeholder="å­¦ç¿’å†…å®¹ã‚„æ°—ã¥ããªã©"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeStudyModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="submitStudyLog()">è¨˜éŒ²ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Redbook Modal -->
  <div class="modal-overlay" id="redbookModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">èµ¤æœ¬è¨˜éŒ²ã‚’è¿½åŠ </h2>
        <button class="modal-close" onclick="closeRedbookModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">æ—¥ä»˜</label>
          <input type="date" class="form-input" id="redbookDate">
        </div>
        <div class="form-group">
          <label class="form-label">å¤§å­¦å</label>
          <select class="form-input form-select" id="redbookUniversity">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="ç«‹æ•™å¤§å­¦">ç«‹æ•™å¤§å­¦</option>
            <option value="é’å±±å­¦é™¢å¤§å­¦">é’å±±å­¦é™¢å¤§å­¦</option>
            <option value="æ³•æ”¿å¤§å­¦">æ³•æ”¿å¤§å­¦</option>
            <option value="ä¸­å¤®å¤§å­¦">ä¸­å¤®å¤§å­¦</option>
            <option value="æ˜æ²»å­¦é™¢å¤§å­¦">æ˜æ²»å­¦é™¢å¤§å­¦</option>
            <option value="æˆåŸå¤§å­¦">æˆåŸå¤§å­¦</option>
            <option value="æ±æ´‹å¤§å­¦">æ±æ´‹å¤§å­¦</option>
            <option value="é§’æ¾¤å¤§å­¦">é§’æ¾¤å¤§å­¦</option>
            <option value="æ—¥æœ¬å¤§å­¦">æ—¥æœ¬å¤§å­¦</option>
            <option value="å°‚ä¿®å¤§å­¦">å°‚ä¿®å¤§å­¦</option>
            <option value="å…±é€šãƒ†ã‚¹ãƒˆ">å…±é€šãƒ†ã‚¹ãƒˆ</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ç§‘ç›®</label>
          <div class="btn-group" id="redbookSubjectButtons">
            <button class="btn-option" data-value="è‹±èª">è‹±èª</button>
            <button class="btn-option" data-value="å›½èª">å›½èª</button>
            <button class="btn-option" data-value="æ•°å­¦">æ•°å­¦</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">å¹´åº¦</label>
          <select class="form-input form-select" id="redbookYear">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="2025">2025å¹´</option>
            <option value="2024">2024å¹´</option>
            <option value="2023">2023å¹´</option>
            <option value="2022">2022å¹´</option>
            <option value="2021">2021å¹´</option>
            <option value="2020">2020å¹´</option>
            <option value="2019">2019å¹´</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">å¾—ç‚¹ç‡ï¼ˆ%ï¼‰</label>
          <input type="number" class="form-input" id="redbookScore" min="0" max="100" placeholder="ä¾‹: 75">
        </div>
        <div class="form-group">
          <label class="form-label">â±ï¸ è§£ç­”æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
          <input type="number" class="form-input" id="redbookTime" min="0" placeholder="ä¾‹: 80">
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ“ å¤§å•ã”ã¨ã®å¾—ç‚¹ï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="redbookSectionScores" placeholder="ä¾‹: å¤§å•1:8/10, å¤§å•2:12/20, å¤§å•3:15/20">
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ“‹ é–“é•ãˆãŸåˆ†é‡ï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="redbookWeakAreas" placeholder="ä¾‹: é–¢ä¿‚è©ã€é•·æ–‡èª­è§£ã€ç¢ºç‡">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <textarea class="form-input form-textarea" id="redbookMemo" placeholder="åçœç‚¹ã‚„æ¬¡å›ã®èª²é¡Œãªã©"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeRedbookModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="submitRedbookLog()">è¨˜éŒ²ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- AI Modal -->
  <div class="modal-overlay" id="aiModal">
    <div class="modal" style="max-width: 520px;">
      <div class="modal-header">
        <h2 class="modal-title">AIã«ç›¸è«‡</h2>
        <button class="modal-close" onclick="closeAIModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="ai-options" id="aiOptions">
          <div class="ai-option active" data-type="weekly">
            <div class="ai-option-icon">ğŸ“…</div>
            <div class="ai-option-label">é€±é–“è¨ˆç”»</div>
          </div>
          <div class="ai-option" data-type="daily">
            <div class="ai-option-icon">ğŸ“</div>
            <div class="ai-option-label">ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Š</div>
          </div>
          <div class="ai-option" data-type="weakness">
            <div class="ai-option-icon">ğŸ¯</div>
            <div class="ai-option-label">å¼±ç‚¹åˆ†æ</div>
          </div>
          <div class="ai-option" data-type="subject">
            <div class="ai-option-icon">ğŸ“š</div>
            <div class="ai-option-label">ç§‘ç›®åˆ¥ç›¸è«‡</div>
          </div>
          <div class="ai-option" data-type="lastspurt">
            <div class="ai-option-icon">ğŸ”¥</div>
            <div class="ai-option-label">ç›´å‰æœŸå¯¾ç­–</div>
          </div>
          <div class="ai-option" data-type="motivation">
            <div class="ai-option-icon">ğŸ’ª</div>
            <div class="ai-option-label">ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³</div>
          </div>
        </div>
        
        <!-- ç§‘ç›®é¸æŠï¼ˆç§‘ç›®åˆ¥ç›¸è«‡æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
        <div class="form-group" id="subjectSelectGroup" style="display: none;">
          <label class="form-label">ç›¸è«‡ã—ãŸã„ç§‘ç›®</label>
          <select class="form-select" id="aiSubjectSelect" onchange="generatePrompt()">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="è‹±èª">è‹±èª</option>
            <option value="æ•°å­¦">æ•°å­¦</option>
            <option value="å›½èª">å›½èª</option>
            <option value="ç†ç§‘">ç†ç§‘</option>
            <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
          </select>
        </div>
        <label class="form-label">ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
        <div class="prompt-preview" id="promptPreview">ç”Ÿæˆä¸­...</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeAIModal()">é–‰ã˜ã‚‹</button>
        <button class="btn btn-primary" onclick="copyPrompt()">ã‚³ãƒ”ãƒ¼ã—ã¦AIã¸</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">è¨­å®š</h2>
        <button class="modal-close" onclick="closeSettingsModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Apps Script URL</label>
          <input type="text" class="form-input" id="settingsApiUrl" placeholder="https://script.google.com/...">
        </div>
        <div class="form-group">
          <label class="form-label">é€±é–“ç›®æ¨™ï¼ˆåˆ†ï¼‰</label>
          <input type="number" class="form-input" id="settingsWeeklyGoal" value="1800" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">å…±é€šãƒ†ã‚¹ãƒˆæ—¥</label>
          <input type="date" class="form-input" id="settingsExamDate">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeSettingsModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    let API_URL = localStorage.getItem('apiUrl') || 'https://script.google.com/macros/s/AKfycbw-DjDh59MJbi4zQIgDNA5EI5eozWjN_tSU-v0YH0Bzvs744moswzobFyB9VNqRNef7KA/exec';
    let appData = {
      studyLogs: [],
      redbookLogs: [],
      goals: [],
      profile: {},
      settings: { weeklyGoalMinutes: 1800 }
    };
    
    let selectedSubject = '';
    let selectedTime = 0;
    let selectedMood = '';
    let selectedStudyType = '';
    let selectedRedbookSubject = '';
    let selectedAIType = 'weekly';
    
    let dailyChart = null;
    let subjectChart = null;
    
    document.addEventListener('DOMContentLoaded', () => {
      initializeDateInputs();
      initializeButtonGroups();
      initializeAIOptions();
      loadSettingsFromStorage();
      
      if (API_URL) {
        refreshData();
      } else {
        hideLoading();
      }
    });
    
    function initializeDateInputs() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('studyDate').value = today;
      document.getElementById('redbookDate').value = today;
    }
    
    function initializeButtonGroups() {
      document.querySelectorAll('#subjectButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#subjectButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedSubject = btn.dataset.value;
        });
      });
      
      document.querySelectorAll('#timeButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#timeButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedTime = parseInt(btn.dataset.value);
        });
      });
      
      document.querySelectorAll('#moodButtons .mood-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#moodButtons .mood-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedMood = btn.dataset.value;
        });
      });
      
      document.querySelectorAll('#studyTypeButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#studyTypeButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedStudyType = btn.dataset.value;
        });
      });
      
      document.querySelectorAll('#redbookSubjectButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#redbookSubjectButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedRedbookSubject = btn.dataset.value;
        });
      });
    }
    
    function initializeAIOptions() {
      document.querySelectorAll('.ai-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.ai-option').forEach(o => o.classList.remove('active'));
          option.classList.add('active');
          selectedAIType = option.dataset.type;
          
          // ç§‘ç›®åˆ¥ç›¸è«‡ã®å ´åˆã®ã¿ç§‘ç›®é¸æŠã‚’è¡¨ç¤º
          const subjectSelectGroup = document.getElementById('subjectSelectGroup');
          if (selectedAIType === 'subject') {
            subjectSelectGroup.style.display = 'block';
          } else {
            subjectSelectGroup.style.display = 'none';
          }
          
          generatePrompt();
        });
      });
    }
    
    function loadSettingsFromStorage() {
      const apiUrl = localStorage.getItem('apiUrl');
      const weeklyGoal = localStorage.getItem('weeklyGoal');
      const examDate = localStorage.getItem('examDate');
      
      if (apiUrl) {
        API_URL = apiUrl;
        document.getElementById('settingsApiUrl').value = apiUrl;
      }
      if (weeklyGoal) {
        appData.settings.weeklyGoalMinutes = parseInt(weeklyGoal);
        document.getElementById('settingsWeeklyGoal').value = weeklyGoal;
      }
      if (examDate) {
        document.getElementById('settingsExamDate').value = examDate;
      }
    }
    
    async function fetchData() {
      if (!API_URL) throw new Error('API URL not set');
      
      console.log('Fetching from:', API_URL);
      
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonpCallback_' + Date.now();
        const script = document.createElement('script');
        
        window[callbackName] = (data) => {
          console.log('JSONP callback received:', data);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          resolve(data);
        };
        
        const fullUrl = `${API_URL}?action=getAllData&callback=${callbackName}`;
        console.log('Full URL:', fullUrl);
        script.src = fullUrl;
        
        script.onerror = (e) => {
          console.error('Script load error:', e);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          reject(new Error('ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€‚Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'));
        };
        
        document.body.appendChild(script);
        
        setTimeout(() => {
          if (window[callbackName]) {
            console.error('JSONP timeout - callback not called');
            delete window[callbackName];
            if (script.parentNode) script.parentNode.removeChild(script);
            reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€‚Apps ScriptãŒæ­£ã—ãå¿œç­”ã—ã¦ã„ã¾ã›ã‚“ã€‚'));
          }
        }, 15000);
      });
    }
    
    async function postData(data) {
      if (!API_URL) throw new Error('API URL not set');
      
      console.log('Posting data:', data);
      
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonpPostCallback_' + Date.now();
        const script = document.createElement('script');
        
        window[callbackName] = (response) => {
          console.log('POST callback received:', response);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          if (response.error) {
            reject(new Error(response.error));
          } else {
            resolve(response);
          }
        };
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
        const params = new URLSearchParams();
        params.append('action', data.action);
        params.append('data', JSON.stringify(data));
        params.append('callback', callbackName);
        
        const fullUrl = `${API_URL}?${params.toString()}`;
        console.log('POST URL:', fullUrl);
        script.src = fullUrl;
        
        script.onerror = (e) => {
          console.error('POST script error:', e);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          reject(new Error('ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚¨ãƒ©ãƒ¼'));
        };
        
        document.body.appendChild(script);
        
        setTimeout(() => {
          if (window[callbackName]) {
            delete window[callbackName];
            if (script.parentNode) script.parentNode.removeChild(script);
            reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
          }
        }, 15000);
      });
    }
    
    async function refreshData() {
      showLoading();
      try {
        const data = await fetchData();
        if (data.error) throw new Error(data.error);
        appData = data;
        renderDashboard();
        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('Error:', error);
        showToast(error.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    function renderDashboard() {
      renderCountdown();
      renderStats();
      renderProgress();
      renderCharts();
      renderGoals();
      renderStudyRecords();
      renderRedbookRecords();
    }
    
    function renderCountdown() {
      const examDate = localStorage.getItem('examDate') || '2025-01-18';
      const mainExam = new Date(examDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const daysUntil = Math.ceil((mainExam - today) / (1000 * 60 * 60 * 24));
      document.getElementById('mainCountdown').textContent = Math.max(0, daysUntil);
    }
    
    function renderStats() {
      const logs = appData.studyLogs || [];
      const today = new Date().toISOString().split('T')[0];
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      const monthAgo = new Date();
      monthAgo.setDate(monthAgo.getDate() - 30);
      
      const todayMinutes = logs
        .filter(log => log.date === today)
        .reduce((sum, log) => sum + (log.minutes || 0), 0);
      document.getElementById('todayMinutes').textContent = todayMinutes + 'åˆ†';
      
      const weekMinutes = logs
        .filter(log => new Date(log.date) >= weekAgo)
        .reduce((sum, log) => sum + (log.minutes || 0), 0);
      document.getElementById('weekMinutes').textContent = Math.round(weekMinutes / 60) + 'æ™‚é–“';
      
      const streakDays = calculateStreak(logs);
      document.getElementById('streakDays').textContent = streakDays;
      
      const monthSessions = logs.filter(log => new Date(log.date) >= monthAgo).length;
      document.getElementById('totalSessions').textContent = monthSessions;
    }
    
    function calculateStreak(logs) {
      if (logs.length === 0) return 0;
      
      const dates = [...new Set(logs.map(log => log.date))].sort().reverse();
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      let streak = 0;
      let currentDate = new Date(today);
      
      const todayStr = today.toISOString().split('T')[0];
      if (!dates.includes(todayStr)) {
        currentDate.setDate(currentDate.getDate() - 1);
      }
      
      for (let i = 0; i < 365; i++) {
        const dateStr = currentDate.toISOString().split('T')[0];
        if (dates.includes(dateStr)) {
          streak++;
          currentDate.setDate(currentDate.getDate() - 1);
        } else {
          break;
        }
      }
      
      return streak;
    }
    
    function renderProgress() {
      const logs = appData.studyLogs || [];
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      
      const weekMinutes = logs
        .filter(log => new Date(log.date) >= weekAgo)
        .reduce((sum, log) => sum + (log.minutes || 0), 0);
      
      const goal = appData.settings?.weeklyGoalMinutes || 1800;
      const percent = Math.min(100, Math.round((weekMinutes / goal) * 100));
      
      document.getElementById('progressValue').textContent = `${weekMinutes} / ${goal} åˆ†`;
      document.getElementById('progressFill').style.width = `${percent}%`;
    }
    
    function renderCharts() {
      renderDailyChart();
      renderSubjectChart();
    }
    
    function renderDailyChart() {
      const ctx = document.getElementById('dailyChart').getContext('2d');
      const logs = appData.studyLogs || [];
      
      const days = [];
      const subjectData = {};
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const dayLabel = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
        days.push(dayLabel);
        
        const dayLogs = logs.filter(log => log.date === dateStr);
        dayLogs.forEach(log => {
          const subject = categorizeSubject(log.subject);
          if (!subjectData[subject]) {
            subjectData[subject] = Array(7).fill(0);
          }
          subjectData[subject][6 - i] += log.minutes || 0;
        });
      }
      
      const colors = {
        'è‹±èª': '#0a0a0a',
        'æ•°å­¦': '#525252',
        'å›½èª': '#a3a3a3',
        'ãã®ä»–': '#d4d4d4'
      };
      
      const datasets = Object.entries(subjectData).map(([subject, data]) => ({
        label: subject,
        data: data,
        backgroundColor: colors[subject] || '#d4d4d4',
        borderRadius: 2,
        barThickness: 16
      }));
      
      if (dailyChart) dailyChart.destroy();
      
      dailyChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: days, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
              stacked: true,
              grid: { display: false },
              border: { display: false },
              ticks: { color: '#a3a3a3', font: { size: 11 } }
            },
            y: { 
              stacked: true,
              beginAtZero: true,
              grid: { color: '#f5f5f5' },
              border: { display: false },
              ticks: { color: '#a3a3a3', font: { size: 11 } }
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 8,
                boxHeight: 8,
                padding: 16,
                color: '#525252',
                font: { size: 11 }
              }
            }
          }
        }
      });
    }
    
    function renderSubjectChart() {
      const ctx = document.getElementById('subjectChart').getContext('2d');
      const logs = appData.studyLogs || [];
      
      const monthAgo = new Date();
      monthAgo.setDate(monthAgo.getDate() - 30);
      
      const subjectMinutes = {};
      logs
        .filter(log => new Date(log.date) >= monthAgo)
        .forEach(log => {
          const subject = log.subject || 'ãã®ä»–';
          subjectMinutes[subject] = (subjectMinutes[subject] || 0) + (log.minutes || 0);
        });
      
      const sortedSubjects = Object.entries(subjectMinutes).sort((a, b) => b[1] - a[1]);
      
      const grays = ['#0a0a0a', '#262626', '#404040', '#525252', '#737373', '#a3a3a3', '#d4d4d4', '#e5e5e5', '#f5f5f5'];
      
      if (subjectChart) subjectChart.destroy();
      
      subjectChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: sortedSubjects.map(s => s[0]),
          datasets: [{
            data: sortedSubjects.map(s => s[1]),
            backgroundColor: grays.slice(0, sortedSubjects.length),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 8,
                boxHeight: 8,
                padding: 12,
                color: '#525252',
                font: { size: 11 }
              }
            }
          },
          cutout: '65%'
        }
      });
    }
    
    function categorizeSubject(subject) {
      const english = ['å˜èª', 'æ–‡æ³•', 'é•·æ–‡', 'éŸ³èª­', 'ãƒªã‚¹ãƒ‹ãƒ³ã‚°'];
      const math = ['æ•°å­¦1A', 'æ•°å­¦2B'];
      const japanese = ['ç¾ä»£æ–‡', 'å¤æ–‡', 'æ¼¢æ–‡'];
      
      if (english.includes(subject)) return 'è‹±èª';
      if (math.includes(subject)) return 'æ•°å­¦';
      if (japanese.includes(subject)) return 'å›½èª';
      return 'ãã®ä»–';
    }
    
    function renderGoals() {
      const section = document.getElementById('goalsSection');
      const goals = appData.goals || [];
      
      if (goals.length === 0) {
        section.innerHTML = '<div class="empty-state">ç›®æ¨™ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        return;
      }
      
      const classes = { 'å›½èª': 'kokugo', 'æ•°å­¦': 'sugaku', 'è‹±èª': 'eigo' };
      
      section.innerHTML = goals.map(goal => {
        const progress = Math.min(100, Math.round(((goal.current) / (goal.target)) * 100));
        const cls = classes[goal.subject] || 'kokugo';
        
        return `
          <div class="goal-item">
            <div class="goal-header">
              <span class="goal-name">${goal.subject}</span>
              <span class="goal-values">${goal.current}% â†’ ${goal.target}%</span>
            </div>
            <div class="goal-bar">
              <div class="goal-fill ${cls}" style="width: ${progress}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderStudyRecords() {
      const container = document.getElementById('studyRecordsList');
      const logs = (appData.studyLogs || []).slice(0, 8);
      
      if (logs.length === 0) {
        container.innerHTML = '<div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = logs.map(log => {
        const hasDetails = log.memo || log.textbook || log.unit || log.studyType;
        return `
        <div class="record-item ${hasDetails ? 'has-details' : ''}">
          <div class="record-main">
            <span class="record-date">${formatDateShort(log.date)}</span>
            <span class="record-subject">${log.subject}</span>
            ${log.studyType ? `<span class="record-type">${log.studyType}</span>` : ''}
            <span class="record-time">${log.minutes}åˆ†</span>
            <span class="record-mood">${log.mood || ''}</span>
          </div>
          ${hasDetails ? `
            <div class="record-details">
              ${log.unit ? `<span class="record-unit">ğŸ“– ${log.unit}</span>` : ''}
              ${log.textbook ? `<span class="record-textbook">ğŸ“š ${log.textbook}</span>` : ''}
              ${log.memo ? `<span class="record-memo">ğŸ“ ${log.memo}</span>` : ''}
            </div>
          ` : ''}
        </div>
      `}).join('');
    }
    
    function renderRedbookRecords() {
      const container = document.getElementById('redbookRecordsList');
      const logs = (appData.redbookLogs || []).slice(0, 8);
      
      if (logs.length === 0) {
        container.innerHTML = '<div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = logs.map(log => {
        const scoreClass = log.score >= 70 ? 'high' : log.score >= 50 ? 'mid' : 'low';
        const hasDetails = log.memo || log.time || log.sectionScores || log.weakAreas;
        return `
          <div class="record-item ${hasDetails ? 'has-details' : ''}">
            <div class="record-main">
              <span class="record-date">${formatDateShort(log.date)}</span>
              <span>${log.university}</span>
              <span class="record-subject-small">${log.subject || ''}</span>
              ${log.time ? `<span class="record-time-small">â±${log.time}åˆ†</span>` : ''}
              <span class="record-score ${scoreClass}">${log.score}%</span>
            </div>
            ${hasDetails ? `
              <div class="record-details">
                ${log.sectionScores ? `<span class="record-section">ğŸ“Š ${log.sectionScores}</span>` : ''}
                ${log.weakAreas ? `<span class="record-weak">âš ï¸ ${log.weakAreas}</span>` : ''}
                ${log.memo ? `<span class="record-memo">ğŸ“ ${log.memo}</span>` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    function toggleFab() {
      const fab = document.getElementById('fabButton');
      const menu = document.getElementById('fabMenu');
      fab.classList.toggle('active');
      menu.classList.toggle('active');
    }
    
    function openStudyModal() {
      toggleFab();
      resetStudyForm();
      document.getElementById('studyModal').classList.add('active');
    }
    
    function closeStudyModal() {
      document.getElementById('studyModal').classList.remove('active');
    }
    
    function resetStudyForm() {
      document.getElementById('studyDate').value = new Date().toISOString().split('T')[0];
      document.querySelectorAll('#subjectButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#studyTypeButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#timeButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#moodButtons .mood-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('studyUnit').value = '';
      document.getElementById('studyTextbook').value = '';
      document.getElementById('studyMemo').value = '';
      selectedSubject = '';
      selectedStudyType = '';
      selectedTime = 0;
      selectedMood = '';
    }
    
    function openRedbookModal() {
      toggleFab();
      resetRedbookForm();
      document.getElementById('redbookModal').classList.add('active');
    }
    
    function closeRedbookModal() {
      document.getElementById('redbookModal').classList.remove('active');
    }
    
    function resetRedbookForm() {
      document.getElementById('redbookDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('redbookUniversity').value = '';
      document.querySelectorAll('#redbookSubjectButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.getElementById('redbookYear').value = '';
      document.getElementById('redbookScore').value = '';
      document.getElementById('redbookTime').value = '';
      document.getElementById('redbookSectionScores').value = '';
      document.getElementById('redbookWeakAreas').value = '';
      document.getElementById('redbookMemo').value = '';
      selectedRedbookSubject = '';
    }
    
    function openAIModal() {
      toggleFab();
      document.getElementById('aiModal').classList.add('active');
      generatePrompt();
    }
    
    function closeAIModal() {
      document.getElementById('aiModal').classList.remove('active');
    }
    
    function openSettingsModal() {
      document.getElementById('settingsApiUrl').value = API_URL;
      document.getElementById('settingsWeeklyGoal').value = appData.settings?.weeklyGoalMinutes || 1800;
      document.getElementById('settingsExamDate').value = localStorage.getItem('examDate') || '2025-01-18';
      document.getElementById('settingsModal').classList.add('active');
    }
    
    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.remove('active');
    }
    
    async function submitStudyLog() {
      if (!selectedSubject) { showToast('ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      if (!selectedTime) { showToast('å­¦ç¿’æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      
      showLoading();
      
      try {
        await postData({
          action: 'addStudyLog',
          date: document.getElementById('studyDate').value,
          subject: selectedSubject,
          studyType: selectedStudyType,
          minutes: selectedTime,
          mood: selectedMood,
          unit: document.getElementById('studyUnit').value,
          textbook: document.getElementById('studyTextbook').value,
          memo: document.getElementById('studyMemo').value
        });
        
        closeStudyModal();
        showToast('å­¦ç¿’è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        setTimeout(() => refreshData(), 1500);
      } catch (error) {
        showToast(error.message, 'error');
        hideLoading();
      }
    }
    
    async function submitRedbookLog() {
      const university = document.getElementById('redbookUniversity').value;
      const year = document.getElementById('redbookYear').value;
      const score = document.getElementById('redbookScore').value;
      
      if (!university) { showToast('å¤§å­¦ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      if (!selectedRedbookSubject) { showToast('ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      if (!year) { showToast('å¹´åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      if (!score) { showToast('å¾—ç‚¹ç‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
      
      showLoading();
      
      try {
        await postData({
          action: 'addRedbookLog',
          date: document.getElementById('redbookDate').value,
          university,
          subject: selectedRedbookSubject,
          year,
          score: parseInt(score),
          time: document.getElementById('redbookTime').value ? parseInt(document.getElementById('redbookTime').value) : '',
          sectionScores: document.getElementById('redbookSectionScores').value,
          weakAreas: document.getElementById('redbookWeakAreas').value,
          memo: document.getElementById('redbookMemo').value
        });
        
        closeRedbookModal();
        showToast('èµ¤æœ¬è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        setTimeout(() => refreshData(), 1500);
      } catch (error) {
        showToast(error.message, 'error');
        hideLoading();
      }
    }
    
    function saveSettings() {
      const apiUrl = document.getElementById('settingsApiUrl').value.trim();
      const weeklyGoal = document.getElementById('settingsWeeklyGoal').value;
      const examDate = document.getElementById('settingsExamDate').value;
      
      localStorage.setItem('apiUrl', apiUrl);
      localStorage.setItem('weeklyGoal', weeklyGoal);
      localStorage.setItem('examDate', examDate);
      
      API_URL = apiUrl;
      appData.settings.weeklyGoalMinutes = parseInt(weeklyGoal);
      
      closeSettingsModal();
      showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      
      if (apiUrl) refreshData();
    }
    
    function generatePrompt() {
      const preview = document.getElementById('promptPreview');
      const logs = appData.studyLogs || [];
      const redbookLogs = appData.redbookLogs || [];
      const profile = appData.profile || {};
      const goals = appData.goals || [];
      
      const examDate = localStorage.getItem('examDate') || '2025-01-18';
      const today = new Date();
      const daysUntil = Math.ceil((new Date(examDate) - today) / (1000 * 60 * 60 * 24));
      
      // ä»Šé€±ã®ãƒ­ã‚°
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      const weekLogs = logs.filter(log => new Date(log.date) >= weekAgo);
      const weekMinutes = weekLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      
      // ç§‘ç›®åˆ¥çµ±è¨ˆï¼ˆè©³ç´°ç‰ˆï¼‰
      const subjectStats = {};
      weekLogs.forEach(log => {
        const cat = categorizeSubject(log.subject);
        if (!subjectStats[cat]) subjectStats[cat] = { minutes: 0, details: {}, types: {}, units: [] };
        subjectStats[cat].minutes += log.minutes || 0;
        subjectStats[cat].details[log.subject] = (subjectStats[cat].details[log.subject] || 0) + (log.minutes || 0);
        if (log.studyType) {
          subjectStats[cat].types[log.studyType] = (subjectStats[cat].types[log.studyType] || 0) + (log.minutes || 0);
        }
        if (log.unit) {
          subjectStats[cat].units.push(log.unit);
        }
      });
      
      // å­¦ç¿’ã‚¿ã‚¤ãƒ—åˆ¥çµ±è¨ˆ
      const typeStats = {};
      weekLogs.forEach(log => {
        if (log.studyType) {
          typeStats[log.studyType] = (typeStats[log.studyType] || 0) + (log.minutes || 0);
        }
      });
      
      // æ‰‹å¿œãˆçµ±è¨ˆ
      const moodStats = { good: [], bad: [] };
      weekLogs.forEach(log => {
        if (log.mood === 'ğŸ˜Š' || log.mood === 'ğŸ™‚') moodStats.good.push({ subject: log.subject, unit: log.unit, memo: log.memo });
        else if (log.mood === 'ğŸ˜«' || log.mood === 'ğŸ˜•') moodStats.bad.push({ subject: log.subject, unit: log.unit, memo: log.memo });
      });
      
      // è‹¦æ‰‹åˆ†é‡ã®é›†è¨ˆï¼ˆèµ¤æœ¬ã‹ã‚‰ï¼‰
      const weakAreasCount = {};
      redbookLogs.forEach(log => {
        if (log.weakAreas) {
          log.weakAreas.split(/[,ã€]/).forEach(area => {
            const trimmed = area.trim();
            if (trimmed) {
              weakAreasCount[trimmed] = (weakAreasCount[trimmed] || 0) + 1;
            }
          });
        }
      });
      
      // ä½¿ç”¨æ•™æã®é›†è¨ˆ
      const textbookCount = {};
      logs.forEach(log => {
        if (log.textbook) {
          textbookCount[log.textbook] = (textbookCount[log.textbook] || 0) + (log.minutes || 0);
        }
      });
      
      // ãƒ‡ãƒ¼ã‚¿ã‚’ã¾ã¨ã‚ã‚‹
      const analysisData = {
        profile,
        goals,
        daysUntil,
        weekMinutes,
        weekLogs,
        subjectStats,
        typeStats,
        moodStats,
        weakAreasCount,
        textbookCount,
        redbookLogs,
        allLogs: logs,
        streak: calculateStreak(logs)
      };
      
      let prompt = '';
      
      switch (selectedAIType) {
        case 'weekly':
          prompt = generateWeeklyPrompt(analysisData);
          break;
        case 'daily':
          prompt = generateDailyPrompt(analysisData);
          break;
        case 'weakness':
          prompt = generateWeaknessPrompt(analysisData);
          break;
        case 'subject':
          prompt = generateSubjectPrompt(analysisData);
          break;
        case 'lastspurt':
          prompt = generateLastSpurtPrompt(analysisData);
          break;
        case 'motivation':
          prompt = generateMotivationPrompt(analysisData);
          break;
      }
      
      preview.textContent = prompt;
    }
    
    // ========== ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ==========
    
    function formatTypeStats(typeStats) {
      const total = Object.values(typeStats).reduce((a, b) => a + b, 0);
      if (total === 0) return 'è¨˜éŒ²ãªã—';
      return Object.entries(typeStats)
        .map(([type, min]) => `${type}: ${Math.round(min / total * 100)}%`)
        .join('ã€');
    }
    
    function getTopWeakAreas(weakAreasCount, limit = 5) {
      return Object.entries(weakAreasCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, limit)
        .map(([area, count]) => `${area}ï¼ˆ${count}å›ï¼‰`)
        .join('ã€');
    }
    
    function getSubjectWeakAreas(redbookLogs, targetSubject) {
      const areas = {};
      redbookLogs.forEach(log => {
        const cat = categorizeSubject(log.subject);
        if (cat === targetSubject && log.weakAreas) {
          log.weakAreas.split(/[,ã€]/).forEach(area => {
            const trimmed = area.trim();
            if (trimmed) areas[trimmed] = (areas[trimmed] || 0) + 1;
          });
        }
      });
      return areas;
    }
    
    // ========== é€±é–“è¨ˆç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ==========
    
    function generateWeeklyPrompt(data) {
      const { profile, goals, daysUntil, weekMinutes, subjectStats, typeStats, moodStats, weakAreasCount, redbookLogs } = data;
      
      let p = `# é€±é–“å­¦ç¿’è¨ˆç”»ã®ç›¸è«‡\n\n`;
      p += `## ç§ã®åŸºæœ¬æƒ…å ±\n\n`;
      p += `- **å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}`;
      if (profile['ç¬¬2å¿—æœ›']) p += `ï¼ˆä½µé¡˜: ${profile['ç¬¬2å¿—æœ›']}ï¼‰`;
      p += `\n- **è©¦é¨“ã¾ã§**: ã‚ã¨${daysUntil}æ—¥\n`;
      
      if (goals.length > 0) {
        p += `\n## ç›®æ¨™å¾—ç‚¹ç‡\n\n`;
        goals.forEach(g => {
          const gap = g.target - g.current;
          p += `- **${g.subject}**: ç¾çŠ¶${g.current}% â†’ ç›®æ¨™${g.target}%ï¼ˆã‚ã¨+${gap}ptå¿…è¦ï¼‰\n`;
        });
      }
      
      p += `\n## å…ˆé€±ã®å­¦ç¿’å®Ÿç¸¾\n\n`;
      p += `**ç·å­¦ç¿’æ™‚é–“**: ${formatMinutes(weekMinutes)}\n\n`;
      
      if (Object.keys(subjectStats).length > 0) {
        p += `### ç§‘ç›®åˆ¥å†…è¨³\n`;
        Object.entries(subjectStats).forEach(([cat, stats]) => {
          const pct = weekMinutes > 0 ? Math.round(stats.minutes / weekMinutes * 100) : 0;
          p += `- **${cat}**: ${formatMinutes(stats.minutes)}ï¼ˆ${pct}%ï¼‰\n`;
          // è©³ç´°ç§‘ç›®
          const details = Object.entries(stats.details).map(([s, m]) => `${s}:${m}åˆ†`).join('ã€');
          if (details) p += `  - å†…è¨³: ${details}\n`;
        });
      }
      
      if (Object.keys(typeStats).length > 0) {
        p += `\n### å­¦ç¿’ã‚¿ã‚¤ãƒ—åˆ¥ãƒãƒ©ãƒ³ã‚¹\n`;
        p += formatTypeStats(typeStats) + '\n';
      }
      
      if (redbookLogs.length > 0) {
        p += `\n## ç›´è¿‘ã®éå»å•æ¼”ç¿’\n\n`;
        redbookLogs.slice(0, 5).forEach(log => {
          p += `- ${log.university} ${log.subject || ''} ${log.year}å¹´: **${log.score}%**`;
          if (log.weakAreas) p += ` âš ï¸é–“é•ã„: ${log.weakAreas}`;
          p += `\n`;
        });
      }
      
      if (Object.keys(weakAreasCount).length > 0) {
        p += `\n## é »å‡ºã®è‹¦æ‰‹åˆ†é‡\n\n`;
        p += getTopWeakAreas(weakAreasCount) + '\n';
      }
      
      if (moodStats.bad.length > 0) {
        p += `\n## è‹¦æˆ¦ã—ãŸå­¦ç¿’ï¼ˆæ‰‹å¿œãˆä½ï¼‰\n\n`;
        const uniqueBad = [...new Set(moodStats.bad.map(m => m.unit ? `${m.subject}(${m.unit})` : m.subject))];
        p += uniqueBad.slice(0, 5).join('ã€') + '\n';
      }
      
      p += `\n---\n\n`;
      p += `## ç›¸è«‡å†…å®¹\n\n`;
      p += `æ¥é€±ã®å­¦ç¿’è¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚\n\n`;
      p += `### å›ç­”å½¢å¼\n`;
      p += `1. **ç¾çŠ¶åˆ†æ**ï¼ˆ2-3è¡Œï¼‰: ä»Šé€±ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¦‹ãˆã‚‹èª²é¡Œ\n`;
      p += `2. **å„ªå…ˆé †ä½**ï¼ˆé«˜/ä¸­/ä½ï¼‰: ç§‘ç›®ãƒ»åˆ†é‡ã”ã¨ã®å„ªå…ˆåº¦\n`;
      p += `3. **é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**: æ›œæ—¥ã”ã¨ã®å…·ä½“çš„ãªå­¦ç¿’å†…å®¹ã¨æ™‚é–“é…åˆ†\n`;
      p += `4. **æ³¨æ„ç‚¹**: ç‰¹ã«æ°—ã‚’ã¤ã‘ã‚‹ã¹ãã“ã¨\n`;
      
      return p;
    }
    
    // ========== ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ==========
    
    function generateDailyPrompt(data) {
      const { allLogs, weekMinutes, subjectStats, typeStats } = data;
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const todayLogs = allLogs.filter(log => log.date === todayStr);
      const todayMinutes = todayLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      
      let p = `# ä»Šæ—¥ã®å­¦ç¿’æŒ¯ã‚Šè¿”ã‚Š\n\n`;
      p += `**æ—¥ä»˜**: ${todayStr}\n`;
      p += `**æœ¬æ—¥ã®å­¦ç¿’æ™‚é–“**: ${formatMinutes(todayMinutes)}\n`;
      p += `**ä»Šé€±ã®ç´¯è¨ˆ**: ${formatMinutes(weekMinutes)}\n\n`;
      
      if (todayLogs.length > 0) {
        p += `## ä»Šæ—¥ã®å­¦ç¿’å†…å®¹\n\n`;
        todayLogs.forEach(log => {
          p += `- **${log.subject}**: ${log.minutes}åˆ†`;
          if (log.studyType) p += `ï¼ˆ${log.studyType}ï¼‰`;
          if (log.mood) p += ` ${log.mood}`;
          p += `\n`;
          if (log.unit) p += `  - ç¯„å›²: ${log.unit}\n`;
          if (log.textbook) p += `  - æ•™æ: ${log.textbook}\n`;
          if (log.memo) p += `  - ãƒ¡ãƒ¢: ${log.memo}\n`;
        });
      } else {
        p += `â€»ä»Šæ—¥ã¯ã¾ã å­¦ç¿’è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n`;
      }
      
      // è‰¯ã‹ã£ãŸç‚¹ãƒ»æ‚ªã‹ã£ãŸç‚¹ã‚’æŠ½å‡º
      const goodLogs = todayLogs.filter(l => l.mood === 'ğŸ˜Š' || l.mood === 'ğŸ™‚');
      const badLogs = todayLogs.filter(l => l.mood === 'ğŸ˜«' || l.mood === 'ğŸ˜•');
      
      if (goodLogs.length > 0) {
        p += `\n## æ‰‹å¿œãˆãŒè‰¯ã‹ã£ãŸå­¦ç¿’\n`;
        goodLogs.forEach(l => p += `- ${l.subject}${l.unit ? `: ${l.unit}` : ''}\n`);
      }
      
      if (badLogs.length > 0) {
        p += `\n## è‹¦æˆ¦ã—ãŸå­¦ç¿’\n`;
        badLogs.forEach(l => {
          p += `- ${l.subject}${l.unit ? `: ${l.unit}` : ''}`;
          if (l.memo) p += ` â†’ ${l.memo}`;
          p += `\n`;
        });
      }
      
      p += `\n---\n\n`;
      p += `## ç›¸è«‡å†…å®¹\n\n`;
      p += `ä»Šæ—¥ã®å­¦ç¿’ã‚’æŒ¯ã‚Šè¿”ã£ã¦ã€æ˜æ—¥ä»¥é™ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚\n\n`;
      p += `### å›ç­”å½¢å¼\n`;
      p += `1. **ä»Šæ—¥ã®è©•ä¾¡**ï¼ˆâ—/â—‹/â–³ï¼‰ã¨ç†ç”±\n`;
      p += `2. **è‰¯ã‹ã£ãŸç‚¹**: ç¶™ç¶šã™ã¹ãã“ã¨\n`;
      p += `3. **æ”¹å–„ç‚¹**: æ˜æ—¥ã‹ã‚‰æ„è­˜ã™ã‚‹ã“ã¨\n`;
      p += `4. **æ˜æ—¥ã®ãŠã™ã™ã‚å­¦ç¿’**: å…·ä½“çš„ãªç§‘ç›®ãƒ»å†…å®¹ãƒ»æ™‚é–“\n`;
      
      return p;
    }
    
    // ========== å¼±ç‚¹åˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ==========
    
    function generateWeaknessPrompt(data) {
      const { profile, goals, redbookLogs, moodStats, weakAreasCount, allLogs } = data;
      
      let p = `# å¼±ç‚¹åˆ†æãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n\n`;
      
      p += `## å¿—æœ›æ ¡\n\n`;
      p += `- ç¬¬1å¿—æœ›: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}\n`;
      if (profile['ç¬¬2å¿—æœ›']) p += `- ç¬¬2å¿—æœ›: ${profile['ç¬¬2å¿—æœ›']}\n`;
      if (profile['ç¬¬3å¿—æœ›']) p += `- ç¬¬3å¿—æœ›: ${profile['ç¬¬3å¿—æœ›']}\n`;
      
      if (goals.length > 0) {
        p += `\n## ç›®æ¨™ã¨ç¾çŠ¶ã®ã‚®ãƒ£ãƒƒãƒ—\n\n`;
        goals.forEach(g => {
          const gap = g.target - g.current;
          const must = g.must || g.target;
          p += `### ${g.subject}\n`;
          p += `- ç¾çŠ¶: ${g.current}% â†’ ç›®æ¨™: ${g.target}%ï¼ˆã‚®ãƒ£ãƒƒãƒ—: ${gap}ptï¼‰\n`;
          p += `- æœ€ä½ãƒ©ã‚¤ãƒ³: ${must}%\n\n`;
        });
      }
      
      if (redbookLogs.length > 0) {
        p += `## éå»å•ãƒ»æ¨¡è©¦ã®çµæœä¸€è¦§\n\n`;
        redbookLogs.slice(0, 15).forEach(log => {
          p += `- **${log.university}** ${log.subject || ''} ${log.year}å¹´: ${log.score}%`;
          if (log.time) p += `ï¼ˆ${log.time}åˆ†ã§è§£ç­”ï¼‰`;
          p += `\n`;
          if (log.sectionScores) p += `  - å¤§å•åˆ¥: ${log.sectionScores}\n`;
          if (log.weakAreas) p += `  - âš ï¸é–“é•ãˆãŸåˆ†é‡: ${log.weakAreas}\n`;
          if (log.memo) p += `  - ãƒ¡ãƒ¢: ${log.memo}\n`;
        });
      }
      
      if (Object.keys(weakAreasCount).length > 0) {
        p += `\n## é »å‡ºã®é–“é•ã„åˆ†é‡ï¼ˆé›†è¨ˆï¼‰\n\n`;
        const sorted = Object.entries(weakAreasCount).sort((a, b) => b[1] - a[1]);
        sorted.forEach(([area, count]) => {
          p += `- **${area}**: ${count}å›\n`;
        });
      }
      
      if (moodStats.bad.length > 0) {
        p += `\n## å­¦ç¿’æ™‚ã«è‹¦æˆ¦ã—ãŸå†…å®¹\n\n`;
        const uniqueBad = [...new Map(moodStats.bad.map(m => [m.subject + m.unit, m])).values()];
        uniqueBad.slice(0, 8).forEach(m => {
          p += `- ${m.subject}`;
          if (m.unit) p += `: ${m.unit}`;
          if (m.memo) p += ` â†’ ${m.memo}`;
          p += `\n`;
        });
      }
      
      p += `\n---\n\n`;
      p += `## åˆ†æãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n\n`;
      p += `ä¸Šè¨˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã€ç§ã®å¼±ç‚¹ã¨å¯¾ç­–ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚\n\n`;
      p += `### å›ç­”å½¢å¼\n`;
      p += `1. **æœ€å„ªå…ˆã§å¯¾ç­–ã™ã¹ãå¼±ç‚¹**ï¼ˆ3ã¤ï¼‰: ç†ç”±ã¨ã¨ã‚‚ã«\n`;
      p += `2. **ç§‘ç›®åˆ¥ã®èª²é¡Œ**: å„ç§‘ç›®ã§ç‰¹ã«æ³¨æ„ã™ã¹ãåˆ†é‡\n`;
      p += `3. **å…·ä½“çš„ãªå¯¾ç­–æ–¹æ³•**: å„å¼±ç‚¹ã«å¯¾ã™ã‚‹å‹‰å¼·æ³•\n`;
      p += `4. **ç›®æ¨™é”æˆã¸ã®è¦‹é€šã—**: ç¾å®Ÿçš„ãªåˆ°é”å¯èƒ½æ€§ã¨å¿…è¦ãªåŠªåŠ›é‡\n`;
      
      return p;
    }
    
    // ========== ç§‘ç›®åˆ¥ç›¸è«‡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ==========
    
    function generateSubjectPrompt(data) {
      const selectedSubject = document.getElementById('aiSubjectSelect').value;
      if (!selectedSubject) {
        return 'â†‘ä¸Šã®ã€Œç›¸è«‡ã—ãŸã„ç§‘ç›®ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
      }
      
      const { profile, goals, allLogs, redbookLogs, daysUntil } = data;
      
      // é¸æŠç§‘ç›®ã«é–¢é€£ã™ã‚‹ãƒ­ã‚°ã‚’æŠ½å‡º
      const subjectLogs = allLogs.filter(log => categorizeSubject(log.subject) === selectedSubject);
      const subjectRedbook = redbookLogs.filter(log => categorizeSubject(log.subject) === selectedSubject);
      const subjectGoal = goals.find(g => g.subject === selectedSubject);
      
      // å­¦ç¿’ã‚¿ã‚¤ãƒ—åˆ¥é›†è¨ˆ
      const typeStats = {};
      subjectLogs.forEach(log => {
        if (log.studyType) typeStats[log.studyType] = (typeStats[log.studyType] || 0) + (log.minutes || 0);
      });
      
      // ä½¿ç”¨æ•™æé›†è¨ˆ
      const textbooks = {};
      subjectLogs.forEach(log => {
        if (log.textbook) textbooks[log.textbook] = (textbooks[log.textbook] || 0) + (log.minutes || 0);
      });
      
      // è‹¦æ‰‹åˆ†é‡é›†è¨ˆ
      const weakAreas = getSubjectWeakAreas(redbookLogs, selectedSubject);
      
      // æ‰‹å¿œãˆé›†è¨ˆ
      const moodCount = { good: 0, bad: 0 };
      subjectLogs.forEach(log => {
        if (log.mood === 'ğŸ˜Š' || log.mood === 'ğŸ™‚') moodCount.good++;
        else if (log.mood === 'ğŸ˜«' || log.mood === 'ğŸ˜•') moodCount.bad++;
      });
      
      let p = `# ${selectedSubject}ã®å­¦ç¿’ç›¸è«‡\n\n`;
      
      p += `## åŸºæœ¬æƒ…å ±\n\n`;
      p += `- å¿—æœ›æ ¡: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}\n`;
      p += `- è©¦é¨“ã¾ã§: ã‚ã¨${daysUntil}æ—¥\n`;
      
      if (subjectGoal) {
        p += `- ç›®æ¨™: ç¾çŠ¶${subjectGoal.current}% â†’ ç›®æ¨™${subjectGoal.target}%ï¼ˆã‚ã¨+${subjectGoal.target - subjectGoal.current}ptï¼‰\n`;
      }
      
      const totalMinutes = subjectLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      p += `\n## ${selectedSubject}ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿\n\n`;
      p += `**ç´¯è¨ˆå­¦ç¿’æ™‚é–“**: ${formatMinutes(totalMinutes)}ï¼ˆ${subjectLogs.length}å›ã®å­¦ç¿’ï¼‰\n\n`;
      
      if (Object.keys(typeStats).length > 0) {
        p += `### å­¦ç¿’ã‚¿ã‚¤ãƒ—å†…è¨³\n`;
        Object.entries(typeStats).forEach(([type, min]) => {
          p += `- ${type}: ${formatMinutes(min)}\n`;
        });
        p += `\n`;
      }
      
      if (Object.keys(textbooks).length > 0) {
        p += `### ä½¿ç”¨æ•™æ\n`;
        Object.entries(textbooks)
          .sort((a, b) => b[1] - a[1])
          .forEach(([book, min]) => {
            p += `- ${book}: ${formatMinutes(min)}\n`;
          });
        p += `\n`;
      }
      
      // æœ€è¿‘ã®å­¦ç¿’å†…å®¹
      const recentLogs = subjectLogs.slice(0, 10);
      if (recentLogs.length > 0) {
        p += `### æœ€è¿‘ã®å­¦ç¿’å†…å®¹\n`;
        recentLogs.forEach(log => {
          p += `- ${log.date}: ${log.subject} ${log.minutes}åˆ†`;
          if (log.mood) p += ` ${log.mood}`;
          if (log.unit) p += ` [${log.unit}]`;
          p += `\n`;
        });
        p += `\n`;
      }
      
      if (subjectRedbook.length > 0) {
        p += `### éå»å•æ¼”ç¿’çµæœ\n`;
        subjectRedbook.forEach(log => {
          p += `- ${log.university} ${log.year}å¹´: **${log.score}%**`;
          if (log.sectionScores) p += `\n  - å¤§å•åˆ¥: ${log.sectionScores}`;
          if (log.weakAreas) p += `\n  - é–“é•ã„: ${log.weakAreas}`;
          p += `\n`;
        });
        p += `\n`;
      }
      
      if (Object.keys(weakAreas).length > 0) {
        p += `### ã‚ˆãé–“é•ãˆã‚‹åˆ†é‡\n`;
        Object.entries(weakAreas)
          .sort((a, b) => b[1] - a[1])
          .forEach(([area, count]) => {
            p += `- ${area}: ${count}å›\n`;
          });
        p += `\n`;
      }
      
      p += `### æ‰‹å¿œãˆã®å‚¾å‘\n`;
      p += `- è‰¯ã„æ‰‹å¿œãˆ: ${moodCount.good}å›\n`;
      p += `- è‹¦æˆ¦: ${moodCount.bad}å›\n`;
      
      p += `\n---\n\n`;
      p += `## ç›¸è«‡å†…å®¹\n\n`;
      p += `${selectedSubject}ã®æˆç¸¾ã‚’ä¸Šã’ã‚‹ãŸã‚ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚\n\n`;
      p += `### å›ç­”å½¢å¼\n`;
      p += `1. **ç¾çŠ¶è¨ºæ–­**: ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¦‹ãˆã‚‹ç§ã®${selectedSubject}ã®ç‰¹å¾´\n`;
      p += `2. **é‡ç‚¹å¯¾ç­–åˆ†é‡**: ç‰¹ã«ä¼¸ã°ã™ã¹ãåˆ†é‡ï¼ˆ3ã¤ï¼‰ã¨ç†ç”±\n`;
      p += `3. **å…·ä½“çš„ãªå­¦ç¿’ãƒ—ãƒ©ãƒ³**: 1æ—¥/1é€±é–“ã®å­¦ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¾‹\n`;
      p += `4. **ãŠã™ã™ã‚æ•™æãƒ»å‹‰å¼·æ³•**: ç¾åœ¨ã®ä½¿ç”¨æ•™æã¸ã®è©•ä¾¡ã‚‚å«ã‚ã¦\n`;
      p += `5. **ç›®æ¨™é”æˆã¸ã®é“ç­‹**: æ®‹ã‚Š${daysUntil}æ—¥ã§ã©ã“ã¾ã§ä¼¸ã°ã›ã‚‹ã‹\n`;
      
      return p;
    }
    
    // ========== ç›´å‰æœŸå¯¾ç­–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ==========
    
    function generateLastSpurtPrompt(data) {
      const { profile, goals, daysUntil, redbookLogs, weakAreasCount, allLogs, weekMinutes } = data;
      
      let p = `# ç›´å‰æœŸå¯¾ç­–ãƒ—ãƒ©ãƒ³ã®ç›¸è«‡\n\n`;
      
      p += `## ç¾åœ¨ã®çŠ¶æ³\n\n`;
      p += `- **å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}\n`;
      if (profile['ç¬¬2å¿—æœ›']) p += `- **ä½µé¡˜æ ¡**: ${profile['ç¬¬2å¿—æœ›']}`;
      if (profile['ç¬¬3å¿—æœ›']) p += `ã€${profile['ç¬¬3å¿—æœ›']}`;
      p += `\n- **è©¦é¨“ã¾ã§**: âš ï¸ **ã‚ã¨${daysUntil}æ—¥**\n`;
      p += `- **ç›´è¿‘1é€±é–“ã®å­¦ç¿’æ™‚é–“**: ${formatMinutes(weekMinutes)}\n`;
      
      if (goals.length > 0) {
        p += `\n## ç›®æ¨™ã¨ç¾çŠ¶\n\n`;
        p += `| ç§‘ç›® | ç¾çŠ¶ | ç›®æ¨™ | æœ€ä½ãƒ©ã‚¤ãƒ³ | å¿…è¦ãªä¼¸ã³ |\n`;
        p += `|------|------|------|------------|------------|\n`;
        goals.forEach(g => {
          const must = g.must || Math.floor((g.current + g.target) / 2);
          p += `| ${g.subject} | ${g.current}% | ${g.target}% | ${must}% | +${g.target - g.current}pt |\n`;
        });
      }
      
      if (redbookLogs.length > 0) {
        p += `\n## ç›´è¿‘ã®éå»å•çµæœ\n\n`;
        const recentRedbook = redbookLogs.slice(0, 8);
        recentRedbook.forEach(log => {
          const icon = log.score >= 70 ? 'ğŸŸ¢' : log.score >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
          p += `- ${icon} **${log.university}** ${log.subject || ''} ${log.year}å¹´: ${log.score}%`;
          if (log.weakAreas) p += ` â†’ èª²é¡Œ: ${log.weakAreas}`;
          p += `\n`;
        });
        
        // å¹³å‡ç‚¹ã‚’è¨ˆç®—
        const avgScore = Math.round(recentRedbook.reduce((sum, l) => sum + l.score, 0) / recentRedbook.length);
        p += `\n**ç›´è¿‘${recentRedbook.length}å›ã®å¹³å‡**: ${avgScore}%\n`;
      }
      
      if (Object.keys(weakAreasCount).length > 0) {
        p += `\n## ç¹°ã‚Šè¿”ã—é–“é•ãˆã‚‹åˆ†é‡ï¼ˆè¦é›†ä¸­å¯¾ç­–ï¼‰\n\n`;
        const topWeak = Object.entries(weakAreasCount)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 6);
        topWeak.forEach(([area, count]) => {
          p += `- ğŸ”´ **${area}**: ${count}å›ãƒŸã‚¹\n`;
        });
      }
      
      // å­¦ç¿’ãƒšãƒ¼ã‚¹ã®è¨ˆç®—
      const totalMinutes = allLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      const avgDailyMinutes = allLogs.length > 0 ? Math.round(totalMinutes / Math.max(1, new Set(allLogs.map(l => l.date)).size)) : 0;
      
      p += `\n## å­¦ç¿’ãƒšãƒ¼ã‚¹\n\n`;
      p += `- ã“ã‚Œã¾ã§ã®ç´¯è¨ˆ: ${formatMinutes(totalMinutes)}\n`;
      p += `- 1æ—¥å¹³å‡: ${formatMinutes(avgDailyMinutes)}\n`;
      p += `- æ®‹ã‚Šæ—¥æ•°ã§ç¢ºä¿ã§ãã‚‹æ™‚é–“: ç´„${formatMinutes(avgDailyMinutes * daysUntil)}\n`;
      
      p += `\n---\n\n`;
      p += `## ç›¸è«‡å†…å®¹\n\n`;
      p += `æ®‹ã‚Š${daysUntil}æ—¥ã®ç›´å‰æœŸå¯¾ç­–ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n`;
      p += `### å›ç­”å½¢å¼\n`;
      p += `1. **å„ªå…ˆé †ä½ã®æ˜ç¢ºåŒ–**: æ®‹ã‚Šæ™‚é–“ã§ã€Œã‚„ã‚‹ã“ã¨ã€ã€Œã‚„ã‚‰ãªã„ã“ã¨ã€ã®åˆ¤æ–­\n`;
      p += `2. **ç§‘ç›®åˆ¥ã®æ™‚é–“é…åˆ†**: 1æ—¥ã‚ãŸã‚Šã®ç†æƒ³çš„ãªé…åˆ†\n`;
      p += `3. **ç›´å‰æœŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**:\n`;
      p += `   - æ®‹ã‚Š2é€±é–“ï½1é€±é–“å‰: ã‚„ã‚‹ã¹ãã“ã¨\n`;
      p += `   - æ®‹ã‚Š1é€±é–“ï½3æ—¥å‰: ã‚„ã‚‹ã¹ãã“ã¨\n`;
      p += `   - ç›´å‰3æ—¥ï½å‰æ—¥: ã‚„ã‚‹ã¹ãã“ã¨\n`;
      p += `4. **æœ¬ç•ªã§+5ç‚¹å–ã‚‹ãŸã‚ã®ã‚³ãƒ„**: è©¦é¨“å½“æ—¥ã®æˆ¦ç•¥\n`;
      p += `5. **ãƒ¡ãƒ³ã‚¿ãƒ«ç®¡ç†**: ç›´å‰æœŸã®ä¸å®‰ã¨ã®å‘ãåˆã„æ–¹\n`;
      
      return p;
    }
    
    // ========== ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ==========
    
    function generateMotivationPrompt(data) {
      const { profile, daysUntil, allLogs, streak, weekMinutes, moodStats } = data;
      
      const totalMinutes = allLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      const totalHours = Math.floor(totalMinutes / 60);
      const totalDays = new Set(allLogs.map(l => l.date)).size;
      
      let p = `# åŠ±ã¾ã—ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®ãŠé¡˜ã„\n\n`;
      
      p += `## ã“ã‚Œã¾ã§ã®é ‘å¼µã‚Š\n\n`;
      p += `- **ç´¯è¨ˆå­¦ç¿’æ™‚é–“**: ${totalHours}æ™‚é–“${totalMinutes % 60}åˆ†\n`;
      p += `- **å­¦ç¿’ã—ãŸæ—¥æ•°**: ${totalDays}æ—¥\n`;
      p += `- **é€£ç¶šå­¦ç¿’æ—¥æ•°**: ${streak}æ—¥\n`;
      p += `- **ç›´è¿‘1é€±é–“**: ${formatMinutes(weekMinutes)}\n`;
      
      p += `\n## å¿—æœ›ã¸ã®æƒ³ã„\n\n`;
      p += `- å¿—æœ›æ ¡: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}\n`;
      p += `- è©¦é¨“ã¾ã§: ã‚ã¨${daysUntil}æ—¥\n`;
      
      // æœ€è¿‘ã®æ‰‹å¿œãˆå‚¾å‘
      const recentGood = moodStats.good.length;
      const recentBad = moodStats.bad.length;
      
      p += `\n## æœ€è¿‘ã®èª¿å­\n\n`;
      if (recentBad > recentGood) {
        p += `æ­£ç›´ã€æœ€è¿‘ã¯è‹¦æˆ¦ã™ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ï¼ˆä»Šé€±: å¥½èª¿${recentGood}å›ã€è‹¦æˆ¦${recentBad}å›ï¼‰ã€‚\n`;
        p += `æ€ã†ã‚ˆã†ã«é€²ã¾ãªãã¦ã€å°‘ã—ç„¦ã£ã¦ã„ã¾ã™ã€‚\n`;
      } else if (recentGood > 0) {
        p += `èª¿å­ã¯æ‚ªããªã„ã§ã™ãŒã€æœ¬ç•ªãŒè¿‘ã¥ã„ã¦ä¸å®‰ã‚‚ã‚ã‚Šã¾ã™ï¼ˆä»Šé€±: å¥½èª¿${recentGood}å›ã€è‹¦æˆ¦${recentBad}å›ï¼‰ã€‚\n`;
      } else {
        p += `æ¯æ—¥é ‘å¼µã£ã¦ã„ã¾ã™ãŒã€æˆæœãŒè¦‹ãˆã«ããã¦ä¸å®‰ã§ã™ã€‚\n`;
      }
      
      p += `\n## ä»Šã®æ°—æŒã¡\n\n`;
      p += `- è©¦é¨“ãŒè¿‘ã¥ã„ã¦ãã¦ç·Šå¼µã—ã¦ã„ã‚‹\n`;
      p += `- è‡ªåˆ†ã®å®ŸåŠ›ã§æœ¬å½“ã«åˆæ ¼ã§ãã‚‹ã‹ä¸å®‰\n`;
      p += `- å‘¨ã‚Šã¨æ¯”ã¹ã¦ç„¦ã‚‹ã“ã¨ãŒã‚ã‚‹\n`;
      p += `- ã§ã‚‚ã€å¿—æœ›æ ¡ã«çµ¶å¯¾ã«å—ã‹ã‚ŠãŸã„\n`;
      
      p += `\n---\n\n`;
      p += `## ãŠé¡˜ã„\n\n`;
      p += `ç§ã‚’åŠ±ã¾ã—ã¦ãã ã•ã„ã€‚ãã—ã¦ã€æ®‹ã‚Š${daysUntil}æ—¥ã‚’ä¹—ã‚Šåˆ‡ã‚‹ãŸã‚ã®ç¾å®Ÿçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚‚ãã ã•ã„ã€‚\n\n`;
      p += `### å›ç­”å½¢å¼\n`;
      p += `1. **ã“ã‚Œã¾ã§ã®åŠªåŠ›ã¸ã®è©•ä¾¡**: å…·ä½“çš„ãªæ•°å­—ï¼ˆ${totalHours}æ™‚é–“ã€${streak}æ—¥é€£ç¶šãªã©ï¼‰ã‚’è¸ã¾ãˆã¦\n`;
      p += `2. **åŠ±ã¾ã—ã®è¨€è‘‰**: æ¸©ã‹ãã€ã§ã‚‚ç¾å®Ÿçš„ã«\n`;
      p += `3. **ä¸å®‰ã¨ã®å‘ãåˆã„æ–¹**: å…·ä½“çš„ãªãƒ¡ãƒ³ã‚¿ãƒ«ç®¡ç†æ³•\n`;
      p += `4. **æ®‹ã‚Š${daysUntil}æ—¥ã®éã”ã—æ–¹**: ç„¡ç†ãªãç¶šã‘ã‚‰ã‚Œã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹\n`;
      p += `5. **åˆæ ¼å¾Œã®è‡ªåˆ†ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã™ã‚‹è¨€è‘‰**: ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸ŠãŒã‚‹ã‚ˆã†ãªä¸€è¨€\n`;
      
      return p;
    }
    
    async function copyPrompt() {
      const prompt = document.getElementById('promptPreview').textContent;
      
      try {
        await navigator.clipboard.writeText(prompt);
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼AIã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
        closeAIModal();
      } catch {
        const textarea = document.createElement('textarea');
        textarea.value = prompt;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        closeAIModal();
      }
    }
    
    function formatMinutes(minutes) {
      if (minutes < 60) return `${minutes}åˆ†`;
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return mins > 0 ? `${hours}æ™‚é–“${mins}åˆ†` : `${hours}æ™‚é–“`;
    }
    
    function formatDateShort(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return `${date.getMonth() + 1}/${date.getDate()}`;
    }
    
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('active');
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }
    
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>
