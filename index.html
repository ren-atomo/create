<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Tracker</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=Noto+Sans+JP:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --black: #0a0a0a;
      --gray-900: #171717;
      --gray-800: #262626;
      --gray-700: #404040;
      --gray-600: #525252;
      --gray-500: #737373;
      --gray-400: #a3a3a3;
      --gray-300: #d4d4d4;
      --gray-200: #e5e5e5;
      --gray-100: #f5f5f5;
      --gray-50: #fafafa;
      --white: #ffffff;
      --success: #22c55e;
      --warning: #eab308;
      --danger: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-size: 15px;
    }

    body {
      font-family: 'DM Sans', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--white);
      color: var(--gray-900);
      min-height: 100vh;
      line-height: 1.5;
      letter-spacing: -0.01em;
      -webkit-font-smoothing: antialiased;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--gray-100);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.125rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--black);
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
      font-family: inherit;
      letter-spacing: -0.01em;
    }

    .btn-ghost {
      background: transparent;
      color: var(--gray-600);
    }

    .btn-ghost:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .btn-primary {
      background: var(--black);
      color: var(--white);
    }

    .btn-primary:hover {
      background: var(--gray-800);
    }

    .btn-outline {
      background: var(--white);
      color: var(--gray-900);
      border: 1px solid var(--gray-200);
    }

    .btn-outline:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }

    /* Main */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2.5rem 2rem 6rem;
    }

    /* Hero Section - Compact */
    .hero {
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .hero-countdown {
      display: inline-flex;
      align-items: baseline;
      gap: 0.375rem;
      margin-bottom: 0.25rem;
    }

    .hero-days {
      font-size: 3.5rem;
      font-weight: 700;
      letter-spacing: -0.04em;
      line-height: 1;
      color: var(--black);
    }

    .hero-unit {
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--gray-500);
    }

    .hero-label {
      font-size: 0.8125rem;
      color: var(--gray-400);
    }

    @media (max-width: 640px) {
      .hero {
        margin-bottom: 1.25rem;
      }
      .hero-days {
        font-size: 2.75rem;
      }
    }

    /* Stats Row - Redesigned */
    .stats-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 2.5rem;
    }

    .stat-hero {
      background: linear-gradient(135deg, var(--gray-900) 0%, var(--gray-800) 100%);
      border-radius: 16px;
      padding: 1.75rem;
      color: var(--white);
      text-align: center;
    }

    .stat-hero .stat-value {
      font-size: 3.5rem;
      font-weight: 700;
      letter-spacing: -0.03em;
      color: var(--white);
      line-height: 1;
      margin-bottom: 0.5rem;
    }

    .stat-hero .stat-label {
      font-size: 0.875rem;
      color: var(--gray-400);
      font-weight: 500;
    }

    .stat-hero .stat-sub {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 0.5rem;
    }

    .stat-actions {
      display: flex;
      gap: 0.625rem;
      margin-top: 1.25rem;
      padding-top: 1rem;
      border-top: 1px solid var(--gray-700);
      justify-content: center;
    }

    .stat-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.625rem 1rem;
      background: var(--white);
      color: var(--gray-900);
      border: none;
      border-radius: 8px;
      font-size: 0.8125rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .stat-action-btn:hover {
      background: var(--gray-100);
      transform: translateY(-1px);
    }

    .stat-action-btn:active {
      transform: translateY(0);
    }

    .stat-action-btn.secondary {
      background: transparent;
      color: var(--white);
      border: 1px solid var(--gray-600);
    }

    .stat-action-btn.secondary:hover {
      background: var(--gray-800);
      border-color: var(--gray-500);
    }

    .stat-action-icon {
      font-size: 0.875rem;
    }

    @media (max-width: 640px) {
      .stat-actions {
        flex-direction: row;
      }
      .stat-action-btn {
        flex: 1;
        justify-content: center;
        padding: 0.75rem 0.875rem;
      }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }

    .stat-item {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      transition: all 0.2s ease;
    }

    .stat-item:hover {
      border-color: var(--gray-300);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--black);
      margin-bottom: 0.125rem;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    @media (max-width: 640px) {
      .stat-hero .stat-value {
        font-size: 3rem;
      }
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
      }
      .stat-item {
        padding: 0.75rem 0.5rem;
      }
      .stat-value {
        font-size: 1.25rem;
      }
    }

    /* Progress Section - Card Style */
    .progress-section {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 2.5rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.875rem;
    }

    .section-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-title-icon {
      font-size: 1.125rem;
    }

    .section-value {
      font-size: 0.875rem;
      color: var(--gray-600);
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }

    .progress-track {
      height: 8px;
      background: var(--gray-100);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #A3BE8C, #8FBCBB);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* Card Title - Enhanced */
    .card-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-title-icon {
      font-size: 1rem;
      opacity: 0.8;
    }

    /* Grid Layout */
    .grid-2 {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    @media (max-width: 900px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    /* Card */
    .card {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1.5rem;
    }

    /* Chart */
    .chart-container {
      position: relative;
      height: 240px;
    }

    /* Goals */
    .goals-list {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .goal-item {
      display: flex;
      flex-direction: column;
      gap: 0.625rem;
    }

    .goal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .goal-name {
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--gray-900);
    }

    .goal-values {
      font-size: 0.8125rem;
      color: var(--gray-500);
      font-variant-numeric: tabular-nums;
    }

    .goal-bar {
      height: 6px;
      background: var(--gray-100);
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }

    .goal-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .goal-fill.kokugo { background: #EBCB8B; }
    .goal-fill.sugaku { background: #A3BE8C; }
    .goal-fill.eigo { background: #5E81AC; }
    .goal-fill.rika { background: #B48EAD; }
    .goal-fill.shakai { background: #D08770; }

    /* Records - Card Style */
    .records-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .record-item {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
      padding: 0.875rem;
      background: var(--gray-50);
      border-radius: 10px;
      transition: background 0.15s ease;
    }

    .record-item:hover {
      background: var(--gray-100);
    }

    .record-main {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
    }

    .record-details {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      padding-left: 0.5rem;
      border-left: 2px solid var(--gray-200);
      margin-left: 0.5rem;
    }

    .record-textbook {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .record-memo {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .record-date {
      font-size: 0.75rem;
      color: var(--gray-400);
      min-width: 50px;
      font-variant-numeric: tabular-nums;
    }

    .record-subject {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--gray-800);
      padding: 0.25rem 0.625rem;
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 6px;
    }

    .record-subject-small {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .record-type {
      font-size: 0.6875rem;
      color: var(--gray-500);
      padding: 0.125rem 0.5rem;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 3px;
    }

    .record-time {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-900);
      margin-left: auto;
      font-variant-numeric: tabular-nums;
    }

    .record-time-small {
      font-size: 0.6875rem;
      color: var(--gray-400);
      font-variant-numeric: tabular-nums;
    }

    .record-mood {
      font-size: 1rem;
      opacity: 0.8;
    }

    .record-score {
      font-size: 0.9375rem;
      font-weight: 600;
      margin-left: auto;
      font-variant-numeric: tabular-nums;
    }

    .record-score.high { color: var(--success); }
    .record-score.mid { color: var(--warning); }
    .record-score.low { color: var(--danger); }

    .record-unit {
      font-size: 0.75rem;
      color: var(--gray-600);
    }

    .record-section {
      font-size: 0.75rem;
      color: var(--gray-600);
    }

    .record-weak {
      font-size: 0.75rem;
      color: var(--danger);
    }

    /* Empty State - Enhanced */
    .empty-state {
      padding: 2rem 1.5rem;
      text-align: center;
      background: var(--gray-50);
      border-radius: 12px;
      border: 1px dashed var(--gray-200);
    }

    .empty-state-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      opacity: 0.7;
    }

    .empty-state-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.375rem;
    }

    .empty-state-desc {
      font-size: 0.8125rem;
      color: var(--gray-500);
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    .empty-state-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.625rem 1rem;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      background: var(--white);
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-700);
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
    }

    .empty-state-btn:hover {
      border-color: var(--black);
      background: var(--gray-100);
    }

    .empty-state-simple {
      padding: 1.5rem 1rem;
      text-align: center;
      color: var(--gray-400);
      font-size: 0.8125rem;
    }
      background: var(--gray-50);
    }

    /* å¿…é ˆãƒãƒ¼ã‚¯ */
    .required::after {
      content: ' *';
      color: #BF616A;
    }

    /* ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”»é¢ */
    .manager-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.875rem;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      background: var(--white);
    }

    .manager-item:hover {
      background: var(--gray-50);
    }

    .manager-item-info {
      flex: 1;
      min-width: 0;
    }

    .manager-item-main {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      font-size: 0.875rem;
    }

    .manager-item-date {
      color: var(--gray-500);
      font-size: 0.75rem;
    }

    .manager-item-subject {
      font-weight: 600;
      color: var(--gray-700);
    }

    .manager-item-detail {
      color: var(--gray-500);
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }

    .manager-delete-btn {
      flex-shrink: 0;
      width: 36px;
      height: 36px;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      background: var(--white);
      color: var(--gray-400);
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      margin-left: 0.75rem;
    }

    .manager-delete-btn:hover {
      background: #fef2f2;
      border-color: #fecaca;
      color: #BF616A;
    }

    .manager-empty {
      text-align: center;
      padding: 2rem;
      color: var(--gray-400);
    }

    /* ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ */
    .chat-header-btn {
      position: relative;
      font-size: 1.25rem;
      padding: 0.5rem 0.75rem;
    }

    .chat-header-badge {
      position: absolute;
      top: 2px;
      right: 2px;
      background: #BF616A;
      color: white;
      font-size: 0.625rem;
      font-weight: 600;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    /* ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« - Enhanced */
    .chat-modal .modal {
      max-width: 480px;
      height: 70vh;
      max-height: 600px;
      display: flex;
      flex-direction: column;
    }

    @media (max-width: 640px) {
      .chat-modal .modal {
        width: 100%;
        max-width: 100%;
        height: 100%;
        max-height: 100%;
        border-radius: 0;
      }
    }

    .chat-modal .modal-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--gray-100);
      flex-shrink: 0;
    }

    .chat-modal .modal-body {
      flex: 1;
      padding: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      background: var(--gray-50);
    }

    .chat-message {
      max-width: 85%;
      padding: 0.625rem 0.875rem;
      border-radius: 16px;
      font-size: 0.9375rem;
      line-height: 1.45;
      word-wrap: break-word;
    }

    .chat-message.student {
      align-self: flex-end;
      background: var(--black);
      color: var(--white);
      border-bottom-right-radius: 4px;
    }

    .chat-message.admin {
      align-self: flex-start;
      background: var(--white);
      color: var(--gray-800);
      border: 1px solid var(--gray-200);
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }

    .chat-message-time {
      font-size: 0.6875rem;
      color: var(--gray-400);
      margin-top: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chat-message.student .chat-message-time {
      color: rgba(255, 255, 255, 0.6);
      justify-content: flex-end;
    }

    .chat-read-status {
      font-size: 0.625rem;
      opacity: 0.8;
    }

    .chat-input-area {
      padding: 0.75rem 1rem;
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
      border-top: 1px solid var(--gray-200);
      display: flex;
      gap: 0.5rem;
      background: var(--white);
      flex-shrink: 0;
    }

    .chat-input {
      flex: 1;
      padding: 0.625rem 1rem;
      border: 1px solid var(--gray-200);
      border-radius: 20px;
      font-size: 0.9375rem;
      resize: none;
      max-height: 80px;
      font-family: inherit;
      background: var(--gray-50);
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--gray-400);
      background: var(--white);
    }

    .chat-send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--black);
      color: var(--white);
      border: none;
      font-size: 1.125rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }

    .chat-send-btn:hover {
      background: var(--gray-700);
      transform: scale(1.05);
    }

    .chat-send-btn:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
      transform: none;
    }

    .chat-empty {
      text-align: center;
      color: var(--gray-400);
      padding: 3rem 1.5rem;
      font-size: 0.875rem;
    }

    .chat-empty-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      opacity: 0.6;
    }

    .chat-date-divider {
      text-align: center;
      font-size: 0.6875rem;
      color: var(--gray-400);
      padding: 0.75rem 0 0.25rem;
      font-weight: 500;
    }
    }

    /* å¿œæ´ãƒãƒŠãƒ¼ - Softer Design */
    .cheer-banner {
      background: var(--gray-900);
      color: white;
      padding: 0.75rem 1rem;
      margin-bottom: 1.25rem;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
      animation: bannerFadeIn 0.4s ease;
    }

    @keyframes bannerFadeIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .cheer-banner-content {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      gap: 0.625rem;
    }

    .cheer-banner-icon {
      font-size: 1.25rem;
      flex-shrink: 0;
    }

    .cheer-banner-text {
      flex: 1;
      min-width: 0;
    }

    .cheer-banner-message {
      font-size: 0.875rem;
      font-weight: 500;
      line-height: 1.4;
    }

    .cheer-banner-close {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      font-size: 0.875rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
      flex-shrink: 0;
    }

    .cheer-banner-close:hover {
      background: rgba(255,255,255,0.25);
    }

    /* é€£ç¶šæ—¥æ•°ãƒãƒƒã‚¸ */
    .streak-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: var(--gray-100);
      border-radius: 4px;
      font-size: 0.6875rem;
      color: var(--gray-600);
      margin-top: 0.25rem;
    }

    .streak-badge.hot {
      background: #fff7ed;
      color: #D08770;
    }

    .streak-badge.fire {
      background: #fef2f2;
      color: #BF616A;
    }

    /* ç›®æ¨™é”æˆãƒãƒƒã‚¸ */
    .goal-achieved {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.125rem 0.375rem;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 4px;
      font-size: 0.6875rem;
      color: #16a34a;
      margin-left: 0.5rem;
    }

    /* é€±é–“ç›®æ¨™é”æˆ */
    .progress-section.achieved .progress-fill {
      background: linear-gradient(90deg, #A3BE8C, #8FBCBB);
    }

    .progress-celebration {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 8px;
      margin-top: 0.75rem;
      font-size: 0.875rem;
      color: #16a34a;
    }

    /* ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
    .custom-input-wrapper {
      display: none;
      margin-top: 0.5rem;
    }

    .custom-input-wrapper.show {
      display: block;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      padding: 1rem;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--white);
      border-radius: 16px;
      width: 100%;
      max-width: 440px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px) scale(0.98);
      transition: all 0.2s ease;
    }

    .modal-overlay.active .modal {
      transform: translateY(0) scale(1);
    }

    .modal-header {
      padding: 1.5rem 1.5rem 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--gray-100);
      color: var(--gray-600);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      font-size: 1rem;
    }

    .modal-close:hover {
      background: var(--gray-200);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 0 1.5rem 1.5rem;
      display: flex;
      gap: 0.75rem;
    }

    .modal-footer .btn {
      flex: 1;
      padding: 0.75rem;
    }

    /* Form */
    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-600);
      margin-bottom: 0.5rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 0.9375rem;
      font-family: inherit;
      transition: all 0.15s ease;
      background: var(--white);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--gray-400);
    }

    .form-input::placeholder {
      color: var(--gray-400);
    }

    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23737373'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1rem;
      padding-right: 2.5rem;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* Button Group */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.375rem;
    }

    .btn-option {
      padding: 0.5rem 0.875rem;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      background: var(--white);
      font-size: 0.8125rem;
      font-family: inherit;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn-option:hover {
      border-color: var(--gray-300);
      background: var(--gray-50);
    }

    .btn-option.active {
      border-color: var(--black);
      background: var(--black);
      color: var(--white);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transform: scale(1.02);
    }

    /* Mood Buttons */
    .mood-group {
      display: flex;
      gap: 0.5rem;
    }

    .mood-btn {
      width: 44px;
      height: 44px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      background: var(--white);
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .mood-btn:hover {
      border-color: var(--gray-300);
      transform: scale(1.05);
    }

    .mood-btn.active {
      border-color: var(--black);
      border-width: 2px;
      background: var(--gray-100);
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background: var(--gray-100);
    }

    /* AI Modal */
    .ai-question {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 1rem;
      text-align: center;
    }
    
    .ai-main-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    
    .ai-card {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      background: var(--white);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .ai-card:hover {
      border-color: var(--gray-400);
      background: var(--gray-50);
    }
    
    .ai-card.active {
      border-color: var(--black);
      background: var(--gray-100);
    }
    
    .ai-card-icon {
      font-size: 1.75rem;
      flex-shrink: 0;
    }
    
    .ai-card-content {
      flex: 1;
    }
    
    .ai-card-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 0.25rem;
    }
    
    .ai-card-desc {
      font-size: 0.75rem;
      color: var(--gray-500);
    }
    
    .ai-more-toggle {
      text-align: center;
      padding: 0.75rem;
      color: var(--gray-500);
      font-size: 0.875rem;
      cursor: pointer;
      transition: color 0.15s;
    }
    
    .ai-more-toggle:hover {
      color: var(--gray-700);
    }
    
    .ai-more-options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.75rem;
      background: var(--gray-50);
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    
    .ai-option-small {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--gray-200);
      border-radius: 20px;
      background: var(--white);
      font-size: 0.8125rem;
      color: var(--gray-700);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .ai-option-small:hover {
      border-color: var(--gray-400);
      background: var(--gray-100);
    }
    
    .ai-option-small.active {
      border-color: var(--black);
      background: var(--gray-900);
      color: var(--white);
    }
    
    .ai-option-small-icon {
      font-size: 1rem;
    }

    .prompt-preview {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 1rem;
      font-size: 0.75rem;
      font-family: 'SF Mono', 'Consolas', monospace;
      white-space: pre-wrap;
      max-height: 280px;
      overflow-y: auto;
      line-height: 1.6;
      color: var(--gray-700);
    }

    /* Score Input */
    .score-input-container {
      background: var(--gray-50);
      border-radius: 8px;
      padding: 1rem;
    }

    .score-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .score-row.score-total {
      background: var(--white);
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      border: 1px solid var(--gray-200);
    }

    .score-label {
      min-width: 50px;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    .section-name {
      width: 70px !important;
      min-width: 70px;
      padding: 0.5rem !important;
      font-size: 0.875rem;
      text-align: center;
    }

    .score-inputs {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
    }

    .score-box {
      width: 70px !important;
      text-align: center;
      padding: 0.5rem !important;
    }

    .score-box:read-only {
      background: var(--gray-100);
      font-weight: 600;
    }

    .score-divider {
      color: var(--gray-400);
      font-weight: 500;
    }

    .score-percent {
      font-size: 0.875rem;
      color: var(--gray-600);
      min-width: 60px;
    }

    .version-info {
      text-align: center;
      padding-top: 1rem;
      margin-top: 1rem;
      border-top: 1px solid var(--gray-200);
      font-size: 0.75rem;
      color: var(--gray-400);
    }

    /* Tab Menu - Bottom Nav on Mobile */
    .tab-menu {
      display: flex;
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      position: sticky;
      top: 60px;
      z-index: 100;
      padding: 0 1rem;
    }

    @media (max-width: 640px) {
      .tab-menu {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: auto;
        border-bottom: none;
        border-top: 1px solid var(--gray-200);
        padding: 0;
        padding-bottom: env(safe-area-inset-bottom);
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }
    }

    .tab-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.75rem 0.5rem;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--gray-500);
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    @media (max-width: 640px) {
      .tab-btn {
        border-bottom: none;
        padding: 0.625rem 0.5rem;
      }
      .tab-btn.active {
        color: var(--black);
        background: var(--gray-50);
      }
    }

    .tab-btn:hover {
      color: var(--gray-700);
      background: var(--gray-50);
    }

    .tab-btn.active {
      color: var(--black);
      border-bottom-color: var(--black);
    }

    .tab-icon {
      font-size: 1.25rem;
    }

    @media (max-width: 640px) {
      .tab-icon {
        font-size: 1.375rem;
      }
    }

    .tab-label {
      font-size: 0.75rem;
      font-weight: 500;
    }

    @media (max-width: 640px) {
      .tab-label {
        font-size: 0.625rem;
      }
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Analysis Header */
    .analysis-header {
      text-align: center;
      padding: 1.5rem 0;
    }

    .analysis-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .analysis-subtitle {
      color: var(--gray-500);
      font-size: 0.875rem;
    }

    /* Four column stats (for analysis tabs) */
    .stats-row.four-cols {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
    }

    .stats-row.four-cols .stat-item {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
    }

    @media (max-width: 600px) {
      .stats-row.four-cols {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Breakdown List */
    .breakdown-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .breakdown-item {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .breakdown-label {
      min-width: 80px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .breakdown-bar-container {
      flex: 1;
      height: 24px;
      background: var(--gray-100);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .breakdown-bar {
      height: 100%;
      background: var(--gray-800);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .breakdown-value {
      min-width: 70px;
      text-align: right;
      font-size: 0.875rem;
      font-weight: 600;
    }

    /* Filter Row */
    .filter-row {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .filter-select {
      flex: 1;
      max-width: 200px;
    }

    /* Full Height Records */
    .records-list.full-height {
      max-height: 400px;
      overflow-y: auto;
    }

    /* Mood Grid */
    .mood-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.75rem;
    }

    .mood-item {
      text-align: center;
      padding: 1rem;
      background: var(--gray-50);
      border-radius: 8px;
    }

    .mood-emoji {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
    }

    .mood-count {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .mood-percent {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    @media (max-width: 600px) {
      .mood-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Weak Areas */
    .weak-areas-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .weak-area-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: var(--gray-50);
      border-radius: 6px;
      border-left: 3px solid var(--gray-400);
    }

    .weak-area-item.high {
      border-left-color: #ef4444;
      background: #fef2f2;
    }

    .weak-area-item.medium {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }

    .weak-area-name {
      font-weight: 500;
    }

    .weak-area-count {
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    /* Time Input Toggle */
    .time-input-toggle {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .time-toggle-btn {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--gray-300);
      background: var(--white);
      border-radius: 6px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .time-toggle-btn.active {
      background: var(--black);
      color: var(--white);
      border-color: var(--black);
    }

    .section-time-input {
      width: 60px !important;
      text-align: center;
      padding: 0.375rem !important;
      font-size: 0.8rem;
    }

    .record-score {
      font-weight: 700;
      color: var(--black);
    }

    .record-detail {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 0.25rem;
      padding-top: 0.25rem;
      border-top: 1px dashed var(--gray-200);
    }

    .score-buttons {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--gray-200);
    }

    .btn-sm {
      padding: 0.375rem 1rem;
      font-size: 1.25rem;
      min-width: 44px;
    }

    #sectionScoresContainer {
      max-height: 200px;
      overflow-y: auto;
    }

    /* Loading */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid var(--gray-200);
      border-top-color: var(--black);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 6rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 4000;
    }

    .toast {
      padding: 0.75rem 1.25rem;
      background: var(--gray-900);
      color: var(--white);
      border-radius: 8px;
      font-size: 0.875rem;
      animation: fadeUp 0.2s ease;
    }

    .toast.error {
      background: var(--danger);
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive */
    @media (max-width: 640px) {
      html {
        font-size: 14px;
      }

      .header-content {
        padding: 0.875rem 1rem;
      }

      .main {
        padding: 1.5rem 1rem calc(5rem + env(safe-area-inset-bottom));
      }

      .hero-days {
        font-size: 3rem;
      }

      .grid-2 {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .ai-options {
        grid-template-columns: repeat(2, 1fr);
      }

      /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
      .modal {
        width: 100%;
        max-width: 100%;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
        margin: 0;
      }

      .modal-body {
        max-height: calc(100vh - 140px);
        overflow-y: auto;
        padding-bottom: 100px;
      }

      .modal-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--white);
        border-top: 1px solid var(--gray-200);
        padding: 1rem;
        z-index: 10;
      }

      /* ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
      .btn-group {
        gap: 0.5rem;
      }

      .btn-option {
        padding: 0.625rem 0.75rem;
        font-size: 0.75rem;
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-400);
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">Study Tracker</div>
      <div class="header-actions">
        <button class="btn btn-ghost" onclick="openAIModal()" title="AIã«ç›¸è«‡">ğŸ¤–</button>
        <button class="btn btn-ghost chat-header-btn" onclick="openChat()" id="chatHeaderBtn" style="display: none;">
          ğŸ’¬
          <span class="chat-header-badge" id="chatHeaderBadge" style="display: none;">0</span>
        </button>
        <button class="btn btn-ghost" onclick="openSettingsModal()">è¨­å®š</button>
        <button class="btn btn-ghost" onclick="refreshData()">æ›´æ–°</button>
      </div>
    </div>
  </header>

  <!-- Tab Menu -->
  <nav class="tab-menu">
    <button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')">
      <span class="tab-icon">ğŸ“Š</span>
      <span class="tab-label">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
    </button>
    <button class="tab-btn" data-tab="study" onclick="switchTab('study')">
      <span class="tab-icon">ğŸ“š</span>
      <span class="tab-label">å­¦ç¿’åˆ†æ</span>
    </button>
    <button class="tab-btn" data-tab="redbook" onclick="switchTab('redbook')">
      <span class="tab-icon">ğŸ“•</span>
      <span class="tab-label">éå»å•åˆ†æ</span>
    </button>
  </nav>

  <!-- Main -->
  <main class="main">
    <!-- ==================== Dashboard Tab ==================== -->
    <div class="tab-content active" id="tab-dashboard">
    
    <!-- å¿œæ´ãƒãƒŠãƒ¼ -->
    <div id="cheerBanner" style="display: none;"></div>
    
    <!-- Hero -->
    <section class="hero">
      <div class="hero-countdown">
        <span class="hero-days" id="mainCountdown">--</span>
        <span class="hero-unit">æ—¥</span>
      </div>
      <p class="hero-label">å…±é€šãƒ†ã‚¹ãƒˆã¾ã§</p>
    </section>

    <!-- Stats - Redesigned -->
    <section class="stats-row">
      <div class="stat-hero">
        <div class="stat-value" id="todayMinutes">0åˆ†</div>
        <div class="stat-label">ä»Šæ—¥ã®å­¦ç¿’æ™‚é–“</div>
        <div class="stat-sub" id="todayGoalStatus">ç›®æ¨™ã¾ã§ã‚ã¨ --åˆ†</div>
        <div class="stat-actions">
          <button class="stat-action-btn" onclick="openStudyModal()">
            <span class="stat-action-icon">ğŸ“–</span>
            <span>å­¦ç¿’ã‚’è¨˜éŒ²</span>
          </button>
          <button class="stat-action-btn secondary" onclick="openRedbookModal()">
            <span class="stat-action-icon">ğŸ“•</span>
            <span>èµ¤æœ¬ã‚’è¨˜éŒ²</span>
          </button>
        </div>
      </div>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value" id="weekMinutes">0h</div>
          <div class="stat-label">ä»Šé€±</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="streakDays">0</div>
          <div class="stat-label">é€£ç¶šæ—¥æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalSessions">0</div>
          <div class="stat-label">å­¦ç¿’å›æ•°</div>
        </div>
      </div>
    </section>

    <!-- Progress -->
    <section class="progress-section" id="progressSection">
      <div class="section-header">
        <span class="section-title"><span class="section-title-icon">ğŸ¯</span> é€±é–“ç›®æ¨™</span>
        <span class="section-value" id="progressValue">0 / 1800 åˆ†</span>
      </div>
      <div class="progress-track">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <div id="progressCelebration"></div>
    </section>

    <!-- Charts -->
    <section class="grid-2">
      <div class="card">
        <h3 class="card-title"><span class="card-title-icon">ğŸ“ˆ</span> æ—¥åˆ¥å­¦ç¿’æ™‚é–“</h3>
        <div class="chart-container">
          <canvas id="dailyChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 class="card-title"><span class="card-title-icon">ğŸ“Š</span> ç§‘ç›®åˆ¥å‰²åˆ</h3>
        <div class="chart-container">
          <canvas id="subjectChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Goals -->
    <section class="card" style="margin-bottom: 1.5rem;">
      <h3 class="card-title"><span class="card-title-icon">ğŸ†</span> ç›®æ¨™é€²æ—</h3>
      <div class="goals-list" id="goalsSection">
        <!-- Goals rendered here -->
      </div>
    </section>

    <!-- Records -->
    <section class="grid-2">
      <div class="card">
        <h3 class="card-title"><span class="card-title-icon">ğŸ“–</span> æœ€è¿‘ã®å­¦ç¿’è¨˜éŒ²</h3>
        <div class="records-list" id="studyRecordsList">
          <div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
      <div class="card">
        <h3 class="card-title"><span class="card-title-icon">ğŸ“•</span> èµ¤æœ¬æ¼”ç¿’å±¥æ­´</h3>
        <div class="records-list" id="redbookRecordsList">
          <div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
    </section>
    </div><!-- End Dashboard Tab -->

    <!-- ==================== Study Analysis Tab ==================== -->
    <div class="tab-content" id="tab-study">
      <section class="analysis-header">
        <h2 class="analysis-title">ğŸ“š å­¦ç¿’åˆ†æ</h2>
        <p class="analysis-subtitle">å­¦ç¿’è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°åˆ†æ</p>
      </section>

      <!-- Study Stats -->
      <section class="stats-row four-cols">
        <div class="stat-item">
          <div class="stat-value" id="studyTotalHours">0</div>
          <div class="stat-label">ç´¯è¨ˆï¼ˆæ™‚é–“ï¼‰</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="studyAvgDaily">0</div>
          <div class="stat-label">1æ—¥å¹³å‡ï¼ˆåˆ†ï¼‰</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="studyTotalDays">0</div>
          <div class="stat-label">å­¦ç¿’æ—¥æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="studyMaxStreak">0</div>
          <div class="stat-label">æœ€é•·é€£ç¶š</div>
        </div>
      </section>

      <!-- Subject Breakdown -->
      <section class="card">
        <h3 class="card-title">ç§‘ç›®åˆ¥å­¦ç¿’æ™‚é–“</h3>
        <div id="subjectBreakdown" class="breakdown-list">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- Day of Week Analysis -->
      <section class="card">
        <h3 class="card-title">æ›œæ—¥åˆ¥å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³</h3>
        <div class="chart-container">
          <canvas id="dayOfWeekChart"></canvas>
        </div>
      </section>

      <!-- Study Type Analysis -->
      <section class="card">
        <h3 class="card-title">å­¦ç¿’ã‚¿ã‚¤ãƒ—åˆ¥å‰²åˆ</h3>
        <div id="studyTypeBreakdown" class="breakdown-list">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- Mood Analysis -->
      <section class="card">
        <h3 class="card-title">æ‰‹å¿œãˆåˆ†æ</h3>
        <div id="moodAnalysis" class="mood-grid">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- All Study Records -->
      <section class="card">
        <h3 class="card-title">å…¨å­¦ç¿’è¨˜éŒ²</h3>
        <div class="filter-row">
          <select class="form-input form-select filter-select" id="studyFilterSubject" onchange="filterStudyRecords()">
            <option value="">å…¨ç§‘ç›®</option>
          </select>
          <select class="form-input form-select filter-select" id="studyFilterPeriod" onchange="filterStudyRecords()">
            <option value="all">å…¨æœŸé–“</option>
            <option value="7">éå»7æ—¥</option>
            <option value="30">éå»30æ—¥</option>
            <option value="90">éå»90æ—¥</option>
          </select>
        </div>
        <div class="records-list full-height" id="allStudyRecords">
          <div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </section>
    </div><!-- End Study Tab -->

    <!-- ==================== Redbook Analysis Tab ==================== -->
    <div class="tab-content" id="tab-redbook">
      <section class="analysis-header">
        <h2 class="analysis-title">ğŸ“• éå»å•åˆ†æ</h2>
        <p class="analysis-subtitle">èµ¤æœ¬ãƒ»æ¨¡è©¦ã®æ¼”ç¿’ãƒ‡ãƒ¼ã‚¿åˆ†æ</p>
      </section>

      <!-- Redbook Stats -->
      <section class="stats-row four-cols">
        <div class="stat-item">
          <div class="stat-value" id="redbookTotalCount">0</div>
          <div class="stat-label">æ¼”ç¿’å›æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="redbookAvgScore">0%</div>
          <div class="stat-label">å¹³å‡å¾—ç‚¹ç‡</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="redbookHighScore">0%</div>
          <div class="stat-label">æœ€é«˜å¾—ç‚¹</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="redbookTrend">â€•</div>
          <div class="stat-label">å‚¾å‘</div>
        </div>
      </section>

      <!-- Score Trend Chart -->
      <section class="card">
        <h3 class="card-title">å¾—ç‚¹ç‡æ¨ç§»</h3>
        <div class="filter-row">
          <select class="form-input form-select filter-select" id="scoreTrendSubject" onchange="updateScoreTrendChart()">
            <option value="">å…¨ç§‘ç›®</option>
          </select>
        </div>
        <div class="chart-container">
          <canvas id="scoreTrendChart"></canvas>
        </div>
      </section>

      <!-- Subject Scores -->
      <section class="card">
        <h3 class="card-title">ç§‘ç›®åˆ¥å¹³å‡å¾—ç‚¹ç‡</h3>
        <div id="subjectScores" class="breakdown-list">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- University Scores -->
      <section class="card">
        <h3 class="card-title">å¤§å­¦åˆ¥å¹³å‡å¾—ç‚¹ç‡</h3>
        <div id="universityScores" class="breakdown-list">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- Weak Areas -->
      <section class="card">
        <h3 class="card-title">âš ï¸ é »å‡ºã®è‹¦æ‰‹åˆ†é‡</h3>
        <div id="weakAreasList" class="weak-areas-list">
          <!-- Rendered by JS -->
        </div>
      </section>

      <!-- All Redbook Records -->
      <section class="card">
        <h3 class="card-title">å…¨æ¼”ç¿’è¨˜éŒ²</h3>
        <div class="filter-row">
          <select class="form-input form-select filter-select" id="redbookFilterSubject" onchange="filterRedbookRecords()">
            <option value="">å…¨ç§‘ç›®</option>
          </select>
          <select class="form-input form-select filter-select" id="redbookFilterUniv" onchange="filterRedbookRecords()">
            <option value="">å…¨å¤§å­¦</option>
          </select>
        </div>
        <div class="records-list full-height" id="allRedbookRecords">
          <div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </section>
    </div><!-- End Redbook Tab -->
  </main>

  <!-- Study Log Modal -->
  <div class="modal-overlay" id="studyModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">å­¦ç¿’è¨˜éŒ²ã‚’è¿½åŠ </h2>
        <button class="modal-close" onclick="closeStudyModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label required">æ—¥ä»˜</label>
          <input type="date" class="form-input" id="studyDate">
        </div>
        <div class="form-group">
          <label class="form-label required">ç§‘ç›®</label>
          <div class="btn-group" id="subjectButtons">
            <button class="btn-option" data-value="ç¾ä»£æ–‡">ç¾ä»£æ–‡</button>
            <button class="btn-option" data-value="å¤æ–‡">å¤æ–‡</button>
            <button class="btn-option" data-value="æ¼¢æ–‡">æ¼¢æ–‡</button>
            <button class="btn-option" data-value="æ•°å­¦1A">æ•°å­¦1A</button>
            <button class="btn-option" data-value="æ•°å­¦2B">æ•°å­¦2B</button>
            <button class="btn-option" data-value="å˜èª">å˜èª</button>
            <button class="btn-option" data-value="æ–‡æ³•">æ–‡æ³•</button>
            <button class="btn-option" data-value="é•·æ–‡">é•·æ–‡</button>
            <button class="btn-option" data-value="éŸ³èª­">éŸ³èª­</button>
            <button class="btn-option" data-value="ãƒªã‚¹ãƒ‹ãƒ³ã‚°">ãƒªã‚¹ãƒ‹ãƒ³ã‚°</button>
            <button class="btn-option" data-value="ãã®ä»–">ãã®ä»–</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ¯ å­¦ç¿’ã‚¿ã‚¤ãƒ—</label>
          <div class="btn-group" id="studyTypeButtons">
            <button class="btn-option" data-value="æ–°è¦">æ–°è¦</button>
            <button class="btn-option" data-value="å¾©ç¿’">å¾©ç¿’</button>
            <button class="btn-option" data-value="æ¼”ç¿’">æ¼”ç¿’</button>
            <button class="btn-option" data-value="æš—è¨˜">æš—è¨˜</button>
            <button class="btn-option" data-value="éå»å•">éå»å•</button>
            <button class="btn-option" data-value="æ¨¡è©¦">æ¨¡è©¦</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label required">å­¦ç¿’æ™‚é–“</label>
          <div class="btn-group" id="timeButtons">
            <button class="btn-option" data-value="15">15åˆ†</button>
            <button class="btn-option" data-value="30">30åˆ†</button>
            <button class="btn-option" data-value="45">45åˆ†</button>
            <button class="btn-option" data-value="50">50åˆ†</button>
            <button class="btn-option" data-value="60">1æ™‚é–“</button>
            <button class="btn-option" data-value="90">1.5æ™‚é–“</button>
            <button class="btn-option" data-value="120">2æ™‚é–“</button>
            <button class="btn-option" data-value="150">2æ™‚é–“è¶…</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">æ‰‹å¿œãˆ</label>
          <div class="mood-group" id="moodButtons">
            <button class="mood-btn" data-value="ğŸ˜«">ğŸ˜«</button>
            <button class="mood-btn" data-value="ğŸ˜•">ğŸ˜•</button>
            <button class="mood-btn" data-value="ğŸ˜">ğŸ˜</button>
            <button class="mood-btn" data-value="ğŸ™‚">ğŸ™‚</button>
            <button class="mood-btn" data-value="ğŸ˜Š">ğŸ˜Š</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ“š å˜å…ƒãƒ»ç« ï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="studyUnit" placeholder="ä¾‹: ç¬¬3ç«  äºŒæ¬¡é–¢æ•°ã€Unit15-16">
        </div>
        <div class="form-group">
          <label class="form-label">å‚è€ƒæ›¸åï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="studyTextbook" placeholder="ä¾‹: é€Ÿèª­è‹±å˜èª">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <textarea class="form-input form-textarea" id="studyMemo" placeholder="å­¦ç¿’å†…å®¹ã‚„æ°—ã¥ããªã©"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeStudyModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="submitStudyLog()">è¨˜éŒ²ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Redbook Modal -->
  <div class="modal-overlay" id="redbookModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">èµ¤æœ¬è¨˜éŒ²ã‚’è¿½åŠ </h2>
        <button class="modal-close" onclick="closeRedbookModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label required">æ—¥ä»˜</label>
          <input type="date" class="form-input" id="redbookDate">
        </div>
        <div class="form-group">
          <label class="form-label required">å¤§å­¦å</label>
          <select class="form-input form-select" id="redbookUniversity" onchange="toggleCustomUniversity()">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="ç«‹æ•™å¤§å­¦">ç«‹æ•™å¤§å­¦</option>
            <option value="é’å±±å­¦é™¢å¤§å­¦">é’å±±å­¦é™¢å¤§å­¦</option>
            <option value="æ³•æ”¿å¤§å­¦">æ³•æ”¿å¤§å­¦</option>
            <option value="ä¸­å¤®å¤§å­¦">ä¸­å¤®å¤§å­¦</option>
            <option value="æ˜æ²»å­¦é™¢å¤§å­¦">æ˜æ²»å­¦é™¢å¤§å­¦</option>
            <option value="æˆåŸå¤§å­¦">æˆåŸå¤§å­¦</option>
            <option value="æ±æ´‹å¤§å­¦">æ±æ´‹å¤§å­¦</option>
            <option value="é§’æ¾¤å¤§å­¦">é§’æ¾¤å¤§å­¦</option>
            <option value="æ—¥æœ¬å¤§å­¦">æ—¥æœ¬å¤§å­¦</option>
            <option value="å°‚ä¿®å¤§å­¦">å°‚ä¿®å¤§å­¦</option>
            <option value="å…±é€šãƒ†ã‚¹ãƒˆ">å…±é€šãƒ†ã‚¹ãƒˆ</option>
            <option value="__custom__">ãã®ä»–ï¼ˆå…¥åŠ›ã™ã‚‹ï¼‰</option>
          </select>
          <div class="custom-input-wrapper" id="customUniversityWrapper">
            <input type="text" class="form-input" id="customUniversity" placeholder="å¤§å­¦åã‚’å…¥åŠ›">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label required">ç§‘ç›®</label>
          <select class="form-input form-select" id="redbookSubject">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <optgroup label="è‹±èª">
              <option value="è‹±èªR">è‹±èªRï¼ˆãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰</option>
              <option value="è‹±èªL">è‹±èªLï¼ˆãƒªã‚¹ãƒ‹ãƒ³ã‚°ï¼‰</option>
              <option value="è‹±èª">è‹±èªï¼ˆç·åˆï¼‰</option>
            </optgroup>
            <optgroup label="å›½èª">
              <option value="ç¾ä»£æ–‡">ç¾ä»£æ–‡</option>
              <option value="å¤æ–‡">å¤æ–‡</option>
              <option value="æ¼¢æ–‡">æ¼¢æ–‡</option>
              <option value="å›½èª">å›½èªï¼ˆç·åˆï¼‰</option>
            </optgroup>
            <optgroup label="æ•°å­¦">
              <option value="æ•°å­¦IA">æ•°å­¦IA</option>
              <option value="æ•°å­¦IIB">æ•°å­¦IIB</option>
              <option value="æ•°å­¦IIIC">æ•°å­¦IIIC</option>
              <option value="æ•°å­¦">æ•°å­¦ï¼ˆç·åˆï¼‰</option>
            </optgroup>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label required">å¹´åº¦</label>
          <select class="form-input form-select" id="redbookYear">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="2025">2025å¹´</option>
            <option value="2024">2024å¹´</option>
            <option value="2023">2023å¹´</option>
            <option value="2022">2022å¹´</option>
            <option value="2021">2021å¹´</option>
            <option value="2020">2020å¹´</option>
            <option value="2019">2019å¹´</option>
            <option value="2018">2018å¹´</option>
            <option value="2017">2017å¹´</option>
            <option value="2016">2016å¹´</option>
            <option value="2015">2015å¹´</option>
            <option value="2014ä»¥å‰">2014å¹´ä»¥å‰</option>
            <option value="ã‚ªãƒªã‚¸ãƒŠãƒ«">ã‚ªãƒªã‚¸ãƒŠãƒ«å•é¡Œ</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label required">å¾—ç‚¹</label>
          <div class="score-input-container">
            <div class="score-row score-total">
              <span class="score-label">ç·åˆ</span>
              <div class="score-inputs">
                <input type="number" class="form-input score-box" id="totalScoreGot" readonly placeholder="0">
                <span class="score-divider">/</span>
                <input type="number" class="form-input score-box" id="totalScoreMax" readonly placeholder="0">
                <span class="score-percent" id="totalScorePercent">ï¼ˆ0%ï¼‰</span>
              </div>
            </div>
            <div id="sectionScoresContainer">
              <div class="score-row" data-section="1">
                <input type="text" class="form-input section-name" value="å¤§å•1" placeholder="å¤§å•1">
                <div class="score-inputs">
                  <input type="number" class="form-input score-box section-got" min="0" placeholder="0" oninput="calculateTotalScore()">
                  <span class="score-divider">/</span>
                  <input type="number" class="form-input score-box section-max" min="0" placeholder="0" oninput="calculateTotalScore()">
                </div>
              </div>
              <div class="score-row" data-section="2">
                <input type="text" class="form-input section-name" value="å¤§å•2" placeholder="å¤§å•2">
                <div class="score-inputs">
                  <input type="number" class="form-input score-box section-got" min="0" placeholder="0" oninput="calculateTotalScore()">
                  <span class="score-divider">/</span>
                  <input type="number" class="form-input score-box section-max" min="0" placeholder="0" oninput="calculateTotalScore()">
                </div>
              </div>
            </div>
            <div class="score-buttons">
              <button type="button" class="btn btn-sm btn-outline" onclick="removeSection()">âˆ’</button>
              <button type="button" class="btn btn-sm btn-outline" onclick="addSection()">ï¼‹</button>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">â±ï¸ è§£ç­”æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
          <div class="time-input-toggle">
            <button type="button" class="time-toggle-btn active" onclick="toggleTimeInputMode('total')">ç·åˆã®ã¿</button>
            <button type="button" class="time-toggle-btn" onclick="toggleTimeInputMode('section')">å¤§å•ã”ã¨</button>
          </div>
          <div id="totalTimeInput">
            <input type="number" class="form-input" id="redbookTime" min="0" placeholder="ä¾‹: 80">
          </div>
          <div id="sectionTimeInput" style="display: none;">
            <div class="score-input-container" style="padding: 0.75rem;">
              <div class="score-row" style="margin-bottom: 0.5rem;">
                <span class="score-label" style="font-weight: 600;">ç·åˆ</span>
                <div class="score-inputs">
                  <input type="number" class="form-input score-box" id="totalTimeCalc" readonly placeholder="0">
                  <span style="color: var(--gray-500); font-size: 0.875rem;">åˆ†ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</span>
                </div>
              </div>
              <div id="sectionTimesContainer">
                <!-- Generated by JS based on score sections -->
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ“‹ é–“é•ãˆãŸåˆ†é‡ï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="redbookWeakAreas" placeholder="ä¾‹: é–¢ä¿‚è©ã€é•·æ–‡èª­è§£ã€ç¢ºç‡">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <textarea class="form-input form-textarea" id="redbookMemo" placeholder="åçœç‚¹ã‚„æ¬¡å›ã®èª²é¡Œãªã©"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeRedbookModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="submitRedbookLog()">è¨˜éŒ²ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- AI Modal -->
  <div class="modal-overlay" id="aiModal">
    <div class="modal" style="max-width: 520px;">
      <div class="modal-header">
        <h2 class="modal-title">AIã«ç›¸è«‡</h2>
        <button class="modal-close" onclick="closeAIModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <p class="ai-question">ä½•ã«ã¤ã„ã¦ç›¸è«‡ã—ã¾ã™ã‹ï¼Ÿ</p>
        
        <!-- ãƒ¡ã‚¤ãƒ³ã®4ã¤ -->
        <div class="ai-main-options" id="aiMainOptions">
          <div class="ai-card active" data-type="weekly">
            <div class="ai-card-icon">ğŸ“…</div>
            <div class="ai-card-content">
              <div class="ai-card-title">æ¥é€±ã®è¨ˆç”»ã‚’ç«‹ã¦ãŸã„</div>
              <div class="ai-card-desc">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«æœ€é©ãªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ææ¡ˆ</div>
            </div>
          </div>
          <div class="ai-card" data-type="weakness">
            <div class="ai-card-icon">ğŸ¯</div>
            <div class="ai-card-content">
              <div class="ai-card-title">è‹¦æ‰‹ã‚’å…‹æœã—ãŸã„</div>
              <div class="ai-card-desc">å¼±ç‚¹åˆ†æã¨å…·ä½“çš„ãªå¯¾ç­–æ–¹æ³•</div>
            </div>
          </div>
          <div class="ai-card" data-type="redbook">
            <div class="ai-card-icon">ğŸ“•</div>
            <div class="ai-card-content">
              <div class="ai-card-title">éå»å•ã®æˆ¦ç•¥ã‚’ç«‹ã¦ãŸã„</div>
              <div class="ai-card-desc">æ¼”ç¿’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æœ€é©ãªéå»å•æ´»ç”¨æ³•ã‚’ææ¡ˆ</div>
            </div>
          </div>
          <div class="ai-card" data-type="motivation">
            <div class="ai-card-icon">ğŸ’ª</div>
            <div class="ai-card-content">
              <div class="ai-card-title">ã‚„ã‚‹æ°—ã‚’å‡ºã—ãŸã„</div>
              <div class="ai-card-desc">åŠªåŠ›ã‚’èªã‚ã¦åŠ±ã¾ã—ã¦ã‚‚ã‚‰ã†</div>
            </div>
          </div>
        </div>
        
        <!-- ãã®ä»–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
        <div class="ai-more-toggle" onclick="toggleMoreOptions()">
          <span id="moreToggleText">ãã®ä»–ã®ç›¸è«‡ â–¼</span>
        </div>
        <div class="ai-more-options" id="aiMoreOptions" style="display: none;">
          <div class="ai-option-small" data-type="daily">
            <span class="ai-option-small-icon">ğŸ“</span>
            <span>ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Š</span>
          </div>
          <div class="ai-option-small" data-type="section">
            <span class="ai-option-small-icon">ğŸ§©</span>
            <span>å¤§å•åˆ¥æ”»ç•¥</span>
          </div>
          <div class="ai-option-small" data-type="university">
            <span class="ai-option-small-icon">ğŸ«</span>
            <span>å¤§å­¦åˆ¥å¯¾ç­–</span>
          </div>
          <div class="ai-option-small" data-type="efficiency">
            <span class="ai-option-small-icon">â±ï¸</span>
            <span>æ™‚é–“åŠ¹ç‡åˆ†æ</span>
          </div>
          <div class="ai-option-small" data-type="prediction">
            <span class="ai-option-small-icon">ğŸ“Š</span>
            <span>å¾—ç‚¹äºˆæ¸¬</span>
          </div>
          <div class="ai-option-small" data-type="subject">
            <span class="ai-option-small-icon">ğŸ“š</span>
            <span>ç§‘ç›®åˆ¥ç›¸è«‡</span>
          </div>
          <div class="ai-option-small" data-type="lastspurt">
            <span class="ai-option-small-icon">ğŸ”¥</span>
            <span>ç›´å‰æœŸå¯¾ç­–</span>
          </div>
        </div>
        
        <!-- ç§‘ç›®é¸æŠï¼ˆç§‘ç›®åˆ¥ç›¸è«‡æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
        <div class="form-group" id="subjectSelectGroup" style="display: none;">
          <label class="form-label">ç›¸è«‡ã—ãŸã„ç§‘ç›®</label>
          <select class="form-select" id="aiSubjectSelect" onchange="generatePrompt()">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="è‹±èª">è‹±èª</option>
            <option value="æ•°å­¦">æ•°å­¦</option>
            <option value="å›½èª">å›½èª</option>
          </select>
        </div>
        
        <!-- å¤§å­¦é¸æŠï¼ˆå¤§å­¦åˆ¥å¯¾ç­–æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
        <div class="form-group" id="universitySelectGroup" style="display: none;">
          <label class="form-label">å¯¾ç­–ã—ãŸã„å¤§å­¦</label>
          <select class="form-select" id="aiUniversitySelect" onchange="generatePrompt()">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <!-- éå»å•ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‹•çš„ã«ç”Ÿæˆ -->
          </select>
        </div>
        
        <label class="form-label">ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
        <div class="prompt-preview" id="promptPreview">ç”Ÿæˆä¸­...</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeAIModal()">é–‰ã˜ã‚‹</button>
        <button class="btn btn-primary" onclick="copyPrompt()">ã‚³ãƒ”ãƒ¼ã—ã¦AIã¸</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">è¨­å®š</h2>
        <button class="modal-close" onclick="closeSettingsModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Apps Script URL</label>
          <input type="text" class="form-input" id="settingsApiUrl" placeholder="https://script.google.com/...">
        </div>
        <div class="form-group">
          <label class="form-label">é€±é–“ç›®æ¨™ï¼ˆåˆ†ï¼‰</label>
          <input type="number" class="form-input" id="settingsWeeklyGoal" value="1800" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">å…±é€šãƒ†ã‚¹ãƒˆæ—¥</label>
          <input type="date" class="form-input" id="settingsExamDate">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒãƒ£ãƒƒãƒˆURLï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="settingsChatUrl" placeholder="https://script.google.com/...">
          <p style="font-size: 0.75rem; color: var(--gray-400); margin-top: 0.25rem;">
            ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã—ã¾ã™
          </p>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
          <label class="form-label">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</label>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn btn-outline" onclick="openDataManager('study')" style="flex: 1; min-width: 120px;">
              ğŸ“– å­¦ç¿’è¨˜éŒ²
            </button>
            <button class="btn btn-outline" onclick="openDataManager('redbook')" style="flex: 1; min-width: 120px;">
              ğŸ“• éå»å•è¨˜éŒ²
            </button>
          </div>
          <p style="font-size: 0.75rem; color: var(--gray-400); margin-top: 0.5rem;">
            è¨˜éŒ²ã®ç¢ºèªãƒ»å‰Šé™¤ãŒã§ãã¾ã™
          </p>
        </div>
        
        <div class="version-info">
          <span id="appVersionDisplay">v1.7.7</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeSettingsModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="dataManagerModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title" id="dataManagerTitle">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
        <button class="modal-close" onclick="closeDataManager()">Ã—</button>
      </div>
      <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
        <div id="dataManagerContent">
          <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeDataManager()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay chat-modal" id="chatModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h2>
        <button class="modal-close" onclick="closeChat()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="chat-container">
          <div class="chat-messages" id="chatMessages">
            <div class="chat-empty">
              <div class="chat-empty-icon">ğŸ’¬</div>
              ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“
            </div>
          </div>
          <div class="chat-input-area">
            <textarea class="chat-input" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." rows="1" onkeydown="handleChatKeydown(event)"></textarea>
            <button class="chat-send-btn" onclick="sendChatMessage()" id="chatSendBtn">â¤</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç† & ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
    // ==========================================
    const APP_VERSION = '1.8.2';
    const DEFAULT_API_URL = 'https://script.google.com/macros/s/AKfycbygSI6dft0E2d_D0isU4lAlWuuQgWRMlizHOdMTDqt8w1Igpud6nvpvN1Gy1t2AyLGpBw/exec';
    const DEFAULT_CHAT_URL = 'https://script.google.com/macros/s/AKfycbxppU_VWeV9IwVl-5tY7o0vuMCqRURoH0fltq_mo7JSegCv5VI-X1QjG7khcATLlj7vGQ/exec';
    
    // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚åˆ»ã§æ—¥ä»˜æ–‡å­—åˆ—ã‚’ä½œæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œã‚’å›é¿ï¼‰
    function formatDateLocal(date) {
      const d = date instanceof Date ? date : new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    function getTodayStr() {
      return formatDateLocal(new Date());
    }
    
    (function checkVersion() {
      const storedVersion = localStorage.getItem('appVersion');
      
      if (storedVersion !== APP_VERSION) {
        console.log(`App updated: ${storedVersion || 'none'} â†’ ${APP_VERSION}`);
        
        // URLã‚’æœ€æ–°ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æ›´æ–°
        localStorage.setItem('apiUrl', DEFAULT_API_URL);
        localStorage.setItem('chatUrl', DEFAULT_CHAT_URL);
        
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿å­˜
        localStorage.setItem('appVersion', APP_VERSION);
        
        // æ›´æ–°é€šçŸ¥ï¼ˆåˆå›ä»¥å¤–ï¼‰
        if (storedVersion) {
          setTimeout(() => {
            showToast(`ã‚¢ãƒ—ãƒªãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ (v${APP_VERSION})`, 'success');
          }, 1000);
        }
      }
    })();
    
    // ==========================================
    // ãƒ¡ã‚¤ãƒ³
    // ==========================================
    let API_URL = localStorage.getItem('apiUrl') || DEFAULT_API_URL;
    let CHAT_URL = localStorage.getItem('chatUrl') || DEFAULT_CHAT_URL;
    let appData = {
      studyLogs: [],
      redbookLogs: [],
      goals: [],
      profile: {},
      settings: { weeklyGoalMinutes: 1800 }
    };
    
    let selectedSubject = '';
    let selectedTime = 0;
    let selectedMood = '';
    let selectedStudyType = '';
    let selectedAIType = 'weekly';
    
    let dailyChart = null;
    let subjectChart = null;
    let dayOfWeekChart = null;
    let scoreTrendChart = null;
    let timeInputMode = 'total';
    
    document.addEventListener('DOMContentLoaded', () => {
      initializeDateInputs();
      initializeButtonGroups();
      initializeAIOptions();
      loadSettingsFromStorage();
      initChat(); // ãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–
      
      if (API_URL) {
        refreshData();
        loadCheerMessages(); // å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿
      } else {
        hideLoading();
      }
    });
    
    // ==========================================
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    // ==========================================
    function switchTab(tabName) {
      // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      
      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabName}`);
      });
      
      // åˆ†æã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆãŸæ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      if (tabName === 'study') {
        renderStudyAnalysis();
      } else if (tabName === 'redbook') {
        renderRedbookAnalysis();
      }
    }
    
    // ==========================================
    // æ™‚é–“å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    // ==========================================
    function toggleTimeInputMode(mode) {
      timeInputMode = mode;
      
      document.querySelectorAll('.time-toggle-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      if (mode === 'total') {
        document.getElementById('totalTimeInput').style.display = 'block';
        document.getElementById('sectionTimeInput').style.display = 'none';
      } else {
        document.getElementById('totalTimeInput').style.display = 'none';
        document.getElementById('sectionTimeInput').style.display = 'block';
        syncSectionTimesWithScores();
      }
    }
    
    function syncSectionTimesWithScores() {
      const scoreContainer = document.getElementById('sectionScoresContainer');
      const timeContainer = document.getElementById('sectionTimesContainer');
      const scoreRows = scoreContainer.querySelectorAll('.score-row');
      
      timeContainer.innerHTML = '';
      
      scoreRows.forEach((row, index) => {
        const sectionName = row.querySelector('.section-name').value || `å¤§å•${index + 1}`;
        const timeRow = document.createElement('div');
        timeRow.className = 'score-row';
        timeRow.style.marginBottom = '0.5rem';
        timeRow.innerHTML = `
          <span class="score-label">${sectionName}</span>
          <div class="score-inputs">
            <input type="number" class="form-input section-time-input" min="0" placeholder="0" oninput="calculateTotalTime()">
            <span style="color: var(--gray-500); font-size: 0.875rem;">åˆ†</span>
          </div>
        `;
        timeContainer.appendChild(timeRow);
      });
    }
    
    function calculateTotalTime() {
      const timeInputs = document.querySelectorAll('#sectionTimesContainer .section-time-input');
      let total = 0;
      timeInputs.forEach(input => {
        total += parseInt(input.value) || 0;
      });
      document.getElementById('totalTimeCalc').value = total;
    }
    
    function initializeDateInputs() {
      const today = getTodayStr();
      document.getElementById('studyDate').value = today;
      document.getElementById('redbookDate').value = today;
    }
    
    function initializeButtonGroups() {
      document.querySelectorAll('#subjectButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#subjectButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedSubject = btn.dataset.value;
        });
      });
      
      document.querySelectorAll('#timeButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#timeButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedTime = parseInt(btn.dataset.value);
        });
      });
      
      document.querySelectorAll('#moodButtons .mood-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#moodButtons .mood-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedMood = btn.dataset.value;
        });
      });
      
      document.querySelectorAll('#studyTypeButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#studyTypeButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedStudyType = btn.dataset.value;
        });
      });
    }
    
    function initializeAIOptions() {
      // ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      document.querySelectorAll('.ai-card').forEach(card => {
        card.addEventListener('click', () => {
          selectAIOption(card);
        });
      });
      
      // ãã®ä»–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      document.querySelectorAll('.ai-option-small').forEach(option => {
        option.addEventListener('click', () => {
          selectAIOption(option);
        });
      });
    }
    
    function selectAIOption(element) {
      // ã™ã¹ã¦ã®é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
      document.querySelectorAll('.ai-card').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.ai-option-small').forEach(o => o.classList.remove('active'));
      
      // é¸æŠçŠ¶æ…‹ã‚’è¨­å®š
      element.classList.add('active');
      selectedAIType = element.dataset.type;
      
      // ç§‘ç›®åˆ¥ç›¸è«‡ã®å ´åˆã®ã¿ç§‘ç›®é¸æŠã‚’è¡¨ç¤º
      const subjectSelectGroup = document.getElementById('subjectSelectGroup');
      const universitySelectGroup = document.getElementById('universitySelectGroup');
      
      subjectSelectGroup.style.display = selectedAIType === 'subject' ? 'block' : 'none';
      universitySelectGroup.style.display = selectedAIType === 'university' ? 'block' : 'none';
      
      // å¤§å­¦é¸æŠæ™‚ã¯é¸æŠè‚¢ã‚’å‹•çš„ã«ç”Ÿæˆ
      if (selectedAIType === 'university') {
        populateUniversitySelect();
      }
      
      generatePrompt();
    }
    
    function toggleMoreOptions() {
      const moreOptions = document.getElementById('aiMoreOptions');
      const toggleText = document.getElementById('moreToggleText');
      
      if (moreOptions.style.display === 'none') {
        moreOptions.style.display = 'flex';
        toggleText.textContent = 'ãã®ä»–ã®ç›¸è«‡ â–²';
      } else {
        moreOptions.style.display = 'none';
        toggleText.textContent = 'ãã®ä»–ã®ç›¸è«‡ â–¼';
      }
    }
    
    function populateUniversitySelect() {
      const select = document.getElementById('aiUniversitySelect');
      const redbookLogs = appData.redbookLogs || [];
      
      // éå»å•ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¤§å­¦ä¸€è¦§ã‚’å–å¾—
      const universities = [...new Set(redbookLogs.map(l => l.university))].filter(Boolean);
      
      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      universities.forEach(uni => {
        const option = document.createElement('option');
        option.value = uni;
        option.textContent = uni;
        select.appendChild(option);
      });
      
      if (universities.length === 0) {
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "ï¼ˆéå»å•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰";
        select.appendChild(option);
      }
    }
    
    function loadSettingsFromStorage() {
      const apiUrl = localStorage.getItem('apiUrl');
      const weeklyGoal = localStorage.getItem('weeklyGoal');
      const examDate = localStorage.getItem('examDate');
      
      if (apiUrl) {
        API_URL = apiUrl;
        document.getElementById('settingsApiUrl').value = apiUrl;
      }
      if (weeklyGoal) {
        appData.settings.weeklyGoalMinutes = parseInt(weeklyGoal);
        document.getElementById('settingsWeeklyGoal').value = weeklyGoal;
      }
      if (examDate) {
        document.getElementById('settingsExamDate').value = examDate;
      }
    }
    
    async function fetchData() {
      if (!API_URL) throw new Error('API URL not set');
      
      console.log('Fetching from:', API_URL);
      
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonpCallback_' + Date.now();
        const script = document.createElement('script');
        
        window[callbackName] = (data) => {
          console.log('JSONP callback received:', data);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          resolve(data);
        };
        
        const fullUrl = `${API_URL}?action=getData&callback=${callbackName}`;
        console.log('Full URL:', fullUrl);
        script.src = fullUrl;
        
        script.onerror = (e) => {
          console.error('Script load error:', e);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          reject(new Error('ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€‚Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'));
        };
        
        document.body.appendChild(script);
        
        setTimeout(() => {
          if (window[callbackName]) {
            console.error('JSONP timeout - callback not called');
            delete window[callbackName];
            if (script.parentNode) script.parentNode.removeChild(script);
            reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€‚Apps ScriptãŒæ­£ã—ãå¿œç­”ã—ã¦ã„ã¾ã›ã‚“ã€‚'));
          }
        }, 15000);
      });
    }
    
    async function postData(data) {
      if (!API_URL) throw new Error('API URL not set');
      
      console.log('Posting data:', data);
      
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonpPostCallback_' + Date.now();
        const script = document.createElement('script');
        
        window[callbackName] = (response) => {
          console.log('POST callback received:', response);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          if (response.error) {
            reject(new Error(response.error));
          } else {
            resolve(response);
          }
        };
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
        const params = new URLSearchParams();
        params.append('action', data.action);
        params.append('data', JSON.stringify(data));
        params.append('callback', callbackName);
        
        const fullUrl = `${API_URL}?${params.toString()}`;
        console.log('POST URL:', fullUrl);
        script.src = fullUrl;
        
        script.onerror = (e) => {
          console.error('POST script error:', e);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          reject(new Error('ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚¨ãƒ©ãƒ¼'));
        };
        
        document.body.appendChild(script);
        
        setTimeout(() => {
          if (window[callbackName]) {
            delete window[callbackName];
            if (script.parentNode) script.parentNode.removeChild(script);
            reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
          }
        }, 15000);
      });
    }
    
    async function refreshData() {
      showLoading();
      try {
        const data = await fetchData();
        if (data.error) throw new Error(data.error);
        appData = data;
        renderDashboard();
        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('Error:', error);
        showToast(error.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    function renderDashboard() {
      renderCheerBanner();
      renderCountdown();
      renderStats();
      renderProgress();
      renderCharts();
      renderGoals();
      renderStudyRecords();
      renderRedbookRecords();
    }
    
    // ==========================================
    // å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    // ==========================================
    let cheerMessages = [];
    let cheerDismissed = {};
    
    async function loadCheerMessages() {
      try {
        const response = await fetch(`${API_URL}?action=getActiveCheerMessages&callback=?`);
        const text = await response.text();
        const json = text.replace(/^\?\(/, '').replace(/\);?$/, '');
        const data = JSON.parse(json);
        
        if (data.messages) {
          cheerMessages = data.messages;
          // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰éè¡¨ç¤ºæ¸ˆã¿ã‚’å–å¾—
          const dismissed = localStorage.getItem('cheerDismissed');
          if (dismissed) {
            cheerDismissed = JSON.parse(dismissed);
          }
          renderCheerBanner();
        }
      } catch (error) {
        console.log('Cheer messages not available');
      }
    }
    
    function renderCheerBanner() {
      const container = document.getElementById('cheerBanner');
      if (!container) return;
      
      // è¡¨ç¤ºå¯èƒ½ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ•ã‚£ãƒ«ã‚¿
      const now = new Date();
      const activeMessages = cheerMessages.filter(msg => {
        // éè¡¨ç¤ºæ¸ˆã¿ãƒã‚§ãƒƒã‚¯
        if (cheerDismissed[msg.id]) return false;
        
        const start = new Date(msg.startTime);
        const end = new Date(msg.endTime);
        return now >= start && now <= end;
      });
      
      if (activeMessages.length === 0) {
        container.style.display = 'none';
        return;
      }
      
      // ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸æŠï¼ˆã¾ãŸã¯æœ€æ–°ã®ã‚‚ã®ï¼‰
      const msg = activeMessages[0];
      
      container.style.display = 'block';
      container.innerHTML = `
        <div class="cheer-banner">
          <button class="cheer-banner-close" onclick="dismissCheer('${msg.id}')" title="é–‰ã˜ã‚‹">Ã—</button>
          <div class="cheer-banner-content">
            <span class="cheer-banner-icon">ğŸ“£</span>
            <div class="cheer-banner-text">
              <div class="cheer-banner-message">${escapeHtml(msg.message)}</div>
            </div>
          </div>
        </div>
      `;
    }
    
    function dismissCheer(id) {
      cheerDismissed[id] = true;
      localStorage.setItem('cheerDismissed', JSON.stringify(cheerDismissed));
      renderCheerBanner();
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/\n/g, '<br>');
    }
    
    function renderCountdown() {
      const examDate = localStorage.getItem('examDate') || '2026-01-17';
      const mainExam = new Date(examDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const daysUntil = Math.ceil((mainExam - today) / (1000 * 60 * 60 * 24));
      document.getElementById('mainCountdown').textContent = Math.max(0, daysUntil);
    }
    
    function renderStats() {
      const logs = appData.studyLogs || [];
      const redbookLogs = appData.redbookLogs || [];
      const today = getTodayStr();
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      const monthAgo = new Date();
      monthAgo.setDate(monthAgo.getDate() - 30);
      
      // å­¦ç¿’è¨˜éŒ²ã®æ™‚é–“
      const studyTodayMinutes = logs
        .filter(log => log.date === today)
        .reduce((sum, log) => sum + (log.minutes || 0), 0);
      
      // èµ¤æœ¬è¨˜éŒ²ã®æ™‚é–“
      const redbookTodayMinutes = redbookLogs
        .filter(log => log.date === today)
        .reduce((sum, log) => sum + (log.time || 0), 0);
      
      const todayMinutes = studyTodayMinutes + redbookTodayMinutes;
      
      // ä»Šæ—¥ã®å­¦ç¿’æ™‚é–“ã‚’æ™‚é–“/åˆ†ã§è¡¨ç¤º
      if (todayMinutes >= 60) {
        const hours = Math.floor(todayMinutes / 60);
        const mins = todayMinutes % 60;
        document.getElementById('todayMinutes').textContent = mins > 0 ? `${hours}æ™‚é–“${mins}åˆ†` : `${hours}æ™‚é–“`;
      } else {
        document.getElementById('todayMinutes').textContent = todayMinutes + 'åˆ†';
      }
      
      // ä»Šæ—¥ã®ç›®æ¨™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ1æ—¥ã®ç›®æ¨™ã‚’é€±é–“ç›®æ¨™Ã·7ã§è¨ˆç®—ï¼‰
      const weeklyGoal = appData.settings?.weeklyGoal || 1800;
      const dailyGoal = Math.round(weeklyGoal / 7);
      const todayGoalStatus = document.getElementById('todayGoalStatus');
      if (todayGoalStatus) {
        if (todayMinutes >= dailyGoal) {
          todayGoalStatus.textContent = 'ğŸ‰ ä»Šæ—¥ã®ç›®æ¨™é”æˆï¼';
          todayGoalStatus.style.color = '#A3BE8C';
        } else {
          const remaining = dailyGoal - todayMinutes;
          todayGoalStatus.textContent = `ç›®æ¨™ã¾ã§ã‚ã¨ ${remaining}åˆ†`;
          todayGoalStatus.style.color = '';
        }
      }
      
      // é€±é–“ã®å­¦ç¿’æ™‚é–“
      const studyWeekMinutes = logs
        .filter(log => new Date(log.date) >= weekAgo)
        .reduce((sum, log) => sum + (log.minutes || 0), 0);
      
      const redbookWeekMinutes = redbookLogs
        .filter(log => new Date(log.date) >= weekAgo)
        .reduce((sum, log) => sum + (log.time || 0), 0);
      
      const weekMinutes = studyWeekMinutes + redbookWeekMinutes;
      const weekHours = Math.round(weekMinutes / 60);
      document.getElementById('weekMinutes').textContent = weekHours + 'h';
      
      // é€£ç¶šæ—¥æ•°ï¼ˆå­¦ç¿’è¨˜éŒ²ã¨èµ¤æœ¬è¨˜éŒ²ã®ä¸¡æ–¹ã‚’è€ƒæ…®ï¼‰
      const allDates = [
        ...logs.map(log => log.date),
        ...redbookLogs.map(log => log.date)
      ];
      const streakDays = calculateStreak({ dates: allDates });
      document.getElementById('streakDays').textContent = streakDays;
      
      // å­¦ç¿’å›æ•°ï¼ˆå­¦ç¿’è¨˜éŒ² + èµ¤æœ¬è¨˜éŒ²ï¼‰
      const monthStudySessions = logs.filter(log => new Date(log.date) >= monthAgo).length;
      const monthRedbookSessions = redbookLogs.filter(log => new Date(log.date) >= monthAgo).length;
      document.getElementById('totalSessions').textContent = monthStudySessions + monthRedbookSessions;
    }
    
    function calculateStreak(input) {
      // é…åˆ—ã¾ãŸã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã«å¯¾å¿œ
      let dates;
      if (Array.isArray(input)) {
        dates = [...new Set(input.map(log => log.date))].sort().reverse();
      } else if (input.dates) {
        dates = [...new Set(input.dates)].filter(Boolean).sort().reverse();
      } else {
        return 0;
      }
      
      if (dates.length === 0) return 0;
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      let streak = 0;
      let currentDate = new Date(today);
      
      const todayStr = formatDateLocal(today);
      if (!dates.includes(todayStr)) {
        currentDate.setDate(currentDate.getDate() - 1);
      }
      
      for (let i = 0; i < 365; i++) {
        const dateStr = formatDateLocal(currentDate);
        if (dates.includes(dateStr)) {
          streak++;
          currentDate.setDate(currentDate.getDate() - 1);
        } else {
          break;
        }
      }
      
      return streak;
    }
    
    function renderProgress() {
      const logs = appData.studyLogs || [];
      const redbookLogs = appData.redbookLogs || [];
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      
      // å­¦ç¿’è¨˜éŒ²ã®é€±é–“æ™‚é–“
      const studyWeekMinutes = logs
        .filter(log => new Date(log.date) >= weekAgo)
        .reduce((sum, log) => sum + (log.minutes || 0), 0);
      
      // èµ¤æœ¬è¨˜éŒ²ã®é€±é–“æ™‚é–“
      const redbookWeekMinutes = redbookLogs
        .filter(log => new Date(log.date) >= weekAgo)
        .reduce((sum, log) => sum + (log.time || 0), 0);
      
      const weekMinutes = studyWeekMinutes + redbookWeekMinutes;
      
      const goal = appData.settings?.weeklyGoalMinutes || 1800;
      const percent = Math.min(100, Math.round((weekMinutes / goal) * 100));
      
      document.getElementById('progressValue').textContent = `${weekMinutes} / ${goal} åˆ†`;
      document.getElementById('progressFill').style.width = `${percent}%`;
      
      // ç›®æ¨™é”æˆæ™‚ã®ãŠç¥ã„è¡¨ç¤º
      const progressSection = document.getElementById('progressSection');
      const celebration = document.getElementById('progressCelebration');
      
      if (percent >= 100) {
        progressSection.classList.add('achieved');
        celebration.innerHTML = `
          <div class="progress-celebration">
            ğŸ‰ é€±é–“ç›®æ¨™é”æˆï¼ãŠã‚ã§ã¨ã†ï¼
          </div>
        `;
      } else if (percent >= 80) {
        progressSection.classList.remove('achieved');
        celebration.innerHTML = `
          <div class="progress-celebration" style="background: #fffbeb; border-color: #fde68a; color: #d97706;">
            ğŸ’ª ã‚ã¨å°‘ã—ï¼æ®‹ã‚Š ${goal - weekMinutes} åˆ†
          </div>
        `;
      } else {
        progressSection.classList.remove('achieved');
        celebration.innerHTML = '';
      }
    }
    
    function renderCharts() {
      renderDailyChart();
      renderSubjectChart();
    }
    
    function renderDailyChart() {
      const ctx = document.getElementById('dailyChart').getContext('2d');
      const logs = appData.studyLogs || [];
      const redbookLogs = appData.redbookLogs || [];
      
      const days = [];
      const subjectData = {};
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = formatDateLocal(date);
        const dayLabel = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
        days.push(dayLabel);
        
        // å­¦ç¿’è¨˜éŒ²
        const dayLogs = logs.filter(log => log.date === dateStr);
        dayLogs.forEach(log => {
          const subject = categorizeSubject(log.subject);
          if (!subjectData[subject]) {
            subjectData[subject] = Array(7).fill(0);
          }
          subjectData[subject][6 - i] += log.minutes || 0;
        });
        
        // èµ¤æœ¬è¨˜éŒ²
        const dayRedbookLogs = redbookLogs.filter(log => log.date === dateStr);
        dayRedbookLogs.forEach(log => {
          if (!subjectData['éå»å•']) {
            subjectData['éå»å•'] = Array(7).fill(0);
          }
          subjectData['éå»å•'][6 - i] += log.time || 0;
        });
      }
      
      // ãƒŸãƒ‹ãƒãƒ«ã§è½ã¡ç€ã„ãŸè¦‹ã‚„ã™ã„ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
      const colors = {
        'è‹±èª': '#5E81AC',    // è½ã¡ç€ã„ãŸãƒ–ãƒ«ãƒ¼
        'æ•°å­¦': '#A3BE8C',    // è½ã¡ç€ã„ãŸã‚°ãƒªãƒ¼ãƒ³
        'å›½èª': '#EBCB8B',    // è½ã¡ç€ã„ãŸã‚¤ã‚¨ãƒ­ãƒ¼
        'ç†ç§‘': '#B48EAD',    // è½ã¡ç€ã„ãŸãƒ‘ãƒ¼ãƒ—ãƒ«
        'ç¤¾ä¼š': '#D08770',    // è½ã¡ç€ã„ãŸã‚ªãƒ¬ãƒ³ã‚¸
        'éå»å•': '#BF616A',  // è½ã¡ç€ã„ãŸãƒ¬ãƒƒãƒ‰
        'ãã®ä»–': '#4C566A'   // ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼
      };
      
      const datasets = Object.entries(subjectData).map(([subject, data]) => ({
        label: subject,
        data: data,
        backgroundColor: colors[subject] || '#d4d4d4',
        borderRadius: 2,
        barThickness: 16
      }));
      
      if (dailyChart) dailyChart.destroy();
      
      dailyChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: days, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
              stacked: true,
              grid: { display: false },
              border: { display: false },
              ticks: { color: '#a3a3a3', font: { size: 11 } }
            },
            y: { 
              stacked: true,
              beginAtZero: true,
              grid: { color: '#f5f5f5' },
              border: { display: false },
              ticks: { color: '#a3a3a3', font: { size: 11 } }
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 8,
                boxHeight: 8,
                padding: 16,
                color: '#525252',
                font: { size: 11 }
              }
            }
          }
        }
      });
    }
    
    function renderSubjectChart() {
      const ctx = document.getElementById('subjectChart').getContext('2d');
      const logs = appData.studyLogs || [];
      const redbookLogs = appData.redbookLogs || [];
      
      const monthAgo = new Date();
      monthAgo.setDate(monthAgo.getDate() - 30);
      
      const subjectMinutes = {};
      
      // å­¦ç¿’è¨˜éŒ²
      logs
        .filter(log => new Date(log.date) >= monthAgo)
        .forEach(log => {
          const subject = log.subject || 'ãã®ä»–';
          subjectMinutes[subject] = (subjectMinutes[subject] || 0) + (log.minutes || 0);
        });
      
      // èµ¤æœ¬è¨˜éŒ²
      const redbookTime = redbookLogs
        .filter(log => new Date(log.date) >= monthAgo)
        .reduce((sum, log) => sum + (log.time || 0), 0);
      
      if (redbookTime > 0) {
        subjectMinutes['éå»å•æ¼”ç¿’'] = redbookTime;
      }
      
      const sortedSubjects = Object.entries(subjectMinutes).sort((a, b) => b[1] - a[1]);
      
      // ç§‘ç›®ã”ã¨ã«å›ºå®šè‰²ã‚’å‰²ã‚Šå½“ã¦
      const subjectColors = {
        'è‹±èª': '#5E81AC',
        'æ•°å­¦': '#A3BE8C',
        'å›½èª': '#EBCB8B',
        'ç†ç§‘': '#B48EAD',
        'ç¤¾ä¼š': '#D08770',
        'éå»å•æ¼”ç¿’': '#BF616A',
        'ãã®ä»–': '#4C566A'
      };
      
      // è‰²ã®é…åˆ—ã‚’ç”Ÿæˆï¼ˆç§‘ç›®ã«å¯¾å¿œã—ãŸè‰²ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ¼é…åˆ—ã‹ã‚‰ï¼‰
      const defaultColors = ['#5E81AC', '#A3BE8C', '#EBCB8B', '#B48EAD', '#D08770', '#BF616A', '#88C0D0', '#81A1C1'];
      const chartColors = sortedSubjects.map((s, i) => subjectColors[s[0]] || defaultColors[i % defaultColors.length]);
      
      if (subjectChart) subjectChart.destroy();
      
      subjectChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: sortedSubjects.map(s => s[0]),
          datasets: [{
            data: sortedSubjects.map(s => s[1]),
            backgroundColor: chartColors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 8,
                boxHeight: 8,
                padding: 12,
                color: '#525252',
                font: { size: 11 }
              }
            }
          },
          cutout: '65%'
        }
      });
    }
    
    function categorizeSubject(subject) {
      // è‹±èªç³»
      const english = ['å˜èª', 'æ–‡æ³•', 'é•·æ–‡', 'éŸ³èª­', 'ãƒªã‚¹ãƒ‹ãƒ³ã‚°', 'è‹±èª', 'è‹±èªR', 'è‹±èªL'];
      // æ•°å­¦ç³»
      const math = ['æ•°å­¦1A', 'æ•°å­¦2B', 'æ•°å­¦', 'æ•°å­¦IA', 'æ•°å­¦IIB', 'æ•°å­¦IIIC'];
      // å›½èªç³»
      const japanese = ['ç¾ä»£æ–‡', 'å¤æ–‡', 'æ¼¢æ–‡', 'å›½èª'];
      // ç†ç§‘ç³»
      const science = ['ç‰©ç†', 'ç‰©ç†åŸºç¤', 'åŒ–å­¦', 'åŒ–å­¦åŸºç¤', 'ç”Ÿç‰©', 'ç”Ÿç‰©åŸºç¤', 'åœ°å­¦', 'åœ°å­¦åŸºç¤'];
      // ç¤¾ä¼šç³»
      const social = ['æ—¥æœ¬å²', 'ä¸–ç•Œå²', 'åœ°ç†', 'æ”¿æ²»çµŒæ¸ˆ', 'å€«ç†', 'å€«ç†æ”¿çµŒ', 'ç¾ä»£ç¤¾ä¼š', 'å…¬å…±'];
      
      if (english.includes(subject)) return 'è‹±èª';
      if (math.includes(subject)) return 'æ•°å­¦';
      if (japanese.includes(subject)) return 'å›½èª';
      if (science.includes(subject)) return 'ç†ç§‘';
      if (social.includes(subject)) return 'ç¤¾ä¼š';
      return 'ãã®ä»–';
    }
    
    function renderGoals() {
      const section = document.getElementById('goalsSection');
      const goals = appData.goals || [];
      
      if (goals.length === 0) {
        section.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ¯</div>
            <div class="empty-state-title">ç›®æ¨™ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
            <div class="empty-state-desc">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œç›®æ¨™ã€ã‚·ãƒ¼ãƒˆã§<br>ç§‘ç›®ã”ã¨ã®ç›®æ¨™ã‚’è¨­å®šã§ãã¾ã™</div>
          </div>
        `;
        return;
      }
      
      const classes = { 'å›½èª': 'kokugo', 'æ•°å­¦': 'sugaku', 'è‹±èª': 'eigo', 'ç†ç§‘': 'rika', 'ç¤¾ä¼š': 'shakai' };
      
      section.innerHTML = goals.map(goal => {
        const progress = Math.min(100, Math.round(((goal.current) / (goal.target)) * 100));
        const cls = classes[goal.subject] || 'kokugo';
        const isAchieved = goal.current >= goal.target;
        
        return `
          <div class="goal-item">
            <div class="goal-header">
              <span class="goal-name">${goal.subject}${isAchieved ? '<span class="goal-achieved">ğŸ† é”æˆï¼</span>' : ''}</span>
              <span class="goal-values">${goal.current}% â†’ ${goal.target}%</span>
            </div>
            <div class="goal-bar">
              <div class="goal-fill ${cls}" style="width: ${progress}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderStudyRecords() {
      const container = document.getElementById('studyRecordsList');
      const logs = (appData.studyLogs || []).slice(0, 8);
      
      if (logs.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“–</div>
            <div class="empty-state-title">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
            <div class="empty-state-desc">å­¦ç¿’ã‚’è¨˜éŒ²ã—ã¦ã€<br>æ¯æ—¥ã®é ‘å¼µã‚Šã‚’è¦‹ãˆã‚‹åŒ–ã—ã‚ˆã†ï¼</div>
            <button class="empty-state-btn" onclick="openStudyModal()">
              ï¼‹ æœ€åˆã®è¨˜éŒ²ã‚’ã¤ã‘ã‚‹
            </button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = logs.map((log, index) => {
        const hasDetails = log.memo || log.textbook || log.unit || log.studyType;
        return `
        <div class="record-item ${hasDetails ? 'has-details' : ''}">
          <div class="record-main">
            <span class="record-date">${formatDateShort(log.date)}</span>
            <span class="record-subject">${log.subject}</span>
            ${log.studyType ? `<span class="record-type">${log.studyType}</span>` : ''}
            <span class="record-time">${log.minutes}åˆ†</span>
            <span class="record-mood">${log.mood || ''}</span>
          </div>
          ${hasDetails ? `
            <div class="record-details">
              ${log.unit ? `<span class="record-unit">ğŸ“– ${log.unit}</span>` : ''}
              ${log.textbook ? `<span class="record-textbook">ğŸ“š ${log.textbook}</span>` : ''}
              ${log.memo ? `<span class="record-memo">ğŸ“ ${log.memo}</span>` : ''}
            </div>
          ` : ''}
        </div>
      `}).join('');
    }
    
    function renderRedbookRecords() {
      const container = document.getElementById('redbookRecordsList');
      const logs = (appData.redbookLogs || []).slice(0, 8);
      
      if (logs.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“•</div>
            <div class="empty-state-title">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
            <div class="empty-state-desc">éå»å•ã‚’è§£ã„ãŸã‚‰è¨˜éŒ²ã—ã¦ã€<br>æˆç¸¾ã®æ¨ç§»ã‚’ç¢ºèªã—ã‚ˆã†ï¼</div>
            <button class="empty-state-btn" onclick="openRedbookModal()">
              ï¼‹ æœ€åˆã®è¨˜éŒ²ã‚’ã¤ã‘ã‚‹
            </button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = logs.map((log, index) => {
        const scoreClass = log.score >= 70 ? 'high' : log.score >= 50 ? 'mid' : 'low';
        const hasDetails = log.memo || log.time || log.sectionScores || log.weakAreas;
        return `
          <div class="record-item ${hasDetails ? 'has-details' : ''}">
            <div class="record-main">
              <span class="record-date">${formatDateShort(log.date)}</span>
              <span>${log.university}</span>
              <span class="record-subject-small">${log.subject || ''}</span>
              ${log.time ? `<span class="record-time-small">â±${log.time}åˆ†</span>` : ''}
              <span class="record-score ${scoreClass}">${log.score}%</span>
            </div>
            ${hasDetails ? `
              <div class="record-details">
                ${log.sectionScores ? `<span class="record-section">ğŸ“Š ${log.sectionScores}</span>` : ''}
                ${log.weakAreas ? `<span class="record-weak">âš ï¸ ${log.weakAreas}</span>` : ''}
                ${log.memo ? `<span class="record-memo">ğŸ“ ${log.memo}</span>` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    function openStudyModal() {
      resetStudyForm();
      document.getElementById('studyModal').classList.add('active');
    }
    
    function closeStudyModal() {
      document.getElementById('studyModal').classList.remove('active');
    }
    
    function resetStudyForm() {
      document.getElementById('studyDate').value = getTodayStr();
      document.querySelectorAll('#subjectButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#studyTypeButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#timeButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#moodButtons .mood-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('studyUnit').value = '';
      document.getElementById('studyTextbook').value = '';
      document.getElementById('studyMemo').value = '';
      selectedSubject = '';
      selectedStudyType = '';
      selectedTime = 0;
      selectedMood = '';
    }
    
    function openRedbookModal() {
      resetRedbookForm();
      document.getElementById('redbookModal').classList.add('active');
      // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã‚’éš ã™
      document.getElementById('customUniversityWrapper').classList.remove('show');
    }
    
    function closeRedbookModal() {
      document.getElementById('redbookModal').classList.remove('active');
    }
    
    // ã‚«ã‚¹ã‚¿ãƒ å¤§å­¦å…¥åŠ›ã®è¡¨ç¤ºåˆ‡æ›¿
    function toggleCustomUniversity() {
      const select = document.getElementById('redbookUniversity');
      const wrapper = document.getElementById('customUniversityWrapper');
      
      if (select.value === '__custom__') {
        wrapper.classList.add('show');
        document.getElementById('customUniversity').focus();
      } else {
        wrapper.classList.remove('show');
      }
    }
    
    // ==========================================
    // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
    // ==========================================
    let currentManagerType = '';
    
    function openDataManager(type) {
      currentManagerType = type;
      const modal = document.getElementById('dataManagerModal');
      const title = document.getElementById('dataManagerTitle');
      
      if (type === 'study') {
        title.textContent = 'ğŸ“– å­¦ç¿’è¨˜éŒ²ã®ç®¡ç†';
        renderStudyManager();
      } else {
        title.textContent = 'ğŸ“• éå»å•è¨˜éŒ²ã®ç®¡ç†';
        renderRedbookManager();
      }
      
      modal.classList.add('active');
    }
    
    function closeDataManager() {
      document.getElementById('dataManagerModal').classList.remove('active');
      currentManagerType = '';
    }
    
    function renderStudyManager() {
      const container = document.getElementById('dataManagerContent');
      const logs = appData.studyLogs || [];
      
      if (logs.length === 0) {
        container.innerHTML = '<div class="manager-empty">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = logs.map((log, index) => `
        <div class="manager-item">
          <div class="manager-item-info">
            <div class="manager-item-main">
              <span class="manager-item-date">${formatDateShort(log.date)}</span>
              <span class="manager-item-subject">${log.subject}</span>
              <span>${log.minutes}åˆ†</span>
              <span>${log.mood || ''}</span>
            </div>
            ${log.studyType || log.unit || log.memo ? `
              <div class="manager-item-detail">
                ${log.studyType ? log.studyType : ''}
                ${log.unit ? ' / ' + log.unit : ''}
                ${log.memo ? ' / ' + log.memo : ''}
              </div>
            ` : ''}
          </div>
          <button class="manager-delete-btn" onclick="deleteStudyLog(${index})" title="å‰Šé™¤">ğŸ—‘</button>
        </div>
      `).join('');
    }
    
    function renderRedbookManager() {
      const container = document.getElementById('dataManagerContent');
      const logs = appData.redbookLogs || [];
      
      if (logs.length === 0) {
        container.innerHTML = '<div class="manager-empty">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = logs.map((log, index) => `
        <div class="manager-item">
          <div class="manager-item-info">
            <div class="manager-item-main">
              <span class="manager-item-date">${formatDateShort(log.date)}</span>
              <span class="manager-item-subject">${log.university}</span>
              <span>${log.subject}</span>
              <span>${log.score}%</span>
            </div>
            ${log.year || log.memo ? `
              <div class="manager-item-detail">
                ${log.year ? log.year + 'å¹´åº¦' : ''}
                ${log.memo ? ' / ' + log.memo : ''}
              </div>
            ` : ''}
          </div>
          <button class="manager-delete-btn" onclick="deleteRedbookLog(${index})" title="å‰Šé™¤">ğŸ—‘</button>
        </div>
      `).join('');
    }
    
    // è¨˜éŒ²å‰Šé™¤
    async function deleteStudyLog(index) {
      if (!confirm('ã“ã®å­¦ç¿’è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      
      showLoading();
      try {
        await postData({
          action: 'deleteStudyLog',
          index: index
        });
        showToast('è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        await refreshData();
        // ç®¡ç†ç”»é¢ãŒé–‹ã„ã¦ã„ãŸã‚‰å†æç”»
        if (currentManagerType === 'study') {
          renderStudyManager();
        }
      } catch (error) {
        showToast(error.message, 'error');
        hideLoading();
      }
    }
    
    async function deleteRedbookLog(index) {
      if (!confirm('ã“ã®éå»å•è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      
      showLoading();
      try {
        await postData({
          action: 'deleteRedbookLog',
          index: index
        });
        showToast('è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        await refreshData();
        // ç®¡ç†ç”»é¢ãŒé–‹ã„ã¦ã„ãŸã‚‰å†æç”»
        if (currentManagerType === 'redbook') {
          renderRedbookManager();
        }
      } catch (error) {
        showToast(error.message, 'error');
        hideLoading();
      }
    }
    
    // å¾—ç‚¹è¨ˆç®—
    function calculateTotalScore() {
      const container = document.getElementById('sectionScoresContainer');
      const rows = container.querySelectorAll('.score-row');
      
      let totalGot = 0;
      let totalMax = 0;
      
      rows.forEach(row => {
        const got = parseInt(row.querySelector('.section-got').value) || 0;
        const max = parseInt(row.querySelector('.section-max').value) || 0;
        totalGot += got;
        totalMax += max;
      });
      
      document.getElementById('totalScoreGot').value = totalGot;
      document.getElementById('totalScoreMax').value = totalMax;
      
      const percent = totalMax > 0 ? Math.round((totalGot / totalMax) * 100) : 0;
      document.getElementById('totalScorePercent').textContent = `ï¼ˆ${percent}%ï¼‰`;
    }
    
    // å¤§å•è¿½åŠ 
    function addSection() {
      const container = document.getElementById('sectionScoresContainer');
      const currentCount = container.querySelectorAll('.score-row').length;
      const newSection = currentCount + 1;
      
      const row = document.createElement('div');
      row.className = 'score-row';
      row.dataset.section = newSection;
      row.innerHTML = `
        <input type="text" class="form-input section-name" value="å¤§å•${newSection}" placeholder="å¤§å•${newSection}">
        <div class="score-inputs">
          <input type="number" class="form-input score-box section-got" min="0" placeholder="0" oninput="calculateTotalScore()">
          <span class="score-divider">/</span>
          <input type="number" class="form-input score-box section-max" min="0" placeholder="0" oninput="calculateTotalScore()">
        </div>
      `;
      
      container.appendChild(row);
      
      // æ™‚é–“å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ãŒå¤§å•ã”ã¨ã®å ´åˆã¯åŒæœŸ
      if (timeInputMode === 'section') {
        syncSectionTimesWithScores();
      }
    }
    
    // å¤§å•å‰Šé™¤
    function removeSection() {
      const container = document.getElementById('sectionScoresContainer');
      const rows = container.querySelectorAll('.score-row');
      
      if (rows.length > 1) {
        rows[rows.length - 1].remove();
        calculateTotalScore();
        
        // æ™‚é–“å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ãŒå¤§å•ã”ã¨ã®å ´åˆã¯åŒæœŸ
        if (timeInputMode === 'section') {
          syncSectionTimesWithScores();
        }
      }
    }
    
    // å¤§å•å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ2å•ã«æˆ»ã™ï¼‰
    function resetSectionScores() {
      const container = document.getElementById('sectionScoresContainer');
      container.innerHTML = `
        <div class="score-row" data-section="1">
          <input type="text" class="form-input section-name" value="å¤§å•1" placeholder="å¤§å•1">
          <div class="score-inputs">
            <input type="number" class="form-input score-box section-got" min="0" placeholder="0" oninput="calculateTotalScore()">
            <span class="score-divider">/</span>
            <input type="number" class="form-input score-box section-max" min="0" placeholder="0" oninput="calculateTotalScore()">
          </div>
        </div>
        <div class="score-row" data-section="2">
          <input type="text" class="form-input section-name" value="å¤§å•2" placeholder="å¤§å•2">
          <div class="score-inputs">
            <input type="number" class="form-input score-box section-got" min="0" placeholder="0" oninput="calculateTotalScore()">
            <span class="score-divider">/</span>
            <input type="number" class="form-input score-box section-max" min="0" placeholder="0" oninput="calculateTotalScore()">
          </div>
        </div>
      `;
      document.getElementById('totalScoreGot').value = '';
      document.getElementById('totalScoreMax').value = '';
      document.getElementById('totalScorePercent').textContent = 'ï¼ˆ0%ï¼‰';
    }
    
    function resetRedbookForm() {
      document.getElementById('redbookDate').value = getTodayStr();
      document.getElementById('redbookUniversity').value = '';
      document.getElementById('redbookSubject').value = '';
      document.getElementById('redbookYear').value = '';
      document.getElementById('redbookTime').value = '';
      document.getElementById('redbookWeakAreas').value = '';
      document.getElementById('redbookMemo').value = '';
      resetSectionScores();
      
      // æ™‚é–“å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
      timeInputMode = 'total';
      document.querySelectorAll('.time-toggle-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === 0);
      });
      document.getElementById('totalTimeInput').style.display = 'block';
      document.getElementById('sectionTimeInput').style.display = 'none';
      document.getElementById('sectionTimesContainer').innerHTML = '';
      document.getElementById('totalTimeCalc').value = '';
    }
    
    function openAIModal() {
      document.getElementById('aiModal').classList.add('active');
      
      // ã€Œãã®ä»–ã€ã‚’é–‰ã˜ãŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('aiMoreOptions').style.display = 'none';
      document.getElementById('moreToggleText').textContent = 'ãã®ä»–ã®ç›¸è«‡ â–¼';
      
      // ã‚µãƒ–é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('subjectSelectGroup').style.display = 'none';
      document.getElementById('universitySelectGroup').style.display = 'none';
      
      generatePrompt();
    }
    
    function closeAIModal() {
      document.getElementById('aiModal').classList.remove('active');
    }
    
    function openSettingsModal() {
      document.getElementById('settingsApiUrl').value = API_URL;
      document.getElementById('settingsWeeklyGoal').value = appData.settings?.weeklyGoalMinutes || 1800;
      document.getElementById('settingsExamDate').value = localStorage.getItem('examDate') || '2026-01-17';
      document.getElementById('settingsChatUrl').value = CHAT_URL;
      document.getElementById('appVersionDisplay').textContent = `v${APP_VERSION}`;
      document.getElementById('settingsModal').classList.add('active');
    }
    
    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.remove('active');
    }
    
    async function submitStudyLog() {
      if (!selectedSubject) { showToast('ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      if (!selectedTime) { showToast('å­¦ç¿’æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      
      showLoading();
      
      try {
        await postData({
          action: 'addStudyLog',
          date: document.getElementById('studyDate').value,
          subject: selectedSubject,
          studyType: selectedStudyType,
          minutes: selectedTime,
          mood: selectedMood,
          unit: document.getElementById('studyUnit').value,
          textbook: document.getElementById('studyTextbook').value,
          memo: document.getElementById('studyMemo').value
        });
        
        closeStudyModal();
        showToast('å­¦ç¿’è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        setTimeout(() => refreshData(), 1500);
      } catch (error) {
        showToast(error.message, 'error');
        hideLoading();
      }
    }
    
    async function submitRedbookLog() {
      let university = document.getElementById('redbookUniversity').value;
      const subject = document.getElementById('redbookSubject').value;
      const year = document.getElementById('redbookYear').value;
      
      // ã‚«ã‚¹ã‚¿ãƒ å¤§å­¦ã®å‡¦ç†
      if (university === '__custom__') {
        university = document.getElementById('customUniversity').value.trim();
        if (!university) {
          showToast('å¤§å­¦åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
          return;
        }
      }
      
      // ç·åˆå¾—ç‚¹ã‚’å–å¾—
      const totalGot = parseInt(document.getElementById('totalScoreGot').value) || 0;
      const totalMax = parseInt(document.getElementById('totalScoreMax').value) || 0;
      
      if (!university) { showToast('å¤§å­¦ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      if (!subject) { showToast('ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      if (!year) { showToast('å¹´åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      if (totalMax === 0) { showToast('å¾—ç‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
      
      // å¾—ç‚¹ç‡ã‚’è¨ˆç®—
      const score = Math.round((totalGot / totalMax) * 100);
      
      // å¤§å•ã”ã¨ã®å¾—ç‚¹ã‚’æ–‡å­—åˆ—å½¢å¼ã§ä½œæˆ
      const container = document.getElementById('sectionScoresContainer');
      const rows = container.querySelectorAll('.score-row');
      const sectionScoresArray = [];
      
      // å¤§å•ã”ã¨ã®æ™‚é–“ã‚‚å–å¾—
      const timeContainer = document.getElementById('sectionTimesContainer');
      const timeInputs = timeContainer.querySelectorAll('.section-time-input');
      
      rows.forEach((row, index) => {
        const name = row.querySelector('.section-name').value || 'å¤§å•';
        const got = row.querySelector('.section-got').value || '0';
        const max = row.querySelector('.section-max').value || '0';
        if (parseInt(max) > 0) {
          let sectionData = `${name}:${got}/${max}`;
          // æ™‚é–“å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ãŒå¤§å•ã”ã¨ã®å ´åˆã€æ™‚é–“ã‚‚è¿½åŠ 
          if (timeInputMode === 'section' && timeInputs[index]) {
            const sectionTime = timeInputs[index].value || '';
            if (sectionTime) {
              sectionData += `(${sectionTime}åˆ†)`;
            }
          }
          sectionScoresArray.push(sectionData);
        }
      });
      const sectionScores = sectionScoresArray.join(', ');
      
      // ç·åˆæ™‚é–“ã‚’å–å¾—
      let totalTime = '';
      if (timeInputMode === 'total') {
        totalTime = document.getElementById('redbookTime').value ? parseInt(document.getElementById('redbookTime').value) : '';
      } else {
        totalTime = document.getElementById('totalTimeCalc').value ? parseInt(document.getElementById('totalTimeCalc').value) : '';
      }
      
      showLoading();
      
      try {
        await postData({
          action: 'addRedbookLog',
          date: document.getElementById('redbookDate').value,
          university,
          subject,
          year,
          score,
          time: totalTime,
          sectionScores,
          weakAreas: document.getElementById('redbookWeakAreas').value,
          memo: document.getElementById('redbookMemo').value
        });
        
        closeRedbookModal();
        showToast('èµ¤æœ¬è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        setTimeout(() => refreshData(), 1500);
      } catch (error) {
        showToast(error.message, 'error');
        hideLoading();
      }
    }
    
    // ==========================================
    // ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
    // ==========================================
    let chatMessages = [];
    
    function initChat() {
      if (CHAT_URL) {
        document.getElementById('chatHeaderBtn').style.display = 'flex';
        loadChatMessages();
        // 30ç§’ã”ã¨ã«æ–°ç€ãƒã‚§ãƒƒã‚¯
        setInterval(checkNewMessages, 30000);
      } else {
        document.getElementById('chatHeaderBtn').style.display = 'none';
      }
    }
    
    // ãƒãƒ£ãƒƒãƒˆç”¨JSONPé–¢æ•°
    function chatJsonp(url) {
      return new Promise((resolve, reject) => {
        const callbackName = 'chatCallback_' + Date.now();
        const script = document.createElement('script');
        
        window[callbackName] = function(data) {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(data);
        };
        
        script.onerror = function() {
          delete window[callbackName];
          document.body.removeChild(script);
          reject(new Error('JSONP request failed'));
        };
        
        const separator = url.includes('?') ? '&' : '?';
        script.src = `${url}${separator}callback=${callbackName}`;
        document.body.appendChild(script);
        
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        setTimeout(() => {
          if (window[callbackName]) {
            delete window[callbackName];
            if (script.parentNode) document.body.removeChild(script);
            reject(new Error('JSONP timeout'));
          }
        }, 10000);
      });
    }
    
    async function loadChatMessages() {
      if (!CHAT_URL) return;
      
      try {
        const data = await chatJsonp(`${CHAT_URL}?action=getMessages`);
        
        if (data.error) throw new Error(data.error);
        
        chatMessages = data.messages || [];
        renderChatMessages();
        updateChatBadge();
        
      } catch (error) {
        console.error('Chat load error:', error);
      }
    }
    
    async function checkNewMessages() {
      if (!CHAT_URL) return;
      
      try {
        const data = await chatJsonp(`${CHAT_URL}?action=getMessages`);
        
        if (data.messages) {
          chatMessages = data.messages;
          renderChatMessages();
        }
        updateChatBadge();
      } catch (error) {
        console.error('Chat check error:', error);
      }
    }
    
    async function markChatAsRead() {
      if (!CHAT_URL) return;
      
      // æœªèª­ã®adminãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®IDã‚’åé›†
      const unreadIds = chatMessages
        .filter(m => m.sender === 'admin' && !m.readByStudent)
        .map(m => m.id);
      
      if (unreadIds.length === 0) return;
      
      try {
        await chatJsonp(`${CHAT_URL}?action=markAsRead&role=student&ids=${unreadIds.join(',')}`);
        // ãƒ­ãƒ¼ã‚«ãƒ«ã®æ—¢èª­çŠ¶æ…‹ã‚‚æ›´æ–°
        chatMessages.forEach(m => {
          if (m.sender === 'admin') m.readByStudent = true;
        });
        renderChatMessages();
        updateChatBadge();
      } catch (error) {
        console.error('Mark as read error:', error);
      }
    }
    
    function updateChatBadge() {
      const badge = document.getElementById('chatHeaderBadge');
      
      // æœªèª­ã®adminãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆreadByStudent === falseï¼‰
      const unreadCount = chatMessages.filter(m => 
        m.sender === 'admin' && !m.readByStudent
      ).length;
      
      if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }
    
    function renderChatMessages() {
      const container = document.getElementById('chatMessages');
      
      if (chatMessages.length === 0) {
        container.innerHTML = '<div class="chat-empty"><div class="chat-empty-icon">ğŸ’¬</div>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      let lastDate = '';
      container.innerHTML = chatMessages.map(msg => {
        const date = new Date(msg.timestamp);
        const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
        const timeStr = `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        
        let dateDivider = '';
        if (dateStr !== lastDate) {
          dateDivider = `<div class="chat-date-divider">${dateStr}</div>`;
          lastDate = dateStr;
        }
        
        // è‡ªåˆ†ï¼ˆstudentï¼‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç›¸æ‰‹ï¼ˆadminï¼‰ã«èª­ã¾ã‚ŒãŸã‹
        let readStatus = '';
        if (msg.sender === 'student' && msg.readByAdmin) {
          readStatus = '<span class="chat-read-status">æ—¢èª­</span>';
        }
        
        return `
          ${dateDivider}
          <div class="chat-message ${msg.sender}">
            <div>${escapeHtml(msg.message)}</div>
            <div class="chat-message-time">${timeStr}${readStatus}</div>
          </div>
        `;
      }).join('');
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã¸
      container.scrollTop = container.scrollHeight;
    }
    
    function openChat() {
      document.getElementById('chatModal').classList.add('active');
      document.getElementById('chatHeaderBadge').style.display = 'none';
      loadChatMessages();
      
      // æ—¢èª­ãƒãƒ¼ã‚¯ã‚’é€ä¿¡
      markChatAsRead();
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã¸
      setTimeout(() => {
        const container = document.getElementById('chatMessages');
        container.scrollTop = container.scrollHeight;
      }, 100);
    }
    
    function closeChat() {
      document.getElementById('chatModal').classList.remove('active');
    }
    
    function handleChatKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage();
      }
    }
    
    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message || !CHAT_URL) return;
      
      const sendBtn = document.getElementById('chatSendBtn');
      sendBtn.disabled = true;
      
      try {
        // JSONPã‚’ä½¿ç”¨ï¼ˆCORSå›é¿ï¼‰
        const params = new URLSearchParams({
          action: 'sendMessage',
          sender: 'student',
          message: message
        });
        
        const data = await chatJsonp(`${CHAT_URL}?${params.toString()}`);
        
        if (data.error) throw new Error(data.error);
        
        input.value = '';
        await loadChatMessages();
        
      } catch (error) {
        showToast('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      } finally {
        sendBtn.disabled = false;
      }
    }
    
    function saveSettings() {
      const apiUrl = document.getElementById('settingsApiUrl').value.trim();
      const weeklyGoal = document.getElementById('settingsWeeklyGoal').value;
      const examDate = document.getElementById('settingsExamDate').value;
      const chatUrl = document.getElementById('settingsChatUrl').value.trim();
      
      localStorage.setItem('apiUrl', apiUrl);
      localStorage.setItem('weeklyGoal', weeklyGoal);
      localStorage.setItem('examDate', examDate);
      localStorage.setItem('chatUrl', chatUrl);
      
      API_URL = apiUrl;
      CHAT_URL = chatUrl;
      appData.settings.weeklyGoalMinutes = parseInt(weeklyGoal);
      
      closeSettingsModal();
      showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      
      initChat();
      if (apiUrl) refreshData();
    }
    
    // ==========================================
    // é«˜åº¦ãªåˆ†æã‚¨ãƒ³ã‚¸ãƒ³
    // ==========================================
    
    function analyzeStudyData(logs, redbookLogs, goals, profile) {
      const today = new Date();
      const examDate = new Date(localStorage.getItem('examDate') || '2026-01-17');
      const daysUntil = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
      
      // æœŸé–“åˆ¥ãƒ­ã‚°
      const getLogsInRange = (days) => {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        return logs.filter(log => new Date(log.date) >= cutoff);
      };
      
      const getRedbookLogsInRange = (days) => {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        return redbookLogs.filter(log => new Date(log.date) >= cutoff);
      };
      
      const weekLogs = getLogsInRange(7);
      const twoWeekLogs = getLogsInRange(14);
      const monthLogs = getLogsInRange(30);
      
      const weekRedbookLogs = getRedbookLogsInRange(7);
      const twoWeekRedbookLogs = getRedbookLogsInRange(14);
      
      // ========== åŸºæœ¬çµ±è¨ˆï¼ˆèµ¤æœ¬æ™‚é–“ã‚’å«ã‚€ï¼‰ ==========
      const studyMinutes = logs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      const redbookMinutes = redbookLogs.reduce((sum, log) => sum + (log.time || 0), 0);
      const totalMinutes = studyMinutes + redbookMinutes;
      
      const studyWeekMinutes = weekLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      const redbookWeekMinutes = weekRedbookLogs.reduce((sum, log) => sum + (log.time || 0), 0);
      const weekMinutes = studyWeekMinutes + redbookWeekMinutes;
      
      const studyPrevWeekMinutes = twoWeekLogs.reduce((sum, log) => sum + (log.minutes || 0), 0) - studyWeekMinutes;
      const redbookPrevWeekMinutes = twoWeekRedbookLogs.reduce((sum, log) => sum + (log.time || 0), 0) - redbookWeekMinutes;
      const prevWeekMinutes = studyPrevWeekMinutes + redbookPrevWeekMinutes;
      
      // å­¦ç¿’æ—¥æ•°ï¼ˆå­¦ç¿’è¨˜éŒ²ã¨èµ¤æœ¬è¨˜éŒ²ã®ä¸¡æ–¹ã‚’è€ƒæ…®ï¼‰
      const allDates = [...new Set([
        ...logs.map(l => l.date),
        ...redbookLogs.map(l => l.date)
      ])];
      const studyDays = allDates.length;
      const streak = calculateStreak({ dates: allDates });
      
      // ========== æ›œæ—¥åˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ ==========
      const dayOfWeekStats = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
      const dayOfWeekCount = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
      logs.forEach(log => {
        const dow = new Date(log.date).getDay();
        dayOfWeekStats[dow] += log.minutes || 0;
        dayOfWeekCount[dow]++;
      });
      // èµ¤æœ¬æ™‚é–“ã‚‚æ›œæ—¥åˆ¥ã«è¿½åŠ 
      redbookLogs.forEach(log => {
        const dow = new Date(log.date).getDay();
        dayOfWeekStats[dow] += log.time || 0;
        dayOfWeekCount[dow]++;
      });
      const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const dayOfWeekAvg = {};
      for (let i = 0; i < 7; i++) {
        dayOfWeekAvg[dayNames[i]] = dayOfWeekCount[i] > 0 
          ? Math.round(dayOfWeekStats[i] / dayOfWeekCount[i]) 
          : 0;
      }
      
      // æœ€ã‚‚å‹‰å¼·ã™ã‚‹æ›œæ—¥ãƒ»ã—ãªã„æ›œæ—¥
      const sortedDays = Object.entries(dayOfWeekAvg).sort((a, b) => b[1] - a[1]);
      const strongDays = sortedDays.filter(d => d[1] > 0).slice(0, 2).map(d => d[0]);
      const weakDays = sortedDays.filter(d => d[1] >= 0).slice(-2).map(d => d[0]);
      
      // ========== ç§‘ç›®åˆ¥è©³ç´°åˆ†æ ==========
      const subjectAnalysis = {};
      const categories = ['è‹±èª', 'æ•°å­¦', 'å›½èª', 'ãã®ä»–'];
      
      categories.forEach(cat => {
        const catLogs = logs.filter(log => categorizeSubject(log.subject) === cat);
        const catWeekLogs = weekLogs.filter(log => categorizeSubject(log.subject) === cat);
        const catPrevWeekLogs = twoWeekLogs.filter(log => categorizeSubject(log.subject) === cat && !catWeekLogs.includes(log));
        
        const weekMin = catWeekLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
        const prevWeekMin = catPrevWeekLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
        const totalMin = catLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
        
        // å­¦ç¿’ã‚¿ã‚¤ãƒ—åˆ¥
        const typeBreakdown = {};
        catWeekLogs.forEach(log => {
          if (log.studyType) {
            typeBreakdown[log.studyType] = (typeBreakdown[log.studyType] || 0) + (log.minutes || 0);
          }
        });
        
        // æ‰‹å¿œãˆåˆ†æ
        const moodBreakdown = { excellent: 0, good: 0, neutral: 0, bad: 0, terrible: 0 };
        catLogs.forEach(log => {
          if (log.mood === 'ğŸ˜Š') moodBreakdown.excellent++;
          else if (log.mood === 'ğŸ™‚') moodBreakdown.good++;
          else if (log.mood === 'ğŸ˜') moodBreakdown.neutral++;
          else if (log.mood === 'ğŸ˜•') moodBreakdown.bad++;
          else if (log.mood === 'ğŸ˜«') moodBreakdown.terrible++;
        });
        
        // ä½¿ç”¨æ•™æ
        const textbooks = {};
        catLogs.forEach(log => {
          if (log.textbook) {
            textbooks[log.textbook] = (textbooks[log.textbook] || 0) + (log.minutes || 0);
          }
        });
        
        // å­¦ç¿’ã—ãŸå˜å…ƒ
        const units = catWeekLogs.filter(l => l.unit).map(l => l.unit);
        
        // å‚¾å‘åˆ¤å®š
        let trend = 'stable';
        if (weekMin > prevWeekMin * 1.2) trend = 'increasing';
        else if (weekMin < prevWeekMin * 0.8) trend = 'decreasing';
        
        subjectAnalysis[cat] = {
          totalMinutes: totalMin,
          weekMinutes: weekMin,
          prevWeekMinutes: prevWeekMin,
          trend,
          typeBreakdown,
          moodBreakdown,
          textbooks,
          recentUnits: units,
          sessionCount: catLogs.length
        };
      });
      
      // ========== å­¦ç¿’ã‚¿ã‚¤ãƒ—ãƒãƒ©ãƒ³ã‚¹ ==========
      const typeBalance = { æ–°è¦: 0, å¾©ç¿’: 0, æ¼”ç¿’: 0, æš—è¨˜: 0, éå»å•: 0, æ¨¡è©¦: 0 };
      weekLogs.forEach(log => {
        if (log.studyType && typeBalance.hasOwnProperty(log.studyType)) {
          typeBalance[log.studyType] += log.minutes || 0;
        }
      });
      const typeTotal = Object.values(typeBalance).reduce((a, b) => a + b, 0);
      const typePercentage = {};
      Object.entries(typeBalance).forEach(([type, min]) => {
        typePercentage[type] = typeTotal > 0 ? Math.round(min / typeTotal * 100) : 0;
      });
      
      // ã‚¿ã‚¤ãƒ—ãƒãƒ©ãƒ³ã‚¹ã®è©•ä¾¡
      let typeBalanceAssessment = [];
      if (typePercentage['å¾©ç¿’'] < 20) typeBalanceAssessment.push('å¾©ç¿’ãŒå°‘ãªã‚ï¼ˆå®šç€ã«ä¸å®‰ï¼‰');
      if (typePercentage['æ¼”ç¿’'] < 15) typeBalanceAssessment.push('æ¼”ç¿’é‡ãŒä¸è¶³ï¼ˆå®Ÿæˆ¦åŠ›ã«èª²é¡Œï¼‰');
      if (typePercentage['æ–°è¦'] > 50) typeBalanceAssessment.push('æ–°è¦å­¦ç¿’ã«åé‡ï¼ˆæ¶ˆåŒ–ä¸è‰¯ã®æã‚Œï¼‰');
      
      // ========== éå»å•åˆ†æï¼ˆå¤§å¹…æ‹¡å¼µï¼‰ ==========
      const redbookAnalysis = {
        totalAttempts: redbookLogs.length,
        totalTime: 0,
        avgScore: 0,
        scoresBySubject: {},
        scoreTrend: 'stable',
        weakAreasSummary: {},
        timeManagement: { adequate: 0, rushed: 0, overtime: 0, unknown: 0 },
        // æ–°è¦è¿½åŠ 
        universityAnalysis: {},
        sectionAnalysis: {},
        recentPerformance: [],
        monthlyProgress: {}
      };
      
      if (redbookLogs.length > 0) {
        // ç·æ¼”ç¿’æ™‚é–“
        redbookAnalysis.totalTime = redbookLogs.reduce((sum, l) => sum + (l.time || 0), 0);
        
        redbookAnalysis.avgScore = Math.round(
          redbookLogs.reduce((sum, l) => sum + l.score, 0) / redbookLogs.length
        );
        
        // ç§‘ç›®åˆ¥å¹³å‡
        const subjectScores = {};
        const subjectCounts = {};
        redbookLogs.forEach(log => {
          const cat = categorizeSubject(log.subject);
          if (!subjectScores[cat]) {
            subjectScores[cat] = 0;
            subjectCounts[cat] = 0;
          }
          subjectScores[cat] += log.score;
          subjectCounts[cat]++;
        });
        Object.keys(subjectScores).forEach(cat => {
          redbookAnalysis.scoresBySubject[cat] = Math.round(subjectScores[cat] / subjectCounts[cat]);
        });
        
        // å¾—ç‚¹ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆç›´è¿‘5å› vs ãã‚Œä»¥å‰ï¼‰
        if (redbookLogs.length >= 4) {
          const sorted = [...redbookLogs].sort((a, b) => new Date(a.date) - new Date(b.date));
          const half = Math.floor(sorted.length / 2);
          const older = sorted.slice(0, half);
          const recent = sorted.slice(half);
          const olderAvg = older.reduce((s, l) => s + l.score, 0) / older.length;
          const recentAvg = recent.reduce((s, l) => s + l.score, 0) / recent.length;
          if (recentAvg > olderAvg + 5) redbookAnalysis.scoreTrend = 'improving';
          else if (recentAvg < olderAvg - 5) redbookAnalysis.scoreTrend = 'declining';
        }
        
        // è‹¦æ‰‹åˆ†é‡é›†è¨ˆ
        redbookLogs.forEach(log => {
          if (log.weakAreas) {
            log.weakAreas.split(/[,ã€]/).forEach(area => {
              const trimmed = area.trim();
              if (trimmed) {
                redbookAnalysis.weakAreasSummary[trimmed] = 
                  (redbookAnalysis.weakAreasSummary[trimmed] || 0) + 1;
              }
            });
          }
        });
        
        // ========== å¤§å­¦åˆ¥è©³ç´°åˆ†æ ==========
        const uniGroups = {};
        redbookLogs.forEach(log => {
          const uni = log.university || 'ä¸æ˜';
          if (!uniGroups[uni]) {
            uniGroups[uni] = [];
          }
          uniGroups[uni].push(log);
        });
        
        Object.entries(uniGroups).forEach(([uni, logs]) => {
          const sorted = [...logs].sort((a, b) => new Date(a.date) - new Date(b.date));
          const avgScore = Math.round(logs.reduce((s, l) => s + l.score, 0) / logs.length);
          const avgTime = logs.filter(l => l.time).length > 0
            ? Math.round(logs.filter(l => l.time).reduce((s, l) => s + l.time, 0) / logs.filter(l => l.time).length)
            : 0;
          
          // ç§‘ç›®åˆ¥
          const bySubject = {};
          logs.forEach(l => {
            const subj = l.subject || 'ä¸æ˜';
            if (!bySubject[subj]) {
              bySubject[subj] = { scores: [], times: [], weakAreas: [] };
            }
            bySubject[subj].scores.push(l.score);
            if (l.time) bySubject[subj].times.push(l.time);
            if (l.weakAreas) {
              l.weakAreas.split(/[,ã€]/).forEach(a => {
                if (a.trim()) bySubject[subj].weakAreas.push(a.trim());
              });
            }
          });
          
          const subjectSummary = {};
          Object.entries(bySubject).forEach(([subj, data]) => {
            subjectSummary[subj] = {
              avgScore: Math.round(data.scores.reduce((a, b) => a + b, 0) / data.scores.length),
              attempts: data.scores.length,
              avgTime: data.times.length > 0 ? Math.round(data.times.reduce((a, b) => a + b, 0) / data.times.length) : null,
              weakAreas: [...new Set(data.weakAreas)].slice(0, 5)
            };
          });
          
          // ãƒˆãƒ¬ãƒ³ãƒ‰
          let trend = 'stable';
          if (sorted.length >= 3) {
            const half = Math.floor(sorted.length / 2);
            const firstHalf = sorted.slice(0, half);
            const secondHalf = sorted.slice(half);
            const firstAvg = firstHalf.reduce((s, l) => s + l.score, 0) / firstHalf.length;
            const secondAvg = secondHalf.reduce((s, l) => s + l.score, 0) / secondHalf.length;
            if (secondAvg > firstAvg + 3) trend = 'improving';
            else if (secondAvg < firstAvg - 3) trend = 'declining';
          }
          
          redbookAnalysis.universityAnalysis[uni] = {
            attempts: logs.length,
            avgScore,
            avgTime,
            highScore: Math.max(...logs.map(l => l.score)),
            lowScore: Math.min(...logs.map(l => l.score)),
            trend,
            bySubject: subjectSummary,
            recentLogs: sorted.slice(-3).reverse()
          };
        });
        
        // ========== å¤§å•åˆ¥åˆ†æ ==========
        const sectionData = {};
        redbookLogs.forEach(log => {
          if (log.sectionScores) {
            // å½¢å¼: "å¤§å•1:15/20, å¤§å•2:30/40" ã¾ãŸã¯ "1A:15/30(25åˆ†), 1B:10/20(15åˆ†)"
            log.sectionScores.split(',').forEach(section => {
              const match = section.trim().match(/(.+?):(\d+)\/(\d+)(?:\((\d+)åˆ†\))?/);
              if (match) {
                const [, name, got, max, time] = match;
                const key = name.trim();
                const rate = max > 0 ? Math.round((parseInt(got) / parseInt(max)) * 100) : 0;
                
                if (!sectionData[key]) {
                  sectionData[key] = { scores: [], times: [], subjects: [] };
                }
                sectionData[key].scores.push(rate);
                if (time) sectionData[key].times.push(parseInt(time));
                sectionData[key].subjects.push(log.subject || 'ä¸æ˜');
              }
            });
          }
        });
        
        Object.entries(sectionData).forEach(([name, data]) => {
          redbookAnalysis.sectionAnalysis[name] = {
            avgScore: Math.round(data.scores.reduce((a, b) => a + b, 0) / data.scores.length),
            attempts: data.scores.length,
            avgTime: data.times.length > 0 ? Math.round(data.times.reduce((a, b) => a + b, 0) / data.times.length) : null,
            subjects: [...new Set(data.subjects)]
          };
        });
        
        // ========== ç›´è¿‘ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ ==========
        redbookAnalysis.recentPerformance = [...redbookLogs]
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .slice(0, 5)
          .map(l => ({
            date: l.date,
            university: l.university,
            subject: l.subject,
            score: l.score,
            time: l.time,
            weakAreas: l.weakAreas
          }));
        
        // ========== æœˆåˆ¥é€²æ— ==========
        redbookLogs.forEach(log => {
          const month = log.date.substring(0, 7); // YYYY-MM
          if (!redbookAnalysis.monthlyProgress[month]) {
            redbookAnalysis.monthlyProgress[month] = { attempts: 0, totalScore: 0, totalTime: 0 };
          }
          redbookAnalysis.monthlyProgress[month].attempts++;
          redbookAnalysis.monthlyProgress[month].totalScore += log.score;
          redbookAnalysis.monthlyProgress[month].totalTime += log.time || 0;
        });
        
        Object.keys(redbookAnalysis.monthlyProgress).forEach(month => {
          const data = redbookAnalysis.monthlyProgress[month];
          data.avgScore = Math.round(data.totalScore / data.attempts);
        });
      }
      
      // ========== ç›®æ¨™é”æˆåˆ†æ ==========
      const goalAnalysis = goals.map(goal => {
        const gap = goal.target - goal.current;
        const mustGap = (goal.must || goal.target) - goal.current;
        const subjectRedbook = redbookLogs.filter(l => categorizeSubject(l.subject) === goal.subject);
        const recentScore = subjectRedbook.length > 0 ? subjectRedbook[0].score : goal.current;
        
        // é”æˆå¯èƒ½æ€§åˆ¤å®š
        let feasibility = 'possible';
        if (gap > 30 && daysUntil < 30) feasibility = 'challenging';
        else if (gap > 20 && daysUntil < 14) feasibility = 'difficult';
        else if (gap <= 10) feasibility = 'likely';
        
        // å¿…è¦ãªé€±é–“å­¦ç¿’æ™‚é–“ã®æ¨å®šï¼ˆç°¡æ˜“ï¼‰
        const neededWeeklyHours = Math.max(1, Math.ceil(gap / 5));
        
        return {
          subject: goal.subject,
          current: goal.current,
          target: goal.target,
          must: goal.must || goal.target,
          gap,
          mustGap,
          recentScore,
          feasibility,
          neededWeeklyHours
        };
      });
      
      // ========== ãƒªã‚¹ã‚¯åˆ†æ ==========
      const risks = [];
      
      // å­¦ç¿’é‡ãƒªã‚¹ã‚¯
      if (weekMinutes < 600) {
        risks.push({ type: 'study_volume', severity: 'high', message: 'é€±é–“å­¦ç¿’æ™‚é–“ãŒ10æ™‚é–“æœªæº€ã§å°‘ãªã‚' });
      } else if (weekMinutes < 900) {
        risks.push({ type: 'study_volume', severity: 'medium', message: 'é€±é–“å­¦ç¿’æ™‚é–“ãŒ15æ™‚é–“æœªæº€' });
      }
      
      // ç§‘ç›®ãƒãƒ©ãƒ³ã‚¹ãƒªã‚¹ã‚¯
      const subjectMinutes = Object.values(subjectAnalysis).map(s => s.weekMinutes);
      const maxSubject = Math.max(...subjectMinutes);
      const minSubject = Math.min(...subjectMinutes.filter(m => m > 0));
      if (maxSubject > minSubject * 3) {
        risks.push({ type: 'balance', severity: 'medium', message: 'ç§‘ç›®é–“ã®å­¦ç¿’æ™‚é–“ã«å¤§ããªåã‚Š' });
      }
      
      // éå»å•ã‚¹ã‚³ã‚¢ãƒªã‚¹ã‚¯
      if (redbookAnalysis.avgScore > 0 && redbookAnalysis.avgScore < 50) {
        risks.push({ type: 'score', severity: 'high', message: 'éå»å•ã®å¹³å‡å¾—ç‚¹ç‡ãŒ50%æœªæº€' });
      }
      
      // å¾©ç¿’ä¸è¶³ãƒªã‚¹ã‚¯
      if (typePercentage['å¾©ç¿’'] < 15) {
        risks.push({ type: 'review', severity: 'medium', message: 'å¾©ç¿’ã®å‰²åˆãŒå°‘ãªãå®šç€ã«ä¸å®‰' });
      }
      
      // ç¶™ç¶šæ€§ãƒªã‚¹ã‚¯
      if (streak < 3 && studyDays > 7) {
        risks.push({ type: 'consistency', severity: 'low', message: 'é€£ç¶šå­¦ç¿’ãŒé€”åˆ‡ã‚ŒãŒã¡' });
      }
      
      // ========== å¼·ã¿ã®ç‰¹å®š ==========
      const strengths = [];
      
      if (streak >= 7) {
        strengths.push({ type: 'consistency', message: `${streak}æ—¥é€£ç¶šå­¦ç¿’ã‚’ç¶™ç¶šä¸­` });
      }
      if (weekMinutes >= 1500) {
        strengths.push({ type: 'volume', message: 'ååˆ†ãªå­¦ç¿’é‡ã‚’ç¢ºä¿' });
      }
      if (redbookAnalysis.scoreTrend === 'improving') {
        strengths.push({ type: 'progress', message: 'éå»å•ã®å¾—ç‚¹ãŒä¸Šæ˜‡å‚¾å‘' });
      }
      
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        const goodMood = data.moodBreakdown.excellent + data.moodBreakdown.good;
        const badMood = data.moodBreakdown.bad + data.moodBreakdown.terrible;
        if (goodMood > badMood * 2 && goodMood >= 3) {
          strengths.push({ type: 'confidence', message: `${cat}ã®å­¦ç¿’ã§å¥½èª¿` });
        }
      });
      
      // ========== æˆé•·åˆ†æï¼ˆæ–°è¦è¿½åŠ ï¼‰ ==========
      const growthAnalysis = {
        // å­¦ç¿’é‡ã®æ¨ç§»
        volumeGrowth: prevWeekMinutes > 0 ? Math.round((weekMinutes - prevWeekMinutes) / prevWeekMinutes * 100) : 0,
        
        // å­¦ç¿’ç¿’æ…£ã‚¹ã‚³ã‚¢ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰
        habitScore: 0,
        habitFactors: [],
        
        // æ‰‹å¿œãˆã®æ¨ç§»
        moodTrend: { improving: 0, stable: 0, declining: 0 },
        
        // ç§‘ç›®åˆ¥ã®æˆé•·
        subjectGrowth: {},
        
        // é€±é–“ã®å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³
        weekPattern: {
          mostProductiveDay: strongDays[0] || 'ä¸æ˜',
          leastProductiveDay: weakDays[0] || 'ä¸æ˜',
          avgDailyMinutes: studyDays > 0 ? Math.round(totalMinutes / studyDays) : 0,
          consistency: 0 // å­¦ç¿’æ—¥ã®é€£ç¶šæ€§
        }
      };
      
      // å­¦ç¿’ç¿’æ…£ã‚¹ã‚³ã‚¢ã®è¨ˆç®—
      let habitScore = 0;
      
      // 1. ç¶™ç¶šæ€§ï¼ˆ30ç‚¹æº€ç‚¹ï¼‰
      if (streak >= 14) { habitScore += 30; growthAnalysis.habitFactors.push('å„ªç§€ãªç¶™ç¶šåŠ›'); }
      else if (streak >= 7) { habitScore += 25; growthAnalysis.habitFactors.push('è‰¯å¥½ãªç¶™ç¶šåŠ›'); }
      else if (streak >= 3) { habitScore += 15; growthAnalysis.habitFactors.push('ç¶™ç¶šåŠ›å‘ä¸Šä¸­'); }
      else { habitScore += 5; }
      
      // 2. å­¦ç¿’é‡ï¼ˆ25ç‚¹æº€ç‚¹ï¼‰
      const weeklyHours = weekMinutes / 60;
      if (weeklyHours >= 30) { habitScore += 25; growthAnalysis.habitFactors.push('ååˆ†ãªå­¦ç¿’é‡'); }
      else if (weeklyHours >= 20) { habitScore += 20; growthAnalysis.habitFactors.push('é©åˆ‡ãªå­¦ç¿’é‡'); }
      else if (weeklyHours >= 10) { habitScore += 15; }
      else { habitScore += 5; }
      
      // 3. ãƒãƒ©ãƒ³ã‚¹ï¼ˆ20ç‚¹æº€ç‚¹ï¼‰
      const activeSubjects = Object.values(subjectAnalysis).filter(s => s.weekMinutes > 0).length;
      if (activeSubjects >= 3) { habitScore += 20; growthAnalysis.habitFactors.push('ãƒãƒ©ãƒ³ã‚¹è‰¯ã„å­¦ç¿’'); }
      else if (activeSubjects >= 2) { habitScore += 15; }
      else { habitScore += 5; }
      
      // 4. å¾©ç¿’ãƒ»æ¼”ç¿’ã®å®Ÿæ–½ï¼ˆ15ç‚¹æº€ç‚¹ï¼‰
      if (typePercentage['å¾©ç¿’'] >= 20 && typePercentage['æ¼”ç¿’'] >= 15) {
        habitScore += 15;
        growthAnalysis.habitFactors.push('å®šç€é‡è¦–ã®å­¦ç¿’');
      } else if (typePercentage['å¾©ç¿’'] >= 15 || typePercentage['æ¼”ç¿’'] >= 10) {
        habitScore += 10;
      } else {
        habitScore += 5;
      }
      
      // 5. éå»å•æ¼”ç¿’ï¼ˆ10ç‚¹æº€ç‚¹ï¼‰
      if (redbookAnalysis.totalAttempts > 0) {
        const recentRedbook = weekRedbookLogs.length;
        if (recentRedbook >= 3) { habitScore += 10; growthAnalysis.habitFactors.push('ç©æ¥µçš„ãªéå»å•æ¼”ç¿’'); }
        else if (recentRedbook >= 1) { habitScore += 7; }
        else { habitScore += 3; }
      }
      
      growthAnalysis.habitScore = habitScore;
      
      // ç§‘ç›®åˆ¥ã®æˆé•·åˆ†æ
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        let growth = 'stable';
        if (data.weekMinutes > data.prevWeekMinutes * 1.2) growth = 'increasing';
        else if (data.weekMinutes < data.prevWeekMinutes * 0.8) growth = 'decreasing';
        
        // æ‰‹å¿œãˆã®é›†è¨ˆ
        const totalMood = Object.values(data.moodBreakdown).reduce((a, b) => a + b, 0);
        const goodRate = totalMood > 0 ? (data.moodBreakdown.excellent + data.moodBreakdown.good) / totalMood * 100 : 0;
        
        growthAnalysis.subjectGrowth[cat] = {
          growth,
          weekMinutes: data.weekMinutes,
          prevWeekMinutes: data.prevWeekMinutes,
          changePercent: data.prevWeekMinutes > 0 ? Math.round((data.weekMinutes - data.prevWeekMinutes) / data.prevWeekMinutes * 100) : 0,
          goodMoodRate: Math.round(goodRate),
          recentUnits: data.recentUnits.slice(0, 5)
        };
      });
      
      // å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¸€è²«æ€§ï¼ˆæ¨™æº–åå·®ã‚’ä½¿ç”¨ï¼‰
      const dayValues = Object.values(dayOfWeekAvg);
      const avgOfDays = dayValues.reduce((a, b) => a + b, 0) / 7;
      const variance = dayValues.reduce((sum, val) => sum + Math.pow(val - avgOfDays, 2), 0) / 7;
      const stdDev = Math.sqrt(variance);
      // ä¸€è²«æ€§ã‚¹ã‚³ã‚¢: æ¨™æº–åå·®ãŒå°ã•ã„ã»ã©é«˜ã„ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰
      growthAnalysis.weekPattern.consistency = avgOfDays > 0 ? Math.max(0, Math.round(100 - (stdDev / avgOfDays * 100))) : 0;
      
      // ========== ç·åˆè©•ä¾¡ï¼ˆæ–°è¦è¿½åŠ ï¼‰ ==========
      const comprehensiveScore = {
        total: 0,
        breakdown: {},
        grade: 'C',
        summary: ''
      };
      
      // å­¦ç¿’é‡ã‚¹ã‚³ã‚¢ï¼ˆ25ç‚¹ï¼‰
      let volumeScore = 0;
      if (weekMinutes >= 1800) volumeScore = 25;
      else if (weekMinutes >= 1200) volumeScore = 20;
      else if (weekMinutes >= 600) volumeScore = 15;
      else volumeScore = Math.round(weekMinutes / 600 * 15);
      comprehensiveScore.breakdown['å­¦ç¿’é‡'] = volumeScore;
      
      // ç¶™ç¶šæ€§ã‚¹ã‚³ã‚¢ï¼ˆ25ç‚¹ï¼‰
      let consistencyScore = Math.min(25, Math.round(streak / 14 * 25));
      comprehensiveScore.breakdown['ç¶™ç¶šæ€§'] = consistencyScore;
      
      // éå»å•æˆç¸¾ã‚¹ã‚³ã‚¢ï¼ˆ25ç‚¹ï¼‰
      let examScore = 0;
      if (redbookAnalysis.avgScore >= 80) examScore = 25;
      else if (redbookAnalysis.avgScore >= 60) examScore = 20;
      else if (redbookAnalysis.avgScore >= 40) examScore = 15;
      else if (redbookAnalysis.avgScore > 0) examScore = 10;
      comprehensiveScore.breakdown['éå»å•æˆç¸¾'] = examScore;
      
      // ãƒãƒ©ãƒ³ã‚¹ã‚¹ã‚³ã‚¢ï¼ˆ25ç‚¹ï¼‰
      let balanceScore = Math.round(activeSubjects / 3 * 15);
      if (typeBalanceAssessment.length === 0) balanceScore += 10;
      else balanceScore += Math.max(0, 10 - typeBalanceAssessment.length * 3);
      comprehensiveScore.breakdown['å­¦ç¿’ãƒãƒ©ãƒ³ã‚¹'] = Math.min(25, balanceScore);
      
      comprehensiveScore.total = Object.values(comprehensiveScore.breakdown).reduce((a, b) => a + b, 0);
      
      // ã‚°ãƒ¬ãƒ¼ãƒ‰åˆ¤å®š
      if (comprehensiveScore.total >= 90) comprehensiveScore.grade = 'S';
      else if (comprehensiveScore.total >= 80) comprehensiveScore.grade = 'A';
      else if (comprehensiveScore.total >= 65) comprehensiveScore.grade = 'B';
      else if (comprehensiveScore.total >= 50) comprehensiveScore.grade = 'C';
      else comprehensiveScore.grade = 'D';
      
      return {
        // åŸºæœ¬æƒ…å ±
        daysUntil,
        totalMinutes,
        weekMinutes,
        prevWeekMinutes,
        studyDays,
        streak,
        weekTrend: weekMinutes > prevWeekMinutes ? 'up' : weekMinutes < prevWeekMinutes ? 'down' : 'stable',
        
        // ãƒ‘ã‚¿ãƒ¼ãƒ³
        dayOfWeekAvg,
        strongDays,
        weakDays,
        
        // ç§‘ç›®åˆ¥
        subjectAnalysis,
        
        // ã‚¿ã‚¤ãƒ—ãƒãƒ©ãƒ³ã‚¹
        typeBalance,
        typePercentage,
        typeBalanceAssessment,
        
        // éå»å•
        redbookAnalysis,
        
        // ç›®æ¨™
        goalAnalysis,
        
        // è©•ä¾¡
        risks,
        strengths,
        
        // æˆé•·åˆ†æï¼ˆæ–°è¦ï¼‰
        growthAnalysis,
        
        // ç·åˆè©•ä¾¡ï¼ˆæ–°è¦ï¼‰
        comprehensiveScore,
        
        // ç”Ÿãƒ‡ãƒ¼ã‚¿
        weekLogs,
        redbookLogs,
        profile
      };
    }
    
    // ==========================================
    // å­¦ç¿’åˆ†æã‚¿ãƒ–
    // ==========================================
    
    function renderStudyAnalysis() {
      const logs = appData.studyLogs || [];
      if (logs.length === 0) return;
      
      // åŸºæœ¬çµ±è¨ˆ
      const totalMinutes = logs.reduce((sum, l) => sum + (l.minutes || 0), 0);
      const studyDates = [...new Set(logs.map(l => l.date))];
      const avgDaily = Math.round(totalMinutes / studyDates.length);
      
      document.getElementById('studyTotalHours').textContent = Math.round(totalMinutes / 60);
      document.getElementById('studyAvgDaily').textContent = avgDaily;
      document.getElementById('studyTotalDays').textContent = studyDates.length;
      
      // æœ€é•·é€£ç¶šæ—¥æ•°ã‚’è¨ˆç®—
      const sortedDates = studyDates.sort();
      let maxStreak = 1, currentStreak = 1;
      for (let i = 1; i < sortedDates.length; i++) {
        const prev = new Date(sortedDates[i-1]);
        const curr = new Date(sortedDates[i]);
        const diff = (curr - prev) / (1000 * 60 * 60 * 24);
        if (diff === 1) {
          currentStreak++;
          maxStreak = Math.max(maxStreak, currentStreak);
        } else {
          currentStreak = 1;
        }
      }
      document.getElementById('studyMaxStreak').textContent = maxStreak;
      
      // ç§‘ç›®åˆ¥å­¦ç¿’æ™‚é–“
      const subjectTotals = {};
      logs.forEach(l => {
        const cat = categorizeSubject(l.subject);
        subjectTotals[cat] = (subjectTotals[cat] || 0) + (l.minutes || 0);
      });
      
      const maxSubjectTime = Math.max(...Object.values(subjectTotals));
      const subjectBreakdown = document.getElementById('subjectBreakdown');
      subjectBreakdown.innerHTML = Object.entries(subjectTotals)
        .sort((a, b) => b[1] - a[1])
        .map(([subject, minutes]) => `
          <div class="breakdown-item">
            <span class="breakdown-label">${subject}</span>
            <div class="breakdown-bar-container">
              <div class="breakdown-bar" style="width: ${(minutes / maxSubjectTime) * 100}%"></div>
            </div>
            <span class="breakdown-value">${Math.round(minutes / 60)}æ™‚é–“</span>
          </div>
        `).join('');
      
      // æ›œæ—¥åˆ¥ãƒãƒ£ãƒ¼ãƒˆ
      renderDayOfWeekChart(logs);
      
      // å­¦ç¿’ã‚¿ã‚¤ãƒ—åˆ¥
      const typeTotals = {};
      logs.forEach(l => {
        const type = l.studyType || 'æœªåˆ†é¡';
        typeTotals[type] = (typeTotals[type] || 0) + (l.minutes || 0);
      });
      
      const maxTypeTime = Math.max(...Object.values(typeTotals));
      const typeBreakdown = document.getElementById('studyTypeBreakdown');
      typeBreakdown.innerHTML = Object.entries(typeTotals)
        .sort((a, b) => b[1] - a[1])
        .map(([type, minutes]) => {
          const percent = Math.round((minutes / totalMinutes) * 100);
          return `
            <div class="breakdown-item">
              <span class="breakdown-label">${type}</span>
              <div class="breakdown-bar-container">
                <div class="breakdown-bar" style="width: ${(minutes / maxTypeTime) * 100}%"></div>
              </div>
              <span class="breakdown-value">${percent}%</span>
            </div>
          `;
        }).join('');
      
      // æ‰‹å¿œãˆåˆ†æ
      const moodCounts = {};
      const moods = ['ğŸ˜Š', 'ğŸ™‚', 'ğŸ˜', 'ğŸ˜£', 'ğŸ˜«'];
      moods.forEach(m => moodCounts[m] = 0);
      logs.forEach(l => {
        if (l.mood && moodCounts.hasOwnProperty(l.mood)) {
          moodCounts[l.mood]++;
        }
      });
      
      const totalMoods = Object.values(moodCounts).reduce((a, b) => a + b, 0);
      const moodAnalysis = document.getElementById('moodAnalysis');
      moodAnalysis.innerHTML = moods.map(mood => {
        const count = moodCounts[mood];
        const percent = totalMoods > 0 ? Math.round((count / totalMoods) * 100) : 0;
        return `
          <div class="mood-item">
            <div class="mood-emoji">${mood}</div>
            <div class="mood-count">${count}</div>
            <div class="mood-percent">${percent}%</div>
          </div>
        `;
      }).join('');
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
      updateStudyFilterOptions();
      
      // å…¨è¨˜éŒ²è¡¨ç¤º
      filterStudyRecords();
    }
    
    function renderDayOfWeekChart(logs) {
      const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const dayTotals = [0, 0, 0, 0, 0, 0, 0];
      const dayCounts = [0, 0, 0, 0, 0, 0, 0];
      
      logs.forEach(l => {
        const date = new Date(l.date);
        const day = date.getDay();
        dayTotals[day] += l.minutes || 0;
        dayCounts[day]++;
      });
      
      const dayAvgs = dayTotals.map((total, i) => dayCounts[i] > 0 ? Math.round(total / dayCounts[i]) : 0);
      
      const ctx = document.getElementById('dayOfWeekChart');
      if (!ctx) return;
      
      if (dayOfWeekChart) dayOfWeekChart.destroy();
      
      dayOfWeekChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dayNames,
          datasets: [{
            label: 'å¹³å‡å­¦ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰',
            data: dayAvgs,
            backgroundColor: '#5E81AC'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
    
    function updateStudyFilterOptions() {
      const logs = appData.studyLogs || [];
      const subjects = [...new Set(logs.map(l => l.subject))].filter(Boolean);
      
      const select = document.getElementById('studyFilterSubject');
      select.innerHTML = '<option value="">å…¨ç§‘ç›®</option>' + 
        subjects.map(s => `<option value="${s}">${s}</option>`).join('');
    }
    
    function filterStudyRecords() {
      const logs = appData.studyLogs || [];
      const subjectFilter = document.getElementById('studyFilterSubject').value;
      const periodFilter = document.getElementById('studyFilterPeriod').value;
      
      let filtered = [...logs];
      
      if (subjectFilter) {
        filtered = filtered.filter(l => l.subject === subjectFilter);
      }
      
      if (periodFilter !== 'all') {
        const days = parseInt(periodFilter);
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        filtered = filtered.filter(l => new Date(l.date) >= cutoff);
      }
      
      const container = document.getElementById('allStudyRecords');
      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">è©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = filtered.map(log => `
        <div class="record-item">
          <div class="record-main">
            <span class="record-subject">${log.subject}</span>
            <span class="record-time">${log.minutes}åˆ†</span>
          </div>
          <div class="record-sub">
            ${log.date} ${log.studyType ? `ãƒ»${log.studyType}` : ''} ${log.mood || ''}
          </div>
        </div>
      `).join('');
    }
    
    // ==========================================
    // éå»å•åˆ†æã‚¿ãƒ–
    // ==========================================
    
    function renderRedbookAnalysis() {
      const logs = appData.redbookLogs || [];
      if (logs.length === 0) return;
      
      // åŸºæœ¬çµ±è¨ˆ
      const totalCount = logs.length;
      const avgScore = Math.round(logs.reduce((sum, l) => sum + (l.score || 0), 0) / totalCount);
      const highScore = Math.max(...logs.map(l => l.score || 0));
      
      document.getElementById('redbookTotalCount').textContent = totalCount;
      document.getElementById('redbookAvgScore').textContent = avgScore + '%';
      document.getElementById('redbookHighScore').textContent = highScore + '%';
      
      // ãƒˆãƒ¬ãƒ³ãƒ‰è¨ˆç®—
      if (logs.length >= 2) {
        const sorted = [...logs].sort((a, b) => new Date(a.date) - new Date(b.date));
        const half = Math.floor(sorted.length / 2);
        const firstHalf = sorted.slice(0, half);
        const secondHalf = sorted.slice(half);
        const firstAvg = firstHalf.reduce((s, l) => s + l.score, 0) / firstHalf.length;
        const secondAvg = secondHalf.reduce((s, l) => s + l.score, 0) / secondHalf.length;
        
        if (secondAvg > firstAvg + 3) {
          document.getElementById('redbookTrend').textContent = 'ğŸ“ˆ';
        } else if (secondAvg < firstAvg - 3) {
          document.getElementById('redbookTrend').textContent = 'ğŸ“‰';
        } else {
          document.getElementById('redbookTrend').textContent = 'â¡ï¸';
        }
      }
      
      // ç§‘ç›®åˆ¥å¹³å‡
      const subjectScores = {};
      logs.forEach(l => {
        if (!subjectScores[l.subject]) {
          subjectScores[l.subject] = { total: 0, count: 0 };
        }
        subjectScores[l.subject].total += l.score || 0;
        subjectScores[l.subject].count++;
      });
      
      const subjectScoresEl = document.getElementById('subjectScores');
      subjectScoresEl.innerHTML = Object.entries(subjectScores)
        .map(([subject, data]) => {
          const avg = Math.round(data.total / data.count);
          return `
            <div class="breakdown-item">
              <span class="breakdown-label">${subject}</span>
              <div class="breakdown-bar-container">
                <div class="breakdown-bar" style="width: ${avg}%"></div>
              </div>
              <span class="breakdown-value">${avg}%</span>
            </div>
          `;
        }).join('');
      
      // å¤§å­¦åˆ¥å¹³å‡
      const univScores = {};
      logs.forEach(l => {
        if (!univScores[l.university]) {
          univScores[l.university] = { total: 0, count: 0 };
        }
        univScores[l.university].total += l.score || 0;
        univScores[l.university].count++;
      });
      
      const univScoresEl = document.getElementById('universityScores');
      univScoresEl.innerHTML = Object.entries(univScores)
        .map(([univ, data]) => {
          const avg = Math.round(data.total / data.count);
          return `
            <div class="breakdown-item">
              <span class="breakdown-label">${univ}</span>
              <div class="breakdown-bar-container">
                <div class="breakdown-bar" style="width: ${avg}%"></div>
              </div>
              <span class="breakdown-value">${avg}% (${data.count}å›)</span>
            </div>
          `;
        }).join('');
      
      // è‹¦æ‰‹åˆ†é‡
      const weakAreas = {};
      logs.forEach(l => {
        if (l.weakAreas) {
          l.weakAreas.split(/[,ã€]/).forEach(area => {
            const trimmed = area.trim();
            if (trimmed) {
              weakAreas[trimmed] = (weakAreas[trimmed] || 0) + 1;
            }
          });
        }
      });
      
      const weakAreasEl = document.getElementById('weakAreasList');
      const sortedWeakAreas = Object.entries(weakAreas).sort((a, b) => b[1] - a[1]);
      
      if (sortedWeakAreas.length === 0) {
        weakAreasEl.innerHTML = '<div class="empty-state">é–“é•ãˆãŸåˆ†é‡ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      } else {
        weakAreasEl.innerHTML = sortedWeakAreas.slice(0, 10).map(([area, count]) => {
          const severity = count >= 3 ? 'high' : count >= 2 ? 'medium' : '';
          return `
            <div class="weak-area-item ${severity}">
              <span class="weak-area-name">${area}</span>
              <span class="weak-area-count">${count}å›</span>
            </div>
          `;
        }).join('');
      }
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°
      updateRedbookFilterOptions();
      
      // å¾—ç‚¹æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆ
      updateScoreTrendChart();
      
      // å…¨è¨˜éŒ²è¡¨ç¤º
      filterRedbookRecords();
    }
    
    function updateRedbookFilterOptions() {
      const logs = appData.redbookLogs || [];
      const subjects = [...new Set(logs.map(l => l.subject))].filter(Boolean);
      const universities = [...new Set(logs.map(l => l.university))].filter(Boolean);
      
      const subjectSelect = document.getElementById('redbookFilterSubject');
      subjectSelect.innerHTML = '<option value="">å…¨ç§‘ç›®</option>' + 
        subjects.map(s => `<option value="${s}">${s}</option>`).join('');
      
      const univSelect = document.getElementById('redbookFilterUniv');
      univSelect.innerHTML = '<option value="">å…¨å¤§å­¦</option>' + 
        universities.map(u => `<option value="${u}">${u}</option>`).join('');
      
      const trendSelect = document.getElementById('scoreTrendSubject');
      trendSelect.innerHTML = '<option value="">å…¨ç§‘ç›®</option>' + 
        subjects.map(s => `<option value="${s}">${s}</option>`).join('');
    }
    
    function updateScoreTrendChart() {
      const logs = appData.redbookLogs || [];
      const subjectFilter = document.getElementById('scoreTrendSubject').value;
      
      let filtered = [...logs].sort((a, b) => new Date(a.date) - new Date(b.date));
      if (subjectFilter) {
        filtered = filtered.filter(l => l.subject === subjectFilter);
      }
      
      const ctx = document.getElementById('scoreTrendChart');
      if (!ctx) return;
      
      if (scoreTrendChart) scoreTrendChart.destroy();
      
      scoreTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: filtered.map(l => l.date),
          datasets: [{
            label: 'å¾—ç‚¹ç‡ï¼ˆ%ï¼‰',
            data: filtered.map(l => l.score),
            borderColor: '#BF616A',
            backgroundColor: 'rgba(191, 97, 106, 0.1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });
    }
    
    function filterRedbookRecords() {
      const logs = appData.redbookLogs || [];
      const subjectFilter = document.getElementById('redbookFilterSubject').value;
      const univFilter = document.getElementById('redbookFilterUniv').value;
      
      let filtered = [...logs];
      
      if (subjectFilter) {
        filtered = filtered.filter(l => l.subject === subjectFilter);
      }
      if (univFilter) {
        filtered = filtered.filter(l => l.university === univFilter);
      }
      
      const container = document.getElementById('allRedbookRecords');
      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">è©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = filtered.map(log => `
        <div class="record-item">
          <div class="record-main">
            <span class="record-subject">${log.university} ${log.subject}</span>
            <span class="record-score">${log.score}%</span>
          </div>
          <div class="record-sub">
            ${log.date} ãƒ» ${log.year}å¹´åº¦ ${log.time ? `ãƒ»${log.time}åˆ†` : ''}
          </div>
          ${log.sectionScores ? `<div class="record-detail">${log.sectionScores}</div>` : ''}
        </div>
      `).join('');
    }
    
    // ==========================================
    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãƒ¡ã‚¤ãƒ³
    // ==========================================
    
    function generatePrompt() {
      const preview = document.getElementById('promptPreview');
      const logs = appData.studyLogs || [];
      const redbookLogs = appData.redbookLogs || [];
      const profile = appData.profile || {};
      const goals = appData.goals || [];
      
      // é«˜åº¦ãªåˆ†æã‚’å®Ÿè¡Œ
      const analysis = analyzeStudyData(logs, redbookLogs, goals, profile);
      
      let prompt = '';
      
      switch (selectedAIType) {
        case 'weekly':
          prompt = generateWeeklyPrompt(analysis);
          break;
        case 'daily':
          prompt = generateDailyPrompt(analysis, logs, redbookLogs);
          break;
        case 'comprehensive':
          prompt = generateComprehensivePrompt(analysis);
          break;
        case 'growth':
          prompt = generateGrowthPrompt(analysis);
          break;
        case 'weakness':
          prompt = generateWeaknessPrompt(analysis);
          break;
        case 'redbook':
          prompt = generateRedbookPrompt(analysis);
          break;
        case 'university':
          prompt = generateUniversityPrompt(analysis);
          break;
        case 'prediction':
          prompt = generatePredictionPrompt(analysis);
          break;
        case 'subject':
          prompt = generateSubjectPrompt(analysis);
          break;
        case 'lastspurt':
          prompt = generateLastSpurtPrompt(analysis);
          break;
        case 'motivation':
          prompt = generateMotivationPrompt(analysis);
          break;
        case 'section':
          prompt = generateSectionPrompt(analysis);
          break;
        case 'efficiency':
          prompt = generateEfficiencyPrompt(analysis);
          break;
      }
      
      preview.textContent = prompt;
    }
    
    // ==========================================
    // é€±é–“è¨ˆç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generateWeeklyPrompt(a) {
      const { profile, daysUntil, weekMinutes, prevWeekMinutes, weekTrend, streak,
              subjectAnalysis, typePercentage, typeBalanceAssessment,
              redbookAnalysis, goalAnalysis, risks, strengths, strongDays, weakDays } = a;
      
      let p = `ã‚ãªãŸã¯å¤§å­¦å—é¨“å°‚é–€ã®å­¦ç¿’ã‚³ãƒ¼ãƒã§ã™ã€‚ä»¥ä¸‹ã®å—é¨“ç”Ÿã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€æ¥é€±ã®æœ€é©ãªå­¦ç¿’è¨ˆç”»ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

---

# ğŸ“‹ å—é¨“ç”Ÿãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}`;
      if (profile['ç¬¬2å¿—æœ›']) p += `
**ä½µé¡˜æ ¡**: ${profile['ç¬¬2å¿—æœ›']}${profile['ç¬¬3å¿—æœ›'] ? 'ã€' + profile['ç¬¬3å¿—æœ›'] : ''}`;
      p += `
**è©¦é¨“ã¾ã§**: ${daysUntil}æ—¥ï¼ˆç´„${Math.ceil(daysUntil / 7)}é€±é–“ï¼‰
**é€£ç¶šå­¦ç¿’æ—¥æ•°**: ${streak}æ—¥

---

# ğŸ“Š å­¦ç¿’ãƒ‡ãƒ¼ã‚¿åˆ†æ

## ä»Šé€±ã®å­¦ç¿’å®Ÿç¸¾

**ç·å­¦ç¿’æ™‚é–“**: ${formatMinutes(weekMinutes)}`;
      if (prevWeekMinutes > 0) {
        const change = weekMinutes - prevWeekMinutes;
        const changeStr = change >= 0 ? `+${formatMinutes(change)}` : `-${formatMinutes(Math.abs(change))}`;
        p += `ï¼ˆå…ˆé€±æ¯”: ${changeStr} ${weekTrend === 'up' ? 'ğŸ“ˆ' : weekTrend === 'down' ? 'ğŸ“‰' : 'â¡ï¸'}ï¼‰`;
      }
      
      p += `\n\n### ç§‘ç›®åˆ¥å†…è¨³\n`;
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        if (data.weekMinutes > 0) {
          const pct = Math.round(data.weekMinutes / weekMinutes * 100);
          const trendIcon = data.trend === 'increasing' ? 'â†‘' : data.trend === 'decreasing' ? 'â†“' : 'â†’';
          p += `- **${cat}**: ${formatMinutes(data.weekMinutes)}ï¼ˆ${pct}%ï¼‰${trendIcon}\n`;
          
          // ã‚¿ã‚¤ãƒ—å†…è¨³ãŒã‚ã‚Œã°
          if (Object.keys(data.typeBreakdown).length > 0) {
            const types = Object.entries(data.typeBreakdown)
              .map(([t, m]) => `${t}${Math.round(m / data.weekMinutes * 100)}%`)
              .join(' / ');
            p += `  â”” ${types}\n`;
          }
        }
      });
      
      p += `\n### å­¦ç¿’ã‚¿ã‚¤ãƒ—ãƒãƒ©ãƒ³ã‚¹\n`;
      Object.entries(typePercentage).forEach(([type, pct]) => {
        if (pct > 0) {
          const bar = 'â–ˆ'.repeat(Math.round(pct / 10)) + 'â–‘'.repeat(10 - Math.round(pct / 10));
          p += `- ${type}: ${bar} ${pct}%\n`;
        }
      });
      
      if (typeBalanceAssessment.length > 0) {
        p += `\nâš ï¸ **ãƒãƒ©ãƒ³ã‚¹èª²é¡Œ**: ${typeBalanceAssessment.join('ã€')}\n`;
      }
      
      p += `\n### å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³\n`;
      p += `- ã‚ˆãå‹‰å¼·ã™ã‚‹æ›œæ—¥: **${strongDays.join('ãƒ»')}æ›œæ—¥**\n`;
      p += `- å­¦ç¿’ãŒå°‘ãªã„æ›œæ—¥: **${weakDays.join('ãƒ»')}æ›œæ—¥**\n`;
      
      if (goalAnalysis.length > 0) {
        p += `\n## ç›®æ¨™ã¨ç¾çŠ¶\n\n`;
        goalAnalysis.forEach(g => {
          const icon = g.feasibility === 'likely' ? 'ğŸŸ¢' : g.feasibility === 'possible' ? 'ğŸŸ¡' : 'ğŸ”´';
          p += `### ${g.subject} ${icon}\n`;
          p += `- ç¾çŠ¶: ${g.current}% â†’ ç›®æ¨™: ${g.target}%ï¼ˆ**+${g.gap}ptå¿…è¦**ï¼‰\n`;
          p += `- æœ€ä½ãƒ©ã‚¤ãƒ³: ${g.must}%\n`;
          if (g.recentScore !== g.current) {
            p += `- ç›´è¿‘ã®éå»å•: ${g.recentScore}%\n`;
          }
          p += `\n`;
        });
      }
      
      if (redbookAnalysis.totalAttempts > 0) {
        p += `## éå»å•æ¼”ç¿’çŠ¶æ³\n\n`;
        p += `- æ¼”ç¿’å›æ•°: ${redbookAnalysis.totalAttempts}å›ï¼ˆç´¯è¨ˆ${formatMinutes(redbookAnalysis.totalTime)}ï¼‰\n`;
        p += `- å¹³å‡å¾—ç‚¹ç‡: ${redbookAnalysis.avgScore}%\n`;
        p += `- å¾—ç‚¹å‚¾å‘: ${redbookAnalysis.scoreTrend === 'improving' ? 'ğŸ“ˆ ä¸Šæ˜‡ä¸­' : redbookAnalysis.scoreTrend === 'declining' ? 'ğŸ“‰ ä¸‹é™æ°—å‘³' : 'â¡ï¸ å®‰å®š'}\n`;
        
        // å¤§å­¦åˆ¥ã‚µãƒãƒªãƒ¼
        const uniKeys = Object.keys(redbookAnalysis.universityAnalysis);
        if (uniKeys.length > 0) {
          p += `\n### å¤§å­¦åˆ¥æˆç¸¾\n`;
          uniKeys.forEach(uni => {
            const uniData = redbookAnalysis.universityAnalysis[uni];
            const trendIcon = uniData.trend === 'improving' ? 'â†‘' : uniData.trend === 'declining' ? 'â†“' : 'â†’';
            p += `- **${uni}**: å¹³å‡${uniData.avgScore}%ï¼ˆ${uniData.attempts}å›ï¼‰${trendIcon}\n`;
          });
        }
        
        if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
          const topWeak = Object.entries(redbookAnalysis.weakAreasSummary)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
          p += `\n**ç¹°ã‚Šè¿”ã—é–“é•ãˆã‚‹åˆ†é‡**:\n`;
          topWeak.forEach(([area, count]) => {
            p += `- âš ï¸ ${area}ï¼ˆ${count}å›ï¼‰\n`;
          });
        }
      }
      
      if (strengths.length > 0) {
        p += `\n## ğŸ’ª å¼·ã¿\n`;
        strengths.forEach(s => p += `- ${s.message}\n`);
      }
      
      if (risks.length > 0) {
        p += `\n## âš ï¸ èª²é¡Œãƒ»ãƒªã‚¹ã‚¯\n`;
        risks.forEach(r => {
          const icon = r.severity === 'high' ? 'ğŸ”´' : r.severity === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
          p += `- ${icon} ${r.message}\n`;
        });
      }
      
      p += `
---

# ğŸ¯ ç›¸è«‡å†…å®¹

ä¸Šè¨˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¸ã¾ãˆã€**æ¥é€±ã®å…·ä½“çš„ãªå­¦ç¿’è¨ˆç”»**ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **ç¾çŠ¶ã®ç·åˆè©•ä¾¡**ï¼ˆ3è¡Œç¨‹åº¦ï¼‰
   - ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ç§ã®å­¦ç¿’çŠ¶æ³ã®ç‰¹å¾´

2. **æ¥é€±ã®é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆ**ï¼ˆå„ªå…ˆåº¦é †ã«3ã¤ï¼‰
   - ä½•ã«æ³¨åŠ›ã™ã¹ãã‹ã€ãªãœã‹

3. **1é€±é–“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ¡ˆ**
   - æ›œæ—¥ã”ã¨ã®å­¦ç¿’å†…å®¹ã¨æ™‚é–“é…åˆ†
   - ç§ã®å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ${strongDays.join('ãƒ»')}æ›œæ—¥ãŒå¼·ã„ï¼‰ã‚’è€ƒæ…®

4. **ç§‘ç›®åˆ¥ã®å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹**
   - è‹¦æ‰‹åˆ†é‡ã¸ã®å¯¾ç­–æ–¹æ³•
   - ä½¿ç”¨ã™ã¹ãæ•™æã‚„å‹‰å¼·æ³•

5. **æ¥é€±æœ«ã®ç›®æ¨™**
   - é”æˆã™ã¹ãå…·ä½“çš„ãªãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³`;
      
      return p;
    }
    
    // ==========================================
    // ç·åˆè¨ºæ–­ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæ–°è¦è¿½åŠ ï¼‰
    // ==========================================
    
    function generateComprehensivePrompt(a) {
      const { profile, daysUntil, totalMinutes, weekMinutes, prevWeekMinutes, streak, studyDays,
              subjectAnalysis, typePercentage, typeBalanceAssessment, redbookAnalysis, 
              goalAnalysis, risks, strengths, growthAnalysis, comprehensiveScore,
              strongDays, weakDays, dayOfWeekAvg } = a;
      
      let p = `ã‚ãªãŸã¯å¤§å­¦å—é¨“å°‚é–€ã®å­¦ç¿’ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®å—é¨“ç”Ÿã®ãƒ‡ãƒ¼ã‚¿ã‚’ç·åˆçš„ã«åˆ†æã—ã€è©³ç´°ãªè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

---

# ğŸ“ ç·åˆè¨ºæ–­ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

## å—é¨“ç”Ÿãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}`;
      if (profile['ç¬¬2å¿—æœ›']) p += `
**ä½µé¡˜æ ¡**: ${profile['ç¬¬2å¿—æœ›']}${profile['ç¬¬3å¿—æœ›'] ? 'ã€' + profile['ç¬¬3å¿—æœ›'] : ''}`;
      p += `
**è©¦é¨“ã¾ã§**: ${daysUntil}æ—¥ï¼ˆç´„${Math.ceil(daysUntil / 7)}é€±é–“ï¼‰

---

# ğŸ“Š ç¾åœ¨ã®ç·åˆã‚¹ã‚³ã‚¢

**ç·åˆè©•ä¾¡: ${comprehensiveScore.total}ç‚¹ / 100ç‚¹ï¼ˆ${comprehensiveScore.grade}ãƒ©ãƒ³ã‚¯ï¼‰**

| é …ç›® | ã‚¹ã‚³ã‚¢ |
|------|--------|`;
      Object.entries(comprehensiveScore.breakdown).forEach(([item, score]) => {
        const bar = 'â–ˆ'.repeat(Math.round(score / 2.5)) + 'â–‘'.repeat(10 - Math.round(score / 2.5));
        p += `
| ${item} | ${bar} ${score}/25 |`;
      });
      
      p += `

---

# ğŸ“ˆ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿è©³ç´°

## å­¦ç¿’é‡ã®æ¨ç§»

**ä»Šé€±ã®ç·å­¦ç¿’æ™‚é–“**: ${formatMinutes(weekMinutes)}`;
      if (prevWeekMinutes > 0) {
        const change = weekMinutes - prevWeekMinutes;
        const changePercent = Math.round(change / prevWeekMinutes * 100);
        p += ` (å…ˆé€±æ¯”: ${change >= 0 ? '+' : ''}${formatMinutes(change)}ã€${changePercent >= 0 ? '+' : ''}${changePercent}%)`;
      }
      p += `
**ç´¯è¨ˆå­¦ç¿’æ™‚é–“**: ${formatMinutes(totalMinutes)}ï¼ˆ${studyDays}æ—¥é–“ï¼‰
**é€£ç¶šå­¦ç¿’æ—¥æ•°**: ${streak}æ—¥
**1æ—¥å¹³å‡**: ${growthAnalysis.weekPattern.avgDailyMinutes}åˆ†

## å­¦ç¿’ç¿’æ…£ã‚¹ã‚³ã‚¢: ${growthAnalysis.habitScore}ç‚¹ / 100ç‚¹

**è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆ**:`;
      growthAnalysis.habitFactors.forEach(factor => {
        p += `
- âœ… ${factor}`;
      });
      
      p += `

## ç§‘ç›®åˆ¥å­¦ç¿’çŠ¶æ³

`;
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        if (data.totalMinutes > 0 || data.weekMinutes > 0) {
          const trendIcon = data.trend === 'increasing' ? 'ğŸ“ˆ' : data.trend === 'decreasing' ? 'ğŸ“‰' : 'â¡ï¸';
          p += `### ${cat} ${trendIcon}
- ä»Šé€±: ${formatMinutes(data.weekMinutes)} / ç´¯è¨ˆ: ${formatMinutes(data.totalMinutes)}
- ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: ${data.sessionCount}å›`;
          
          // æ‰‹å¿œãˆ
          const totalMood = Object.values(data.moodBreakdown).reduce((a, b) => a + b, 0);
          if (totalMood > 0) {
            const goodRate = Math.round((data.moodBreakdown.excellent + data.moodBreakdown.good) / totalMood * 100);
            p += `
- æ‰‹å¿œãˆ: ğŸ˜ŠğŸ™‚ ${goodRate}% / ğŸ˜•ğŸ˜« ${100 - goodRate}%`;
          }
          
          // æœ€è¿‘ã®å­¦ç¿’å˜å…ƒ
          if (data.recentUnits && data.recentUnits.length > 0) {
            p += `
- æœ€è¿‘ã®å˜å…ƒ: ${data.recentUnits.slice(0, 3).join('ã€')}`;
          }
          p += `

`;
        }
      });
      
      p += `## å­¦ç¿’ã‚¿ã‚¤ãƒ—ãƒãƒ©ãƒ³ã‚¹

`;
      Object.entries(typePercentage).forEach(([type, pct]) => {
        if (pct > 0) {
          const bar = 'â–ˆ'.repeat(Math.round(pct / 10)) + 'â–‘'.repeat(10 - Math.round(pct / 10));
          p += `- ${type}: ${bar} ${pct}%
`;
        }
      });
      
      if (typeBalanceAssessment.length > 0) {
        p += `
âš ï¸ **ãƒãƒ©ãƒ³ã‚¹ä¸Šã®èª²é¡Œ**: ${typeBalanceAssessment.join('ã€')}
`;
      }
      
      p += `
## å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ

**æ›œæ—¥åˆ¥å¹³å‡å­¦ç¿’æ™‚é–“**:
`;
      Object.entries(dayOfWeekAvg).forEach(([day, min]) => {
        const bar = 'â–“'.repeat(Math.round(min / 30));
        p += `- ${day}æ›œ: ${bar} ${min}åˆ†
`;
      });
      
      p += `
- æœ€ã‚‚é›†ä¸­ã§ãã‚‹æ›œæ—¥: **${strongDays.join('ãƒ»')}æ›œæ—¥**
- å­¦ç¿’ãŒå°‘ãªã„æ›œæ—¥: **${weakDays.join('ãƒ»')}æ›œæ—¥**
- ãƒ‘ã‚¿ãƒ¼ãƒ³ä¸€è²«æ€§: ${growthAnalysis.weekPattern.consistency}%
`;
      
      if (redbookAnalysis.totalAttempts > 0) {
        p += `
## éå»å•æ¼”ç¿’åˆ†æ

**æ¼”ç¿’å›æ•°**: ${redbookAnalysis.totalAttempts}å›
**ç´¯è¨ˆæ™‚é–“**: ${formatMinutes(redbookAnalysis.totalTime)}
**å¹³å‡å¾—ç‚¹ç‡**: ${redbookAnalysis.avgScore}%
**å¾—ç‚¹å‚¾å‘**: ${redbookAnalysis.scoreTrend === 'improving' ? 'ğŸ“ˆ ä¸Šæ˜‡ä¸­' : redbookAnalysis.scoreTrend === 'declining' ? 'ğŸ“‰ ä¸‹é™ä¸­' : 'â¡ï¸ å®‰å®š'}

`;
        // ç§‘ç›®åˆ¥
        if (Object.keys(redbookAnalysis.scoresBySubject).length > 0) {
          p += `**ç§‘ç›®åˆ¥å¹³å‡**:
`;
          Object.entries(redbookAnalysis.scoresBySubject).forEach(([subj, score]) => {
            p += `- ${subj}: ${score}%
`;
          });
        }
        
        // è‹¦æ‰‹åˆ†é‡
        if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
          const topWeak = Object.entries(redbookAnalysis.weakAreasSummary)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
          p += `
**é »å‡ºã®è‹¦æ‰‹åˆ†é‡**:
`;
          topWeak.forEach(([area, count]) => {
            p += `- âš ï¸ ${area}ï¼ˆ${count}å›å‡ºç¾ï¼‰
`;
          });
        }
      }
      
      if (goalAnalysis.length > 0) {
        p += `
## ç›®æ¨™é”æˆçŠ¶æ³

`;
        goalAnalysis.forEach(g => {
          const icon = g.feasibility === 'likely' ? 'ğŸŸ¢' : g.feasibility === 'possible' ? 'ğŸŸ¡' : 'ğŸ”´';
          p += `**${g.subject}** ${icon}
- ç¾çŠ¶: ${g.current}% â†’ ç›®æ¨™: ${g.target}%ï¼ˆ**+${g.gap}ptå¿…è¦**ï¼‰
- é”æˆå¯èƒ½æ€§: ${g.feasibility === 'likely' ? 'é«˜ã„' : g.feasibility === 'possible' ? 'å¯èƒ½' : 'è¦åŠªåŠ›'}

`;
        });
      }
      
      if (strengths.length > 0) {
        p += `## ğŸ’ª å¼·ã¿ãƒ»è‰¯ã„ç‚¹
`;
        strengths.forEach(s => p += `- ${s.message}
`);
      }
      
      if (risks.length > 0) {
        p += `
## âš ï¸ èª²é¡Œãƒ»æ”¹å–„ç‚¹
`;
        risks.forEach(r => {
          const icon = r.severity === 'high' ? 'ğŸ”´' : r.severity === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
          p += `- ${icon} ${r.message}
`;
        });
      }
      
      p += `
---

# ğŸ¯ ç›¸è«‡å†…å®¹

ä¸Šè¨˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç·åˆçš„ã«åˆ†æã—ã€ä»¥ä¸‹ã®å½¢å¼ã§**è©³ç´°ãªè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ**ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **ç·åˆè©•ä¾¡**ï¼ˆ5æ®µéšã§è©•å®š + 200å­—ç¨‹åº¦ã®ã‚µãƒãƒªãƒ¼ï¼‰
   - ç¾åœ¨ã®å­¦ç¿’çŠ¶æ³ã‚’å®¢è¦³çš„ã«è©•ä¾¡
   - æœ€ã‚‚è‰¯ã„ç‚¹ã¨æœ€ã‚‚æ”¹å–„ã™ã¹ãç‚¹

2. **å­¦ç¿’ç¿’æ…£ã®è¨ºæ–­**
   - ç¶™ç¶šæ€§ã€å­¦ç¿’é‡ã€ãƒãƒ©ãƒ³ã‚¹ã®è©•ä¾¡
   - æ›œæ—¥åˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰è¦‹ãˆã‚‹æ”¹å–„ç‚¹
   - å…·ä½“çš„ãªç¿’æ…£æ”¹å–„ã®ææ¡ˆ

3. **ç§‘ç›®åˆ¥ã®è©³ç´°åˆ†æ**
   - å„ç§‘ç›®ã®ç¾çŠ¶ã¨èª²é¡Œ
   - æ‰‹å¿œãˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¦‹ãˆã‚‹å¿ƒç†é¢ã®åˆ†æ
   - å„ªå…ˆçš„ã«å–ã‚Šçµ„ã‚€ã¹ãç§‘ç›®ã¨ç†ç”±

4. **éå»å•æ¼”ç¿’ã®è©•ä¾¡**ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼‰
   - å¾—ç‚¹å‚¾å‘ã®åˆ†æ
   - è‹¦æ‰‹åˆ†é‡ã¸ã®å¯¾ç­–ææ¡ˆ
   - ä»Šå¾Œã®æ¼”ç¿’è¨ˆç”»

5. **ç›®æ¨™é”æˆã«å‘ã‘ãŸãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—**
   - æ®‹ã‚Š${daysUntil}æ—¥ã§ä½•ã‚’ã™ã¹ãã‹
   - é€±å˜ä½ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³
   - ç¾å®Ÿçš„ãªç›®æ¨™è¨­å®šã®ææ¡ˆ

6. **ä»Šã™ãå®Ÿè¡Œã™ã¹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³3ã¤**
   - å„ªå…ˆåº¦é †ã«å…·ä½“çš„ãªè¡Œå‹•ã‚’æç¤º`;
      
      return p;
    }
    
    // ==========================================
    // æˆé•·åˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæ–°è¦è¿½åŠ ï¼‰
    // ==========================================
    
    function generateGrowthPrompt(a) {
      const { profile, daysUntil, totalMinutes, weekMinutes, prevWeekMinutes, streak, studyDays,
              subjectAnalysis, redbookAnalysis, growthAnalysis, comprehensiveScore,
              strongDays, weakDays, dayOfWeekAvg } = a;
      
      let p = `ã‚ãªãŸã¯å­¦ç¿’ãƒ‡ãƒ¼ã‚¿åˆ†æã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®å—é¨“ç”Ÿã®æˆé•·ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€æˆé•·ã‚’åŠ é€Ÿã•ã›ã‚‹ãŸã‚ã®å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚

---

# ğŸ“ˆ æˆé•·åˆ†æãƒªã‚¯ã‚¨ã‚¹ãƒˆ

## åŸºæœ¬æƒ…å ±

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}
**è©¦é¨“ã¾ã§**: ${daysUntil}æ—¥
**é€£ç¶šå­¦ç¿’æ—¥æ•°**: ${streak}æ—¥
**ç·å­¦ç¿’æ—¥æ•°**: ${studyDays}æ—¥

---

# ğŸ”„ å­¦ç¿’é‡ã®æ¨ç§»

**ä»Šé€± vs å…ˆé€±**:
- ä»Šé€±: ${formatMinutes(weekMinutes)}
- å…ˆé€±: ${formatMinutes(prevWeekMinutes)}
- å¤‰åŒ–: ${growthAnalysis.volumeGrowth >= 0 ? '+' : ''}${growthAnalysis.volumeGrowth}%

**ç´¯è¨ˆå­¦ç¿’æ™‚é–“**: ${formatMinutes(totalMinutes)}

---

# ğŸ† å­¦ç¿’ç¿’æ…£ã‚¹ã‚³ã‚¢: ${growthAnalysis.habitScore}ç‚¹ / 100ç‚¹

**å†…è¨³**:
`;
      
      // ç¿’æ…£ã‚¹ã‚³ã‚¢ã®è©³ç´°
      const habitCategories = [
        { name: 'ç¶™ç¶šæ€§', max: 30, desc: 'æ¯æ—¥ã®å­¦ç¿’ç¿’æ…£' },
        { name: 'å­¦ç¿’é‡', max: 25, desc: 'é€±é–“ã®å­¦ç¿’æ™‚é–“' },
        { name: 'ãƒãƒ©ãƒ³ã‚¹', max: 20, desc: 'è¤‡æ•°ç§‘ç›®ã®å­¦ç¿’' },
        { name: 'å®šç€åº¦', max: 15, desc: 'å¾©ç¿’ãƒ»æ¼”ç¿’ã®å®Ÿæ–½' },
        { name: 'å®Ÿæˆ¦åŠ›', max: 10, desc: 'éå»å•æ¼”ç¿’' }
      ];
      
      habitCategories.forEach(cat => {
        p += `- ${cat.name}ï¼ˆ${cat.desc}ï¼‰: /${cat.max}ç‚¹
`;
      });
      
      p += `
**è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆ**:
`;
      if (growthAnalysis.habitFactors.length > 0) {
        growthAnalysis.habitFactors.forEach(factor => {
          p += `âœ… ${factor}
`;
        });
      } else {
        p += `ï¼ˆã¾ã ååˆ†ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰
`;
      }
      
      p += `
---

# ğŸ“Š ç§‘ç›®åˆ¥ã®æˆé•·çŠ¶æ³

`;
      Object.entries(growthAnalysis.subjectGrowth).forEach(([cat, data]) => {
        if (data.weekMinutes > 0 || data.prevWeekMinutes > 0) {
          const trendIcon = data.growth === 'increasing' ? 'ğŸ“ˆ' : data.growth === 'decreasing' ? 'ğŸ“‰' : 'â¡ï¸';
          p += `## ${cat} ${trendIcon}

- **ä»Šé€±**: ${formatMinutes(data.weekMinutes)}
- **å…ˆé€±**: ${formatMinutes(data.prevWeekMinutes)}
- **å¤‰åŒ–**: ${data.changePercent >= 0 ? '+' : ''}${data.changePercent}%
- **æ‰‹å¿œãˆè‰¯å¥½ç‡**: ${data.goodMoodRate}%`;
          
          if (data.recentUnits && data.recentUnits.length > 0) {
            p += `
- **æœ€è¿‘å­¦ç¿’ã—ãŸå˜å…ƒ**: ${data.recentUnits.join('ã€')}`;
          }
          p += `

`;
        }
      });
      
      p += `---

# ğŸ“… å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ

## æ›œæ—¥åˆ¥ã®å­¦ç¿’æ™‚é–“ï¼ˆå¹³å‡ï¼‰

`;
      const maxDayMin = Math.max(...Object.values(dayOfWeekAvg));
      Object.entries(dayOfWeekAvg).forEach(([day, min]) => {
        const barLength = maxDayMin > 0 ? Math.round(min / maxDayMin * 20) : 0;
        const bar = 'â–ˆ'.repeat(barLength) + 'â–‘'.repeat(20 - barLength);
        p += `${day}æ›œ: ${bar} ${min}åˆ†
`;
      });
      
      p += `
**æœ€ã‚‚é›†ä¸­ã§ãã‚‹æ›œæ—¥**: ${strongDays.join('ãƒ»')}æ›œæ—¥
**å­¦ç¿’ãŒå°‘ãªã„æ›œæ—¥**: ${weakDays.join('ãƒ»')}æ›œæ—¥

## ãƒ‘ã‚¿ãƒ¼ãƒ³ä¸€è²«æ€§ã‚¹ã‚³ã‚¢: ${growthAnalysis.weekPattern.consistency}%

ï¼ˆé«˜ã„ã»ã©æ¯æ—¥å‡ç­‰ã«å­¦ç¿’ã§ãã¦ã„ã‚‹ï¼‰
`;
      
      if (redbookAnalysis.totalAttempts > 0) {
        p += `
---

# ğŸ“• éå»å•æ¼”ç¿’ã®æˆé•·

**æ¼”ç¿’å›æ•°**: ${redbookAnalysis.totalAttempts}å›
**å¹³å‡å¾—ç‚¹ç‡**: ${redbookAnalysis.avgScore}%
**å¾—ç‚¹å‚¾å‘**: ${redbookAnalysis.scoreTrend === 'improving' ? 'ğŸ“ˆ ä¸Šæ˜‡ä¸­ï¼' : redbookAnalysis.scoreTrend === 'declining' ? 'ğŸ“‰ ä¸‹é™ä¸­ï¼ˆè¦æ³¨æ„ï¼‰' : 'â¡ï¸ å®‰å®š'}

`;
        // æœˆåˆ¥é€²æ—ãŒã‚ã‚Œã°è¡¨ç¤º
        if (Object.keys(redbookAnalysis.monthlyProgress).length > 1) {
          p += `**æœˆåˆ¥ã®æ¨ç§»**:
`;
          Object.entries(redbookAnalysis.monthlyProgress)
            .sort((a, b) => a[0].localeCompare(b[0]))
            .slice(-3)
            .forEach(([month, data]) => {
              p += `- ${month}: ${data.attempts}å›æ¼”ç¿’ã€å¹³å‡${data.avgScore}%
`;
            });
        }
        
        if (Object.keys(redbookAnalysis.scoresBySubject).length > 0) {
          p += `
**ç§‘ç›®åˆ¥ã®å¾—ç‚¹ç‡**:
`;
          Object.entries(redbookAnalysis.scoresBySubject).forEach(([subj, score]) => {
            const scoreBar = 'â–ˆ'.repeat(Math.round(score / 10)) + 'â–‘'.repeat(10 - Math.round(score / 10));
            p += `- ${subj}: ${scoreBar} ${score}%
`;
          });
        }
      }
      
      p += `
---

# ğŸ¯ ç›¸è«‡å†…å®¹

ä¸Šè¨˜ã®æˆé•·ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€**æˆé•·ã‚’åŠ é€Ÿã•ã›ã‚‹ãŸã‚ã®å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹**ã‚’ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **æˆé•·çŠ¶æ³ã®è©•ä¾¡**
   - è‰¯ã„æˆé•·ãŒè¦‹ã‚‰ã‚Œã‚‹ç‚¹
   - åœæ»ã¾ãŸã¯å¾Œé€€ã—ã¦ã„ã‚‹ç‚¹
   - ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¦‹ãˆã‚‹ç§ã®å­¦ç¿’ã‚¹ã‚¿ã‚¤ãƒ«ã®ç‰¹å¾´

2. **å­¦ç¿’ç¿’æ…£ã®æ”¹å–„ææ¡ˆ**
   - ç¿’æ…£ã‚¹ã‚³ã‚¢ã‚’ä¸Šã’ã‚‹ãŸã‚ã®å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
   - æ›œæ—¥åˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ´»ã‹ã—ãŸå­¦ç¿’è¨ˆç”»
   - ç¶™ç¶šæ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã®ã‚³ãƒ„

3. **ç§‘ç›®åˆ¥ã®æˆé•·æˆ¦ç•¥**
   - å„ç§‘ç›®ã®æˆé•·ç‡ã‚’ä¸Šã’ã‚‹ãŸã‚ã®æ–¹æ³•
   - æ‰‹å¿œãˆãŒæ‚ªã„ç§‘ç›®ã¸ã®å¯¾å‡¦æ³•
   - åŠ¹ç‡çš„ãªæ™‚é–“é…åˆ†ã®ææ¡ˆ

4. **éå»å•æ¼”ç¿’ã®æ”¹å–„ç‚¹**ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼‰
   - å¾—ç‚¹ã‚’ä¸Šã’ã‚‹ãŸã‚ã®å…·ä½“çš„ãªå¯¾ç­–
   - æ¼”ç¿’é »åº¦ã‚„æ–¹æ³•ã®æ”¹å–„ææ¡ˆ

5. **æ¬¡ã®2é€±é–“ã§é”æˆã™ã¹ãæˆé•·ç›®æ¨™**
   - å®šé‡çš„ãªç›®æ¨™ï¼ˆå­¦ç¿’æ™‚é–“ã€å¾—ç‚¹ç‡ãªã©ï¼‰
   - å®šæ€§çš„ãªç›®æ¨™ï¼ˆç¿’æ…£ã€ãƒ¡ãƒ³ã‚¿ãƒ«ãªã©ï¼‰

6. **ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ç¶­æŒã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹**
   - ç§ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¦‹ãˆã‚‹å¼·ã¿ã‚’æ´»ã‹ã™æ–¹æ³•
   - æˆé•·ã‚’å®Ÿæ„Ÿã™ã‚‹ãŸã‚ã®ãƒã‚¤ãƒ³ãƒˆ`;
      
      return p;
    }
    
    // ==========================================
    // ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generateDailyPrompt(a, allLogs, allRedbookLogs) {
      const { profile, daysUntil, weekMinutes, streak, subjectAnalysis } = a;
      const redbookLogs = allRedbookLogs || [];
      const today = new Date();
      const todayStr = formatDateLocal(today);
      const todayLogs = allLogs.filter(log => log.date === todayStr);
      const todayRedbookLogs = redbookLogs.filter(log => log.date === todayStr);
      const todayStudyMinutes = todayLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      const todayRedbookMinutes = todayRedbookLogs.reduce((sum, log) => sum + (log.time || 0), 0);
      const todayMinutes = todayStudyMinutes + todayRedbookMinutes;
      
      // æ˜¨æ—¥ã®ãƒ­ã‚°
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = formatDateLocal(yesterday);
      const yesterdayLogs = allLogs.filter(log => log.date === yesterdayStr);
      const yesterdayRedbookLogs = redbookLogs.filter(log => log.date === yesterdayStr);
      const yesterdayMinutes = yesterdayLogs.reduce((sum, log) => sum + (log.minutes || 0), 0)
                             + yesterdayRedbookLogs.reduce((sum, log) => sum + (log.time || 0), 0);
      
      let p = `ã‚ãªãŸã¯å¤§å­¦å—é¨“å°‚é–€ã®å­¦ç¿’ã‚³ãƒ¼ãƒã§ã™ã€‚ä»Šæ—¥ã®å­¦ç¿’ã‚’æŒ¯ã‚Šè¿”ã‚Šã€æ˜æ—¥ä»¥é™ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚

---

# ğŸ“… ä»Šæ—¥ã®å­¦ç¿’è¨˜éŒ²

**æ—¥ä»˜**: ${todayStr}ï¼ˆè©¦é¨“ã¾ã§ã‚ã¨${daysUntil}æ—¥ï¼‰
**æœ¬æ—¥ã®ç·å­¦ç¿’æ™‚é–“**: ${formatMinutes(todayMinutes)}`;
      
      if (todayStudyMinutes > 0 && todayRedbookMinutes > 0) {
        p += `ï¼ˆå­¦ç¿’${formatMinutes(todayStudyMinutes)} + éå»å•${formatMinutes(todayRedbookMinutes)}ï¼‰`;
      }
      
      if (yesterdayMinutes > 0) {
        const diff = todayMinutes - yesterdayMinutes;
        p += `
**æ˜¨æ—¥æ¯”**: ${diff >= 0 ? '+' : ''}${formatMinutes(diff)} ${diff > 0 ? 'ğŸ“ˆ' : diff < 0 ? 'ğŸ“‰' : 'â¡ï¸'}`;
      }
      
      p += `
**ä»Šé€±ã®ç´¯è¨ˆ**: ${formatMinutes(weekMinutes)}
**é€£ç¶šå­¦ç¿’æ—¥æ•°**: ${streak}æ—¥

`;
      
      if (todayLogs.length > 0) {
        p += `## ğŸ“š å­¦ç¿’å†…å®¹ã®è©³ç´°\n\n`;
        todayLogs.forEach(log => {
          const moodText = {
            'ğŸ˜Š': 'çµ¶å¥½èª¿',
            'ğŸ™‚': 'å¥½èª¿',
            'ğŸ˜': 'æ™®é€š',
            'ğŸ˜•': 'è‹¦æˆ¦',
            'ğŸ˜«': 'ã‹ãªã‚Šè‹¦æˆ¦'
          };
          
          p += `### ${log.subject}ï¼ˆ${log.minutes}åˆ†ï¼‰\n`;
          if (log.studyType) p += `- ã‚¿ã‚¤ãƒ—: ${log.studyType}\n`;
          if (log.unit) p += `- ç¯„å›²: ${log.unit}\n`;
          if (log.textbook) p += `- æ•™æ: ${log.textbook}\n`;
          if (log.mood) p += `- æ‰‹å¿œãˆ: ${log.mood} ${moodText[log.mood] || ''}\n`;
          if (log.memo) p += `- ãƒ¡ãƒ¢: ã€Œ${log.memo}ã€\n`;
          p += `\n`;
        });
        
        // æ‰‹å¿œãˆåˆ†æ
        const excellent = todayLogs.filter(l => l.mood === 'ğŸ˜Š').map(l => l.subject);
        const struggling = todayLogs.filter(l => l.mood === 'ğŸ˜«' || l.mood === 'ğŸ˜•').map(l => l.subject);
        
        if (excellent.length > 0 || struggling.length > 0) {
          p += `## ä»Šæ—¥ã®æ‰‹å¿œãˆ\n`;
          if (excellent.length > 0) p += `- âœ¨ å¥½èª¿: ${excellent.join('ã€')}\n`;
          if (struggling.length > 0) p += `- ğŸ’¦ è‹¦æˆ¦: ${struggling.join('ã€')}\n`;
          p += `\n`;
        }
      }
      
      // ä»Šæ—¥ã®éå»å•æ¼”ç¿’
      if (todayRedbookLogs.length > 0) {
        p += `## ğŸ“• ä»Šæ—¥ã®éå»å•æ¼”ç¿’\n\n`;
        todayRedbookLogs.forEach(log => {
          const scoreIcon = log.score >= 70 ? 'ğŸŸ¢' : log.score >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
          p += `### ${log.university} ${log.subject || ''} ${log.year}å¹´\n`;
          p += `- å¾—ç‚¹ç‡: ${scoreIcon} **${log.score}%**\n`;
          if (log.time) p += `- è§£ç­”æ™‚é–“: ${log.time}åˆ†\n`;
          if (log.sectionScores) p += `- å¤§å•åˆ¥: ${log.sectionScores}\n`;
          if (log.weakAreas) p += `- âš ï¸ é–“é•ãˆãŸåˆ†é‡: **${log.weakAreas}**\n`;
          if (log.memo) p += `- æŒ¯ã‚Šè¿”ã‚Š: ${log.memo}\n`;
          p += `\n`;
        });
      }
      
      if (todayLogs.length === 0 && todayRedbookLogs.length === 0) {
        p += `## ä»Šæ—¥ã®å­¦ç¿’\n\n`;
        p += `â€»ã¾ã ä»Šæ—¥ã®å­¦ç¿’è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n\n`;
      }
      
      p += `---

# ğŸ¯ ç›¸è«‡å†…å®¹

ä»Šæ—¥ã®å­¦ç¿’ã‚’æŒ¯ã‚Šè¿”ã£ã¦ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨æ˜æ—¥ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **ä»Šæ—¥ã®è©•ä¾¡**ï¼ˆâ—/â—‹/â–³/Ã—ï¼‰
   - è‰¯ã‹ã£ãŸç‚¹ã¨æ”¹å–„ç‚¹

2. **è‹¦æˆ¦ã—ãŸéƒ¨åˆ†ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹**
   - å…·ä½“çš„ãªå…‹æœæ–¹æ³•

3. **æ˜æ—¥ã®å­¦ç¿’ãƒ—ãƒ©ãƒ³**
   - ãŠã™ã™ã‚ã®ç§‘ç›®ãƒ»å†…å®¹ãƒ»æ™‚é–“é…åˆ†
   - ä»Šæ—¥ã®ç¶šãã§ã‚„ã‚‹ã¹ãã“ã¨

4. **ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿ã¤ä¸€è¨€**`;
      
      return p;
    }
    
    // ==========================================
    // å¼±ç‚¹åˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generateWeaknessPrompt(a) {
      const { profile, daysUntil, redbookAnalysis, goalAnalysis, subjectAnalysis, redbookLogs } = a;
      
      let p = `ã‚ãªãŸã¯å¤§å­¦å—é¨“ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¼±ç‚¹ã‚’åˆ†æã—ã€åŠ¹ç‡çš„ãªå¯¾ç­–ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

---

# ğŸ“‹ åŸºæœ¬æƒ…å ±

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}
**è©¦é¨“ã¾ã§**: ${daysUntil}æ—¥

`;
      
      if (goalAnalysis.length > 0) {
        p += `# ğŸ“Š ç›®æ¨™ã¨ç¾çŠ¶ã®ã‚®ãƒ£ãƒƒãƒ—\n\n`;
        p += `| ç§‘ç›® | ç¾çŠ¶ | ç›®æ¨™ | ã‚®ãƒ£ãƒƒãƒ— | é”æˆè¦‹è¾¼ã¿ |\n`;
        p += `|------|------|------|----------|------------|\n`;
        goalAnalysis.forEach(g => {
          const status = g.feasibility === 'likely' ? 'ğŸŸ¢ é”æˆåœå†…' : 
                         g.feasibility === 'possible' ? 'ğŸŸ¡ åŠªåŠ›æ¬¡ç¬¬' : 'ğŸ”´ è¦é›†ä¸­å¯¾ç­–';
          p += `| ${g.subject} | ${g.current}% | ${g.target}% | +${g.gap}pt | ${status} |\n`;
        });
        p += `\n`;
      }
      
      if (redbookLogs.length > 0) {
        p += `# ğŸ“ éå»å•ãƒ»æ¨¡è©¦ã®å…¨çµæœ\n\n`;
        redbookLogs.forEach(log => {
          const scoreIcon = log.score >= 70 ? 'ğŸŸ¢' : log.score >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
          p += `## ${log.date} ${log.university} ${log.subject || ''} ${log.year}å¹´\n`;
          p += `- å¾—ç‚¹ç‡: ${scoreIcon} **${log.score}%**\n`;
          if (log.time) p += `- è§£ç­”æ™‚é–“: ${log.time}åˆ†\n`;
          if (log.sectionScores) p += `- å¤§å•åˆ¥: ${log.sectionScores}\n`;
          if (log.weakAreas) p += `- âš ï¸ é–“é•ãˆãŸåˆ†é‡: **${log.weakAreas}**\n`;
          if (log.memo) p += `- ãƒ¡ãƒ¢: ${log.memo}\n`;
          p += `\n`;
        });
      }
      
      if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
        p += `# ğŸ”´ ç¹°ã‚Šè¿”ã—é–“é•ãˆã‚‹åˆ†é‡ï¼ˆè¦é‡ç‚¹å¯¾ç­–ï¼‰\n\n`;
        const sorted = Object.entries(redbookAnalysis.weakAreasSummary)
          .sort((a, b) => b[1] - a[1]);
        
        p += `| åˆ†é‡ | å‡ºç¾å›æ•° | æ·±åˆ»åº¦ |\n`;
        p += `|------|----------|--------|\n`;
        sorted.forEach(([area, count]) => {
          const severity = count >= 3 ? 'ğŸ”´ é«˜' : count >= 2 ? 'ğŸŸ¡ ä¸­' : 'ğŸŸ¢ ä½';
          p += `| ${area} | ${count}å› | ${severity} |\n`;
        });
        p += `\n`;
      }
      
      p += `# ğŸ“ˆ ç§‘ç›®åˆ¥ã®å­¦ç¿’çŠ¶æ³\n\n`;
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        if (data.totalMinutes > 0) {
          const goodRate = data.sessionCount > 0 
            ? Math.round((data.moodBreakdown.excellent + data.moodBreakdown.good) / data.sessionCount * 100)
            : 0;
          const badRate = data.sessionCount > 0
            ? Math.round((data.moodBreakdown.bad + data.moodBreakdown.terrible) / data.sessionCount * 100)
            : 0;
          
          p += `## ${cat}\n`;
          p += `- ç´¯è¨ˆå­¦ç¿’æ™‚é–“: ${formatMinutes(data.totalMinutes)}\n`;
          p += `- å­¦ç¿’å›æ•°: ${data.sessionCount}å›\n`;
          p += `- æ‰‹å¿œãˆ: å¥½èª¿${goodRate}% / è‹¦æˆ¦${badRate}%\n`;
          if (redbookAnalysis.scoresBySubject[cat]) {
            p += `- éå»å•å¹³å‡: ${redbookAnalysis.scoresBySubject[cat]}%\n`;
          }
          p += `\n`;
        }
      });
      
      p += `---

# ğŸ¯ åˆ†æãƒªã‚¯ã‚¨ã‚¹ãƒˆ

ä¸Šè¨˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’è©³ç´°ã«åˆ†æã—ã€å¼±ç‚¹å…‹æœã®ãŸã‚ã®æˆ¦ç•¥ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **å¼±ç‚¹ã®å„ªå…ˆé †ä½ä»˜ã‘**
   - æœ€ã‚‚å¯¾ç­–ãŒå¿…è¦ãªåˆ†é‡TOP3ã¨ãã®ç†ç”±
   - è©¦é¨“ã¸ã®å½±éŸ¿åº¦ã¨æ”¹å–„ã®é›£æ˜“åº¦

2. **å¼±ç‚¹ã®æ ¹æœ¬åŸå› ã®åˆ†æ**
   - ãªãœãã®åˆ†é‡ã§é–“é•ã„ãŒå¤šã„ã®ã‹
   - çŸ¥è­˜ä¸è¶³ãªã®ã‹ã€è§£æ³•ãƒ‘ã‚¿ãƒ¼ãƒ³ãªã®ã‹ã€æ™‚é–“ç®¡ç†ãªã®ã‹

3. **å…·ä½“çš„ãªå¯¾ç­–ãƒ—ãƒ©ãƒ³**
   - å„å¼±ç‚¹ã«å¯¾ã™ã‚‹å…·ä½“çš„ãªå‹‰å¼·æ³•
   - ä½¿ã†ã¹ãæ•™æã‚„å‚è€ƒæ›¸
   - 1æ—¥ã‚ãŸã‚Šã®ç›®å®‰æ™‚é–“

4. **æ®‹ã‚Š${daysUntil}æ—¥ã§ã®ç¾å®Ÿçš„ãªç›®æ¨™**
   - ã©ã“ã¾ã§æ”¹å–„ã§ããã†ã‹
   - å„ªå…ˆã—ã¦æ¨ã¦ã‚‹ã¹ãåˆ†é‡ãŒã‚ã‚Œã°

5. **å­¦ç¿’åŠ¹ç‡ã‚’ä¸Šã’ã‚‹ã‚³ãƒ„**
   - åŒã˜ãƒŸã‚¹ã‚’ç¹°ã‚Šè¿”ã•ãªã„ãŸã‚ã®æ–¹æ³•`;
      
      return p;
    }
    
    // ==========================================
    // ç§‘ç›®åˆ¥ç›¸è«‡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generateSubjectPrompt(a) {
      const selectedSubject = document.getElementById('aiSubjectSelect').value;
      if (!selectedSubject) {
        return 'â†‘ä¸Šã®ã€Œç›¸è«‡ã—ãŸã„ç§‘ç›®ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
      }
      
      const { profile, daysUntil, subjectAnalysis, redbookAnalysis, goalAnalysis, redbookLogs, weekLogs } = a;
      const subjectData = subjectAnalysis[selectedSubject] || {};
      const subjectGoal = goalAnalysis.find(g => g.subject === selectedSubject);
      const subjectRedbook = redbookLogs.filter(l => categorizeSubject(l.subject) === selectedSubject);
      const subjectWeekLogs = weekLogs.filter(l => categorizeSubject(l.subject) === selectedSubject);
      
      // ç§‘ç›®åˆ¥ã®è‹¦æ‰‹åˆ†é‡
      const weakAreas = {};
      subjectRedbook.forEach(log => {
        if (log.weakAreas) {
          log.weakAreas.split(/[,ã€]/).forEach(area => {
            const trimmed = area.trim();
            if (trimmed) weakAreas[trimmed] = (weakAreas[trimmed] || 0) + 1;
          });
        }
      });
      
      let p = `ã‚ãªãŸã¯${selectedSubject}å°‚é–€ã®å—é¨“ã‚³ãƒ¼ãƒã§ã™ã€‚ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€${selectedSubject}ã®æˆç¸¾å‘ä¸Šã®ãŸã‚ã®å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚

---

# ğŸ“‹ åŸºæœ¬æƒ…å ±

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}
**è©¦é¨“ã¾ã§**: ${daysUntil}æ—¥
**ç›¸è«‡ç§‘ç›®**: ${selectedSubject}

`;
      
      if (subjectGoal) {
        p += `# ğŸ¯ ç›®æ¨™è¨­å®š\n\n`;
        p += `- **ç¾çŠ¶**: ${subjectGoal.current}%\n`;
        p += `- **ç›®æ¨™**: ${subjectGoal.target}%ï¼ˆ+${subjectGoal.gap}ptå¿…è¦ï¼‰\n`;
        p += `- **æœ€ä½ãƒ©ã‚¤ãƒ³**: ${subjectGoal.must}%\n`;
        p += `- **é”æˆè¦‹è¾¼ã¿**: ${subjectGoal.feasibility === 'likely' ? 'ğŸŸ¢ é”æˆåœå†…' : subjectGoal.feasibility === 'possible' ? 'ğŸŸ¡ åŠªåŠ›æ¬¡ç¬¬' : 'ğŸ”´ è¦é›†ä¸­å¯¾ç­–'}\n\n`;
      }
      
      p += `# ğŸ“Š å­¦ç¿’ãƒ‡ãƒ¼ã‚¿\n\n`;
      p += `**ç´¯è¨ˆå­¦ç¿’æ™‚é–“**: ${formatMinutes(subjectData.totalMinutes || 0)}\n`;
      p += `**ä»Šé€±ã®å­¦ç¿’æ™‚é–“**: ${formatMinutes(subjectData.weekMinutes || 0)}\n`;
      p += `**å­¦ç¿’å›æ•°**: ${subjectData.sessionCount || 0}å›\n`;
      p += `**å‚¾å‘**: ${subjectData.trend === 'increasing' ? 'ğŸ“ˆ å¢—åŠ ä¸­' : subjectData.trend === 'decreasing' ? 'ğŸ“‰ æ¸›å°‘ä¸­' : 'â¡ï¸ å®‰å®š'}\n\n`;
      
      if (Object.keys(subjectData.typeBreakdown || {}).length > 0) {
        p += `## å­¦ç¿’ã‚¿ã‚¤ãƒ—ã®å†…è¨³\n`;
        Object.entries(subjectData.typeBreakdown).forEach(([type, min]) => {
          p += `- ${type}: ${formatMinutes(min)}\n`;
        });
        p += `\n`;
      }
      
      if (Object.keys(subjectData.textbooks || {}).length > 0) {
        p += `## ä½¿ç”¨æ•™æ\n`;
        Object.entries(subjectData.textbooks)
          .sort((a, b) => b[1] - a[1])
          .forEach(([book, min]) => {
            p += `- ${book}: ${formatMinutes(min)}\n`;
          });
        p += `\n`;
      }
      
      if (subjectWeekLogs.length > 0) {
        p += `## ä»Šé€±ã®å­¦ç¿’å†…å®¹\n`;
        subjectWeekLogs.forEach(log => {
          p += `- ${log.date}: ${log.subject} ${log.minutes}åˆ†`;
          if (log.mood) p += ` ${log.mood}`;
          if (log.unit) p += ` [${log.unit}]`;
          if (log.memo) p += ` â†’ ${log.memo}`;
          p += `\n`;
        });
        p += `\n`;
      }
      
      if (subjectRedbook.length > 0) {
        p += `## éå»å•æ¼”ç¿’çµæœ\n\n`;
        subjectRedbook.forEach(log => {
          p += `### ${log.university} ${log.year}å¹´ï¼ˆ${log.date}ï¼‰\n`;
          p += `- å¾—ç‚¹ç‡: **${log.score}%**\n`;
          if (log.time) p += `- è§£ç­”æ™‚é–“: ${log.time}åˆ†\n`;
          if (log.sectionScores) p += `- å¤§å•åˆ¥: ${log.sectionScores}\n`;
          if (log.weakAreas) p += `- é–“é•ãˆãŸåˆ†é‡: ${log.weakAreas}\n`;
          if (log.memo) p += `- æŒ¯ã‚Šè¿”ã‚Š: ${log.memo}\n`;
          p += `\n`;
        });
      }
      
      if (Object.keys(weakAreas).length > 0) {
        p += `## âš ï¸ ã‚ˆãé–“é•ãˆã‚‹åˆ†é‡\n`;
        Object.entries(weakAreas)
          .sort((a, b) => b[1] - a[1])
          .forEach(([area, count]) => {
            p += `- **${area}**: ${count}å›\n`;
          });
        p += `\n`;
      }
      
      // æ‰‹å¿œãˆåˆ†æ
      if (subjectData.moodBreakdown) {
        const mb = subjectData.moodBreakdown;
        const total = mb.excellent + mb.good + mb.neutral + mb.bad + mb.terrible;
        if (total > 0) {
          p += `## æ‰‹å¿œãˆã®å‚¾å‘\n`;
          p += `- ğŸ˜Š çµ¶å¥½èª¿: ${mb.excellent}å›\n`;
          p += `- ğŸ™‚ å¥½èª¿: ${mb.good}å›\n`;
          p += `- ğŸ˜ æ™®é€š: ${mb.neutral}å›\n`;
          p += `- ğŸ˜• è‹¦æˆ¦: ${mb.bad}å›\n`;
          p += `- ğŸ˜« ã‹ãªã‚Šè‹¦æˆ¦: ${mb.terrible}å›\n\n`;
        }
      }
      
      p += `---

# ğŸ¯ ç›¸è«‡å†…å®¹

${selectedSubject}ã®æˆç¸¾ã‚’åŠ¹ç‡çš„ã«ä¸Šã’ã‚‹ãŸã‚ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **ç¾çŠ¶è¨ºæ–­**
   - ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¦‹ãˆã‚‹ç§ã®${selectedSubject}ã®ç‰¹å¾´
   - å¼·ã¿ã¨å¼±ã¿ã®åˆ†æ

2. **é‡ç‚¹å¯¾ç­–åˆ†é‡**ï¼ˆ3ã¤ï¼‰
   - å„ªå…ˆåº¦ã®é«˜ã„é †ã«
   - ãªãœãã®åˆ†é‡ã‚’é‡è¦–ã™ã¹ãã‹

3. **å…·ä½“çš„ãªå­¦ç¿’ãƒ—ãƒ©ãƒ³**
   - 1æ—¥ã®${selectedSubject}å­¦ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¾‹
   - 1é€±é–“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ¡ˆ

4. **æ•™æãƒ»å‹‰å¼·æ³•ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹**
   - ç¾åœ¨ä½¿ç”¨ä¸­ã®æ•™æã¸ã®è©•ä¾¡
   - è¿½åŠ ã§ä½¿ã†ã¹ãæ•™æãŒã‚ã‚Œã°

5. **ç›®æ¨™é”æˆã¸ã®é“ç­‹**
   - æ®‹ã‚Š${daysUntil}æ—¥ã§${subjectGoal ? `+${subjectGoal.gap}pt` : 'ç›®æ¨™'}é”æˆã™ã‚‹ãŸã‚ã«`;
      
      return p;
    }
    
    // ==========================================
    // ç›´å‰æœŸå¯¾ç­–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generateLastSpurtPrompt(a) {
      const { profile, daysUntil, weekMinutes, totalMinutes, streak, studyDays,
              redbookAnalysis, goalAnalysis, risks, subjectAnalysis } = a;
      
      const avgDailyMinutes = studyDays > 0 ? Math.round(totalMinutes / studyDays) : 0;
      const remainingStudyTime = avgDailyMinutes * daysUntil;
      
      let p = `ã‚ãªãŸã¯å¤§å­¦å—é¨“ã®ç›´å‰æœŸå¯¾ç­–ã®ã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆã§ã™ã€‚æ®‹ã‚Šæ—¥æ•°ã‚’è€ƒæ…®ã—ãŸç¾å®Ÿçš„ãªå¯¾ç­–ãƒ—ãƒ©ãƒ³ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

---

# â° æ®‹ã‚Šæ™‚é–“

**è©¦é¨“ã¾ã§**: âš ï¸ **${daysUntil}æ—¥**ï¼ˆç´„${Math.ceil(daysUntil / 7)}é€±é–“ï¼‰
**æ¨å®šå¯èƒ½å­¦ç¿’æ™‚é–“**: ç´„${formatMinutes(remainingStudyTime)}
ï¼ˆ1æ—¥å¹³å‡${formatMinutes(avgDailyMinutes)}ã§è¨ˆç®—ï¼‰

---

# ğŸ“‹ å—é¨“ç”Ÿã®çŠ¶æ³

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}`;
      if (profile['ç¬¬2å¿—æœ›']) p += `
**ä½µé¡˜æ ¡**: ${profile['ç¬¬2å¿—æœ›']}${profile['ç¬¬3å¿—æœ›'] ? 'ã€' + profile['ç¬¬3å¿—æœ›'] : ''}`;
      p += `

**ã“ã‚Œã¾ã§ã®å®Ÿç¸¾**:
- ç´¯è¨ˆå­¦ç¿’æ™‚é–“: ${formatMinutes(totalMinutes)}
- å­¦ç¿’æ—¥æ•°: ${studyDays}æ—¥
- é€£ç¶šå­¦ç¿’: ${streak}æ—¥
- ç›´è¿‘1é€±é–“: ${formatMinutes(weekMinutes)}

`;
      
      if (goalAnalysis.length > 0) {
        p += `# ğŸ¯ ç›®æ¨™ã¨ç¾çŠ¶\n\n`;
        p += `| ç§‘ç›® | ç¾çŠ¶ | ç›®æ¨™ | å¿…è¦ãªä¼¸ã³ | é”æˆé›£æ˜“åº¦ |\n`;
        p += `|------|------|------|------------|------------|\n`;
        goalAnalysis.forEach(g => {
          const difficulty = g.feasibility === 'likely' ? 'â˜…â˜†â˜†' : 
                            g.feasibility === 'possible' ? 'â˜…â˜…â˜†' : 'â˜…â˜…â˜…';
          p += `| ${g.subject} | ${g.current}% | ${g.target}% | +${g.gap}pt | ${difficulty} |\n`;
        });
        p += `\n`;
      }
      
      if (redbookAnalysis.totalAttempts > 0) {
        p += `# ğŸ“ éå»å•æ¼”ç¿’ã®ç¾çŠ¶\n\n`;
        p += `- æ¼”ç¿’å›æ•°: ${redbookAnalysis.totalAttempts}å›\n`;
        p += `- å¹³å‡å¾—ç‚¹ç‡: **${redbookAnalysis.avgScore}%**\n`;
        p += `- å¾—ç‚¹å‚¾å‘: ${redbookAnalysis.scoreTrend === 'improving' ? 'ğŸ“ˆ ä¸Šæ˜‡ä¸­ï¼ˆè‰¯ã„å‚¾å‘ï¼‰' : redbookAnalysis.scoreTrend === 'declining' ? 'ğŸ“‰ ä¸‹é™æ°—å‘³ï¼ˆè¦å¯¾ç­–ï¼‰' : 'â¡ï¸ å®‰å®š'}\n\n`;
        
        if (Object.keys(redbookAnalysis.scoresBySubject).length > 0) {
          p += `**ç§‘ç›®åˆ¥å¹³å‡**:\n`;
          Object.entries(redbookAnalysis.scoresBySubject).forEach(([cat, score]) => {
            const icon = score >= 70 ? 'ğŸŸ¢' : score >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
            p += `- ${cat}: ${icon} ${score}%\n`;
          });
          p += `\n`;
        }
        
        if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
          p += `**ç¹°ã‚Šè¿”ã—é–“é•ãˆã‚‹åˆ†é‡ï¼ˆç›´å‰æœŸã§å¿…ãšå¯¾ç­–ï¼‰**:\n`;
          Object.entries(redbookAnalysis.weakAreasSummary)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .forEach(([area, count]) => {
              p += `- ğŸ”´ ${area}ï¼ˆ${count}å›ï¼‰\n`;
            });
          p += `\n`;
        }
      }
      
      if (risks.length > 0) {
        p += `# âš ï¸ ç¾åœ¨ã®ãƒªã‚¹ã‚¯è¦å› \n\n`;
        risks.forEach(r => {
          const icon = r.severity === 'high' ? 'ğŸ”´' : r.severity === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
          p += `- ${icon} ${r.message}\n`;
        });
        p += `\n`;
      }
      
      p += `# ğŸ“Š ç§‘ç›®åˆ¥ã®ä»•ä¸ŠãŒã‚Šåº¦\n\n`;
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        if (data.totalMinutes > 0) {
          const score = redbookAnalysis.scoresBySubject[cat] || 'æœªæ¸¬å®š';
          const goalData = goalAnalysis.find(g => g.subject === cat);
          const status = typeof score === 'number' 
            ? (goalData && score >= goalData.target ? 'ğŸŸ¢ ç›®æ¨™åœå†…' : score >= 50 ? 'ğŸŸ¡ ã‚‚ã†ä¸€æ¯' : 'ğŸ”´ è¦å¼·åŒ–')
            : 'âšª è¦æ¼”ç¿’';
          p += `- **${cat}**: ${status}ï¼ˆéå»å•å¹³å‡: ${score}${typeof score === 'number' ? '%' : ''}ï¼‰\n`;
        }
      });
      
      p += `
---

# ğŸ¯ ç›¸è«‡å†…å®¹

æ®‹ã‚Š${daysUntil}æ—¥ã§åˆæ ¼ã‚’å‹ã¡å–ã‚‹ãŸã‚ã®**ç›´å‰æœŸå¯¾ç­–ãƒ—ãƒ©ãƒ³**ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **ã‚„ã‚‹ã“ã¨ãƒ»ã‚„ã‚‰ãªã„ã“ã¨ã®åˆ¤æ–­**
   - æ®‹ã‚Šæ™‚é–“ã§å„ªå…ˆã™ã¹ãã“ã¨
   - æ€ã„åˆ‡ã£ã¦æ¨ã¦ã‚‹ã¹ãã“ã¨

2. **ç›´å‰æœŸã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**
   - ã€œ1é€±é–“å‰: ã‚„ã‚‹ã¹ãã“ã¨
   - ç›´å‰3æ—¥é–“: ã‚„ã‚‹ã¹ãã“ã¨
   - å‰æ—¥: ã‚„ã‚‹ã¹ãã“ã¨

3. **ç§‘ç›®åˆ¥ã®æ™‚é–“é…åˆ†**
   - 1æ—¥ã‚ãŸã‚Šã®ç†æƒ³çš„ãªé…åˆ†

4. **å¼±ç‚¹ã¸ã®å¯¾å‡¦æ³•**
   - ä»Šã‹ã‚‰é–“ã«åˆã†å¯¾ç­–
   - æœ¬ç•ªã§é¿ã‘ã‚‹ã¹ãå•é¡Œ

5. **è©¦é¨“æœ¬ç•ªã®æˆ¦ç•¥**
   - æ™‚é–“é…åˆ†
   - è§£ãé †ç•ª
   - ãƒ‘ãƒ‹ãƒƒã‚¯æ™‚ã®å¯¾å‡¦æ³•

6. **ãƒ¡ãƒ³ã‚¿ãƒ«ç®¡ç†**
   - ä¸å®‰ã¨ã®ä»˜ãåˆã„æ–¹
   - ç›´å‰æœŸã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ç¶­æŒ`;
      
      return p;
    }
    
    // ==========================================
    // ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generateMotivationPrompt(a) {
      const { profile, daysUntil, totalMinutes, studyDays, streak, weekMinutes,
              subjectAnalysis, strengths, redbookAnalysis } = a;
      
      const totalHours = Math.floor(totalMinutes / 60);
      
      // ãƒã‚¸ãƒ†ã‚£ãƒ–ãªå®Ÿç¸¾ã‚’æŠ½å‡º
      const achievements = [];
      if (streak >= 3) achievements.push(`${streak}æ—¥é€£ç¶šã§å­¦ç¿’ã‚’ç¶™ç¶š`);
      if (totalHours >= 50) achievements.push(`ç´¯è¨ˆ${totalHours}æ™‚é–“ä»¥ä¸Šã®å­¦ç¿’`);
      if (studyDays >= 14) achievements.push(`${studyDays}æ—¥é–“ã‚³ãƒ„ã‚³ãƒ„åŠªåŠ›`);
      if (redbookAnalysis.scoreTrend === 'improving') achievements.push('éå»å•ã®å¾—ç‚¹ãŒä¸Šæ˜‡å‚¾å‘');
      
      // è‹¦æˆ¦ã—ã¦ã„ã‚‹éƒ¨åˆ†
      const struggles = [];
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        const badRate = data.sessionCount > 0
          ? (data.moodBreakdown.bad + data.moodBreakdown.terrible) / data.sessionCount
          : 0;
        if (badRate > 0.4) struggles.push(`${cat}ã§è‹¦æˆ¦ã™ã‚‹ã“ã¨ãŒå¤šã„`);
      });
      
      let p = `ã‚ãªãŸã¯å—é¨“ç”Ÿã®ãƒ¡ãƒ³ã‚¿ãƒ«ã‚µãƒãƒ¼ãƒˆã®å°‚é–€å®¶ã§ã™ã€‚æ¸©ã‹ãã€ã§ã‚‚ç¾å®Ÿçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã§ç§ã‚’åŠ±ã¾ã—ã¦ãã ã•ã„ã€‚

---

# ğŸ‘¤ ç§ã«ã¤ã„ã¦

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}
**è©¦é¨“ã¾ã§**: ã‚ã¨${daysUntil}æ—¥

---

# ğŸ“Š ã“ã‚Œã¾ã§ã®åŠªåŠ›

**æ•°å­—ã§è¦‹ã‚‹ç§ã®é ‘å¼µã‚Š**:
- ğŸ• ç´¯è¨ˆå­¦ç¿’æ™‚é–“: **${totalHours}æ™‚é–“${totalMinutes % 60}åˆ†**
- ğŸ“… å­¦ç¿’ã—ãŸæ—¥æ•°: **${studyDays}æ—¥**
- ğŸ”¥ é€£ç¶šå­¦ç¿’æ—¥æ•°: **${streak}æ—¥**
- ğŸ“ˆ ç›´è¿‘1é€±é–“: ${formatMinutes(weekMinutes)}

`;
      
      if (achievements.length > 0) {
        p += `**ç§ã®å®Ÿç¸¾**:\n`;
        achievements.forEach(a => p += `- âœ¨ ${a}\n`);
        p += `\n`;
      }
      
      if (strengths.length > 0) {
        p += `**å¼·ã¿**:\n`;
        strengths.forEach(s => p += `- ğŸ’ª ${s.message}\n`);
        p += `\n`;
      }
      
      p += `---

# ğŸ˜” ä»Šã®æ°—æŒã¡

æ­£ç›´ã«è¨€ã†ã¨ã€æœ€è¿‘ã“ã‚“ãªæ°—æŒã¡ãŒã‚ã‚Šã¾ã™ï¼š

- è©¦é¨“ãŒè¿‘ã¥ã„ã¦ãã¦ã€æ¼ ç„¶ã¨ã—ãŸä¸å®‰ãŒã‚ã‚‹
- æœ¬å½“ã«è‡ªåˆ†ãŒåˆæ ¼ã§ãã‚‹ã®ã‹è‡ªä¿¡ãŒæŒã¦ãªã„
- å‘¨ã‚Šã®å—é¨“ç”Ÿã¨æ¯”ã¹ã¦ç„¦ã£ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚‹
- å‹‰å¼·ã—ã¦ã‚‚æˆæœãŒè¦‹ãˆã«ããã¦ã€ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸‹ãŒã‚‹æ™‚ãŒã‚ã‚‹
`;
      
      if (struggles.length > 0) {
        p += `- ${struggles.join('\n- ')}\n`;
      }
      
      p += `
ã§ã‚‚ã€${profile['ç¬¬1å¿—æœ›'] || 'å¿—æœ›æ ¡'}ã«çµ¶å¯¾ã«åˆæ ¼ã—ãŸã„ã¨ã„ã†æ°—æŒã¡ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚

---

# ğŸ¯ ãŠé¡˜ã„

ä»Šã¾ã§ã®åŠªåŠ›ã‚’èªã‚ã¦ã»ã—ã„ã§ã™ã€‚ãã—ã¦ã€æ®‹ã‚Š${daysUntil}æ—¥ã‚’ä¹—ã‚Šåˆ‡ã‚‹ãŸã‚ã®åŠ›ã‚’ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **ç§ã®åŠªåŠ›ã¸ã®è©•ä¾¡**
   - ${totalHours}æ™‚é–“ã¨ã„ã†æ•°å­—ã®æ„å‘³
   - ${streak}æ—¥é€£ç¶šã¨ã„ã†ç¶™ç¶šã®ä¾¡å€¤
   - å…·ä½“çš„ã«è¤’ã‚ã¦ã»ã—ã„

2. **æ¸©ã‹ã„åŠ±ã¾ã—ã®è¨€è‘‰**
   - ä¸å®‰ã‚’å’Œã‚‰ã’ã‚‹è¨€è‘‰
   - è‡ªä¿¡ã‚’æŒã¦ã‚‹ã‚ˆã†ãªè¨€è‘‰

3. **ä¸å®‰ã¨ã®å‘ãåˆã„æ–¹**
   - å—é¨“ç”Ÿãªã‚‰èª°ã‚‚ãŒæ„Ÿã˜ã‚‹ä¸å®‰ã§ã‚ã‚‹ã“ã¨
   - å…·ä½“çš„ãªãƒ¡ãƒ³ã‚¿ãƒ«ç®¡ç†ã®ã‚³ãƒ„

4. **æ®‹ã‚Š${daysUntil}æ—¥ã®éã”ã—æ–¹**
   - ç„¡ç†ãªãç¶šã‘ã‚‰ã‚Œã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹
   - ç„¦ã‚‰ãªã„ãŸã‚ã®è€ƒãˆæ–¹

5. **åˆæ ¼ã—ãŸæœªæ¥ã®ã‚¤ãƒ¡ãƒ¼ã‚¸**
   - å¿—æœ›æ ¡ã«é€šã†è‡ªåˆ†ã‚’æƒ³åƒã•ã›ã¦ã»ã—ã„
   - æœ€å¾Œã«ã€åŠ›å¼·ã„å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’`;
      
      return p;
    }
    
    // ==========================================
    // å¾—ç‚¹äºˆæ¸¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generatePredictionPrompt(a) {
      const { profile, daysUntil, totalMinutes, studyDays, weekMinutes,
              subjectAnalysis, redbookAnalysis, goalAnalysis, redbookLogs } = a;
      
      // ç§‘ç›®åˆ¥ã®éå»å•ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†
      const subjectScoreHistory = {};
      redbookLogs.forEach(log => {
        const cat = categorizeSubject(log.subject);
        if (!subjectScoreHistory[cat]) {
          subjectScoreHistory[cat] = [];
        }
        subjectScoreHistory[cat].push({
          date: log.date,
          university: log.university,
          year: log.year,
          score: log.score,
          weakAreas: log.weakAreas
        });
      });
      
      // å„ç§‘ç›®ã®æˆé•·ç‡ã‚’è¨ˆç®—
      const growthAnalysis = {};
      Object.entries(subjectScoreHistory).forEach(([cat, scores]) => {
        if (scores.length >= 2) {
          // æ™‚ç³»åˆ—é †ã«ã‚½ãƒ¼ãƒˆï¼ˆå¤ã„é †ï¼‰
          const sorted = [...scores].sort((a, b) => new Date(a.date) - new Date(b.date));
          const firstHalf = sorted.slice(0, Math.ceil(sorted.length / 2));
          const secondHalf = sorted.slice(Math.ceil(sorted.length / 2));
          
          const firstAvg = firstHalf.reduce((s, l) => s + l.score, 0) / firstHalf.length;
          const secondAvg = secondHalf.reduce((s, l) => s + l.score, 0) / secondHalf.length;
          const growth = secondAvg - firstAvg;
          
          growthAnalysis[cat] = {
            firstAvg: Math.round(firstAvg),
            secondAvg: Math.round(secondAvg),
            growth: Math.round(growth),
            trend: growth > 3 ? 'improving' : growth < -3 ? 'declining' : 'stable',
            sampleSize: scores.length
          };
        }
      });
      
      // å­¦ç¿’æ™‚é–“ã¨ç§‘ç›®ã®é–¢ä¿‚
      const studyTimeBySubject = {};
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        studyTimeBySubject[cat] = {
          total: data.totalMinutes,
          weekly: data.weekMinutes,
          sessionCount: data.sessionCount
        };
      });
      
      // å…±é€šãƒ†ã‚¹ãƒˆã®é…ç‚¹ã‚’æƒ³å®šï¼ˆä¸€èˆ¬çš„ãªæ–‡ç³»ã®å ´åˆï¼‰
      const commonTestStructure = {
        'è‹±èª': { reading: 100, listening: 100, total: 200 },
        'æ•°å­¦': { math1A: 100, math2B: 100, total: 200 },
        'å›½èª': { modern: 110, classic: 90, total: 200 },
        'ç†ç§‘': { total: 100 },
        'ç¤¾ä¼š': { total: 100 }
      };
      
      let p = `ã‚ãªãŸã¯å¤§å­¦å—é¨“ã®ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ãƒ†ã‚£ã‚¹ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’çµ±è¨ˆçš„ã«åˆ†æã—ã€å…±é€šãƒ†ã‚¹ãƒˆã§ã®å¾—ç‚¹ã‚’å®¢è¦³çš„ã«äºˆæ¸¬ã—ã¦ãã ã•ã„ã€‚

âš ï¸ **é‡è¦**: äºˆæ¸¬ã¯æ¥½è¦³çš„ã«ãªã‚Šã™ããšã€ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸç¾å®Ÿçš„ãªæ•°å€¤ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚å—é¨“ç”Ÿã®ä»Šå¾Œã®å­¦ç¿’è¨ˆç”»ã«å½±éŸ¿ã™ã‚‹ãŸã‚ã€æ ¹æ‹ ã®ãªã„å¸Œæœ›çš„è¦³æ¸¬ã¯é¿ã‘ã¦ãã ã•ã„ã€‚

---

# ğŸ“‹ åŸºæœ¬æƒ…å ±

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}
**è©¦é¨“ã¾ã§**: ${daysUntil}æ—¥
**ç´¯è¨ˆå­¦ç¿’æ™‚é–“**: ${formatMinutes(totalMinutes)}
**å­¦ç¿’æ—¥æ•°**: ${studyDays}æ—¥
**ç›´è¿‘1é€±é–“**: ${formatMinutes(weekMinutes)}

`;
      
      if (goalAnalysis.length > 0) {
        p += `# ğŸ¯ ç›®æ¨™è¨­å®š\n\n`;
        p += `| ç§‘ç›® | ç¾çŠ¶ï¼ˆè‡ªå·±è©•ä¾¡ï¼‰ | ç›®æ¨™ | æœ€ä½ãƒ©ã‚¤ãƒ³ |\n`;
        p += `|------|------------------|------|------------|\n`;
        goalAnalysis.forEach(g => {
          p += `| ${g.subject} | ${g.current}% | ${g.target}% | ${g.must}% |\n`;
        });
        p += `\n`;
      }
      
      p += `# ğŸ“Š éå»å•ãƒ»æ¨¡è©¦ã®å…¨è¨˜éŒ²\n\n`;
      
      if (redbookLogs.length === 0) {
        p += `â€»éå»å•ãƒ»æ¨¡è©¦ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚äºˆæ¸¬ã®ç²¾åº¦ãŒä½ããªã‚Šã¾ã™ã€‚\n\n`;
      } else {
        // ç§‘ç›®åˆ¥ã«æ•´ç†ã—ã¦è¡¨ç¤º
        Object.entries(subjectScoreHistory).forEach(([cat, scores]) => {
          if (scores.length > 0) {
            p += `## ${cat}\n\n`;
            p += `| æ—¥ä»˜ | å¤§å­¦/æ¨¡è©¦ | å¹´åº¦ | å¾—ç‚¹ç‡ | é–“é•ãˆãŸåˆ†é‡ |\n`;
            p += `|------|-----------|------|--------|-------------|\n`;
            scores.forEach(s => {
              p += `| ${s.date} | ${s.university} | ${s.year} | **${s.score}%** | ${s.weakAreas || '-'} |\n`;
            });
            
            // çµ±è¨ˆã‚µãƒãƒªãƒ¼
            const avg = Math.round(scores.reduce((sum, s) => sum + s.score, 0) / scores.length);
            const max = Math.max(...scores.map(s => s.score));
            const min = Math.min(...scores.map(s => s.score));
            const latest = scores[0].score;
            
            p += `\n**çµ±è¨ˆ**: å¹³å‡${avg}% / æœ€é«˜${max}% / æœ€ä½${min}% / ç›´è¿‘${latest}%\n`;
            
            if (growthAnalysis[cat]) {
              const ga = growthAnalysis[cat];
              const trendIcon = ga.trend === 'improving' ? 'ğŸ“ˆ' : ga.trend === 'declining' ? 'ğŸ“‰' : 'â¡ï¸';
              p += `**æˆé•·**: å‰åŠå¹³å‡${ga.firstAvg}% â†’ å¾ŒåŠå¹³å‡${ga.secondAvg}%ï¼ˆ${ga.growth >= 0 ? '+' : ''}${ga.growth}ptï¼‰${trendIcon}\n`;
            }
            p += `\n`;
          }
        });
        
        // å…¨ä½“çµ±è¨ˆ
        p += `## å…¨ç§‘ç›®ç·åˆ\n\n`;
        p += `- æ¼”ç¿’å›æ•°: ${redbookAnalysis.totalAttempts}å›\n`;
        p += `- å…¨ä½“å¹³å‡: **${redbookAnalysis.avgScore}%**\n`;
        p += `- å¾—ç‚¹å‚¾å‘: ${redbookAnalysis.scoreTrend === 'improving' ? 'ğŸ“ˆ ä¸Šæ˜‡å‚¾å‘' : redbookAnalysis.scoreTrend === 'declining' ? 'ğŸ“‰ ä¸‹é™å‚¾å‘' : 'â¡ï¸ æ¨ªã°ã„'}\n\n`;
      }
      
      p += `# ğŸ“š å­¦ç¿’æ™‚é–“ãƒ‡ãƒ¼ã‚¿\n\n`;
      p += `| ç§‘ç›® | ç´¯è¨ˆæ™‚é–“ | ä»Šé€± | å­¦ç¿’å›æ•° |\n`;
      p += `|------|----------|------|----------|\n`;
      Object.entries(studyTimeBySubject).forEach(([cat, data]) => {
        if (data.total > 0) {
          p += `| ${cat} | ${formatMinutes(data.total)} | ${formatMinutes(data.weekly)} | ${data.sessionCount}å› |\n`;
        }
      });
      
      if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
        p += `\n# âš ï¸ ç¹°ã‚Šè¿”ã—é–“é•ãˆã‚‹åˆ†é‡\n\n`;
        const sorted = Object.entries(redbookAnalysis.weakAreasSummary)
          .sort((a, b) => b[1] - a[1]);
        p += `| åˆ†é‡ | å‡ºç¾å›æ•° | æ·±åˆ»åº¦ |\n`;
        p += `|------|----------|--------|\n`;
        sorted.forEach(([area, count]) => {
          const severity = count >= 3 ? 'ğŸ”´ é«˜' : count >= 2 ? 'ğŸŸ¡ ä¸­' : 'ğŸŸ¢ ä½';
          p += `| ${area} | ${count}å› | ${severity} |\n`;
        });
        p += `\n`;
      }
      
      p += `# ğŸ“ˆ æ®‹ã‚ŠæœŸé–“ã§ã®ä¼¸ã³ã—ã‚è¦å› \n\n`;
      p += `**ãƒ—ãƒ©ã‚¹è¦å› **:\n`;
      if (daysUntil >= 30) p += `- æ®‹ã‚Š${daysUntil}æ—¥ã‚ã‚Šã€å¯¾ç­–ã®æ™‚é–“ãŒã‚ã‚‹\n`;
      if (redbookAnalysis.scoreTrend === 'improving') p += `- å¾—ç‚¹ãŒä¸Šæ˜‡å‚¾å‘ã«ã‚ã‚‹\n`;
      if (weekMinutes >= 1200) p += `- é€±20æ™‚é–“ä»¥ä¸Šã®å­¦ç¿’é‡ã‚’ç¢ºä¿\n`;
      
      p += `\n**ãƒã‚¤ãƒŠã‚¹è¦å› **:\n`;
      if (daysUntil < 30) p += `- æ®‹ã‚Š${daysUntil}æ—¥ã¨æ™‚é–“ãŒé™ã‚‰ã‚Œã¦ã„ã‚‹\n`;
      if (redbookAnalysis.scoreTrend === 'declining') p += `- å¾—ç‚¹ãŒä¸‹é™å‚¾å‘ã«ã‚ã‚‹\n`;
      if (Object.keys(redbookAnalysis.weakAreasSummary).length >= 5) p += `- è‹¦æ‰‹åˆ†é‡ãŒè¤‡æ•°ã‚ã‚‹\n`;
      if (weekMinutes < 600) p += `- é€±ã®å­¦ç¿’æ™‚é–“ãŒ10æ™‚é–“æœªæº€\n`;
      
      p += `
---

# ğŸ¯ äºˆæ¸¬ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

ä¸Šè¨˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€**å…±é€šãƒ†ã‚¹ãƒˆæœ¬ç•ªã§ã®å¾—ç‚¹ç‡**ã‚’äºˆæ¸¬ã—ã¦ãã ã•ã„ã€‚

## å›ç­”å½¢å¼

### 1. ç§‘ç›®åˆ¥ã®å¾—ç‚¹äºˆæ¸¬

å„ç§‘ç›®ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®3ãƒ‘ã‚¿ãƒ¼ãƒ³ã§äºˆæ¸¬ã—ã¦ãã ã•ã„ï¼š

| ç§‘ç›® | æ‚²è¦³çš„ | ç¾å®Ÿçš„ | æ¥½è¦³çš„ | äºˆæ¸¬æ ¹æ‹  |
|------|--------|--------|--------|----------|
| è‹±èª | â—‹â—‹% | â—‹â—‹% | â—‹â—‹% | ... |
| æ•°å­¦ | â—‹â—‹% | â—‹â—‹% | â—‹â—‹% | ... |
| å›½èª | â—‹â—‹% | â—‹â—‹% | â—‹â—‹% | ... |
| ... | ... | ... | ... | ... |

- **æ‚²è¦³çš„**: è‹¦æ‰‹åˆ†é‡ãŒå‡ºé¡Œã•ã‚ŒãŸå ´åˆã€ä½“èª¿ä¸è‰¯ã®å ´åˆãªã©
- **ç¾å®Ÿçš„**: ç¾åœ¨ã®å®ŸåŠ›ãŒãã®ã¾ã¾ç™ºæ®ã•ã‚ŒãŸå ´åˆ
- **æ¥½è¦³çš„**: å¾—æ„åˆ†é‡ãŒå‡ºé¡Œã•ã‚Œã€å®ŸåŠ›ä»¥ä¸Šã‚’ç™ºæ®ã—ãŸå ´åˆ

### 2. ç·åˆå¾—ç‚¹ã®äºˆæ¸¬

- æ‚²è¦³çš„ã‚·ãƒŠãƒªã‚ª: â—‹â—‹â—‹ç‚¹ / â—‹â—‹â—‹ç‚¹ï¼ˆâ—‹â—‹%ï¼‰
- ç¾å®Ÿçš„ã‚·ãƒŠãƒªã‚ª: â—‹â—‹â—‹ç‚¹ / â—‹â—‹â—‹ç‚¹ï¼ˆâ—‹â—‹%ï¼‰
- æ¥½è¦³çš„ã‚·ãƒŠãƒªã‚ª: â—‹â—‹â—‹ç‚¹ / â—‹â—‹â—‹ç‚¹ï¼ˆâ—‹â—‹%ï¼‰

### 3. äºˆæ¸¬ã®æ ¹æ‹ 

- ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹å‚¾å‘
- æ®‹ã‚Š${daysUntil}æ—¥ã§ã®ä¼¸ã³ã—ã‚ã®æ¨å®š
- äºˆæ¸¬ã®ä¿¡é ¼åº¦ï¼ˆãƒ‡ãƒ¼ã‚¿é‡ã«åŸºã¥ãï¼‰

### 4. ç›®æ¨™é”æˆã®å¯èƒ½æ€§

- ç›®æ¨™å¾—ç‚¹ç‡ã¸ã®åˆ°é”å¯èƒ½æ€§ï¼ˆ%ï¼‰
- æœ€ä½ãƒ©ã‚¤ãƒ³çªç ´ã®å¯èƒ½æ€§ï¼ˆ%ï¼‰
- é”æˆã«å¿…è¦ãªæ¡ä»¶

### 5. ä¸ŠæŒ¯ã‚Œãƒ»ä¸‹æŒ¯ã‚Œè¦å› 

**ä¸ŠæŒ¯ã‚Œã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆ**:
- ...

**ä¸‹æŒ¯ã‚Œã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆ**:
- ...

### 6. æ®‹ã‚Š${daysUntil}æ—¥ã§ç‚¹æ•°ã‚’ä¸Šã’ã‚‹ãŸã‚ã®ææ¡ˆ

å„ªå…ˆåº¦ã®é«˜ã„é †ã«ã€å…·ä½“çš„ãªå¯¾ç­–ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚`;
      
      return p;
    }
    
    // ==========================================
    // éå»å•æˆ¦ç•¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæ–°è¦è¿½åŠ ï¼‰
    // ==========================================
    
    function generateRedbookPrompt(a) {
      const { profile, daysUntil, redbookAnalysis, redbookLogs, goalAnalysis } = a;
      
      if (redbookLogs.length === 0) {
        return `éå»å•æ¼”ç¿’ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

ã¾ãšéå»å•ã‚’è§£ã„ã¦è¨˜éŒ²ã‚’ã¤ã‘ã¦ã‹ã‚‰ã€ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚

éå»å•æ¼”ç¿’ã‚’è¨˜éŒ²ã™ã‚‹éš›ã¯ï¼š
1. å¤§å­¦åãƒ»ç§‘ç›®ãƒ»å¹´åº¦
2. å¾—ç‚¹ã¨é…ç‚¹
3. è§£ç­”æ™‚é–“
4. å¤§å•ã”ã¨ã®å¾—ç‚¹
5. é–“é•ãˆãŸåˆ†é‡

ã“ã‚Œã‚‰ã‚’è¨˜éŒ²ã—ã¦ãŠãã¨ã€ã‚ˆã‚Šç²¾åº¦ã®é«˜ã„æˆ¦ç•¥ã‚’ç«‹ã¦ã‚‰ã‚Œã¾ã™ã€‚`;
      }
      
      let p = `ã‚ãªãŸã¯å¤§å­¦å—é¨“ã®éå»å•åˆ†æã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®éå»å•æ¼”ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’è©³ç´°ã«åˆ†æã—ã€æœ¬ç•ªã§æœ€å¤§é™ã®å¾—ç‚¹ã‚’å–ã‚‹ãŸã‚ã®æˆ¦ç•¥ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

---

# ğŸ“‹ åŸºæœ¬æƒ…å ±

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}
**è©¦é¨“ã¾ã§**: ${daysUntil}æ—¥
**éå»å•æ¼”ç¿’å›æ•°**: ${redbookAnalysis.totalAttempts}å›
**ç·æ¼”ç¿’æ™‚é–“**: ${formatMinutes(redbookAnalysis.totalTime)}
**å¹³å‡å¾—ç‚¹ç‡**: ${redbookAnalysis.avgScore}%

---

# ğŸ“Š éå»å•æ¼”ç¿’ã®å…¨è¨˜éŒ²

`;
      
      // æ—¥ä»˜é †ã«è©³ç´°ã‚’è¡¨ç¤º
      const sortedLogs = [...redbookLogs].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      sortedLogs.forEach((log, index) => {
        const scoreIcon = log.score >= 70 ? 'ğŸŸ¢' : log.score >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
        p += `## ${index + 1}. ${log.university} ${log.subject || ''} ${log.year}å¹´ï¼ˆ${log.date}ï¼‰\n\n`;
        p += `- å¾—ç‚¹ç‡: ${scoreIcon} **${log.score}%**\n`;
        if (log.time) p += `- è§£ç­”æ™‚é–“: **${log.time}åˆ†**\n`;
        if (log.sectionScores) {
          p += `- å¤§å•åˆ¥å¾—ç‚¹:\n`;
          log.sectionScores.split(',').forEach(section => {
            const match = section.trim().match(/(.+?):(\d+)\/(\d+)(?:\((\d+)åˆ†\))?/);
            if (match) {
              const [, name, got, max, time] = match;
              const rate = max > 0 ? Math.round((parseInt(got) / parseInt(max)) * 100) : 0;
              const rateIcon = rate >= 70 ? 'ğŸŸ¢' : rate >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
              p += `  - ${name}: ${got}/${max}ç‚¹ï¼ˆ${rate}%ï¼‰${rateIcon}`;
              if (time) p += ` [${time}åˆ†]`;
              p += `\n`;
            }
          });
        }
        if (log.weakAreas) p += `- âš ï¸ é–“é•ãˆãŸåˆ†é‡: **${log.weakAreas}**\n`;
        if (log.memo) p += `- æŒ¯ã‚Šè¿”ã‚Š: ${log.memo}\n`;
        p += `\n`;
      });
      
      // å¤§å•åˆ¥åˆ†æ
      if (Object.keys(redbookAnalysis.sectionAnalysis).length > 0) {
        p += `# ğŸ“ å¤§å•åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ\n\n`;
        p += `| å¤§å• | å¹³å‡å¾—ç‚¹ç‡ | æ¼”ç¿’å›æ•° | å¹³å‡æ™‚é–“ |\n`;
        p += `|------|-----------|----------|----------|\n`;
        
        const sortedSections = Object.entries(redbookAnalysis.sectionAnalysis)
          .sort((a, b) => a[1].avgScore - b[1].avgScore);
        
        sortedSections.forEach(([name, data]) => {
          const icon = data.avgScore >= 70 ? 'ğŸŸ¢' : data.avgScore >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
          const timeStr = data.avgTime ? `${data.avgTime}åˆ†` : '-';
          p += `| ${name} | ${icon} ${data.avgScore}% | ${data.attempts}å› | ${timeStr} |\n`;
        });
        
        // è‹¦æ‰‹å¤§å•ã®ç‰¹å®š
        const weakSections = sortedSections.filter(([, d]) => d.avgScore < 50);
        if (weakSections.length > 0) {
          p += `\n**âš ï¸ è¦å¯¾ç­–ã®å¤§å•**: ${weakSections.map(([n]) => n).join('ã€')}\n`;
        }
        p += `\n`;
      }
      
      // å¤§å­¦åˆ¥åˆ†æ
      if (Object.keys(redbookAnalysis.universityAnalysis).length > 0) {
        p += `# ğŸ« å¤§å­¦åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹\n\n`;
        
        Object.entries(redbookAnalysis.universityAnalysis).forEach(([uni, data]) => {
          const trendIcon = data.trend === 'improving' ? 'ğŸ“ˆ' : data.trend === 'declining' ? 'ğŸ“‰' : 'â¡ï¸';
          p += `## ${uni} ${trendIcon}\n\n`;
          p += `- æ¼”ç¿’å›æ•°: ${data.attempts}å›\n`;
          p += `- å¹³å‡å¾—ç‚¹ç‡: **${data.avgScore}%**ï¼ˆæœ€é«˜${data.highScore}% / æœ€ä½${data.lowScore}%ï¼‰\n`;
          if (data.avgTime) p += `- å¹³å‡è§£ç­”æ™‚é–“: ${data.avgTime}åˆ†\n`;
          
          // ç§‘ç›®åˆ¥
          if (Object.keys(data.bySubject).length > 0) {
            p += `- ç§‘ç›®åˆ¥:\n`;
            Object.entries(data.bySubject).forEach(([subj, subjData]) => {
              p += `  - ${subj}: ${subjData.avgScore}%ï¼ˆ${subjData.attempts}å›ï¼‰`;
              if (subjData.weakAreas.length > 0) {
                p += ` â† è‹¦æ‰‹: ${subjData.weakAreas.slice(0, 3).join('ã€')}`;
              }
              p += `\n`;
            });
          }
          p += `\n`;
        });
      }
      
      // è‹¦æ‰‹åˆ†é‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°
      if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
        p += `# ğŸ”´ ç¹°ã‚Šè¿”ã—é–“é•ãˆã‚‹åˆ†é‡ï¼ˆæ·±åˆ»åº¦é †ï¼‰\n\n`;
        
        const sorted = Object.entries(redbookAnalysis.weakAreasSummary)
          .sort((a, b) => b[1] - a[1]);
        
        sorted.forEach(([area, count], index) => {
          const severity = count >= 3 ? 'ğŸ”´ æœ€å„ªå…ˆ' : count >= 2 ? 'ğŸŸ¡ è¦å¯¾ç­–' : 'ğŸŸ¢ æ³¨æ„';
          p += `${index + 1}. **${area}**ï¼ˆ${count}å›ï¼‰- ${severity}\n`;
        });
        p += `\n`;
      }
      
      // æœˆåˆ¥é€²æ—
      if (Object.keys(redbookAnalysis.monthlyProgress).length > 1) {
        p += `# ğŸ“ˆ æœˆåˆ¥æ¼”ç¿’çŠ¶æ³\n\n`;
        p += `| æœˆ | æ¼”ç¿’å›æ•° | å¹³å‡å¾—ç‚¹ç‡ | æ¼”ç¿’æ™‚é–“ |\n`;
        p += `|-----|---------|-----------|----------|\n`;
        
        Object.entries(redbookAnalysis.monthlyProgress)
          .sort((a, b) => a[0].localeCompare(b[0]))
          .forEach(([month, data]) => {
            p += `| ${month} | ${data.attempts}å› | ${data.avgScore}% | ${formatMinutes(data.totalTime)} |\n`;
          });
        p += `\n`;
      }
      
      p += `---

# ğŸ¯ åˆ†æãƒªã‚¯ã‚¨ã‚¹ãƒˆ

ä¸Šè¨˜ã®éå»å•æ¼”ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€æœ¬ç•ªã§æœ€å¤§é™ã®å¾—ç‚¹ã‚’å–ã‚‹ãŸã‚ã®æˆ¦ç•¥ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

### 1. ç¾çŠ¶ã®ç·åˆè©•ä¾¡

- éå»å•æ¼”ç¿’ã®é‡ã¯ååˆ†ã‹
- å¾—ç‚¹å‚¾å‘ã‹ã‚‰è¦‹ãˆã‚‹å¼·ã¿ãƒ»å¼±ã¿
- æ™‚é–“é…åˆ†ã®å‚¾å‘

### 2. å¤§å•åˆ¥ã®æˆ¦ç•¥

å„å¤§å•ã«ã¤ã„ã¦ï¼š
- å¾—ç‚¹ã‚’ä¼¸ã°ã—ã‚„ã™ã„å¤§å•ï¼ˆé›†ä¸­å¯¾ç­–ã™ã¹ãï¼‰
- ç¾çŠ¶ç¶­æŒã§OKã®å¤§å•
- æ€ã„åˆ‡ã£ã¦æ¨ã¦ã‚‹ã“ã¨ã‚’æ¤œè¨ã™ã¹ãå¤§å•

### 3. æ™‚é–“é…åˆ†ã®ææ¡ˆ

- å„å¤§å•ã¸ã®æ¨å¥¨æ™‚é–“é…åˆ†
- è§£ãé †ç•ªã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹
- è¦‹ç›´ã—æ™‚é–“ã®ç¢ºä¿æ–¹æ³•

### 4. è‹¦æ‰‹åˆ†é‡ã®å…‹æœãƒ—ãƒ©ãƒ³

å„ªå…ˆåº¦ã®é«˜ã„é †ã«ï¼š
- å…·ä½“çš„ãªå¯¾ç­–æ–¹æ³•
- ä½¿ã†ã¹ãæ•™æ
- å¿…è¦ãªå­¦ç¿’æ™‚é–“ã®ç›®å®‰

### 5. æ®‹ã‚Š${daysUntil}æ—¥ã®éå»å•æ¼”ç¿’è¨ˆç”»

- ä½•å¹´åˆ†ã‚’ã©ã®é †ç•ªã§è§£ãã¹ãã‹
- å¾©ç¿’ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°
- ç›´å‰æœŸã®ä»•ä¸Šã’æ–¹`;
      
      return p;
    }
    
    // ==========================================
    // å¤§å­¦åˆ¥å¯¾ç­–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæ–°è¦è¿½åŠ ï¼‰
    // ==========================================
    
    function generateUniversityPrompt(a) {
      const selectedUniversity = document.getElementById('aiUniversitySelect').value;
      if (!selectedUniversity) {
        return 'â†‘ä¸Šã®ã€Œå¯¾ç­–ã—ãŸã„å¤§å­¦ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\n\néå»å•æ¼”ç¿’ã®è¨˜éŒ²ãŒãªã„å ´åˆã¯ã€ã¾ãšéå»å•ã‚’è§£ã„ã¦è¨˜éŒ²ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚';
      }
      
      const { profile, daysUntil, redbookAnalysis, redbookLogs, subjectAnalysis, goalAnalysis } = a;
      const uniData = redbookAnalysis.universityAnalysis[selectedUniversity];
      
      if (!uniData) {
        return `ã€Œ${selectedUniversity}ã€ã®éå»å•æ¼”ç¿’è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n\nã¾ãšéå»å•ã‚’è§£ã„ã¦è¨˜éŒ²ã‚’ã¤ã‘ã¦ã‹ã‚‰ã€ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚`;
      }
      
      const uniLogs = redbookLogs.filter(l => l.university === selectedUniversity);
      const sortedLogs = [...uniLogs].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      let p = `ã‚ãªãŸã¯ã€Œ${selectedUniversity}ã€ã®å…¥è©¦å¯¾ç­–ã«ç²¾é€šã—ãŸå—é¨“ã‚³ãƒ¼ãƒã§ã™ã€‚ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€ã“ã®å¤§å­¦ã«åˆæ ¼ã™ã‚‹ãŸã‚ã®å…·ä½“çš„ãªæˆ¦ç•¥ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

---

# ğŸ“‹ åŸºæœ¬æƒ…å ±

**å¯¾è±¡å¤§å­¦**: ${selectedUniversity}
**å¿—æœ›é †ä½**: ${profile['ç¬¬1å¿—æœ›'] === selectedUniversity ? 'ç¬¬1å¿—æœ› â­' : profile['ç¬¬2å¿—æœ›'] === selectedUniversity ? 'ç¬¬2å¿—æœ›' : profile['ç¬¬3å¿—æœ›'] === selectedUniversity ? 'ç¬¬3å¿—æœ›' : 'å¿—æœ›æ ¡'}
**è©¦é¨“ã¾ã§**: ${daysUntil}æ—¥

---

# ğŸ“Š ${selectedUniversity}ã®æ¼”ç¿’æˆç¸¾

**æ¼”ç¿’å›æ•°**: ${uniData.attempts}å›
**å¹³å‡å¾—ç‚¹ç‡**: ${uniData.avgScore}%
**æœ€é«˜å¾—ç‚¹**: ${uniData.highScore}%
**æœ€ä½å¾—ç‚¹**: ${uniData.lowScore}%
**å‚¾å‘**: ${uniData.trend === 'improving' ? 'ğŸ“ˆ ä¸Šæ˜‡ä¸­ï¼ˆè‰¯ã„å‚¾å‘ï¼‰' : uniData.trend === 'declining' ? 'ğŸ“‰ ä¸‹é™æ°—å‘³ï¼ˆè¦æ³¨æ„ï¼‰' : 'â¡ï¸ å®‰å®š'}
${uniData.avgTime ? `**å¹³å‡è§£ç­”æ™‚é–“**: ${uniData.avgTime}åˆ†` : ''}

`;
      
      // ç§‘ç›®åˆ¥æˆç¸¾
      if (Object.keys(uniData.bySubject).length > 0) {
        p += `## ç§‘ç›®åˆ¥æˆç¸¾\n\n`;
        p += `| ç§‘ç›® | å¹³å‡å¾—ç‚¹ç‡ | æ¼”ç¿’å›æ•° | è‹¦æ‰‹åˆ†é‡ |\n`;
        p += `|------|-----------|----------|----------|\n`;
        
        Object.entries(uniData.bySubject).forEach(([subj, data]) => {
          const icon = data.avgScore >= 70 ? 'ğŸŸ¢' : data.avgScore >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
          const weakStr = data.weakAreas.length > 0 ? data.weakAreas.slice(0, 2).join('ã€') : '-';
          p += `| ${subj} | ${icon} ${data.avgScore}% | ${data.attempts}å› | ${weakStr} |\n`;
        });
        p += `\n`;
      }
      
      // å…¨æ¼”ç¿’è¨˜éŒ²
      p += `## æ¼”ç¿’å±¥æ­´ï¼ˆæ–°ã—ã„é †ï¼‰\n\n`;
      
      sortedLogs.forEach((log, index) => {
        const scoreIcon = log.score >= 70 ? 'ğŸŸ¢' : log.score >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
        p += `### ${index + 1}. ${log.subject || 'ç·åˆ'} ${log.year}å¹´ï¼ˆ${log.date}ï¼‰\n\n`;
        p += `- å¾—ç‚¹ç‡: ${scoreIcon} **${log.score}%**\n`;
        if (log.time) p += `- è§£ç­”æ™‚é–“: ${log.time}åˆ†\n`;
        
        if (log.sectionScores) {
          p += `- å¤§å•åˆ¥:\n`;
          log.sectionScores.split(',').forEach(section => {
            const match = section.trim().match(/(.+?):(\d+)\/(\d+)(?:\((\d+)åˆ†\))?/);
            if (match) {
              const [, name, got, max, time] = match;
              const rate = max > 0 ? Math.round((parseInt(got) / parseInt(max)) * 100) : 0;
              const rateIcon = rate >= 70 ? 'ğŸŸ¢' : rate >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
              p += `  - ${name}: ${got}/${max}ï¼ˆ${rate}%ï¼‰${rateIcon}`;
              if (time) p += ` [${time}åˆ†]`;
              p += `\n`;
            }
          });
        }
        
        if (log.weakAreas) p += `- âš ï¸ é–“é•ãˆãŸåˆ†é‡: ${log.weakAreas}\n`;
        if (log.memo) p += `- ãƒ¡ãƒ¢: ${log.memo}\n`;
        p += `\n`;
      });
      
      // è‹¦æ‰‹åˆ†é‡é›†è¨ˆ
      const uniWeakAreas = {};
      uniLogs.forEach(log => {
        if (log.weakAreas) {
          log.weakAreas.split(/[,ã€]/).forEach(area => {
            const trimmed = area.trim();
            if (trimmed) {
              uniWeakAreas[trimmed] = (uniWeakAreas[trimmed] || 0) + 1;
            }
          });
        }
      });
      
      if (Object.keys(uniWeakAreas).length > 0) {
        p += `## âš ï¸ ã“ã®å¤§å­¦ã§ã‚ˆãé–“é•ãˆã‚‹åˆ†é‡\n\n`;
        
        Object.entries(uniWeakAreas)
          .sort((a, b) => b[1] - a[1])
          .forEach(([area, count]) => {
            const severity = count >= 2 ? 'ğŸ”´ æœ€å„ªå…ˆ' : 'ğŸŸ¡ è¦å¯¾ç­–';
            p += `- **${area}**ï¼ˆ${count}å›ï¼‰- ${severity}\n`;
          });
        p += `\n`;
      }
      
      // é–¢é€£ã™ã‚‹å­¦ç¿’ãƒ‡ãƒ¼ã‚¿
      p += `## ğŸ“š é–¢é€£ã™ã‚‹å­¦ç¿’çŠ¶æ³\n\n`;
      
      Object.keys(uniData.bySubject).forEach(subj => {
        const cat = categorizeSubject(subj);
        const studyData = subjectAnalysis[cat];
        if (studyData) {
          p += `### ${cat}\n`;
          p += `- ç´¯è¨ˆå­¦ç¿’æ™‚é–“: ${formatMinutes(studyData.totalMinutes)}\n`;
          p += `- ä»Šé€±ã®å­¦ç¿’æ™‚é–“: ${formatMinutes(studyData.weekMinutes)}\n`;
          p += `- å­¦ç¿’å›æ•°: ${studyData.sessionCount}å›\n\n`;
        }
      });
      
      // ç›®æ¨™ã¨ã®æ¯”è¼ƒ
      const relevantGoal = goalAnalysis.find(g => 
        Object.keys(uniData.bySubject).some(s => categorizeSubject(s) === g.subject)
      );
      
      if (relevantGoal || goalAnalysis.length > 0) {
        p += `## ğŸ¯ ç›®æ¨™è¨­å®š\n\n`;
        goalAnalysis.forEach(g => {
          const icon = g.feasibility === 'likely' ? 'ğŸŸ¢' : g.feasibility === 'possible' ? 'ğŸŸ¡' : 'ğŸ”´';
          p += `- ${g.subject}: ç¾çŠ¶${g.current}% â†’ ç›®æ¨™${g.target}%ï¼ˆ+${g.gap}ptå¿…è¦ï¼‰${icon}\n`;
        });
        p += `\n`;
      }
      
      p += `---

# ğŸ¯ åˆ†æãƒªã‚¯ã‚¨ã‚¹ãƒˆ

ã€Œ${selectedUniversity}ã€ã«åˆæ ¼ã™ã‚‹ãŸã‚ã®å…·ä½“çš„ãªæˆ¦ç•¥ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

### 1. ç¾çŠ¶ã®åˆæ ¼å¯èƒ½æ€§

- ç¾åœ¨ã®æ¼”ç¿’æˆç¸¾ã‹ã‚‰è¦‹ãŸåˆæ ¼å¯èƒ½æ€§
- ä¼¸ã³ã—ã‚ã®ã‚ã‚‹ç§‘ç›®ãƒ»åˆ†é‡
- å±é™ºä¿¡å·ãŒå‡ºã¦ã„ã‚‹ç‚¹

### 2. ${selectedUniversity}ã®å…¥è©¦å‚¾å‘åˆ†æ

- å‡ºé¡Œå‚¾å‘ã®ç‰¹å¾´ï¼ˆã‚ã‹ã‚‹ç¯„å›²ã§ï¼‰
- é…ç‚¹ã®é‡ã¿
- åˆæ ¼æœ€ä½ç‚¹ã®ç›®å®‰

### 3. ç§‘ç›®åˆ¥ã®å¯¾ç­–æ–¹é‡

å„ç§‘ç›®ã«ã¤ã„ã¦ï¼š
- ç›®æ¨™å¾—ç‚¹ç‡
- å„ªå…ˆã—ã¦å¯¾ç­–ã™ã¹ãåˆ†é‡
- åŠ¹æœçš„ãªå­¦ç¿’æ–¹æ³•

### 4. æ™‚é–“é…åˆ†ãƒ»è§£ç­”æˆ¦ç•¥

- æ¨å¥¨ã™ã‚‹è§£ç­”é †åº
- å„å¤§å•ã¸ã®æ™‚é–“é…åˆ†
- å–ã‚‹ã¹ãå•é¡Œãƒ»æ¨ã¦ã‚‹å•é¡Œã®åˆ¤æ–­åŸºæº–

### 5. æ®‹ã‚Š${daysUntil}æ—¥ã®å¯¾ç­–ãƒ—ãƒ©ãƒ³

- é€±ã”ã¨ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³
- ã‚„ã‚‹ã¹ãã“ã¨ã®å„ªå…ˆé †ä½
- ç›´å‰æœŸã®ä»•ä¸Šã’æ–¹

### 6. å½“æ—¥ã®ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ»æˆ¦ç•¥ã‚¢ãƒ‰ãƒã‚¤ã‚¹

- è©¦é¨“å½“æ—¥ã®å¿ƒæ§‹ãˆ
- æƒ³å®šå¤–ã®äº‹æ…‹ã¸ã®å¯¾å‡¦æ³•`;
      
      return p;
    }
    
    // ==========================================
    // å¤§å•åˆ¥æ”»ç•¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generateSectionPrompt(a) {
      const { profile, daysUntil, redbookLogs, redbookAnalysis } = a;
      
      // å¤§å•åˆ¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
      const sectionData = {};
      
      redbookLogs.forEach(log => {
        if (!log.sectionScores) return;
        
        const subject = log.subject || 'ä¸æ˜';
        if (!sectionData[subject]) {
          sectionData[subject] = {};
        }
        
        // å¤§å•åˆ¥ã‚¹ã‚³ã‚¢ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆä¾‹: "å¤§å•1:15/20(10åˆ†), å¤§å•2:20/30(15åˆ†)"ï¼‰
        const sections = log.sectionScores.split(/[,ã€]/).map(s => s.trim());
        sections.forEach(section => {
          const match = section.match(/(.+?):(\d+)\/(\d+)(?:\((\d+)åˆ†?\))?/);
          if (match) {
            const [, name, got, max, time] = match;
            if (!sectionData[subject][name]) {
              sectionData[subject][name] = { scores: [], times: [], maxScores: [] };
            }
            const rate = Math.round((parseInt(got) / parseInt(max)) * 100);
            sectionData[subject][name].scores.push(rate);
            sectionData[subject][name].maxScores.push(parseInt(max));
            if (time) sectionData[subject][name].times.push(parseInt(time));
          }
        });
      });
      
      let p = `ã‚ãªãŸã¯å¤§å­¦å…¥è©¦å•é¡Œã®åˆ†æã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚å¤§å•ã”ã¨ã®å‚¾å‘ã‚’åˆ†æã—ã€æ”»ç•¥æ³•ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

---

# ğŸ“‹ åŸºæœ¬æƒ…å ±

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}
**è©¦é¨“ã¾ã§**: ${daysUntil}æ—¥
**éå»å•æ¼”ç¿’å›æ•°**: ${redbookAnalysis.totalAttempts}å›

---

# ğŸ§© å¤§å•åˆ¥ã®å¾—ç‚¹åˆ†æ

`;
      
      if (Object.keys(sectionData).length === 0) {
        p += `â€»å¤§å•åˆ¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚èµ¤æœ¬ãƒ•ã‚©ãƒ¼ãƒ ã§å¤§å•ã”ã¨ã®å¾—ç‚¹ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€è©³ç´°ãªåˆ†æãŒã§ãã¾ã™ã€‚\n\n`;
      } else {
        Object.entries(sectionData).forEach(([subject, sections]) => {
          p += `## ${subject}\n\n`;
          p += `| å¤§å• | å¹³å‡å¾—ç‚¹ç‡ | é…ç‚¹ç›®å®‰ | å¹³å‡æ™‚é–“ | å®‰å®šåº¦ | åˆ¤å®š |\n`;
          p += `|------|------------|----------|----------|--------|------|\n`;
          
          const sectionAnalysis = [];
          Object.entries(sections).forEach(([name, data]) => {
            const avgScore = Math.round(data.scores.reduce((a, b) => a + b, 0) / data.scores.length);
            const avgMax = Math.round(data.maxScores.reduce((a, b) => a + b, 0) / data.maxScores.length);
            const avgTime = data.times.length > 0 
              ? Math.round(data.times.reduce((a, b) => a + b, 0) / data.times.length) + 'åˆ†'
              : '-';
            
            const variance = data.scores.length > 1
              ? data.scores.reduce((sum, s) => sum + Math.pow(s - avgScore, 2), 0) / data.scores.length
              : 0;
            const stability = variance < 100 ? 'å®‰å®š' : variance < 400 ? 'ã‚„ã‚„ä¸å®‰å®š' : 'ä¸å®‰å®š';
            
            const icon = avgScore >= 70 ? 'ğŸŸ¢ å¾—æ„' : avgScore >= 50 ? 'ğŸŸ¡ æ™®é€š' : 'ğŸ”´ è‹¦æ‰‹';
            
            p += `| ${name} | ${avgScore}% | ${avgMax}ç‚¹ | ${avgTime} | ${stability} | ${icon} |\n`;
            
            sectionAnalysis.push({
              name,
              avgScore,
              category: avgScore >= 70 ? 'strong' : avgScore >= 50 ? 'normal' : 'weak'
            });
          });
          
          const strong = sectionAnalysis.filter(s => s.category === 'strong');
          const weak = sectionAnalysis.filter(s => s.category === 'weak');
          
          if (strong.length > 0 || weak.length > 0) {
            p += `\n**æˆ¦ç•¥ãƒã‚¤ãƒ³ãƒˆ**:\n`;
            if (strong.length > 0) p += `- âœ… å¾—ç‚¹æº: ${strong.map(s => s.name).join('ã€')}\n`;
            if (weak.length > 0) p += `- âš ï¸ è¦å¼·åŒ–: ${weak.map(s => s.name).join('ã€')}\n`;
          }
          p += `\n`;
        });
      }
      
      if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
        p += `## âš ï¸ ã‚ˆãé–“é•ãˆã‚‹åˆ†é‡\n\n`;
        Object.entries(redbookAnalysis.weakAreasSummary)
          .sort((a, b) => b[1] - a[1])
          .forEach(([area, count]) => {
            p += `- **${area}**: ${count}å›\n`;
          });
        p += `\n`;
      }
      
      p += `---

# ğŸ¯ ç›¸è«‡å†…å®¹

å¤§å•ã”ã¨ã®æ”»ç•¥æˆ¦ç•¥ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **å¤§å•åˆ¥ã®å„ªå…ˆé †ä½** - ã©ã®å¤§å•ã‹ã‚‰è§£ãã¹ãã‹ã€æ™‚é–“é…åˆ†ã®ç›®å®‰
2. **å¾—æ„ãªå¤§å•ã®æ´»ç”¨æ³•** - ç¢ºå®Ÿã«å¾—ç‚¹ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆ
3. **è‹¦æ‰‹ãªå¤§å•ã¸ã®å¯¾ç­–** - å…·ä½“çš„ãªå­¦ç¿’æ–¹æ³•ã€æ¨ã¦å•ã®åˆ¤æ–­åŸºæº–
4. **æ™‚é–“ç®¡ç†æˆ¦ç•¥** - å„å¤§å•ã®ç›®æ¨™è§£ç­”æ™‚é–“
5. **è©¦é¨“å½“æ—¥ã®è§£ç­”é †åº** - æœ€é©ãªé †åºã®ææ¡ˆ`;
      
      return p;
    }
    
    // ==========================================
    // æ™‚é–“åŠ¹ç‡åˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generateEfficiencyPrompt(a) {
      const { profile, daysUntil, totalMinutes, studyDays,
              subjectAnalysis, redbookLogs } = a;
      
      const efficiencyData = {};
      
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        const studyTime = data.totalMinutes;
        const catLogs = redbookLogs
          .filter(l => categorizeSubject(l.subject) === cat)
          .sort((a, b) => new Date(a.date) - new Date(b.date));
        
        if (studyTime > 0 && catLogs.length >= 2) {
          const firstScore = catLogs[0].score;
          const lastScore = catLogs[catLogs.length - 1].score;
          const growth = lastScore - firstScore;
          const hoursSpent = studyTime / 60;
          const efficiency = growth / hoursSpent;
          
          efficiencyData[cat] = {
            studyTime, hoursSpent, firstScore, lastScore, growth, efficiency,
            attempts: catLogs.length
          };
        } else if (studyTime > 0) {
          efficiencyData[cat] = {
            studyTime, hoursSpent: studyTime / 60,
            firstScore: null, lastScore: catLogs[0]?.score || null,
            growth: null, efficiency: null, attempts: catLogs.length
          };
        }
      });
      
      const typeAnalysis = {};
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        Object.entries(data.typeBreakdown || {}).forEach(([type, minutes]) => {
          if (!typeAnalysis[type]) typeAnalysis[type] = { totalMinutes: 0 };
          typeAnalysis[type].totalMinutes += minutes;
        });
      });
      
      const efficiencyRanking = Object.entries(efficiencyData)
        .filter(([, data]) => data.efficiency !== null)
        .sort((a, b) => b[1].efficiency - a[1].efficiency);
      
      let p = `ã‚ãªãŸã¯å­¦ç¿’åŠ¹ç‡ã®åˆ†æã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ™‚é–“å¯¾åŠ¹æœã‚’åˆ†æã—ã€å­¦ç¿’åŠ¹ç‡ã‚’ä¸Šã’ã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚

---

# ğŸ“‹ åŸºæœ¬æƒ…å ±

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}
**è©¦é¨“ã¾ã§**: ${daysUntil}æ—¥
**ç´¯è¨ˆå­¦ç¿’æ™‚é–“**: ${formatMinutes(totalMinutes)}ï¼ˆç´„${Math.round(totalMinutes / 60)}æ™‚é–“ï¼‰
**å­¦ç¿’æ—¥æ•°**: ${studyDays}æ—¥
**1æ—¥å¹³å‡**: ${studyDays > 0 ? Math.round(totalMinutes / studyDays) : 0}åˆ†

---

# â±ï¸ æ™‚é–“å¯¾åŠ¹æœã®åˆ†æ

`;
      
      if (efficiencyRanking.length > 0) {
        p += `## ç§‘ç›®åˆ¥ã®å­¦ç¿’åŠ¹ç‡\n\n`;
        p += `| ç§‘ç›® | å­¦ç¿’æ™‚é–“ | æˆé•· | åŠ¹ç‡ | åˆ¤å®š |\n`;
        p += `|------|----------|------|------|------|\n`;
        
        efficiencyRanking.forEach(([cat, data]) => {
          const growthStr = data.growth >= 0 ? `+${data.growth}pt` : `${data.growth}pt`;
          const effStr = data.efficiency.toFixed(2) + 'pt/h';
          const rating = data.efficiency > 1 ? 'ğŸŸ¢ é«˜åŠ¹ç‡' : data.efficiency > 0.3 ? 'ğŸŸ¡ æ™®é€š' : 'ğŸ”´ è¦æ”¹å–„';
          p += `| ${cat} | ${formatMinutes(data.studyTime)} | ${data.firstScore}%â†’${data.lastScore}%ï¼ˆ${growthStr}ï¼‰ | ${effStr} | ${rating} |\n`;
        });
        p += `\n`;
        
        if (efficiencyRanking.length >= 2) {
          const best = efficiencyRanking[0];
          const worst = efficiencyRanking[efficiencyRanking.length - 1];
          p += `**åŠ¹ç‡åˆ†æã‚µãƒãƒªãƒ¼**:\n`;
          p += `- ğŸ† æœ€ã‚‚åŠ¹ç‡ãŒè‰¯ã„: **${best[0]}**ï¼ˆ${best[1].efficiency.toFixed(2)}pt/æ™‚é–“ï¼‰\n`;
          p += `- âš ï¸ åŠ¹ç‡æ”¹å–„ãŒå¿…è¦: **${worst[0]}**ï¼ˆ${worst[1].efficiency.toFixed(2)}pt/æ™‚é–“ï¼‰\n\n`;
        }
      } else {
        p += `â€»éå»å•ã‚’è¤‡æ•°å›è§£ãã¨ã€ç§‘ç›®åˆ¥ã®å­¦ç¿’åŠ¹ç‡ãŒåˆ†æã§ãã¾ã™ã€‚\n\n`;
      }
      
      const noDataSubjects = Object.entries(efficiencyData)
        .filter(([, data]) => data.efficiency === null && data.studyTime > 60);
      
      if (noDataSubjects.length > 0) {
        p += `## âš ï¸ åŠ¹ç‡æ¸¬å®šã§ãã¦ã„ãªã„ç§‘ç›®\n\n`;
        noDataSubjects.forEach(([cat, data]) => {
          p += `- **${cat}**: ${formatMinutes(data.studyTime)}å­¦ç¿’æ¸ˆã¿ â†’ éå»å•ã§æˆæœã‚’æ¸¬å®šã—ã¾ã—ã‚‡ã†\n`;
        });
        p += `\n`;
      }
      
      if (Object.keys(typeAnalysis).length > 0) {
        p += `## ğŸ“Š å­¦ç¿’ã‚¿ã‚¤ãƒ—åˆ¥ã®æ™‚é–“é…åˆ†\n\n`;
        const sortedTypes = Object.entries(typeAnalysis).sort((a, b) => b[1].totalMinutes - a[1].totalMinutes);
        const totalTypeMinutes = sortedTypes.reduce((sum, [, data]) => sum + data.totalMinutes, 0);
        
        sortedTypes.forEach(([type, data]) => {
          const pct = totalTypeMinutes > 0 ? Math.round((data.totalMinutes / totalTypeMinutes) * 100) : 0;
          const bar = 'â–ˆ'.repeat(Math.round(pct / 10)) + 'â–‘'.repeat(10 - Math.round(pct / 10));
          p += `- **${type}**: ${bar} ${pct}%ï¼ˆ${formatMinutes(data.totalMinutes)}ï¼‰\n`;
        });
        p += `\n`;
      }
      
      p += `---

# ğŸ¯ ç›¸è«‡å†…å®¹

å­¦ç¿’åŠ¹ç‡ã‚’ä¸Šã’ã‚‹ãŸã‚ã®å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **ç¾åœ¨ã®å­¦ç¿’åŠ¹ç‡ã®è©•ä¾¡** - ç§‘ç›®ã”ã¨ã®åŠ¹ç‡ã¯é©åˆ‡ã‹
2. **åŠ¹ç‡ãŒæ‚ªã„ç§‘ç›®ã®æ”¹å–„ç­–** - ãªãœåŠ¹ç‡ãŒæ‚ªã„ã®ã‹ã€ã©ã†æ”¹å–„ã™ã¹ãã‹
3. **å­¦ç¿’ã‚¿ã‚¤ãƒ—ã®ãƒãƒ©ãƒ³ã‚¹** - ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã¨ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã®æ¯”ç‡ã¯é©åˆ‡ã‹
4. **æ™‚é–“é…åˆ†ã®æœ€é©åŒ–** - å„ç§‘ç›®ã«å‰²ãã¹ãæ™‚é–“ã®ç›®å®‰
5. **æ®‹ã‚Š${daysUntil}æ—¥ã§åŠ¹ç‡ã‚’æœ€å¤§åŒ–ã™ã‚‹ã‚³ãƒ„**`;
      
      return p;
    }
    
    async function copyPrompt() {
      const prompt = document.getElementById('promptPreview').textContent;
      
      try {
        await navigator.clipboard.writeText(prompt);
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼AIã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
        closeAIModal();
      } catch {
        const textarea = document.createElement('textarea');
        textarea.value = prompt;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        closeAIModal();
      }
    }
    
    function formatMinutes(minutes) {
      if (minutes < 60) return `${minutes}åˆ†`;
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return mins > 0 ? `${hours}æ™‚é–“${mins}åˆ†` : `${hours}æ™‚é–“`;
    }
    
    function formatDateShort(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return `${date.getMonth() + 1}/${date.getDate()}`;
    }
    
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('active');
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }
    
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>
