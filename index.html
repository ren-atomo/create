<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¦ç¿’è¨˜éŒ²ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@300;400;500;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ============================================
       å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã‚¹ã‚¿ã‚¤ãƒ«
       ============================================ */
    
    /* FABãƒœã‚¿ãƒ³ï¼ˆå³ä¸‹ã®+ãƒœã‚¿ãƒ³ï¼‰ */
    .fab-button {
      position: fixed;
      bottom: 32px;
      right: 32px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #111 0%, #333 100%);
      color: white;
      border: none;
      font-size: 32px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .fab-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 28px rgba(0,0,0,0.4);
    }

    .fab-button.active {
      transform: rotate(45deg);
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“ */
    .modal {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-radius: 24px 24px 0 0;
      padding: 32px;
      z-index: 1001;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal.active {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #111;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: #f5f5f5;
      color: #666;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: #eee;
      color: #111;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ãƒ– */
    .form-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid #eee;
      padding-bottom: 16px;
    }

    .form-tab {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: #888;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 10px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .form-tab:hover {
      background: #f5f5f5;
      color: #333;
    }

    .form-tab.active {
      background: #111;
      color: white;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ  */
    .form-content {
      display: none;
    }

    .form-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #666;
      margin-bottom: 8px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #eee;
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s ease;
      background: white;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #111;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* é¸æŠå¼ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
    .button-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .button-option {
      padding: 10px 16px;
      border: 2px solid #eee;
      border-radius: 10px;
      background: white;
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .button-option:hover {
      border-color: #ccc;
    }

    .button-option.selected {
      border-color: #111;
      background: #111;
      color: white;
    }

    /* æ‰‹å¿œãˆé¸æŠ */
    .feeling-group {
      display: flex;
      gap: 12px;
    }

    .feeling-option {
      width: 48px;
      height: 48px;
      border: 2px solid #eee;
      border-radius: 12px;
      background: white;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .feeling-option:hover {
      border-color: #ccc;
      transform: scale(1.05);
    }

    .feeling-option.selected {
      border-color: #111;
      background: #f5f5f5;
      transform: scale(1.1);
    }

    /* é€ä¿¡ãƒœã‚¿ãƒ³ */
    .submit-button {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, #111 0%, #333 100%);
      color: white;
      font-size: 16px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 8px;
    }

    .submit-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }

    .submit-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .submit-button.success {
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
    }

    /* 2åˆ—ã‚°ãƒªãƒƒãƒ‰ */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 480px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      .fab-button {
        bottom: 24px;
        right: 24px;
        width: 56px;
        height: 56px;
        font-size: 28px;
      }
      .modal {
        padding: 24px;
      }
    }

    /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #111;
      color: white;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1002;
    }

    .toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success {
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
    }

    .toast.error {
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Zen Kaku Gothic New', 'DM Sans', sans-serif;
      background: linear-gradient(180deg, #fafafa 0%, #f3f3f3 100%);
      min-height: 100vh;
      color: #1a1a1a;
      line-height: 1.6;
    }

    /* Header */
    .header {
      background: white;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      padding: 20px 40px;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.95);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 20px;
      font-weight: 700;
      color: #111;
      letter-spacing: -0.5px;
    }

    .logo span {
      color: #2563eb;
    }

    .header-date {
      font-size: 14px;
      color: #888;
      font-weight: 400;
    }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      gap: 8px;
      padding: 16px 40px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .tab-btn {
      padding: 12px 24px;
      border: none;
      background: transparent;
      color: #666;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 12px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .tab-btn:hover {
      background: rgba(0,0,0,0.04);
      color: #333;
    }

    .tab-btn.active {
      background: #111;
      color: white;
    }

    /* Main Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px 40px 60px;
    }

    /* Cards */
    .card {
      background: white;
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.03);
      border: 1px solid rgba(0,0,0,0.04);
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.06), 0 8px 24px rgba(0,0,0,0.05);
      transform: translateY(-2px);
    }

    .card-title {
      font-size: 13px;
      font-weight: 500;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 28px;
    }

    .stat-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      border: 1px solid rgba(0,0,0,0.04);
      transition: all 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    .stat-label {
      font-size: 12px;
      color: #888;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #111;
      font-family: 'DM Sans', sans-serif;
    }

    .stat-value span {
      font-size: 16px;
      font-weight: 400;
      color: #666;
    }

    .stat-sub {
      font-size: 13px;
      color: #10b981;
      margin-top: 4px;
      font-weight: 500;
    }

    .stat-sub.warning {
      color: #f59e0b;
    }

    /* Grid Layout */
    .grid-2 {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      margin-bottom: 24px;
    }

    /* Chart Container */
    .chart-container {
      position: relative;
      height: 280px;
    }

    /* Progress Section */
    .progress-section {
      margin-top: 20px;
    }

    .progress-item {
      margin-bottom: 20px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .progress-label {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    .progress-value {
      font-size: 14px;
      color: #666;
      font-family: 'DM Sans', sans-serif;
    }

    .progress-bar {
      height: 10px;
      background: #f0f0f0;
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      border-radius: 5px;
      transition: width 0.8s ease;
    }

    .progress-target {
      position: absolute;
      top: 0;
      height: 100%;
      width: 2px;
      background: #111;
    }

    .progress-must {
      position: absolute;
      top: 0;
      height: 100%;
      width: 2px;
      background: #f59e0b;
    }

    /* Subject Tags */
    .subject-tag {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }

    .subject-tag.english { background: #dbeafe; color: #1d4ed8; }
    .subject-tag.math { background: #d1fae5; color: #047857; }
    .subject-tag.japanese { background: #fee2e2; color: #b91c1c; }
    .subject-tag.akabon { background: #fef3c7; color: #b45309; }

    /* Records Table */
    .records-list {
      margin-top: 16px;
    }

    .record-row {
      display: grid;
      grid-template-columns: 70px 90px 1fr 100px 70px 50px;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid #f5f5f5;
      transition: all 0.2s ease;
    }

    .record-row:hover {
      background: #fafafa;
      margin: 0 -16px;
      padding: 16px;
      border-radius: 12px;
    }

    .record-date {
      font-size: 13px;
      color: #888;
      font-family: 'DM Sans', sans-serif;
    }

    .record-detail {
      font-size: 14px;
      color: #333;
    }

    .record-book {
      font-size: 13px;
      color: #666;
    }

    .record-time {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      font-family: 'DM Sans', sans-serif;
    }

    .record-feeling {
      font-size: 20px;
    }

    /* Akabon Cards */
    .akabon-grid {
      display: grid;
      gap: 16px;
      margin-top: 16px;
    }

    .akabon-card {
      background: linear-gradient(135deg, #fff 0%, #fafafa 100%);
      border: 1px solid #eee;
      border-radius: 16px;
      padding: 20px;
      transition: all 0.2s ease;
    }

    .akabon-card:hover {
      border-color: #dc2626;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.08);
    }

    .akabon-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .akabon-univ {
      font-size: 16px;
      font-weight: 600;
      color: #111;
    }

    .akabon-meta {
      font-size: 13px;
      color: #888;
    }

    .akabon-score {
      font-size: 24px;
      font-weight: 700;
      color: #dc2626;
      font-family: 'DM Sans', sans-serif;
    }

    .akabon-memo {
      font-size: 13px;
      color: #666;
      margin-top: 8px;
      padding-top: 12px;
      border-top: 1px solid #f0f0f0;
    }

    /* Weekly Goal */
    .weekly-goal {
      background: linear-gradient(135deg, #111 0%, #333 100%);
      color: white;
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 24px;
    }

    .weekly-goal .card-title {
      color: rgba(255,255,255,0.6);
    }

    .weekly-progress {
      display: flex;
      align-items: flex-end;
      gap: 16px;
      margin-top: 16px;
    }

    .weekly-current {
      font-size: 48px;
      font-weight: 700;
      font-family: 'DM Sans', sans-serif;
      line-height: 1;
    }

    .weekly-target {
      font-size: 18px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 8px;
    }

    .weekly-bar {
      height: 8px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
      margin-top: 20px;
      overflow: hidden;
    }

    .weekly-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #34d399);
      border-radius: 4px;
      transition: width 0.8s ease;
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Legend */
    .legend {
      display: flex;
      gap: 20px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #666;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    /* Loading State */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: #888;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .grid-2 { grid-template-columns: 1fr; }
      .grid-3 { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      .header { padding: 16px 20px; }
      .nav-tabs { padding: 12px 20px; overflow-x: auto; }
      .container { padding: 16px 20px 40px; }
      .stats-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
      .stat-card { padding: 16px; }
      .stat-value { font-size: 24px; }
      .record-row { 
        grid-template-columns: 60px 70px 1fr 60px 40px;
        font-size: 13px;
      }
      .record-book { display: none; }
    }

    /* Connection Status */
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #888;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
    }

    .status-dot.offline {
      background: #f59e0b;
    }

    /* Setup Guide */
    .setup-guide {
      background: #fffbeb;
      border: 1px solid #fcd34d;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .setup-guide h3 {
      font-size: 16px;
      font-weight: 600;
      color: #92400e;
      margin-bottom: 12px;
    }

    .setup-guide p {
      font-size: 14px;
      color: #a16207;
      margin-bottom: 8px;
    }

    .setup-guide code {
      background: rgba(0,0,0,0.06);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 13px;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">Study<span>Track</span></div>
      <div style="display: flex; align-items: center; gap: 24px;">
        <div class="connection-status">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">æ¥ç¶šä¸­...</span>
        </div>
        <div class="header-date" id="currentDate"></div>
      </div>
    </div>
  </header>

  <!-- Navigation -->
  <nav class="nav-tabs">
    <button class="tab-btn active" data-tab="overview">æ¦‚è¦</button>
    <button class="tab-btn" data-tab="records">å­¦ç¿’è¨˜éŒ²</button>
    <button class="tab-btn" data-tab="akabon">èµ¤æœ¬æ¼”ç¿’</button>
    <button class="tab-btn" data-tab="progress">ç›®æ¨™é€²æ—</button>
  </nav>

  <!-- Main Content -->
  <main class="container">

    <!-- Overview Tab -->
    <div class="tab-content active" id="tab-overview">
      
      <!-- Weekly Goal -->
      <div class="weekly-goal">
        <div class="card-title">ä»Šé€±ã®å­¦ç¿’æ™‚é–“</div>
        <div class="weekly-progress">
          <div class="weekly-current"><span id="weeklyHours">0</span><span style="font-size: 20px; font-weight: 400;">h</span></div>
          <div class="weekly-target">/ <span id="weeklyTarget">30</span>h ç›®æ¨™</div>
        </div>
        <div class="weekly-bar">
          <div class="weekly-bar-fill" id="weeklyBarFill" style="width: 0%"></div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">ä»Šæ—¥ã®å­¦ç¿’</div>
          <div class="stat-value" id="todayStudy">0<span>åˆ†</span></div>
          <div class="stat-sub" id="todayDiff">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">é€£ç¶šå­¦ç¿’æ—¥æ•°</div>
          <div class="stat-value" id="streak">0<span>æ—¥</span></div>
          <div class="stat-sub">ğŸ”¥ ç¶™ç¶šä¸­</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æœ€ã‚‚å­¦ç¿’ã—ãŸç§‘ç›®</div>
          <div class="stat-value" id="topSubject" style="font-size: 24px;">--</div>
          <div class="stat-sub" id="topSubjectTime">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å¹³å‡æ‰‹å¿œãˆ</div>
          <div class="stat-value" id="avgFeeling" style="font-size: 36px;">ğŸ˜</div>
          <div class="stat-sub" id="avgFeelingText">--</div>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid-2">
        <div class="card">
          <div class="card-title">æ—¥åˆ¥å­¦ç¿’æ™‚é–“</div>
          <div class="chart-container">
            <canvas id="dailyChart"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-title">ç§‘ç›®åˆ¥å‰²åˆ</div>
          <div class="chart-container">
            <canvas id="subjectChart"></canvas>
          </div>
          <div class="legend" id="subjectLegend"></div>
        </div>
      </div>

      <!-- Recent Records -->
      <div class="card">
        <div class="card-title">æœ€è¿‘ã®å­¦ç¿’è¨˜éŒ²</div>
        <div class="records-list" id="recentRecords">
          <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- Records Tab -->
    <div class="tab-content" id="tab-records">
      <div class="card">
        <div class="card-title">å…¨å­¦ç¿’è¨˜éŒ²</div>
        <div class="records-list" id="allRecords">
          <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- Akabon Tab -->
    <div class="tab-content" id="tab-akabon">
      <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
        <div class="stat-card">
          <div class="stat-label">èµ¤æœ¬æ¼”ç¿’å›æ•°</div>
          <div class="stat-value" id="akabonCount">0<span>å›</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å¹³å‡å¾—ç‚¹ç‡</div>
          <div class="stat-value" id="akabonAvg">--%</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æœ€é«˜å¾—ç‚¹</div>
          <div class="stat-value" id="akabonBest">--%</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">èµ¤æœ¬æ¼”ç¿’å±¥æ­´</div>
        <div class="akabon-grid" id="akabonList">
          <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- Progress Tab -->
    <div class="tab-content" id="tab-progress">
      <div class="grid-3">
        <div class="card">
          <div class="card-title">å›½èª</div>
          <div class="stat-value" id="japaneseScore">50<span>%</span></div>
          <div class="progress-section">
            <div class="progress-bar">
              <div class="progress-fill" id="japaneseFill" style="width: 50%; background: linear-gradient(90deg, #dc2626, #f87171);"></div>
              <div class="progress-must" style="left: 65%"></div>
              <div class="progress-target" style="left: 80%"></div>
            </div>
          </div>
          <div class="legend" style="margin-top: 12px;">
            <div class="legend-item"><div class="legend-dot" style="background: #f59e0b"></div>ãƒã‚¹ãƒˆ 65%</div>
            <div class="legend-item"><div class="legend-dot" style="background: #111"></div>ç›®æ¨™ 80%</div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">æ•°å­¦</div>
          <div class="stat-value" id="mathScore">50<span>%</span></div>
          <div class="progress-section">
            <div class="progress-bar">
              <div class="progress-fill" id="mathFill" style="width: 50%; background: linear-gradient(90deg, #059669, #34d399);"></div>
              <div class="progress-must" style="left: 65%"></div>
              <div class="progress-target" style="left: 80%"></div>
            </div>
          </div>
          <div class="legend" style="margin-top: 12px;">
            <div class="legend-item"><div class="legend-dot" style="background: #f59e0b"></div>ãƒã‚¹ãƒˆ 65%</div>
            <div class="legend-item"><div class="legend-dot" style="background: #111"></div>ç›®æ¨™ 80%</div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">è‹±èª</div>
          <div class="stat-value" id="englishScore">58<span>%</span></div>
          <div class="progress-section">
            <div class="progress-bar">
              <div class="progress-fill" id="englishFill" style="width: 58%; background: linear-gradient(90deg, #2563eb, #60a5fa);"></div>
              <div class="progress-must" style="left: 65%"></div>
              <div class="progress-target" style="left: 80%"></div>
            </div>
          </div>
          <div class="legend" style="margin-top: 12px;">
            <div class="legend-item"><div class="legend-dot" style="background: #f59e0b"></div>ãƒã‚¹ãƒˆ 65%</div>
            <div class="legend-item"><div class="legend-dot" style="background: #111"></div>ç›®æ¨™ 80%</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ç§‘ç›®åˆ¥è©³ç´°ï¼ˆä»Šé€±ã®å­¦ç¿’æ™‚é–“ï¼‰</div>
        <div class="chart-container" style="height: 320px;">
          <canvas id="detailChart"></canvas>
        </div>
      </div>
    </div>

  </main>

  <!-- FABãƒœã‚¿ãƒ³ï¼ˆè¨˜éŒ²ã‚’è¿½åŠ ï¼‰ -->
  <button class="fab-button" id="fabButton" onclick="toggleModal()">+</button>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="modal-overlay" id="modalOverlay" onclick="toggleModal()"></div>

  <!-- å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="inputModal">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ“ è¨˜éŒ²ã‚’è¿½åŠ </h2>
      <button class="modal-close" onclick="toggleModal()">Ã—</button>
    </div>

    <!-- ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ãƒ– -->
    <div class="form-tabs">
      <button class="form-tab active" data-form="study" onclick="switchFormTab('study')">å­¦ç¿’è¨˜éŒ²</button>
      <button class="form-tab" data-form="akabon" onclick="switchFormTab('akabon')">èµ¤æœ¬æ¼”ç¿’</button>
    </div>

    <!-- å­¦ç¿’è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="form-content active" id="form-study">
      <div class="form-group">
        <label class="form-label">ç§‘ç›®</label>
        <div class="button-group" id="subjectButtons">
          <button type="button" class="button-option" data-value="ç¾ä»£æ–‡">ç¾ä»£æ–‡</button>
          <button type="button" class="button-option" data-value="å¤æ–‡">å¤æ–‡</button>
          <button type="button" class="button-option" data-value="æ¼¢æ–‡">æ¼¢æ–‡</button>
          <button type="button" class="button-option" data-value="æ•°å­¦1A">æ•°å­¦1A</button>
          <button type="button" class="button-option" data-value="æ•°å­¦2B">æ•°å­¦2B</button>
          <button type="button" class="button-option" data-value="å˜èª">å˜èª</button>
          <button type="button" class="button-option" data-value="æ–‡æ³•">æ–‡æ³•</button>
          <button type="button" class="button-option" data-value="é•·æ–‡">é•·æ–‡</button>
          <button type="button" class="button-option" data-value="éŸ³èª­">éŸ³èª­</button>
          <button type="button" class="button-option" data-value="ãƒªã‚¹ãƒ‹ãƒ³ã‚°">ãƒªã‚¹ãƒ‹ãƒ³ã‚°</button>
          <button type="button" class="button-option" data-value="ãã®ä»–æ¼”ç¿’">ãã®ä»–</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">å­¦ç¿’æ™‚é–“</label>
        <div class="button-group" id="timeButtons">
          <button type="button" class="button-option" data-value="15">15åˆ†</button>
          <button type="button" class="button-option" data-value="30">30åˆ†</button>
          <button type="button" class="button-option" data-value="45">45åˆ†</button>
          <button type="button" class="button-option" data-value="50">50åˆ†</button>
          <button type="button" class="button-option" data-value="60">1æ™‚é–“</button>
          <button type="button" class="button-option" data-value="90">1.5æ™‚é–“</button>
          <button type="button" class="button-option" data-value="120">2æ™‚é–“</button>
          <button type="button" class="button-option" data-value="150">2æ™‚é–“è¶…</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">æ‰‹å¿œãˆ</label>
        <div class="feeling-group" id="feelingButtons">
          <button type="button" class="feeling-option" data-value="1">ğŸ˜«</button>
          <button type="button" class="feeling-option" data-value="2">ğŸ˜•</button>
          <button type="button" class="feeling-option" data-value="3">ğŸ˜</button>
          <button type="button" class="feeling-option" data-value="4">ğŸ™‚</button>
          <button type="button" class="feeling-option" data-value="5">ğŸ˜Š</button>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">å‚è€ƒæ›¸åï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="bookName" placeholder="ä¾‹: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1900">
        </div>
        <div class="form-group">
          <label class="form-label">æ—¥ä»˜</label>
          <input type="date" class="form-input" id="studyDate">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <textarea class="form-textarea" id="studyMemo" placeholder="ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šãªã©..."></textarea>
      </div>

      <button class="submit-button" id="submitStudy" onclick="submitStudyRecord()">è¨˜éŒ²ã‚’ä¿å­˜</button>
    </div>

    <!-- èµ¤æœ¬ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="form-content" id="form-akabon">
      <div class="form-group">
        <label class="form-label">å¤§å­¦å</label>
        <select class="form-select" id="akabonUniv">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="ç«‹æ•™å¤§å­¦">ç«‹æ•™å¤§å­¦</option>
          <option value="é’å±±å­¦é™¢å¤§å­¦">é’å±±å­¦é™¢å¤§å­¦</option>
          <option value="æ³•æ”¿å¤§å­¦">æ³•æ”¿å¤§å­¦</option>
          <option value="ä¸­å¤®å¤§å­¦">ä¸­å¤®å¤§å­¦</option>
          <option value="æ˜æ²»å­¦é™¢å¤§å­¦">æ˜æ²»å­¦é™¢å¤§å­¦</option>
          <option value="æˆåŸå¤§å­¦">æˆåŸå¤§å­¦</option>
          <option value="æ±æ´‹å¤§å­¦">æ±æ´‹å¤§å­¦</option>
          <option value="æ—¥æœ¬å¤§å­¦">æ—¥æœ¬å¤§å­¦</option>
          <option value="å°‚ä¿®å¤§å­¦">å°‚ä¿®å¤§å­¦</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ç§‘ç›®</label>
          <div class="button-group" id="akabonSubjectButtons">
            <button type="button" class="button-option" data-value="è‹±èª">è‹±èª</button>
            <button type="button" class="button-option" data-value="å›½èª">å›½èª</button>
            <button type="button" class="button-option" data-value="æ•°å­¦">æ•°å­¦</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">å¹´åº¦</label>
          <select class="form-select" id="akabonYear">
            <option value="2024">2024å¹´åº¦</option>
            <option value="2023">2023å¹´åº¦</option>
            <option value="2022">2022å¹´åº¦</option>
            <option value="2021">2021å¹´åº¦</option>
            <option value="2020">2020å¹´åº¦</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">å¾—ç‚¹ç‡ï¼ˆ%ï¼‰</label>
          <input type="number" class="form-input" id="akabonScore" min="0" max="100" placeholder="72">
        </div>
        <div class="form-group">
          <label class="form-label">æ—¥ä»˜</label>
          <input type="date" class="form-input" id="akabonDate">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¢ãƒ»æŒ¯ã‚Šè¿”ã‚Š</label>
        <textarea class="form-textarea" id="akabonMemo" placeholder="é›£ã—ã‹ã£ãŸã¨ã“ã‚ã€æ¬¡å›ã®å¯¾ç­–ãªã©..."></textarea>
      </div>

      <button class="submit-button" id="submitAkabon" onclick="submitAkabonRecord()">è¨˜éŒ²ã‚’ä¿å­˜</button>
    </div>
  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
  <div class="toast" id="toast"></div>

  <script>
    // ============================================
    // è¨­å®š: ã“ã“ã«Google Apps Scriptã®URLã‚’å…¥ã‚Œã¦ãã ã•ã„
    // ============================================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwB7BxnYVeeSMAW2jhV7akTDCiqXIr2IQw7LKsnCzcU2Y2-aqNJ6R78nPAz7z_rLlchpg/exec';

    // ============================================
    // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºå‰ã®ãƒ†ã‚¹ãƒˆç”¨ï¼‰
    // ============================================
    const demoData = {
      dailyStudy: [
        { date: '11/18', å›½èª: 60, æ•°å­¦: 90, è‹±èª: 120 },
        { date: '11/19', å›½èª: 45, æ•°å­¦: 60, è‹±èª: 90 },
        { date: '11/20', å›½èª: 30, æ•°å­¦: 120, è‹±èª: 60 },
        { date: '11/21', å›½èª: 75, æ•°å­¦: 45, è‹±èª: 150 },
        { date: '11/22', å›½èª: 60, æ•°å­¦: 90, è‹±èª: 90 },
        { date: '11/23', å›½èª: 90, æ•°å­¦: 60, è‹±èª: 120 },
        { date: '11/24', å›½èª: 45, æ•°å­¦: 105, è‹±èª: 105 },
      ],
      subjectTotals: { è‹±èª: 735, æ•°å­¦: 570, å›½èª: 405 },
      subjectDetail: {
        è‹±èª: { é•·æ–‡: 280, å˜èª: 180, æ–‡æ³•: 120, ãƒªã‚¹ãƒ‹ãƒ³ã‚°: 95, éŸ³èª­: 60 },
        æ•°å­¦: { 'æ•°å­¦2B': 320, 'æ•°å­¦1A': 250 },
        å›½èª: { ç¾ä»£æ–‡: 200, å¤æ–‡: 130, æ¼¢æ–‡: 75 },
      },
      records: [
        { date: '11/24', subject: 'è‹±èª', detail: 'é•·æ–‡', time: 60, feeling: 4, book: 'ã‚„ã£ã¦ãŠããŸã„500' },
        { date: '11/24', subject: 'æ•°å­¦', detail: '2B', time: 45, feeling: 3, book: 'é’ãƒãƒ£ãƒ¼ãƒˆ' },
        { date: '11/24', subject: 'è‹±èª', detail: 'å˜èª', time: 30, feeling: 4, book: 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1900' },
        { date: '11/23', subject: 'å›½èª', detail: 'ç¾ä»£æ–‡', time: 45, feeling: 3, book: 'å…¥è©¦ç¾ä»£æ–‡ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹' },
        { date: '11/23', subject: 'è‹±èª', detail: 'ãƒªã‚¹ãƒ‹ãƒ³ã‚°', time: 30, feeling: 5, book: 'å…±é€šãƒ†ã‚¹ãƒˆå¯¾ç­–' },
        { date: '11/23', subject: 'æ•°å­¦', detail: '1A', time: 60, feeling: 4, book: 'é’ãƒãƒ£ãƒ¼ãƒˆ' },
        { date: '11/22', subject: 'è‹±èª', detail: 'æ–‡æ³•', time: 45, feeling: 3, book: 'NextStage' },
        { date: '11/22', subject: 'å›½èª', detail: 'å¤æ–‡', time: 40, feeling: 2, book: 'å¤æ–‡ä¸Šé”' },
      ],
      akabon: [
        { date: '11/22', university: 'ç«‹æ•™å¤§å­¦', subject: 'è‹±èª', year: '2023', score: 72, memo: 'é•·æ–‡2å•ç›®ãŒé›£ã—ã‹ã£ãŸ' },
        { date: '11/20', university: 'é’å±±å­¦é™¢å¤§å­¦', subject: 'è‹±èª', year: '2023', score: 68, memo: 'æ™‚é–“é…åˆ†ãƒŸã‚¹' },
        { date: '11/18', university: 'ç«‹æ•™å¤§å­¦', subject: 'å›½èª', year: '2022', score: 65, memo: 'å¤æ–‡ã§å¤±ç‚¹' },
        { date: '11/15', university: 'æ³•æ”¿å¤§å­¦', subject: 'è‹±èª', year: '2022', score: 70, memo: 'ã¾ã‚ã¾ã‚' },
      ],
      targets: {
        å›½èª: { current: 50, target: 80, must: 65 },
        æ•°å­¦: { current: 50, target: 80, must: 65 },
        è‹±èª: { current: 58, target: 80, must: 65 },
      },
      weeklyGoal: { target: 1800, current: 1710 },
      streak: 12,
    };

    // ============================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // ============================================
    let appData = null;
    let dailyChart = null;
    let subjectChart = null;
    let detailChart = null;
    const feelingEmoji = ['', 'ğŸ˜«', 'ğŸ˜•', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜Š'];

    // ============================================
    // åˆæœŸåŒ–
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      // æ—¥ä»˜è¡¨ç¤º
      const today = new Date();
      document.getElementById('currentDate').textContent = 
        `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;

      // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
        });
      });

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      loadData();
    });

    // ============================================
    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    // ============================================
    async function loadData() {
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');

      if (SCRIPT_URL) {
        try {
          statusText.textContent = 'æ¥ç¶šä¸­...';
          const response = await fetch(SCRIPT_URL);
          appData = await response.json();
          statusDot.classList.remove('offline');
          statusText.textContent = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºä¸­';
        } catch (error) {
          console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          statusDot.classList.add('offline');
          statusText.textContent = 'ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰';
          appData = demoData;
        }
      } else {
        statusDot.classList.add('offline');
        statusText.textContent = 'ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰';
        appData = demoData;
      }

      renderAll();
    }

    // ============================================
    // å…¨ä½“ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    // ============================================
    function renderAll() {
      renderStats();
      renderCharts();
      renderRecords();
      renderAkabon();
      renderProgress();
    }

    // ============================================
    // çµ±è¨ˆã‚«ãƒ¼ãƒ‰
    // ============================================
    function renderStats() {
      // ä»Šé€±ã®å­¦ç¿’æ™‚é–“
      const weeklyMinutes = appData.weeklyGoal.current;
      const weeklyHours = Math.floor(weeklyMinutes / 60);
      const weeklyPercent = Math.min(100, (weeklyMinutes / appData.weeklyGoal.target) * 100);
      
      document.getElementById('weeklyHours').textContent = weeklyHours;
      document.getElementById('weeklyTarget').textContent = Math.floor(appData.weeklyGoal.target / 60);
      document.getElementById('weeklyBarFill').style.width = `${weeklyPercent}%`;

      // ä»Šæ—¥ã®å­¦ç¿’
      const todayData = appData.dailyStudy[appData.dailyStudy.length - 1];
      const todayTotal = (todayData.å›½èª || 0) + (todayData.æ•°å­¦ || 0) + (todayData.è‹±èª || 0);
      document.getElementById('todayStudy').innerHTML = `${todayTotal}<span>åˆ†</span>`;

      // æ˜¨æ—¥ã¨ã®æ¯”è¼ƒ
      if (appData.dailyStudy.length > 1) {
        const yesterdayData = appData.dailyStudy[appData.dailyStudy.length - 2];
        const yesterdayTotal = (yesterdayData.å›½èª || 0) + (yesterdayData.æ•°å­¦ || 0) + (yesterdayData.è‹±èª || 0);
        const diff = todayTotal - yesterdayTotal;
        const diffEl = document.getElementById('todayDiff');
        if (diff > 0) {
          diffEl.textContent = `â†‘ æ˜¨æ—¥ã‚ˆã‚Š${diff}åˆ†å¤šã„`;
          diffEl.className = 'stat-sub';
        } else if (diff < 0) {
          diffEl.textContent = `â†“ æ˜¨æ—¥ã‚ˆã‚Š${Math.abs(diff)}åˆ†å°‘ãªã„`;
          diffEl.className = 'stat-sub warning';
        } else {
          diffEl.textContent = 'æ˜¨æ—¥ã¨åŒã˜';
          diffEl.className = 'stat-sub';
        }
      }

      // é€£ç¶šå­¦ç¿’æ—¥æ•°
      document.getElementById('streak').innerHTML = `${appData.streak}<span>æ—¥</span>`;

      // æœ€ã‚‚å­¦ç¿’ã—ãŸç§‘ç›®
      const subjects = appData.subjectTotals;
      const topSubject = Object.entries(subjects).sort((a, b) => b[1] - a[1])[0];
      document.getElementById('topSubject').textContent = topSubject[0];
      document.getElementById('topSubjectTime').textContent = `${Math.floor(topSubject[1] / 60)}æ™‚é–“${topSubject[1] % 60}åˆ†`;

      // å¹³å‡æ‰‹å¿œãˆ
      const feelings = appData.records.map(r => r.feeling).filter(f => f > 0);
      const avgFeeling = feelings.length > 0 ? feelings.reduce((a, b) => a + b, 0) / feelings.length : 3;
      document.getElementById('avgFeeling').textContent = feelingEmoji[Math.round(avgFeeling)];
      document.getElementById('avgFeelingText').textContent = `å¹³å‡ ${avgFeeling.toFixed(1)} / 5.0`;
    }

    // ============================================
    // ãƒãƒ£ãƒ¼ãƒˆæç”»
    // ============================================
    function renderCharts() {
      // æ—¥åˆ¥å­¦ç¿’æ™‚é–“ãƒãƒ£ãƒ¼ãƒˆ
      const dailyCtx = document.getElementById('dailyChart').getContext('2d');
      if (dailyChart) dailyChart.destroy();
      
      dailyChart = new Chart(dailyCtx, {
        type: 'bar',
        data: {
          labels: appData.dailyStudy.map(d => d.date),
          datasets: [
            {
              label: 'å›½èª',
              data: appData.dailyStudy.map(d => d.å›½èª || 0),
              backgroundColor: '#fecaca',
              borderRadius: 4,
            },
            {
              label: 'æ•°å­¦',
              data: appData.dailyStudy.map(d => d.æ•°å­¦ || 0),
              backgroundColor: '#a7f3d0',
              borderRadius: 4,
            },
            {
              label: 'è‹±èª',
              data: appData.dailyStudy.map(d => d.è‹±èª || 0),
              backgroundColor: '#bfdbfe',
              borderRadius: 4,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { stacked: true, grid: { display: false } },
            y: { 
              stacked: true, 
              grid: { color: '#f0f0f0' },
              ticks: { callback: v => `${v}åˆ†` }
            },
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: ${ctx.raw}åˆ†`
              }
            }
          },
        },
      });

      // ç§‘ç›®åˆ¥å‰²åˆãƒãƒ£ãƒ¼ãƒˆ
      const subjectCtx = document.getElementById('subjectChart').getContext('2d');
      if (subjectChart) subjectChart.destroy();

      const subjectColors = {
        è‹±èª: '#2563eb',
        æ•°å­¦: '#059669', 
        å›½èª: '#dc2626',
      };

      subjectChart = new Chart(subjectCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(appData.subjectTotals),
          datasets: [{
            data: Object.values(appData.subjectTotals),
            backgroundColor: Object.keys(appData.subjectTotals).map(k => subjectColors[k] || '#888'),
            borderWidth: 0,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '65%',
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const mins = ctx.raw;
                  const hours = Math.floor(mins / 60);
                  const remainMins = mins % 60;
                  return `${ctx.label}: ${hours}æ™‚é–“${remainMins}åˆ†`;
                }
              }
            }
          },
        },
      });

      // å‡¡ä¾‹
      const legendEl = document.getElementById('subjectLegend');
      legendEl.innerHTML = Object.entries(appData.subjectTotals)
        .map(([name, mins]) => `
          <div class="legend-item">
            <div class="legend-dot" style="background: ${subjectColors[name]}"></div>
            ${name} (${Math.floor(mins / 60)}h${mins % 60}m)
          </div>
        `).join('');

      // è©³ç´°ãƒãƒ£ãƒ¼ãƒˆ
      const detailCtx = document.getElementById('detailChart').getContext('2d');
      if (detailChart) detailChart.destroy();

      const detailLabels = [];
      const detailData = [];
      const detailColors = [];

      const colorMap = {
        è‹±èª: ['#1d4ed8', '#2563eb', '#3b82f6', '#60a5fa', '#93c5fd'],
        æ•°å­¦: ['#047857', '#059669', '#10b981', '#34d399'],
        å›½èª: ['#b91c1c', '#dc2626', '#ef4444'],
      };

      Object.entries(appData.subjectDetail).forEach(([subject, details]) => {
        const colors = colorMap[subject] || ['#888'];
        Object.entries(details).forEach(([name, mins], i) => {
          detailLabels.push(name);
          detailData.push(mins);
          detailColors.push(colors[i % colors.length]);
        });
      });

      detailChart = new Chart(detailCtx, {
        type: 'bar',
        data: {
          labels: detailLabels,
          datasets: [{
            data: detailData,
            backgroundColor: detailColors,
            borderRadius: 6,
          }],
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
              grid: { color: '#f0f0f0' },
              ticks: { callback: v => `${v}åˆ†` }
            },
            y: { grid: { display: false } },
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.raw}åˆ†`
              }
            }
          },
        },
      });
    }

    // ============================================
    // å­¦ç¿’è¨˜éŒ²
    // ============================================
    function renderRecords() {
      const getSubjectClass = (subject) => {
        if (subject.includes('è‹±')) return 'english';
        if (subject.includes('æ•°')) return 'math';
        if (subject.includes('å›½') || subject.includes('ç¾') || subject.includes('å¤') || subject.includes('æ¼¢')) return 'japanese';
        return '';
      };

      const renderRecordRows = (records) => records.map(r => `
        <div class="record-row">
          <span class="record-date">${r.date}</span>
          <span class="subject-tag ${getSubjectClass(r.subject)}">${r.subject}</span>
          <span class="record-detail">${r.detail || ''} ${r.book ? `<span class="record-book">- ${r.book}</span>` : ''}</span>
          <span class="record-time">${r.time}åˆ†</span>
          <span class="record-feeling">${feelingEmoji[r.feeling] || ''}</span>
        </div>
      `).join('');

      // æœ€è¿‘ã®è¨˜éŒ²ï¼ˆ5ä»¶ï¼‰
      document.getElementById('recentRecords').innerHTML = renderRecordRows(appData.records.slice(0, 5));

      // å…¨è¨˜éŒ²
      document.getElementById('allRecords').innerHTML = renderRecordRows(appData.records);
    }

    // ============================================
    // èµ¤æœ¬è¨˜éŒ²
    // ============================================
    function renderAkabon() {
      const akabon = appData.akabon;
      
      // çµ±è¨ˆ
      document.getElementById('akabonCount').innerHTML = `${akabon.length}<span>å›</span>`;
      
      if (akabon.length > 0) {
        const scores = akabon.map(a => a.score);
        const avg = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
        const best = Math.max(...scores);
        
        document.getElementById('akabonAvg').textContent = `${avg}%`;
        document.getElementById('akabonBest').textContent = `${best}%`;
      }

      // ãƒªã‚¹ãƒˆ
      document.getElementById('akabonList').innerHTML = akabon.map(a => `
        <div class="akabon-card">
          <div class="akabon-header">
            <div>
              <div class="akabon-univ">${a.university}</div>
              <div class="akabon-meta">${a.subject} / ${a.year}å¹´åº¦ / ${a.date}</div>
            </div>
            <div class="akabon-score">${a.score}%</div>
          </div>
          ${a.memo ? `<div class="akabon-memo">ğŸ“ ${a.memo}</div>` : ''}
        </div>
      `).join('');
    }

    // ============================================
    // ç›®æ¨™é€²æ—
    // ============================================
    function renderProgress() {
      const targets = appData.targets;
      
      document.getElementById('japaneseScore').innerHTML = `${targets.å›½èª.current}<span>%</span>`;
      document.getElementById('japaneseFill').style.width = `${targets.å›½èª.current}%`;
      
      document.getElementById('mathScore').innerHTML = `${targets.æ•°å­¦.current}<span>%</span>`;
      document.getElementById('mathFill').style.width = `${targets.æ•°å­¦.current}%`;
      
      document.getElementById('englishScore').innerHTML = `${targets.è‹±èª.current}<span>%</span>`;
      document.getElementById('englishFill').style.width = `${targets.è‹±èª.current}%`;
    }

    // ============================================
    // ãƒ•ã‚©ãƒ¼ãƒ é–¢é€£
    // ============================================
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã®çŠ¶æ…‹
    const formState = {
      study: { subject: null, time: null, feeling: null },
      akabon: { subject: null },
    };

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
    document.addEventListener('DOMContentLoaded', () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('studyDate').value = today;
      document.getElementById('akabonDate').value = today;
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰
    function toggleModal() {
      const modal = document.getElementById('inputModal');
      const overlay = document.getElementById('modalOverlay');
      const fab = document.getElementById('fabButton');
      
      modal.classList.toggle('active');
      overlay.classList.toggle('active');
      fab.classList.toggle('active');
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchFormTab(tab) {
      document.querySelectorAll('.form-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.form-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`.form-tab[data-form="${tab}"]`).classList.add('active');
      document.getElementById(`form-${tab}`).classList.add('active');
    }

    // ãƒœã‚¿ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³é¸æŠ
    document.querySelectorAll('.button-group').forEach(group => {
      group.querySelectorAll('.button-option').forEach(btn => {
        btn.addEventListener('click', () => {
          // åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®é¸æŠã‚’è§£é™¤
          group.querySelectorAll('.button-option').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          
          // çŠ¶æ…‹ã‚’æ›´æ–°
          const value = btn.dataset.value;
          if (group.id === 'subjectButtons') formState.study.subject = value;
          if (group.id === 'timeButtons') formState.study.time = parseInt(value);
          if (group.id === 'akabonSubjectButtons') formState.akabon.subject = value;
        });
      });
    });

    // æ‰‹å¿œãˆé¸æŠ
    document.querySelectorAll('.feeling-option').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.feeling-option').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        formState.study.feeling = parseInt(btn.dataset.value);
      });
    });

    // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // å­¦ç¿’è¨˜éŒ²ã‚’é€ä¿¡
    async function submitStudyRecord() {
      const button = document.getElementById('submitStudy');
      
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!formState.study.subject) {
        showToast('ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      if (!formState.study.time) {
        showToast('å­¦ç¿’æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const record = {
        type: 'study',
        date: document.getElementById('studyDate').value,
        subject: formState.study.subject,
        time: formState.study.time,
        feeling: formState.study.feeling || 3,
        book: document.getElementById('bookName').value,
        memo: document.getElementById('studyMemo').value,
      };

      button.disabled = true;
      button.textContent = 'ä¿å­˜ä¸­...';

      try {
        if (SCRIPT_URL) {
          await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(record),
          });
        }

        // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚æˆåŠŸæ‰±ã„
        button.textContent = 'âœ“ ä¿å­˜ã—ã¾ã—ãŸï¼';
        button.classList.add('success');
        showToast('å­¦ç¿’è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        setTimeout(() => {
          resetStudyForm();
          toggleModal();
          loadData(); // ãƒ‡ãƒ¼ã‚¿å†å–å¾—
        }, 1000);

      } catch (error) {
        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        button.disabled = false;
        button.textContent = 'è¨˜éŒ²ã‚’ä¿å­˜';
      }
    }

    // èµ¤æœ¬è¨˜éŒ²ã‚’é€ä¿¡
    async function submitAkabonRecord() {
      const button = document.getElementById('submitAkabon');
      
      const univ = document.getElementById('akabonUniv').value;
      const score = document.getElementById('akabonScore').value;
      
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!univ) {
        showToast('å¤§å­¦åã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      if (!formState.akabon.subject) {
        showToast('ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      if (!score) {
        showToast('å¾—ç‚¹ç‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const record = {
        type: 'akabon',
        date: document.getElementById('akabonDate').value,
        university: univ,
        subject: formState.akabon.subject,
        year: document.getElementById('akabonYear').value,
        score: parseInt(score),
        memo: document.getElementById('akabonMemo').value,
      };

      button.disabled = true;
      button.textContent = 'ä¿å­˜ä¸­...';

      try {
        if (SCRIPT_URL) {
          await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(record),
          });
        }

        button.textContent = 'âœ“ ä¿å­˜ã—ã¾ã—ãŸï¼';
        button.classList.add('success');
        showToast('èµ¤æœ¬è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');

        setTimeout(() => {
          resetAkabonForm();
          toggleModal();
          loadData();
        }, 1000);

      } catch (error) {
        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        button.disabled = false;
        button.textContent = 'è¨˜éŒ²ã‚’ä¿å­˜';
      }
    }

    // å­¦ç¿’è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    function resetStudyForm() {
      formState.study = { subject: null, time: null, feeling: null };
      document.querySelectorAll('#form-study .button-option').forEach(b => b.classList.remove('selected'));
      document.querySelectorAll('#form-study .feeling-option').forEach(b => b.classList.remove('selected'));
      document.getElementById('bookName').value = '';
      document.getElementById('studyMemo').value = '';
      document.getElementById('studyDate').value = new Date().toISOString().split('T')[0];
      
      const button = document.getElementById('submitStudy');
      button.disabled = false;
      button.textContent = 'è¨˜éŒ²ã‚’ä¿å­˜';
      button.classList.remove('success');
    }

    // èµ¤æœ¬ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    function resetAkabonForm() {
      formState.akabon = { subject: null };
      document.querySelectorAll('#form-akabon .button-option').forEach(b => b.classList.remove('selected'));
      document.getElementById('akabonUniv').value = '';
      document.getElementById('akabonScore').value = '';
      document.getElementById('akabonMemo').value = '';
      document.getElementById('akabonDate').value = new Date().toISOString().split('T')[0];
      
      const button = document.getElementById('submitAkabon');
      button.disabled = false;
      button.textContent = 'è¨˜éŒ²ã‚’ä¿å­˜';
      button.classList.remove('success');
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('inputModal');
        if (modal.classList.contains('active')) {
          toggleModal();
        }
      }
    });
  </script>

</body>
</html>
