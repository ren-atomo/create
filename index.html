<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Tracker</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=Noto+Sans+JP:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --black: #0a0a0a;
      --gray-900: #171717;
      --gray-800: #262626;
      --gray-700: #404040;
      --gray-600: #525252;
      --gray-500: #737373;
      --gray-400: #a3a3a3;
      --gray-300: #d4d4d4;
      --gray-200: #e5e5e5;
      --gray-100: #f5f5f5;
      --gray-50: #fafafa;
      --white: #ffffff;
      --success: #22c55e;
      --warning: #eab308;
      --danger: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-size: 15px;
    }

    body {
      font-family: 'DM Sans', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--white);
      color: var(--gray-900);
      min-height: 100vh;
      line-height: 1.5;
      letter-spacing: -0.01em;
      -webkit-font-smoothing: antialiased;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--gray-100);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.125rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--black);
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
      font-family: inherit;
      letter-spacing: -0.01em;
    }

    .btn-ghost {
      background: transparent;
      color: var(--gray-600);
    }

    .btn-ghost:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .btn-primary {
      background: var(--black);
      color: var(--white);
    }

    .btn-primary:hover {
      background: var(--gray-800);
    }

    .btn-outline {
      background: var(--white);
      color: var(--gray-900);
      border: 1px solid var(--gray-200);
    }

    .btn-outline:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }

    /* Main */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2.5rem 2rem 6rem;
    }

    /* Hero Section */
    .hero {
      margin-bottom: 3rem;
    }

    .hero-countdown {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .hero-days {
      font-size: 4.5rem;
      font-weight: 600;
      letter-spacing: -0.04em;
      line-height: 1;
      color: var(--black);
    }

    .hero-unit {
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--gray-500);
    }

    .hero-label {
      font-size: 0.9375rem;
      color: var(--gray-500);
    }

    /* Stats Row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1px;
      background: var(--gray-200);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 3rem;
    }

    @media (max-width: 768px) {
      .stats-row {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .stat-item {
      background: var(--white);
      padding: 1.5rem;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--black);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.8125rem;
      color: var(--gray-500);
    }

    /* Progress Section */
    .progress-section {
      margin-bottom: 3rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .section-title {
      font-size: 0.8125rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
    }

    .section-value {
      font-size: 0.875rem;
      color: var(--gray-600);
      font-variant-numeric: tabular-nums;
    }

    .progress-track {
      height: 4px;
      background: var(--gray-100);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--black);
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    /* Grid Layout */
    .grid-2 {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 2rem;
      margin-bottom: 3rem;
    }

    @media (max-width: 900px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    /* Card */
    .card {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .card-title {
      font-size: 0.8125rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
      margin-bottom: 1.25rem;
    }

    /* Chart */
    .chart-container {
      position: relative;
      height: 240px;
    }

    /* Goals */
    .goals-list {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .goal-item {
      display: flex;
      flex-direction: column;
      gap: 0.625rem;
    }

    .goal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .goal-name {
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--gray-900);
    }

    .goal-values {
      font-size: 0.8125rem;
      color: var(--gray-500);
      font-variant-numeric: tabular-nums;
    }

    .goal-bar {
      height: 6px;
      background: var(--gray-100);
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }

    .goal-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .goal-fill.kokugo { background: var(--gray-900); }
    .goal-fill.sugaku { background: var(--gray-600); }
    .goal-fill.eigo { background: var(--gray-400); }
    .goal-fill.rika { background: #22c55e; }
    .goal-fill.shakai { background: #f59e0b; }

    /* Records */
    .records-list {
      display: flex;
      flex-direction: column;
    }

    .record-item {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 0.875rem 0;
      border-bottom: 1px solid var(--gray-100);
    }

    .record-item:last-child {
      border-bottom: none;
    }

    .record-main {
      display: flex;
      align-items: center;
      gap: 1rem;
      width: 100%;
    }

    .record-details {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      padding-left: 0.5rem;
      border-left: 2px solid var(--gray-200);
      margin-left: 0.5rem;
    }

    .record-textbook {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .record-memo {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .record-date {
      font-size: 0.8125rem;
      color: var(--gray-400);
      min-width: 60px;
      font-variant-numeric: tabular-nums;
    }

    .record-subject {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-900);
      padding: 0.25rem 0.625rem;
      background: var(--gray-100);
      border-radius: 4px;
    }

    .record-subject-small {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .record-type {
      font-size: 0.6875rem;
      color: var(--gray-500);
      padding: 0.125rem 0.5rem;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 3px;
    }

    .record-time {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-900);
      margin-left: auto;
      font-variant-numeric: tabular-nums;
    }

    .record-time-small {
      font-size: 0.6875rem;
      color: var(--gray-400);
      font-variant-numeric: tabular-nums;
    }

    .record-mood {
      font-size: 1rem;
      opacity: 0.8;
    }

    .record-score {
      font-size: 0.9375rem;
      font-weight: 600;
      margin-left: auto;
      font-variant-numeric: tabular-nums;
    }

    .record-score.high { color: var(--success); }
    .record-score.mid { color: var(--warning); }
    .record-score.low { color: var(--danger); }

    .record-unit {
      font-size: 0.75rem;
      color: var(--gray-600);
    }

    .record-section {
      font-size: 0.75rem;
      color: var(--gray-600);
    }

    .record-weak {
      font-size: 0.75rem;
      color: var(--danger);
    }

    .empty-state {
      padding: 2rem;
      text-align: center;
      color: var(--gray-400);
      font-size: 0.875rem;
    }

    /* FAB */
    .fab-container {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      display: flex;
      flex-direction: column-reverse;
      align-items: flex-end;
      gap: 0.75rem;
      z-index: 1000;
    }

    .fab {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--black);
      color: var(--white);
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .fab:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .fab.active {
      transform: rotate(45deg);
    }

    .fab-menu {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: all 0.2s ease;
    }

    .fab-menu.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .fab-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-900);
      white-space: nowrap;
    }

    .fab-item:hover {
      background: var(--gray-50);
      transform: translateX(-4px);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      padding: 1rem;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--white);
      border-radius: 16px;
      width: 100%;
      max-width: 440px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px) scale(0.98);
      transition: all 0.2s ease;
    }

    .modal-overlay.active .modal {
      transform: translateY(0) scale(1);
    }

    .modal-header {
      padding: 1.5rem 1.5rem 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--gray-100);
      color: var(--gray-600);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      font-size: 1rem;
    }

    .modal-close:hover {
      background: var(--gray-200);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 0 1.5rem 1.5rem;
      display: flex;
      gap: 0.75rem;
    }

    .modal-footer .btn {
      flex: 1;
      padding: 0.75rem;
    }

    /* Form */
    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-600);
      margin-bottom: 0.5rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 0.9375rem;
      font-family: inherit;
      transition: all 0.15s ease;
      background: var(--white);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--gray-400);
    }

    .form-input::placeholder {
      color: var(--gray-400);
    }

    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23737373'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1rem;
      padding-right: 2.5rem;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* Button Group */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.375rem;
    }

    .btn-option {
      padding: 0.5rem 0.875rem;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      background: var(--white);
      font-size: 0.8125rem;
      font-family: inherit;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn-option:hover {
      border-color: var(--gray-300);
      background: var(--gray-50);
    }

    .btn-option.active {
      border-color: var(--black);
      background: var(--black);
      color: var(--white);
    }

    /* Mood Buttons */
    .mood-group {
      display: flex;
      gap: 0.5rem;
    }

    .mood-btn {
      width: 44px;
      height: 44px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      background: var(--white);
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .mood-btn:hover {
      border-color: var(--gray-300);
      transform: scale(1.05);
    }

    .mood-btn.active {
      border-color: var(--black);
      background: var(--gray-100);
    }

    /* AI Modal */
    .ai-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .ai-option {
      padding: 0.75rem 0.5rem;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      background: var(--white);
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: center;
    }

    .ai-option:hover {
      border-color: var(--gray-300);
    }

    .ai-option.active {
      border-color: var(--black);
      background: var(--gray-50);
    }

    .ai-option-icon {
      font-size: 1.25rem;
      margin-bottom: 0.375rem;
    }

    .ai-option-label {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    .prompt-preview {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 1rem;
      font-size: 0.75rem;
      font-family: 'SF Mono', 'Consolas', monospace;
      white-space: pre-wrap;
      max-height: 280px;
      overflow-y: auto;
      line-height: 1.6;
      color: var(--gray-700);
    }

    /* Loading */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid var(--gray-200);
      border-top-color: var(--black);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 6rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 4000;
    }

    .toast {
      padding: 0.75rem 1.25rem;
      background: var(--gray-900);
      color: var(--white);
      border-radius: 8px;
      font-size: 0.875rem;
      animation: fadeUp 0.2s ease;
    }

    .toast.error {
      background: var(--danger);
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive */
    @media (max-width: 640px) {
      html {
        font-size: 14px;
      }

      .header-content {
        padding: 0.875rem 1rem;
      }

      .main {
        padding: 1.5rem 1rem 5rem;
      }

      .hero-days {
        font-size: 3.5rem;
      }

      .stats-row {
        grid-template-columns: repeat(2, 1fr);
      }

      .stat-item {
        padding: 1rem;
      }

      .stat-value {
        font-size: 1.5rem;
      }

      .grid-2 {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .fab-container {
        bottom: 1.5rem;
        right: 1.5rem;
      }

      .fab {
        width: 52px;
        height: 52px;
      }

      .ai-options {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-400);
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">Study Tracker</div>
      <div class="header-actions">
        <button class="btn btn-ghost" onclick="openSettingsModal()">è¨­å®š</button>
        <button class="btn btn-ghost" onclick="refreshData()">æ›´æ–°</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <!-- Hero -->
    <section class="hero">
      <div class="hero-countdown">
        <span class="hero-days" id="mainCountdown">--</span>
        <span class="hero-unit">æ—¥</span>
      </div>
      <p class="hero-label">å…±é€šãƒ†ã‚¹ãƒˆã¾ã§</p>
    </section>

    <!-- Stats -->
    <section class="stats-row">
      <div class="stat-item">
        <div class="stat-value" id="todayMinutes">0åˆ†</div>
        <div class="stat-label">ä»Šæ—¥</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="weekMinutes">0æ™‚é–“</div>
        <div class="stat-label">ä»Šé€±</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="streakDays">0</div>
        <div class="stat-label">é€£ç¶šæ—¥æ•°</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="totalSessions">0</div>
        <div class="stat-label">å­¦ç¿’å›æ•°</div>
      </div>
    </section>

    <!-- Progress -->
    <section class="progress-section">
      <div class="section-header">
        <span class="section-title">é€±é–“ç›®æ¨™</span>
        <span class="section-value" id="progressValue">0 / 1800 åˆ†</span>
      </div>
      <div class="progress-track">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </section>

    <!-- Charts -->
    <section class="grid-2">
      <div class="card">
        <h3 class="card-title">æ—¥åˆ¥å­¦ç¿’æ™‚é–“</h3>
        <div class="chart-container">
          <canvas id="dailyChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 class="card-title">ç§‘ç›®åˆ¥å‰²åˆ</h3>
        <div class="chart-container">
          <canvas id="subjectChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Goals -->
    <section class="card" style="margin-bottom: 2rem;">
      <h3 class="card-title">ç›®æ¨™é€²æ—</h3>
      <div class="goals-list" id="goalsSection">
        <!-- Goals rendered here -->
      </div>
    </section>

    <!-- Records -->
    <section class="grid-2">
      <div class="card">
        <h3 class="card-title">æœ€è¿‘ã®å­¦ç¿’è¨˜éŒ²</h3>
        <div class="records-list" id="studyRecordsList">
          <div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
      <div class="card">
        <h3 class="card-title">èµ¤æœ¬æ¼”ç¿’å±¥æ­´</h3>
        <div class="records-list" id="redbookRecordsList">
          <div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
    </section>
  </main>

  <!-- FAB -->
  <div class="fab-container">
    <div class="fab-menu" id="fabMenu">
      <button class="fab-item" onclick="openAIModal()">
        <span>ğŸ¤–</span> AIã«ç›¸è«‡
      </button>
      <button class="fab-item" onclick="openRedbookModal()">
        <span>ğŸ“•</span> èµ¤æœ¬è¨˜éŒ²
      </button>
      <button class="fab-item" onclick="openStudyModal()">
        <span>ğŸ“–</span> å­¦ç¿’è¨˜éŒ²
      </button>
    </div>
    <button class="fab" id="fabButton" onclick="toggleFab()">ï¼‹</button>
  </div>

  <!-- Study Log Modal -->
  <div class="modal-overlay" id="studyModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">å­¦ç¿’è¨˜éŒ²ã‚’è¿½åŠ </h2>
        <button class="modal-close" onclick="closeStudyModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">æ—¥ä»˜</label>
          <input type="date" class="form-input" id="studyDate">
        </div>
        <div class="form-group">
          <label class="form-label">ç§‘ç›®</label>
          <div class="btn-group" id="subjectButtons">
            <button class="btn-option" data-value="ç¾ä»£æ–‡">ç¾ä»£æ–‡</button>
            <button class="btn-option" data-value="å¤æ–‡">å¤æ–‡</button>
            <button class="btn-option" data-value="æ¼¢æ–‡">æ¼¢æ–‡</button>
            <button class="btn-option" data-value="æ•°å­¦1A">æ•°å­¦1A</button>
            <button class="btn-option" data-value="æ•°å­¦2B">æ•°å­¦2B</button>
            <button class="btn-option" data-value="å˜èª">å˜èª</button>
            <button class="btn-option" data-value="æ–‡æ³•">æ–‡æ³•</button>
            <button class="btn-option" data-value="é•·æ–‡">é•·æ–‡</button>
            <button class="btn-option" data-value="éŸ³èª­">éŸ³èª­</button>
            <button class="btn-option" data-value="ãƒªã‚¹ãƒ‹ãƒ³ã‚°">ãƒªã‚¹ãƒ‹ãƒ³ã‚°</button>
            <button class="btn-option" data-value="ãã®ä»–">ãã®ä»–</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ¯ å­¦ç¿’ã‚¿ã‚¤ãƒ—</label>
          <div class="btn-group" id="studyTypeButtons">
            <button class="btn-option" data-value="æ–°è¦">æ–°è¦</button>
            <button class="btn-option" data-value="å¾©ç¿’">å¾©ç¿’</button>
            <button class="btn-option" data-value="æ¼”ç¿’">æ¼”ç¿’</button>
            <button class="btn-option" data-value="æš—è¨˜">æš—è¨˜</button>
            <button class="btn-option" data-value="éå»å•">éå»å•</button>
            <button class="btn-option" data-value="æ¨¡è©¦">æ¨¡è©¦</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">å­¦ç¿’æ™‚é–“</label>
          <div class="btn-group" id="timeButtons">
            <button class="btn-option" data-value="15">15åˆ†</button>
            <button class="btn-option" data-value="30">30åˆ†</button>
            <button class="btn-option" data-value="45">45åˆ†</button>
            <button class="btn-option" data-value="50">50åˆ†</button>
            <button class="btn-option" data-value="60">1æ™‚é–“</button>
            <button class="btn-option" data-value="90">1.5æ™‚é–“</button>
            <button class="btn-option" data-value="120">2æ™‚é–“</button>
            <button class="btn-option" data-value="150">2æ™‚é–“è¶…</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">æ‰‹å¿œãˆ</label>
          <div class="mood-group" id="moodButtons">
            <button class="mood-btn" data-value="ğŸ˜«">ğŸ˜«</button>
            <button class="mood-btn" data-value="ğŸ˜•">ğŸ˜•</button>
            <button class="mood-btn" data-value="ğŸ˜">ğŸ˜</button>
            <button class="mood-btn" data-value="ğŸ™‚">ğŸ™‚</button>
            <button class="mood-btn" data-value="ğŸ˜Š">ğŸ˜Š</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ“š å˜å…ƒãƒ»ç« ï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="studyUnit" placeholder="ä¾‹: ç¬¬3ç«  äºŒæ¬¡é–¢æ•°ã€Unit15-16">
        </div>
        <div class="form-group">
          <label class="form-label">å‚è€ƒæ›¸åï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="studyTextbook" placeholder="ä¾‹: é€Ÿèª­è‹±å˜èª">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <textarea class="form-input form-textarea" id="studyMemo" placeholder="å­¦ç¿’å†…å®¹ã‚„æ°—ã¥ããªã©"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeStudyModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="submitStudyLog()">è¨˜éŒ²ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Redbook Modal -->
  <div class="modal-overlay" id="redbookModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">èµ¤æœ¬è¨˜éŒ²ã‚’è¿½åŠ </h2>
        <button class="modal-close" onclick="closeRedbookModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">æ—¥ä»˜</label>
          <input type="date" class="form-input" id="redbookDate">
        </div>
        <div class="form-group">
          <label class="form-label">å¤§å­¦å</label>
          <select class="form-input form-select" id="redbookUniversity">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="ç«‹æ•™å¤§å­¦">ç«‹æ•™å¤§å­¦</option>
            <option value="é’å±±å­¦é™¢å¤§å­¦">é’å±±å­¦é™¢å¤§å­¦</option>
            <option value="æ³•æ”¿å¤§å­¦">æ³•æ”¿å¤§å­¦</option>
            <option value="ä¸­å¤®å¤§å­¦">ä¸­å¤®å¤§å­¦</option>
            <option value="æ˜æ²»å­¦é™¢å¤§å­¦">æ˜æ²»å­¦é™¢å¤§å­¦</option>
            <option value="æˆåŸå¤§å­¦">æˆåŸå¤§å­¦</option>
            <option value="æ±æ´‹å¤§å­¦">æ±æ´‹å¤§å­¦</option>
            <option value="é§’æ¾¤å¤§å­¦">é§’æ¾¤å¤§å­¦</option>
            <option value="æ—¥æœ¬å¤§å­¦">æ—¥æœ¬å¤§å­¦</option>
            <option value="å°‚ä¿®å¤§å­¦">å°‚ä¿®å¤§å­¦</option>
            <option value="å…±é€šãƒ†ã‚¹ãƒˆ">å…±é€šãƒ†ã‚¹ãƒˆ</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ç§‘ç›®</label>
          <select class="form-input form-select" id="redbookSubject">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <optgroup label="è‹±èª">
              <option value="è‹±èªR">è‹±èªRï¼ˆãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰</option>
              <option value="è‹±èªL">è‹±èªLï¼ˆãƒªã‚¹ãƒ‹ãƒ³ã‚°ï¼‰</option>
              <option value="è‹±èª">è‹±èªï¼ˆç·åˆï¼‰</option>
            </optgroup>
            <optgroup label="å›½èª">
              <option value="ç¾ä»£æ–‡">ç¾ä»£æ–‡</option>
              <option value="å¤æ–‡">å¤æ–‡</option>
              <option value="æ¼¢æ–‡">æ¼¢æ–‡</option>
              <option value="å›½èª">å›½èªï¼ˆç·åˆï¼‰</option>
            </optgroup>
            <optgroup label="æ•°å­¦">
              <option value="æ•°å­¦IA">æ•°å­¦IA</option>
              <option value="æ•°å­¦IIB">æ•°å­¦IIB</option>
              <option value="æ•°å­¦IIIC">æ•°å­¦IIIC</option>
              <option value="æ•°å­¦">æ•°å­¦ï¼ˆç·åˆï¼‰</option>
            </optgroup>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">å¹´åº¦</label>
          <select class="form-input form-select" id="redbookYear">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="2025">2025å¹´</option>
            <option value="2024">2024å¹´</option>
            <option value="2023">2023å¹´</option>
            <option value="2022">2022å¹´</option>
            <option value="2021">2021å¹´</option>
            <option value="2020">2020å¹´</option>
            <option value="2019">2019å¹´</option>
            <option value="2018">2018å¹´</option>
            <option value="2017">2017å¹´</option>
            <option value="2016">2016å¹´</option>
            <option value="2015">2015å¹´</option>
            <option value="2014ä»¥å‰">2014å¹´ä»¥å‰</option>
            <option value="ã‚ªãƒªã‚¸ãƒŠãƒ«">ã‚ªãƒªã‚¸ãƒŠãƒ«å•é¡Œ</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">å¾—ç‚¹ç‡ï¼ˆ%ï¼‰</label>
          <input type="number" class="form-input" id="redbookScore" min="0" max="100" placeholder="ä¾‹: 75">
        </div>
        <div class="form-group">
          <label class="form-label">â±ï¸ è§£ç­”æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
          <input type="number" class="form-input" id="redbookTime" min="0" placeholder="ä¾‹: 80">
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ“ å¤§å•ã”ã¨ã®å¾—ç‚¹ï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="redbookSectionScores" placeholder="ä¾‹: å¤§å•1:8/10, å¤§å•2:12/20, å¤§å•3:15/20">
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ“‹ é–“é•ãˆãŸåˆ†é‡ï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="redbookWeakAreas" placeholder="ä¾‹: é–¢ä¿‚è©ã€é•·æ–‡èª­è§£ã€ç¢ºç‡">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <textarea class="form-input form-textarea" id="redbookMemo" placeholder="åçœç‚¹ã‚„æ¬¡å›ã®èª²é¡Œãªã©"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeRedbookModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="submitRedbookLog()">è¨˜éŒ²ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- AI Modal -->
  <div class="modal-overlay" id="aiModal">
    <div class="modal" style="max-width: 520px;">
      <div class="modal-header">
        <h2 class="modal-title">AIã«ç›¸è«‡</h2>
        <button class="modal-close" onclick="closeAIModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="ai-options" id="aiOptions">
          <div class="ai-option active" data-type="weekly">
            <div class="ai-option-icon">ğŸ“…</div>
            <div class="ai-option-label">é€±é–“è¨ˆç”»</div>
          </div>
          <div class="ai-option" data-type="daily">
            <div class="ai-option-icon">ğŸ“</div>
            <div class="ai-option-label">ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Š</div>
          </div>
          <div class="ai-option" data-type="weakness">
            <div class="ai-option-icon">ğŸ¯</div>
            <div class="ai-option-label">å¼±ç‚¹åˆ†æ</div>
          </div>
          <div class="ai-option" data-type="prediction">
            <div class="ai-option-icon">ğŸ“Š</div>
            <div class="ai-option-label">å¾—ç‚¹äºˆæ¸¬</div>
          </div>
          <div class="ai-option" data-type="subject">
            <div class="ai-option-icon">ğŸ“š</div>
            <div class="ai-option-label">ç§‘ç›®åˆ¥ç›¸è«‡</div>
          </div>
          <div class="ai-option" data-type="lastspurt">
            <div class="ai-option-icon">ğŸ”¥</div>
            <div class="ai-option-label">ç›´å‰æœŸå¯¾ç­–</div>
          </div>
          <div class="ai-option" data-type="motivation">
            <div class="ai-option-icon">ğŸ’ª</div>
            <div class="ai-option-label">ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³</div>
          </div>
        </div>
        
        <!-- ç§‘ç›®é¸æŠï¼ˆç§‘ç›®åˆ¥ç›¸è«‡æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
        <div class="form-group" id="subjectSelectGroup" style="display: none;">
          <label class="form-label">ç›¸è«‡ã—ãŸã„ç§‘ç›®</label>
          <select class="form-select" id="aiSubjectSelect" onchange="generatePrompt()">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="è‹±èª">è‹±èª</option>
            <option value="æ•°å­¦">æ•°å­¦</option>
            <option value="å›½èª">å›½èª</option>
            <option value="ç†ç§‘">ç†ç§‘</option>
            <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
          </select>
        </div>
        <label class="form-label">ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
        <div class="prompt-preview" id="promptPreview">ç”Ÿæˆä¸­...</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeAIModal()">é–‰ã˜ã‚‹</button>
        <button class="btn btn-primary" onclick="copyPrompt()">ã‚³ãƒ”ãƒ¼ã—ã¦AIã¸</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">è¨­å®š</h2>
        <button class="modal-close" onclick="closeSettingsModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Apps Script URL</label>
          <input type="text" class="form-input" id="settingsApiUrl" placeholder="https://script.google.com/...">
        </div>
        <div class="form-group">
          <label class="form-label">é€±é–“ç›®æ¨™ï¼ˆåˆ†ï¼‰</label>
          <input type="number" class="form-input" id="settingsWeeklyGoal" value="1800" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">å…±é€šãƒ†ã‚¹ãƒˆæ—¥</label>
          <input type="date" class="form-input" id="settingsExamDate">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeSettingsModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    let API_URL = localStorage.getItem('apiUrl') || 'https://script.google.com/macros/s/AKfycbw-DjDh59MJbi4zQIgDNA5EI5eozWjN_tSU-v0YH0Bzvs744moswzobFyB9VNqRNef7KA/exec';
    let appData = {
      studyLogs: [],
      redbookLogs: [],
      goals: [],
      profile: {},
      settings: { weeklyGoalMinutes: 1800 }
    };
    
    let selectedSubject = '';
    let selectedTime = 0;
    let selectedMood = '';
    let selectedStudyType = '';
    let selectedAIType = 'weekly';
    
    let dailyChart = null;
    let subjectChart = null;
    
    document.addEventListener('DOMContentLoaded', () => {
      initializeDateInputs();
      initializeButtonGroups();
      initializeAIOptions();
      loadSettingsFromStorage();
      
      if (API_URL) {
        refreshData();
      } else {
        hideLoading();
      }
    });
    
    function initializeDateInputs() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('studyDate').value = today;
      document.getElementById('redbookDate').value = today;
    }
    
    function initializeButtonGroups() {
      document.querySelectorAll('#subjectButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#subjectButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedSubject = btn.dataset.value;
        });
      });
      
      document.querySelectorAll('#timeButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#timeButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedTime = parseInt(btn.dataset.value);
        });
      });
      
      document.querySelectorAll('#moodButtons .mood-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#moodButtons .mood-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedMood = btn.dataset.value;
        });
      });
      
      document.querySelectorAll('#studyTypeButtons .btn-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#studyTypeButtons .btn-option').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedStudyType = btn.dataset.value;
        });
      });
    }
    
    function initializeAIOptions() {
      document.querySelectorAll('.ai-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.ai-option').forEach(o => o.classList.remove('active'));
          option.classList.add('active');
          selectedAIType = option.dataset.type;
          
          // ç§‘ç›®åˆ¥ç›¸è«‡ã®å ´åˆã®ã¿ç§‘ç›®é¸æŠã‚’è¡¨ç¤º
          const subjectSelectGroup = document.getElementById('subjectSelectGroup');
          if (selectedAIType === 'subject') {
            subjectSelectGroup.style.display = 'block';
          } else {
            subjectSelectGroup.style.display = 'none';
          }
          
          generatePrompt();
        });
      });
    }
    
    function loadSettingsFromStorage() {
      const apiUrl = localStorage.getItem('apiUrl');
      const weeklyGoal = localStorage.getItem('weeklyGoal');
      const examDate = localStorage.getItem('examDate');
      
      if (apiUrl) {
        API_URL = apiUrl;
        document.getElementById('settingsApiUrl').value = apiUrl;
      }
      if (weeklyGoal) {
        appData.settings.weeklyGoalMinutes = parseInt(weeklyGoal);
        document.getElementById('settingsWeeklyGoal').value = weeklyGoal;
      }
      if (examDate) {
        document.getElementById('settingsExamDate').value = examDate;
      }
    }
    
    async function fetchData() {
      if (!API_URL) throw new Error('API URL not set');
      
      console.log('Fetching from:', API_URL);
      
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonpCallback_' + Date.now();
        const script = document.createElement('script');
        
        window[callbackName] = (data) => {
          console.log('JSONP callback received:', data);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          resolve(data);
        };
        
        const fullUrl = `${API_URL}?action=getAllData&callback=${callbackName}`;
        console.log('Full URL:', fullUrl);
        script.src = fullUrl;
        
        script.onerror = (e) => {
          console.error('Script load error:', e);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          reject(new Error('ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€‚Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'));
        };
        
        document.body.appendChild(script);
        
        setTimeout(() => {
          if (window[callbackName]) {
            console.error('JSONP timeout - callback not called');
            delete window[callbackName];
            if (script.parentNode) script.parentNode.removeChild(script);
            reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€‚Apps ScriptãŒæ­£ã—ãå¿œç­”ã—ã¦ã„ã¾ã›ã‚“ã€‚'));
          }
        }, 15000);
      });
    }
    
    async function postData(data) {
      if (!API_URL) throw new Error('API URL not set');
      
      console.log('Posting data:', data);
      
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonpPostCallback_' + Date.now();
        const script = document.createElement('script');
        
        window[callbackName] = (response) => {
          console.log('POST callback received:', response);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          if (response.error) {
            reject(new Error(response.error));
          } else {
            resolve(response);
          }
        };
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
        const params = new URLSearchParams();
        params.append('action', data.action);
        params.append('data', JSON.stringify(data));
        params.append('callback', callbackName);
        
        const fullUrl = `${API_URL}?${params.toString()}`;
        console.log('POST URL:', fullUrl);
        script.src = fullUrl;
        
        script.onerror = (e) => {
          console.error('POST script error:', e);
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
          reject(new Error('ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚¨ãƒ©ãƒ¼'));
        };
        
        document.body.appendChild(script);
        
        setTimeout(() => {
          if (window[callbackName]) {
            delete window[callbackName];
            if (script.parentNode) script.parentNode.removeChild(script);
            reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
          }
        }, 15000);
      });
    }
    
    async function refreshData() {
      showLoading();
      try {
        const data = await fetchData();
        if (data.error) throw new Error(data.error);
        appData = data;
        renderDashboard();
        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('Error:', error);
        showToast(error.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    function renderDashboard() {
      renderCountdown();
      renderStats();
      renderProgress();
      renderCharts();
      renderGoals();
      renderStudyRecords();
      renderRedbookRecords();
    }
    
    function renderCountdown() {
      const examDate = localStorage.getItem('examDate') || '2025-01-18';
      const mainExam = new Date(examDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const daysUntil = Math.ceil((mainExam - today) / (1000 * 60 * 60 * 24));
      document.getElementById('mainCountdown').textContent = Math.max(0, daysUntil);
    }
    
    function renderStats() {
      const logs = appData.studyLogs || [];
      const today = new Date().toISOString().split('T')[0];
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      const monthAgo = new Date();
      monthAgo.setDate(monthAgo.getDate() - 30);
      
      const todayMinutes = logs
        .filter(log => log.date === today)
        .reduce((sum, log) => sum + (log.minutes || 0), 0);
      document.getElementById('todayMinutes').textContent = todayMinutes + 'åˆ†';
      
      const weekMinutes = logs
        .filter(log => new Date(log.date) >= weekAgo)
        .reduce((sum, log) => sum + (log.minutes || 0), 0);
      document.getElementById('weekMinutes').textContent = Math.round(weekMinutes / 60) + 'æ™‚é–“';
      
      const streakDays = calculateStreak(logs);
      document.getElementById('streakDays').textContent = streakDays;
      
      const monthSessions = logs.filter(log => new Date(log.date) >= monthAgo).length;
      document.getElementById('totalSessions').textContent = monthSessions;
    }
    
    function calculateStreak(logs) {
      if (logs.length === 0) return 0;
      
      const dates = [...new Set(logs.map(log => log.date))].sort().reverse();
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      let streak = 0;
      let currentDate = new Date(today);
      
      const todayStr = today.toISOString().split('T')[0];
      if (!dates.includes(todayStr)) {
        currentDate.setDate(currentDate.getDate() - 1);
      }
      
      for (let i = 0; i < 365; i++) {
        const dateStr = currentDate.toISOString().split('T')[0];
        if (dates.includes(dateStr)) {
          streak++;
          currentDate.setDate(currentDate.getDate() - 1);
        } else {
          break;
        }
      }
      
      return streak;
    }
    
    function renderProgress() {
      const logs = appData.studyLogs || [];
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      
      const weekMinutes = logs
        .filter(log => new Date(log.date) >= weekAgo)
        .reduce((sum, log) => sum + (log.minutes || 0), 0);
      
      const goal = appData.settings?.weeklyGoalMinutes || 1800;
      const percent = Math.min(100, Math.round((weekMinutes / goal) * 100));
      
      document.getElementById('progressValue').textContent = `${weekMinutes} / ${goal} åˆ†`;
      document.getElementById('progressFill').style.width = `${percent}%`;
    }
    
    function renderCharts() {
      renderDailyChart();
      renderSubjectChart();
    }
    
    function renderDailyChart() {
      const ctx = document.getElementById('dailyChart').getContext('2d');
      const logs = appData.studyLogs || [];
      
      const days = [];
      const subjectData = {};
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const dayLabel = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
        days.push(dayLabel);
        
        const dayLogs = logs.filter(log => log.date === dateStr);
        dayLogs.forEach(log => {
          const subject = categorizeSubject(log.subject);
          if (!subjectData[subject]) {
            subjectData[subject] = Array(7).fill(0);
          }
          subjectData[subject][6 - i] += log.minutes || 0;
        });
      }
      
      const colors = {
        'è‹±èª': '#0a0a0a',
        'æ•°å­¦': '#525252',
        'å›½èª': '#a3a3a3',
        'ãã®ä»–': '#d4d4d4'
      };
      
      const datasets = Object.entries(subjectData).map(([subject, data]) => ({
        label: subject,
        data: data,
        backgroundColor: colors[subject] || '#d4d4d4',
        borderRadius: 2,
        barThickness: 16
      }));
      
      if (dailyChart) dailyChart.destroy();
      
      dailyChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: days, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
              stacked: true,
              grid: { display: false },
              border: { display: false },
              ticks: { color: '#a3a3a3', font: { size: 11 } }
            },
            y: { 
              stacked: true,
              beginAtZero: true,
              grid: { color: '#f5f5f5' },
              border: { display: false },
              ticks: { color: '#a3a3a3', font: { size: 11 } }
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 8,
                boxHeight: 8,
                padding: 16,
                color: '#525252',
                font: { size: 11 }
              }
            }
          }
        }
      });
    }
    
    function renderSubjectChart() {
      const ctx = document.getElementById('subjectChart').getContext('2d');
      const logs = appData.studyLogs || [];
      
      const monthAgo = new Date();
      monthAgo.setDate(monthAgo.getDate() - 30);
      
      const subjectMinutes = {};
      logs
        .filter(log => new Date(log.date) >= monthAgo)
        .forEach(log => {
          const subject = log.subject || 'ãã®ä»–';
          subjectMinutes[subject] = (subjectMinutes[subject] || 0) + (log.minutes || 0);
        });
      
      const sortedSubjects = Object.entries(subjectMinutes).sort((a, b) => b[1] - a[1]);
      
      const grays = ['#0a0a0a', '#262626', '#404040', '#525252', '#737373', '#a3a3a3', '#d4d4d4', '#e5e5e5', '#f5f5f5'];
      
      if (subjectChart) subjectChart.destroy();
      
      subjectChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: sortedSubjects.map(s => s[0]),
          datasets: [{
            data: sortedSubjects.map(s => s[1]),
            backgroundColor: grays.slice(0, sortedSubjects.length),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 8,
                boxHeight: 8,
                padding: 12,
                color: '#525252',
                font: { size: 11 }
              }
            }
          },
          cutout: '65%'
        }
      });
    }
    
    function categorizeSubject(subject) {
      // è‹±èªç³»
      const english = ['å˜èª', 'æ–‡æ³•', 'é•·æ–‡', 'éŸ³èª­', 'ãƒªã‚¹ãƒ‹ãƒ³ã‚°', 'è‹±èª', 'è‹±èªR', 'è‹±èªL'];
      // æ•°å­¦ç³»
      const math = ['æ•°å­¦1A', 'æ•°å­¦2B', 'æ•°å­¦', 'æ•°å­¦IA', 'æ•°å­¦IIB', 'æ•°å­¦IIIC'];
      // å›½èªç³»
      const japanese = ['ç¾ä»£æ–‡', 'å¤æ–‡', 'æ¼¢æ–‡', 'å›½èª'];
      // ç†ç§‘ç³»
      const science = ['ç‰©ç†', 'ç‰©ç†åŸºç¤', 'åŒ–å­¦', 'åŒ–å­¦åŸºç¤', 'ç”Ÿç‰©', 'ç”Ÿç‰©åŸºç¤', 'åœ°å­¦', 'åœ°å­¦åŸºç¤'];
      // ç¤¾ä¼šç³»
      const social = ['æ—¥æœ¬å²', 'ä¸–ç•Œå²', 'åœ°ç†', 'æ”¿æ²»çµŒæ¸ˆ', 'å€«ç†', 'å€«ç†æ”¿çµŒ', 'ç¾ä»£ç¤¾ä¼š', 'å…¬å…±'];
      
      if (english.includes(subject)) return 'è‹±èª';
      if (math.includes(subject)) return 'æ•°å­¦';
      if (japanese.includes(subject)) return 'å›½èª';
      if (science.includes(subject)) return 'ç†ç§‘';
      if (social.includes(subject)) return 'ç¤¾ä¼š';
      return 'ãã®ä»–';
    }
    
    function renderGoals() {
      const section = document.getElementById('goalsSection');
      const goals = appData.goals || [];
      
      if (goals.length === 0) {
        section.innerHTML = '<div class="empty-state">ç›®æ¨™ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        return;
      }
      
      const classes = { 'å›½èª': 'kokugo', 'æ•°å­¦': 'sugaku', 'è‹±èª': 'eigo', 'ç†ç§‘': 'rika', 'ç¤¾ä¼š': 'shakai' };
      
      section.innerHTML = goals.map(goal => {
        const progress = Math.min(100, Math.round(((goal.current) / (goal.target)) * 100));
        const cls = classes[goal.subject] || 'kokugo';
        
        return `
          <div class="goal-item">
            <div class="goal-header">
              <span class="goal-name">${goal.subject}</span>
              <span class="goal-values">${goal.current}% â†’ ${goal.target}%</span>
            </div>
            <div class="goal-bar">
              <div class="goal-fill ${cls}" style="width: ${progress}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderStudyRecords() {
      const container = document.getElementById('studyRecordsList');
      const logs = (appData.studyLogs || []).slice(0, 8);
      
      if (logs.length === 0) {
        container.innerHTML = '<div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = logs.map(log => {
        const hasDetails = log.memo || log.textbook || log.unit || log.studyType;
        return `
        <div class="record-item ${hasDetails ? 'has-details' : ''}">
          <div class="record-main">
            <span class="record-date">${formatDateShort(log.date)}</span>
            <span class="record-subject">${log.subject}</span>
            ${log.studyType ? `<span class="record-type">${log.studyType}</span>` : ''}
            <span class="record-time">${log.minutes}åˆ†</span>
            <span class="record-mood">${log.mood || ''}</span>
          </div>
          ${hasDetails ? `
            <div class="record-details">
              ${log.unit ? `<span class="record-unit">ğŸ“– ${log.unit}</span>` : ''}
              ${log.textbook ? `<span class="record-textbook">ğŸ“š ${log.textbook}</span>` : ''}
              ${log.memo ? `<span class="record-memo">ğŸ“ ${log.memo}</span>` : ''}
            </div>
          ` : ''}
        </div>
      `}).join('');
    }
    
    function renderRedbookRecords() {
      const container = document.getElementById('redbookRecordsList');
      const logs = (appData.redbookLogs || []).slice(0, 8);
      
      if (logs.length === 0) {
        container.innerHTML = '<div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = logs.map(log => {
        const scoreClass = log.score >= 70 ? 'high' : log.score >= 50 ? 'mid' : 'low';
        const hasDetails = log.memo || log.time || log.sectionScores || log.weakAreas;
        return `
          <div class="record-item ${hasDetails ? 'has-details' : ''}">
            <div class="record-main">
              <span class="record-date">${formatDateShort(log.date)}</span>
              <span>${log.university}</span>
              <span class="record-subject-small">${log.subject || ''}</span>
              ${log.time ? `<span class="record-time-small">â±${log.time}åˆ†</span>` : ''}
              <span class="record-score ${scoreClass}">${log.score}%</span>
            </div>
            ${hasDetails ? `
              <div class="record-details">
                ${log.sectionScores ? `<span class="record-section">ğŸ“Š ${log.sectionScores}</span>` : ''}
                ${log.weakAreas ? `<span class="record-weak">âš ï¸ ${log.weakAreas}</span>` : ''}
                ${log.memo ? `<span class="record-memo">ğŸ“ ${log.memo}</span>` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    function toggleFab() {
      const fab = document.getElementById('fabButton');
      const menu = document.getElementById('fabMenu');
      fab.classList.toggle('active');
      menu.classList.toggle('active');
    }
    
    function openStudyModal() {
      toggleFab();
      resetStudyForm();
      document.getElementById('studyModal').classList.add('active');
    }
    
    function closeStudyModal() {
      document.getElementById('studyModal').classList.remove('active');
    }
    
    function resetStudyForm() {
      document.getElementById('studyDate').value = new Date().toISOString().split('T')[0];
      document.querySelectorAll('#subjectButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#studyTypeButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#timeButtons .btn-option').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#moodButtons .mood-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('studyUnit').value = '';
      document.getElementById('studyTextbook').value = '';
      document.getElementById('studyMemo').value = '';
      selectedSubject = '';
      selectedStudyType = '';
      selectedTime = 0;
      selectedMood = '';
    }
    
    function openRedbookModal() {
      toggleFab();
      resetRedbookForm();
      document.getElementById('redbookModal').classList.add('active');
    }
    
    function closeRedbookModal() {
      document.getElementById('redbookModal').classList.remove('active');
    }
    
    function resetRedbookForm() {
      document.getElementById('redbookDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('redbookUniversity').value = '';
      document.getElementById('redbookSubject').value = '';
      document.getElementById('redbookYear').value = '';
      document.getElementById('redbookScore').value = '';
      document.getElementById('redbookTime').value = '';
      document.getElementById('redbookSectionScores').value = '';
      document.getElementById('redbookWeakAreas').value = '';
      document.getElementById('redbookMemo').value = '';
    }
    
    function openAIModal() {
      toggleFab();
      document.getElementById('aiModal').classList.add('active');
      generatePrompt();
    }
    
    function closeAIModal() {
      document.getElementById('aiModal').classList.remove('active');
    }
    
    function openSettingsModal() {
      document.getElementById('settingsApiUrl').value = API_URL;
      document.getElementById('settingsWeeklyGoal').value = appData.settings?.weeklyGoalMinutes || 1800;
      document.getElementById('settingsExamDate').value = localStorage.getItem('examDate') || '2025-01-18';
      document.getElementById('settingsModal').classList.add('active');
    }
    
    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.remove('active');
    }
    
    async function submitStudyLog() {
      if (!selectedSubject) { showToast('ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      if (!selectedTime) { showToast('å­¦ç¿’æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      
      showLoading();
      
      try {
        await postData({
          action: 'addStudyLog',
          date: document.getElementById('studyDate').value,
          subject: selectedSubject,
          studyType: selectedStudyType,
          minutes: selectedTime,
          mood: selectedMood,
          unit: document.getElementById('studyUnit').value,
          textbook: document.getElementById('studyTextbook').value,
          memo: document.getElementById('studyMemo').value
        });
        
        closeStudyModal();
        showToast('å­¦ç¿’è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        setTimeout(() => refreshData(), 1500);
      } catch (error) {
        showToast(error.message, 'error');
        hideLoading();
      }
    }
    
    async function submitRedbookLog() {
      const university = document.getElementById('redbookUniversity').value;
      const subject = document.getElementById('redbookSubject').value;
      const year = document.getElementById('redbookYear').value;
      const score = document.getElementById('redbookScore').value;
      
      if (!university) { showToast('å¤§å­¦ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      if (!subject) { showToast('ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      if (!year) { showToast('å¹´åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
      if (!score) { showToast('å¾—ç‚¹ç‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
      
      showLoading();
      
      try {
        await postData({
          action: 'addRedbookLog',
          date: document.getElementById('redbookDate').value,
          university,
          subject,
          year,
          score: parseInt(score),
          time: document.getElementById('redbookTime').value ? parseInt(document.getElementById('redbookTime').value) : '',
          sectionScores: document.getElementById('redbookSectionScores').value,
          weakAreas: document.getElementById('redbookWeakAreas').value,
          memo: document.getElementById('redbookMemo').value
        });
        
        closeRedbookModal();
        showToast('èµ¤æœ¬è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        setTimeout(() => refreshData(), 1500);
      } catch (error) {
        showToast(error.message, 'error');
        hideLoading();
      }
    }
    
    function saveSettings() {
      const apiUrl = document.getElementById('settingsApiUrl').value.trim();
      const weeklyGoal = document.getElementById('settingsWeeklyGoal').value;
      const examDate = document.getElementById('settingsExamDate').value;
      
      localStorage.setItem('apiUrl', apiUrl);
      localStorage.setItem('weeklyGoal', weeklyGoal);
      localStorage.setItem('examDate', examDate);
      
      API_URL = apiUrl;
      appData.settings.weeklyGoalMinutes = parseInt(weeklyGoal);
      
      closeSettingsModal();
      showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      
      if (apiUrl) refreshData();
    }
    
    // ==========================================
    // é«˜åº¦ãªåˆ†æã‚¨ãƒ³ã‚¸ãƒ³
    // ==========================================
    
    function analyzeStudyData(logs, redbookLogs, goals, profile) {
      const today = new Date();
      const examDate = new Date(localStorage.getItem('examDate') || '2025-01-18');
      const daysUntil = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
      
      // æœŸé–“åˆ¥ãƒ­ã‚°
      const getLogsInRange = (days) => {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        return logs.filter(log => new Date(log.date) >= cutoff);
      };
      
      const weekLogs = getLogsInRange(7);
      const twoWeekLogs = getLogsInRange(14);
      const monthLogs = getLogsInRange(30);
      
      // ========== åŸºæœ¬çµ±è¨ˆ ==========
      const totalMinutes = logs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      const weekMinutes = weekLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      const prevWeekMinutes = twoWeekLogs.reduce((sum, log) => sum + (log.minutes || 0), 0) - weekMinutes;
      const studyDays = new Set(logs.map(l => l.date)).size;
      const streak = calculateStreak(logs);
      
      // ========== æ›œæ—¥åˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ ==========
      const dayOfWeekStats = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
      const dayOfWeekCount = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
      logs.forEach(log => {
        const dow = new Date(log.date).getDay();
        dayOfWeekStats[dow] += log.minutes || 0;
        dayOfWeekCount[dow]++;
      });
      const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const dayOfWeekAvg = {};
      for (let i = 0; i < 7; i++) {
        dayOfWeekAvg[dayNames[i]] = dayOfWeekCount[i] > 0 
          ? Math.round(dayOfWeekStats[i] / dayOfWeekCount[i]) 
          : 0;
      }
      
      // æœ€ã‚‚å‹‰å¼·ã™ã‚‹æ›œæ—¥ãƒ»ã—ãªã„æ›œæ—¥
      const sortedDays = Object.entries(dayOfWeekAvg).sort((a, b) => b[1] - a[1]);
      const strongDays = sortedDays.filter(d => d[1] > 0).slice(0, 2).map(d => d[0]);
      const weakDays = sortedDays.filter(d => d[1] >= 0).slice(-2).map(d => d[0]);
      
      // ========== ç§‘ç›®åˆ¥è©³ç´°åˆ†æ ==========
      const subjectAnalysis = {};
      const categories = ['è‹±èª', 'æ•°å­¦', 'å›½èª', 'ãã®ä»–'];
      
      categories.forEach(cat => {
        const catLogs = logs.filter(log => categorizeSubject(log.subject) === cat);
        const catWeekLogs = weekLogs.filter(log => categorizeSubject(log.subject) === cat);
        const catPrevWeekLogs = twoWeekLogs.filter(log => categorizeSubject(log.subject) === cat && !catWeekLogs.includes(log));
        
        const weekMin = catWeekLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
        const prevWeekMin = catPrevWeekLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
        const totalMin = catLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
        
        // å­¦ç¿’ã‚¿ã‚¤ãƒ—åˆ¥
        const typeBreakdown = {};
        catWeekLogs.forEach(log => {
          if (log.studyType) {
            typeBreakdown[log.studyType] = (typeBreakdown[log.studyType] || 0) + (log.minutes || 0);
          }
        });
        
        // æ‰‹å¿œãˆåˆ†æ
        const moodBreakdown = { excellent: 0, good: 0, neutral: 0, bad: 0, terrible: 0 };
        catLogs.forEach(log => {
          if (log.mood === 'ğŸ˜Š') moodBreakdown.excellent++;
          else if (log.mood === 'ğŸ™‚') moodBreakdown.good++;
          else if (log.mood === 'ğŸ˜') moodBreakdown.neutral++;
          else if (log.mood === 'ğŸ˜•') moodBreakdown.bad++;
          else if (log.mood === 'ğŸ˜«') moodBreakdown.terrible++;
        });
        
        // ä½¿ç”¨æ•™æ
        const textbooks = {};
        catLogs.forEach(log => {
          if (log.textbook) {
            textbooks[log.textbook] = (textbooks[log.textbook] || 0) + (log.minutes || 0);
          }
        });
        
        // å­¦ç¿’ã—ãŸå˜å…ƒ
        const units = catWeekLogs.filter(l => l.unit).map(l => l.unit);
        
        // å‚¾å‘åˆ¤å®š
        let trend = 'stable';
        if (weekMin > prevWeekMin * 1.2) trend = 'increasing';
        else if (weekMin < prevWeekMin * 0.8) trend = 'decreasing';
        
        subjectAnalysis[cat] = {
          totalMinutes: totalMin,
          weekMinutes: weekMin,
          prevWeekMinutes: prevWeekMin,
          trend,
          typeBreakdown,
          moodBreakdown,
          textbooks,
          recentUnits: units,
          sessionCount: catLogs.length
        };
      });
      
      // ========== å­¦ç¿’ã‚¿ã‚¤ãƒ—ãƒãƒ©ãƒ³ã‚¹ ==========
      const typeBalance = { æ–°è¦: 0, å¾©ç¿’: 0, æ¼”ç¿’: 0, æš—è¨˜: 0, éå»å•: 0, æ¨¡è©¦: 0 };
      weekLogs.forEach(log => {
        if (log.studyType && typeBalance.hasOwnProperty(log.studyType)) {
          typeBalance[log.studyType] += log.minutes || 0;
        }
      });
      const typeTotal = Object.values(typeBalance).reduce((a, b) => a + b, 0);
      const typePercentage = {};
      Object.entries(typeBalance).forEach(([type, min]) => {
        typePercentage[type] = typeTotal > 0 ? Math.round(min / typeTotal * 100) : 0;
      });
      
      // ã‚¿ã‚¤ãƒ—ãƒãƒ©ãƒ³ã‚¹ã®è©•ä¾¡
      let typeBalanceAssessment = [];
      if (typePercentage['å¾©ç¿’'] < 20) typeBalanceAssessment.push('å¾©ç¿’ãŒå°‘ãªã‚ï¼ˆå®šç€ã«ä¸å®‰ï¼‰');
      if (typePercentage['æ¼”ç¿’'] < 15) typeBalanceAssessment.push('æ¼”ç¿’é‡ãŒä¸è¶³ï¼ˆå®Ÿæˆ¦åŠ›ã«èª²é¡Œï¼‰');
      if (typePercentage['æ–°è¦'] > 50) typeBalanceAssessment.push('æ–°è¦å­¦ç¿’ã«åé‡ï¼ˆæ¶ˆåŒ–ä¸è‰¯ã®æã‚Œï¼‰');
      
      // ========== éå»å•åˆ†æ ==========
      const redbookAnalysis = {
        totalAttempts: redbookLogs.length,
        avgScore: 0,
        scoresBySubject: {},
        scoreTrend: 'stable',
        weakAreasSummary: {},
        timeManagement: { adequate: 0, rushed: 0, unknown: 0 }
      };
      
      if (redbookLogs.length > 0) {
        redbookAnalysis.avgScore = Math.round(
          redbookLogs.reduce((sum, l) => sum + l.score, 0) / redbookLogs.length
        );
        
        // ç§‘ç›®åˆ¥å¹³å‡
        const subjectScores = {};
        const subjectCounts = {};
        redbookLogs.forEach(log => {
          const cat = categorizeSubject(log.subject);
          if (!subjectScores[cat]) {
            subjectScores[cat] = 0;
            subjectCounts[cat] = 0;
          }
          subjectScores[cat] += log.score;
          subjectCounts[cat]++;
        });
        Object.keys(subjectScores).forEach(cat => {
          redbookAnalysis.scoresBySubject[cat] = Math.round(subjectScores[cat] / subjectCounts[cat]);
        });
        
        // å¾—ç‚¹ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆç›´è¿‘5å› vs ãã‚Œä»¥å‰ï¼‰
        if (redbookLogs.length >= 4) {
          const recent = redbookLogs.slice(0, Math.floor(redbookLogs.length / 2));
          const older = redbookLogs.slice(Math.floor(redbookLogs.length / 2));
          const recentAvg = recent.reduce((s, l) => s + l.score, 0) / recent.length;
          const olderAvg = older.reduce((s, l) => s + l.score, 0) / older.length;
          if (recentAvg > olderAvg + 5) redbookAnalysis.scoreTrend = 'improving';
          else if (recentAvg < olderAvg - 5) redbookAnalysis.scoreTrend = 'declining';
        }
        
        // è‹¦æ‰‹åˆ†é‡é›†è¨ˆ
        redbookLogs.forEach(log => {
          if (log.weakAreas) {
            log.weakAreas.split(/[,ã€]/).forEach(area => {
              const trimmed = area.trim();
              if (trimmed) {
                redbookAnalysis.weakAreasSummary[trimmed] = 
                  (redbookAnalysis.weakAreasSummary[trimmed] || 0) + 1;
              }
            });
          }
        });
      }
      
      // ========== ç›®æ¨™é”æˆåˆ†æ ==========
      const goalAnalysis = goals.map(goal => {
        const gap = goal.target - goal.current;
        const mustGap = (goal.must || goal.target) - goal.current;
        const subjectRedbook = redbookLogs.filter(l => categorizeSubject(l.subject) === goal.subject);
        const recentScore = subjectRedbook.length > 0 ? subjectRedbook[0].score : goal.current;
        
        // é”æˆå¯èƒ½æ€§åˆ¤å®š
        let feasibility = 'possible';
        if (gap > 30 && daysUntil < 30) feasibility = 'challenging';
        else if (gap > 20 && daysUntil < 14) feasibility = 'difficult';
        else if (gap <= 10) feasibility = 'likely';
        
        // å¿…è¦ãªé€±é–“å­¦ç¿’æ™‚é–“ã®æ¨å®šï¼ˆç°¡æ˜“ï¼‰
        const neededWeeklyHours = Math.max(1, Math.ceil(gap / 5));
        
        return {
          subject: goal.subject,
          current: goal.current,
          target: goal.target,
          must: goal.must || goal.target,
          gap,
          mustGap,
          recentScore,
          feasibility,
          neededWeeklyHours
        };
      });
      
      // ========== ãƒªã‚¹ã‚¯åˆ†æ ==========
      const risks = [];
      
      // å­¦ç¿’é‡ãƒªã‚¹ã‚¯
      if (weekMinutes < 600) {
        risks.push({ type: 'study_volume', severity: 'high', message: 'é€±é–“å­¦ç¿’æ™‚é–“ãŒ10æ™‚é–“æœªæº€ã§å°‘ãªã‚' });
      } else if (weekMinutes < 900) {
        risks.push({ type: 'study_volume', severity: 'medium', message: 'é€±é–“å­¦ç¿’æ™‚é–“ãŒ15æ™‚é–“æœªæº€' });
      }
      
      // ç§‘ç›®ãƒãƒ©ãƒ³ã‚¹ãƒªã‚¹ã‚¯
      const subjectMinutes = Object.values(subjectAnalysis).map(s => s.weekMinutes);
      const maxSubject = Math.max(...subjectMinutes);
      const minSubject = Math.min(...subjectMinutes.filter(m => m > 0));
      if (maxSubject > minSubject * 3) {
        risks.push({ type: 'balance', severity: 'medium', message: 'ç§‘ç›®é–“ã®å­¦ç¿’æ™‚é–“ã«å¤§ããªåã‚Š' });
      }
      
      // éå»å•ã‚¹ã‚³ã‚¢ãƒªã‚¹ã‚¯
      if (redbookAnalysis.avgScore > 0 && redbookAnalysis.avgScore < 50) {
        risks.push({ type: 'score', severity: 'high', message: 'éå»å•ã®å¹³å‡å¾—ç‚¹ç‡ãŒ50%æœªæº€' });
      }
      
      // å¾©ç¿’ä¸è¶³ãƒªã‚¹ã‚¯
      if (typePercentage['å¾©ç¿’'] < 15) {
        risks.push({ type: 'review', severity: 'medium', message: 'å¾©ç¿’ã®å‰²åˆãŒå°‘ãªãå®šç€ã«ä¸å®‰' });
      }
      
      // ç¶™ç¶šæ€§ãƒªã‚¹ã‚¯
      if (streak < 3 && studyDays > 7) {
        risks.push({ type: 'consistency', severity: 'low', message: 'é€£ç¶šå­¦ç¿’ãŒé€”åˆ‡ã‚ŒãŒã¡' });
      }
      
      // ========== å¼·ã¿ã®ç‰¹å®š ==========
      const strengths = [];
      
      if (streak >= 7) {
        strengths.push({ type: 'consistency', message: `${streak}æ—¥é€£ç¶šå­¦ç¿’ã‚’ç¶™ç¶šä¸­` });
      }
      if (weekMinutes >= 1500) {
        strengths.push({ type: 'volume', message: 'ååˆ†ãªå­¦ç¿’é‡ã‚’ç¢ºä¿' });
      }
      if (redbookAnalysis.scoreTrend === 'improving') {
        strengths.push({ type: 'progress', message: 'éå»å•ã®å¾—ç‚¹ãŒä¸Šæ˜‡å‚¾å‘' });
      }
      
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        const goodMood = data.moodBreakdown.excellent + data.moodBreakdown.good;
        const badMood = data.moodBreakdown.bad + data.moodBreakdown.terrible;
        if (goodMood > badMood * 2 && goodMood >= 3) {
          strengths.push({ type: 'confidence', message: `${cat}ã®å­¦ç¿’ã§å¥½èª¿` });
        }
      });
      
      return {
        // åŸºæœ¬æƒ…å ±
        daysUntil,
        totalMinutes,
        weekMinutes,
        prevWeekMinutes,
        studyDays,
        streak,
        weekTrend: weekMinutes > prevWeekMinutes ? 'up' : weekMinutes < prevWeekMinutes ? 'down' : 'stable',
        
        // ãƒ‘ã‚¿ãƒ¼ãƒ³
        dayOfWeekAvg,
        strongDays,
        weakDays,
        
        // ç§‘ç›®åˆ¥
        subjectAnalysis,
        
        // ã‚¿ã‚¤ãƒ—ãƒãƒ©ãƒ³ã‚¹
        typeBalance,
        typePercentage,
        typeBalanceAssessment,
        
        // éå»å•
        redbookAnalysis,
        
        // ç›®æ¨™
        goalAnalysis,
        
        // è©•ä¾¡
        risks,
        strengths,
        
        // ç”Ÿãƒ‡ãƒ¼ã‚¿
        weekLogs,
        redbookLogs,
        profile
      };
    }
    
    // ==========================================
    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãƒ¡ã‚¤ãƒ³
    // ==========================================
    
    function generatePrompt() {
      const preview = document.getElementById('promptPreview');
      const logs = appData.studyLogs || [];
      const redbookLogs = appData.redbookLogs || [];
      const profile = appData.profile || {};
      const goals = appData.goals || [];
      
      // é«˜åº¦ãªåˆ†æã‚’å®Ÿè¡Œ
      const analysis = analyzeStudyData(logs, redbookLogs, goals, profile);
      
      let prompt = '';
      
      switch (selectedAIType) {
        case 'weekly':
          prompt = generateWeeklyPrompt(analysis);
          break;
        case 'daily':
          prompt = generateDailyPrompt(analysis, logs);
          break;
        case 'weakness':
          prompt = generateWeaknessPrompt(analysis);
          break;
        case 'prediction':
          prompt = generatePredictionPrompt(analysis);
          break;
        case 'subject':
          prompt = generateSubjectPrompt(analysis);
          break;
        case 'lastspurt':
          prompt = generateLastSpurtPrompt(analysis);
          break;
        case 'motivation':
          prompt = generateMotivationPrompt(analysis);
          break;
      }
      
      preview.textContent = prompt;
    }
    
    // ==========================================
    // é€±é–“è¨ˆç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generateWeeklyPrompt(a) {
      const { profile, daysUntil, weekMinutes, prevWeekMinutes, weekTrend, streak,
              subjectAnalysis, typePercentage, typeBalanceAssessment,
              redbookAnalysis, goalAnalysis, risks, strengths, strongDays, weakDays } = a;
      
      let p = `ã‚ãªãŸã¯å¤§å­¦å—é¨“å°‚é–€ã®å­¦ç¿’ã‚³ãƒ¼ãƒã§ã™ã€‚ä»¥ä¸‹ã®å—é¨“ç”Ÿã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€æ¥é€±ã®æœ€é©ãªå­¦ç¿’è¨ˆç”»ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

---

# ğŸ“‹ å—é¨“ç”Ÿãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}`;
      if (profile['ç¬¬2å¿—æœ›']) p += `
**ä½µé¡˜æ ¡**: ${profile['ç¬¬2å¿—æœ›']}${profile['ç¬¬3å¿—æœ›'] ? 'ã€' + profile['ç¬¬3å¿—æœ›'] : ''}`;
      p += `
**è©¦é¨“ã¾ã§**: ${daysUntil}æ—¥ï¼ˆç´„${Math.ceil(daysUntil / 7)}é€±é–“ï¼‰
**é€£ç¶šå­¦ç¿’æ—¥æ•°**: ${streak}æ—¥

---

# ğŸ“Š å­¦ç¿’ãƒ‡ãƒ¼ã‚¿åˆ†æ

## ä»Šé€±ã®å­¦ç¿’å®Ÿç¸¾

**ç·å­¦ç¿’æ™‚é–“**: ${formatMinutes(weekMinutes)}`;
      if (prevWeekMinutes > 0) {
        const change = weekMinutes - prevWeekMinutes;
        const changeStr = change >= 0 ? `+${formatMinutes(change)}` : `-${formatMinutes(Math.abs(change))}`;
        p += `ï¼ˆå…ˆé€±æ¯”: ${changeStr} ${weekTrend === 'up' ? 'ğŸ“ˆ' : weekTrend === 'down' ? 'ğŸ“‰' : 'â¡ï¸'}ï¼‰`;
      }
      
      p += `\n\n### ç§‘ç›®åˆ¥å†…è¨³\n`;
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        if (data.weekMinutes > 0) {
          const pct = Math.round(data.weekMinutes / weekMinutes * 100);
          const trendIcon = data.trend === 'increasing' ? 'â†‘' : data.trend === 'decreasing' ? 'â†“' : 'â†’';
          p += `- **${cat}**: ${formatMinutes(data.weekMinutes)}ï¼ˆ${pct}%ï¼‰${trendIcon}\n`;
          
          // ã‚¿ã‚¤ãƒ—å†…è¨³ãŒã‚ã‚Œã°
          if (Object.keys(data.typeBreakdown).length > 0) {
            const types = Object.entries(data.typeBreakdown)
              .map(([t, m]) => `${t}${Math.round(m / data.weekMinutes * 100)}%`)
              .join(' / ');
            p += `  â”” ${types}\n`;
          }
        }
      });
      
      p += `\n### å­¦ç¿’ã‚¿ã‚¤ãƒ—ãƒãƒ©ãƒ³ã‚¹\n`;
      Object.entries(typePercentage).forEach(([type, pct]) => {
        if (pct > 0) {
          const bar = 'â–ˆ'.repeat(Math.round(pct / 10)) + 'â–‘'.repeat(10 - Math.round(pct / 10));
          p += `- ${type}: ${bar} ${pct}%\n`;
        }
      });
      
      if (typeBalanceAssessment.length > 0) {
        p += `\nâš ï¸ **ãƒãƒ©ãƒ³ã‚¹èª²é¡Œ**: ${typeBalanceAssessment.join('ã€')}\n`;
      }
      
      p += `\n### å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³\n`;
      p += `- ã‚ˆãå‹‰å¼·ã™ã‚‹æ›œæ—¥: **${strongDays.join('ãƒ»')}æ›œæ—¥**\n`;
      p += `- å­¦ç¿’ãŒå°‘ãªã„æ›œæ—¥: **${weakDays.join('ãƒ»')}æ›œæ—¥**\n`;
      
      if (goalAnalysis.length > 0) {
        p += `\n## ç›®æ¨™ã¨ç¾çŠ¶\n\n`;
        goalAnalysis.forEach(g => {
          const icon = g.feasibility === 'likely' ? 'ğŸŸ¢' : g.feasibility === 'possible' ? 'ğŸŸ¡' : 'ğŸ”´';
          p += `### ${g.subject} ${icon}\n`;
          p += `- ç¾çŠ¶: ${g.current}% â†’ ç›®æ¨™: ${g.target}%ï¼ˆ**+${g.gap}ptå¿…è¦**ï¼‰\n`;
          p += `- æœ€ä½ãƒ©ã‚¤ãƒ³: ${g.must}%\n`;
          if (g.recentScore !== g.current) {
            p += `- ç›´è¿‘ã®éå»å•: ${g.recentScore}%\n`;
          }
          p += `\n`;
        });
      }
      
      if (redbookAnalysis.totalAttempts > 0) {
        p += `## éå»å•æ¼”ç¿’çŠ¶æ³\n\n`;
        p += `- æ¼”ç¿’å›æ•°: ${redbookAnalysis.totalAttempts}å›\n`;
        p += `- å¹³å‡å¾—ç‚¹ç‡: ${redbookAnalysis.avgScore}%\n`;
        p += `- å¾—ç‚¹å‚¾å‘: ${redbookAnalysis.scoreTrend === 'improving' ? 'ğŸ“ˆ ä¸Šæ˜‡ä¸­' : redbookAnalysis.scoreTrend === 'declining' ? 'ğŸ“‰ ä¸‹é™æ°—å‘³' : 'â¡ï¸ å®‰å®š'}\n`;
        
        if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
          const topWeak = Object.entries(redbookAnalysis.weakAreasSummary)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
          p += `\n**ç¹°ã‚Šè¿”ã—é–“é•ãˆã‚‹åˆ†é‡**:\n`;
          topWeak.forEach(([area, count]) => {
            p += `- âš ï¸ ${area}ï¼ˆ${count}å›ï¼‰\n`;
          });
        }
      }
      
      if (strengths.length > 0) {
        p += `\n## ğŸ’ª å¼·ã¿\n`;
        strengths.forEach(s => p += `- ${s.message}\n`);
      }
      
      if (risks.length > 0) {
        p += `\n## âš ï¸ èª²é¡Œãƒ»ãƒªã‚¹ã‚¯\n`;
        risks.forEach(r => {
          const icon = r.severity === 'high' ? 'ğŸ”´' : r.severity === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
          p += `- ${icon} ${r.message}\n`;
        });
      }
      
      p += `
---

# ğŸ¯ ç›¸è«‡å†…å®¹

ä¸Šè¨˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¸ã¾ãˆã€**æ¥é€±ã®å…·ä½“çš„ãªå­¦ç¿’è¨ˆç”»**ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **ç¾çŠ¶ã®ç·åˆè©•ä¾¡**ï¼ˆ3è¡Œç¨‹åº¦ï¼‰
   - ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ç§ã®å­¦ç¿’çŠ¶æ³ã®ç‰¹å¾´

2. **æ¥é€±ã®é‡ç‚¹ãƒã‚¤ãƒ³ãƒˆ**ï¼ˆå„ªå…ˆåº¦é †ã«3ã¤ï¼‰
   - ä½•ã«æ³¨åŠ›ã™ã¹ãã‹ã€ãªãœã‹

3. **1é€±é–“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ¡ˆ**
   - æ›œæ—¥ã”ã¨ã®å­¦ç¿’å†…å®¹ã¨æ™‚é–“é…åˆ†
   - ç§ã®å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ${strongDays.join('ãƒ»')}æ›œæ—¥ãŒå¼·ã„ï¼‰ã‚’è€ƒæ…®

4. **ç§‘ç›®åˆ¥ã®å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹**
   - è‹¦æ‰‹åˆ†é‡ã¸ã®å¯¾ç­–æ–¹æ³•
   - ä½¿ç”¨ã™ã¹ãæ•™æã‚„å‹‰å¼·æ³•

5. **æ¥é€±æœ«ã®ç›®æ¨™**
   - é”æˆã™ã¹ãå…·ä½“çš„ãªãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³`;
      
      return p;
    }
    
    // ==========================================
    // ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generateDailyPrompt(a, allLogs) {
      const { profile, daysUntil, weekMinutes, streak, subjectAnalysis } = a;
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const todayLogs = allLogs.filter(log => log.date === todayStr);
      const todayMinutes = todayLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      
      // æ˜¨æ—¥ã®ãƒ­ã‚°
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = yesterday.toISOString().split('T')[0];
      const yesterdayLogs = allLogs.filter(log => log.date === yesterdayStr);
      const yesterdayMinutes = yesterdayLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);
      
      let p = `ã‚ãªãŸã¯å¤§å­¦å—é¨“å°‚é–€ã®å­¦ç¿’ã‚³ãƒ¼ãƒã§ã™ã€‚ä»Šæ—¥ã®å­¦ç¿’ã‚’æŒ¯ã‚Šè¿”ã‚Šã€æ˜æ—¥ä»¥é™ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚

---

# ğŸ“… ä»Šæ—¥ã®å­¦ç¿’è¨˜éŒ²

**æ—¥ä»˜**: ${todayStr}ï¼ˆè©¦é¨“ã¾ã§ã‚ã¨${daysUntil}æ—¥ï¼‰
**æœ¬æ—¥ã®å­¦ç¿’æ™‚é–“**: ${formatMinutes(todayMinutes)}`;
      
      if (yesterdayMinutes > 0) {
        const diff = todayMinutes - yesterdayMinutes;
        p += `ï¼ˆæ˜¨æ—¥æ¯”: ${diff >= 0 ? '+' : ''}${formatMinutes(diff)}ï¼‰`;
      }
      
      p += `
**ä»Šé€±ã®ç´¯è¨ˆ**: ${formatMinutes(weekMinutes)}
**é€£ç¶šå­¦ç¿’æ—¥æ•°**: ${streak}æ—¥

`;
      
      if (todayLogs.length > 0) {
        p += `## å­¦ç¿’å†…å®¹ã®è©³ç´°\n\n`;
        todayLogs.forEach(log => {
          const moodText = {
            'ğŸ˜Š': 'çµ¶å¥½èª¿',
            'ğŸ™‚': 'å¥½èª¿',
            'ğŸ˜': 'æ™®é€š',
            'ğŸ˜•': 'è‹¦æˆ¦',
            'ğŸ˜«': 'ã‹ãªã‚Šè‹¦æˆ¦'
          };
          
          p += `### ${log.subject}ï¼ˆ${log.minutes}åˆ†ï¼‰\n`;
          if (log.studyType) p += `- ã‚¿ã‚¤ãƒ—: ${log.studyType}\n`;
          if (log.unit) p += `- ç¯„å›²: ${log.unit}\n`;
          if (log.textbook) p += `- æ•™æ: ${log.textbook}\n`;
          if (log.mood) p += `- æ‰‹å¿œãˆ: ${log.mood} ${moodText[log.mood] || ''}\n`;
          if (log.memo) p += `- ãƒ¡ãƒ¢: ã€Œ${log.memo}ã€\n`;
          p += `\n`;
        });
        
        // æ‰‹å¿œãˆåˆ†æ
        const excellent = todayLogs.filter(l => l.mood === 'ğŸ˜Š').map(l => l.subject);
        const struggling = todayLogs.filter(l => l.mood === 'ğŸ˜«' || l.mood === 'ğŸ˜•').map(l => l.subject);
        
        if (excellent.length > 0 || struggling.length > 0) {
          p += `## ä»Šæ—¥ã®æ‰‹å¿œãˆ\n`;
          if (excellent.length > 0) p += `- âœ¨ å¥½èª¿: ${excellent.join('ã€')}\n`;
          if (struggling.length > 0) p += `- ğŸ’¦ è‹¦æˆ¦: ${struggling.join('ã€')}\n`;
          p += `\n`;
        }
      } else {
        p += `## ä»Šæ—¥ã®å­¦ç¿’\n\n`;
        p += `â€»ã¾ã ä»Šæ—¥ã®å­¦ç¿’è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n\n`;
      }
      
      p += `---

# ğŸ¯ ç›¸è«‡å†…å®¹

ä»Šæ—¥ã®å­¦ç¿’ã‚’æŒ¯ã‚Šè¿”ã£ã¦ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨æ˜æ—¥ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **ä»Šæ—¥ã®è©•ä¾¡**ï¼ˆâ—/â—‹/â–³/Ã—ï¼‰
   - è‰¯ã‹ã£ãŸç‚¹ã¨æ”¹å–„ç‚¹

2. **è‹¦æˆ¦ã—ãŸéƒ¨åˆ†ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹**
   - å…·ä½“çš„ãªå…‹æœæ–¹æ³•

3. **æ˜æ—¥ã®å­¦ç¿’ãƒ—ãƒ©ãƒ³**
   - ãŠã™ã™ã‚ã®ç§‘ç›®ãƒ»å†…å®¹ãƒ»æ™‚é–“é…åˆ†
   - ä»Šæ—¥ã®ç¶šãã§ã‚„ã‚‹ã¹ãã“ã¨

4. **ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿ã¤ä¸€è¨€**`;
      
      return p;
    }
    
    // ==========================================
    // å¼±ç‚¹åˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generateWeaknessPrompt(a) {
      const { profile, daysUntil, redbookAnalysis, goalAnalysis, subjectAnalysis, redbookLogs } = a;
      
      let p = `ã‚ãªãŸã¯å¤§å­¦å—é¨“ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¼±ç‚¹ã‚’åˆ†æã—ã€åŠ¹ç‡çš„ãªå¯¾ç­–ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

---

# ğŸ“‹ åŸºæœ¬æƒ…å ±

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}
**è©¦é¨“ã¾ã§**: ${daysUntil}æ—¥

`;
      
      if (goalAnalysis.length > 0) {
        p += `# ğŸ“Š ç›®æ¨™ã¨ç¾çŠ¶ã®ã‚®ãƒ£ãƒƒãƒ—\n\n`;
        p += `| ç§‘ç›® | ç¾çŠ¶ | ç›®æ¨™ | ã‚®ãƒ£ãƒƒãƒ— | é”æˆè¦‹è¾¼ã¿ |\n`;
        p += `|------|------|------|----------|------------|\n`;
        goalAnalysis.forEach(g => {
          const status = g.feasibility === 'likely' ? 'ğŸŸ¢ é”æˆåœå†…' : 
                         g.feasibility === 'possible' ? 'ğŸŸ¡ åŠªåŠ›æ¬¡ç¬¬' : 'ğŸ”´ è¦é›†ä¸­å¯¾ç­–';
          p += `| ${g.subject} | ${g.current}% | ${g.target}% | +${g.gap}pt | ${status} |\n`;
        });
        p += `\n`;
      }
      
      if (redbookLogs.length > 0) {
        p += `# ğŸ“ éå»å•ãƒ»æ¨¡è©¦ã®å…¨çµæœ\n\n`;
        redbookLogs.forEach(log => {
          const scoreIcon = log.score >= 70 ? 'ğŸŸ¢' : log.score >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
          p += `## ${log.date} ${log.university} ${log.subject || ''} ${log.year}å¹´\n`;
          p += `- å¾—ç‚¹ç‡: ${scoreIcon} **${log.score}%**\n`;
          if (log.time) p += `- è§£ç­”æ™‚é–“: ${log.time}åˆ†\n`;
          if (log.sectionScores) p += `- å¤§å•åˆ¥: ${log.sectionScores}\n`;
          if (log.weakAreas) p += `- âš ï¸ é–“é•ãˆãŸåˆ†é‡: **${log.weakAreas}**\n`;
          if (log.memo) p += `- ãƒ¡ãƒ¢: ${log.memo}\n`;
          p += `\n`;
        });
      }
      
      if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
        p += `# ğŸ”´ ç¹°ã‚Šè¿”ã—é–“é•ãˆã‚‹åˆ†é‡ï¼ˆè¦é‡ç‚¹å¯¾ç­–ï¼‰\n\n`;
        const sorted = Object.entries(redbookAnalysis.weakAreasSummary)
          .sort((a, b) => b[1] - a[1]);
        
        p += `| åˆ†é‡ | å‡ºç¾å›æ•° | æ·±åˆ»åº¦ |\n`;
        p += `|------|----------|--------|\n`;
        sorted.forEach(([area, count]) => {
          const severity = count >= 3 ? 'ğŸ”´ é«˜' : count >= 2 ? 'ğŸŸ¡ ä¸­' : 'ğŸŸ¢ ä½';
          p += `| ${area} | ${count}å› | ${severity} |\n`;
        });
        p += `\n`;
      }
      
      p += `# ğŸ“ˆ ç§‘ç›®åˆ¥ã®å­¦ç¿’çŠ¶æ³\n\n`;
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        if (data.totalMinutes > 0) {
          const goodRate = data.sessionCount > 0 
            ? Math.round((data.moodBreakdown.excellent + data.moodBreakdown.good) / data.sessionCount * 100)
            : 0;
          const badRate = data.sessionCount > 0
            ? Math.round((data.moodBreakdown.bad + data.moodBreakdown.terrible) / data.sessionCount * 100)
            : 0;
          
          p += `## ${cat}\n`;
          p += `- ç´¯è¨ˆå­¦ç¿’æ™‚é–“: ${formatMinutes(data.totalMinutes)}\n`;
          p += `- å­¦ç¿’å›æ•°: ${data.sessionCount}å›\n`;
          p += `- æ‰‹å¿œãˆ: å¥½èª¿${goodRate}% / è‹¦æˆ¦${badRate}%\n`;
          if (redbookAnalysis.scoresBySubject[cat]) {
            p += `- éå»å•å¹³å‡: ${redbookAnalysis.scoresBySubject[cat]}%\n`;
          }
          p += `\n`;
        }
      });
      
      p += `---

# ğŸ¯ åˆ†æãƒªã‚¯ã‚¨ã‚¹ãƒˆ

ä¸Šè¨˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’è©³ç´°ã«åˆ†æã—ã€å¼±ç‚¹å…‹æœã®ãŸã‚ã®æˆ¦ç•¥ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **å¼±ç‚¹ã®å„ªå…ˆé †ä½ä»˜ã‘**
   - æœ€ã‚‚å¯¾ç­–ãŒå¿…è¦ãªåˆ†é‡TOP3ã¨ãã®ç†ç”±
   - è©¦é¨“ã¸ã®å½±éŸ¿åº¦ã¨æ”¹å–„ã®é›£æ˜“åº¦

2. **å¼±ç‚¹ã®æ ¹æœ¬åŸå› ã®åˆ†æ**
   - ãªãœãã®åˆ†é‡ã§é–“é•ã„ãŒå¤šã„ã®ã‹
   - çŸ¥è­˜ä¸è¶³ãªã®ã‹ã€è§£æ³•ãƒ‘ã‚¿ãƒ¼ãƒ³ãªã®ã‹ã€æ™‚é–“ç®¡ç†ãªã®ã‹

3. **å…·ä½“çš„ãªå¯¾ç­–ãƒ—ãƒ©ãƒ³**
   - å„å¼±ç‚¹ã«å¯¾ã™ã‚‹å…·ä½“çš„ãªå‹‰å¼·æ³•
   - ä½¿ã†ã¹ãæ•™æã‚„å‚è€ƒæ›¸
   - 1æ—¥ã‚ãŸã‚Šã®ç›®å®‰æ™‚é–“

4. **æ®‹ã‚Š${daysUntil}æ—¥ã§ã®ç¾å®Ÿçš„ãªç›®æ¨™**
   - ã©ã“ã¾ã§æ”¹å–„ã§ããã†ã‹
   - å„ªå…ˆã—ã¦æ¨ã¦ã‚‹ã¹ãåˆ†é‡ãŒã‚ã‚Œã°

5. **å­¦ç¿’åŠ¹ç‡ã‚’ä¸Šã’ã‚‹ã‚³ãƒ„**
   - åŒã˜ãƒŸã‚¹ã‚’ç¹°ã‚Šè¿”ã•ãªã„ãŸã‚ã®æ–¹æ³•`;
      
      return p;
    }
    
    // ==========================================
    // ç§‘ç›®åˆ¥ç›¸è«‡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generateSubjectPrompt(a) {
      const selectedSubject = document.getElementById('aiSubjectSelect').value;
      if (!selectedSubject) {
        return 'â†‘ä¸Šã®ã€Œç›¸è«‡ã—ãŸã„ç§‘ç›®ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
      }
      
      const { profile, daysUntil, subjectAnalysis, redbookAnalysis, goalAnalysis, redbookLogs, weekLogs } = a;
      const subjectData = subjectAnalysis[selectedSubject] || {};
      const subjectGoal = goalAnalysis.find(g => g.subject === selectedSubject);
      const subjectRedbook = redbookLogs.filter(l => categorizeSubject(l.subject) === selectedSubject);
      const subjectWeekLogs = weekLogs.filter(l => categorizeSubject(l.subject) === selectedSubject);
      
      // ç§‘ç›®åˆ¥ã®è‹¦æ‰‹åˆ†é‡
      const weakAreas = {};
      subjectRedbook.forEach(log => {
        if (log.weakAreas) {
          log.weakAreas.split(/[,ã€]/).forEach(area => {
            const trimmed = area.trim();
            if (trimmed) weakAreas[trimmed] = (weakAreas[trimmed] || 0) + 1;
          });
        }
      });
      
      let p = `ã‚ãªãŸã¯${selectedSubject}å°‚é–€ã®å—é¨“ã‚³ãƒ¼ãƒã§ã™ã€‚ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€${selectedSubject}ã®æˆç¸¾å‘ä¸Šã®ãŸã‚ã®å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚

---

# ğŸ“‹ åŸºæœ¬æƒ…å ±

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}
**è©¦é¨“ã¾ã§**: ${daysUntil}æ—¥
**ç›¸è«‡ç§‘ç›®**: ${selectedSubject}

`;
      
      if (subjectGoal) {
        p += `# ğŸ¯ ç›®æ¨™è¨­å®š\n\n`;
        p += `- **ç¾çŠ¶**: ${subjectGoal.current}%\n`;
        p += `- **ç›®æ¨™**: ${subjectGoal.target}%ï¼ˆ+${subjectGoal.gap}ptå¿…è¦ï¼‰\n`;
        p += `- **æœ€ä½ãƒ©ã‚¤ãƒ³**: ${subjectGoal.must}%\n`;
        p += `- **é”æˆè¦‹è¾¼ã¿**: ${subjectGoal.feasibility === 'likely' ? 'ğŸŸ¢ é”æˆåœå†…' : subjectGoal.feasibility === 'possible' ? 'ğŸŸ¡ åŠªåŠ›æ¬¡ç¬¬' : 'ğŸ”´ è¦é›†ä¸­å¯¾ç­–'}\n\n`;
      }
      
      p += `# ğŸ“Š å­¦ç¿’ãƒ‡ãƒ¼ã‚¿\n\n`;
      p += `**ç´¯è¨ˆå­¦ç¿’æ™‚é–“**: ${formatMinutes(subjectData.totalMinutes || 0)}\n`;
      p += `**ä»Šé€±ã®å­¦ç¿’æ™‚é–“**: ${formatMinutes(subjectData.weekMinutes || 0)}\n`;
      p += `**å­¦ç¿’å›æ•°**: ${subjectData.sessionCount || 0}å›\n`;
      p += `**å‚¾å‘**: ${subjectData.trend === 'increasing' ? 'ğŸ“ˆ å¢—åŠ ä¸­' : subjectData.trend === 'decreasing' ? 'ğŸ“‰ æ¸›å°‘ä¸­' : 'â¡ï¸ å®‰å®š'}\n\n`;
      
      if (Object.keys(subjectData.typeBreakdown || {}).length > 0) {
        p += `## å­¦ç¿’ã‚¿ã‚¤ãƒ—ã®å†…è¨³\n`;
        Object.entries(subjectData.typeBreakdown).forEach(([type, min]) => {
          p += `- ${type}: ${formatMinutes(min)}\n`;
        });
        p += `\n`;
      }
      
      if (Object.keys(subjectData.textbooks || {}).length > 0) {
        p += `## ä½¿ç”¨æ•™æ\n`;
        Object.entries(subjectData.textbooks)
          .sort((a, b) => b[1] - a[1])
          .forEach(([book, min]) => {
            p += `- ${book}: ${formatMinutes(min)}\n`;
          });
        p += `\n`;
      }
      
      if (subjectWeekLogs.length > 0) {
        p += `## ä»Šé€±ã®å­¦ç¿’å†…å®¹\n`;
        subjectWeekLogs.forEach(log => {
          p += `- ${log.date}: ${log.subject} ${log.minutes}åˆ†`;
          if (log.mood) p += ` ${log.mood}`;
          if (log.unit) p += ` [${log.unit}]`;
          if (log.memo) p += ` â†’ ${log.memo}`;
          p += `\n`;
        });
        p += `\n`;
      }
      
      if (subjectRedbook.length > 0) {
        p += `## éå»å•æ¼”ç¿’çµæœ\n\n`;
        subjectRedbook.forEach(log => {
          p += `### ${log.university} ${log.year}å¹´ï¼ˆ${log.date}ï¼‰\n`;
          p += `- å¾—ç‚¹ç‡: **${log.score}%**\n`;
          if (log.time) p += `- è§£ç­”æ™‚é–“: ${log.time}åˆ†\n`;
          if (log.sectionScores) p += `- å¤§å•åˆ¥: ${log.sectionScores}\n`;
          if (log.weakAreas) p += `- é–“é•ãˆãŸåˆ†é‡: ${log.weakAreas}\n`;
          if (log.memo) p += `- æŒ¯ã‚Šè¿”ã‚Š: ${log.memo}\n`;
          p += `\n`;
        });
      }
      
      if (Object.keys(weakAreas).length > 0) {
        p += `## âš ï¸ ã‚ˆãé–“é•ãˆã‚‹åˆ†é‡\n`;
        Object.entries(weakAreas)
          .sort((a, b) => b[1] - a[1])
          .forEach(([area, count]) => {
            p += `- **${area}**: ${count}å›\n`;
          });
        p += `\n`;
      }
      
      // æ‰‹å¿œãˆåˆ†æ
      if (subjectData.moodBreakdown) {
        const mb = subjectData.moodBreakdown;
        const total = mb.excellent + mb.good + mb.neutral + mb.bad + mb.terrible;
        if (total > 0) {
          p += `## æ‰‹å¿œãˆã®å‚¾å‘\n`;
          p += `- ğŸ˜Š çµ¶å¥½èª¿: ${mb.excellent}å›\n`;
          p += `- ğŸ™‚ å¥½èª¿: ${mb.good}å›\n`;
          p += `- ğŸ˜ æ™®é€š: ${mb.neutral}å›\n`;
          p += `- ğŸ˜• è‹¦æˆ¦: ${mb.bad}å›\n`;
          p += `- ğŸ˜« ã‹ãªã‚Šè‹¦æˆ¦: ${mb.terrible}å›\n\n`;
        }
      }
      
      p += `---

# ğŸ¯ ç›¸è«‡å†…å®¹

${selectedSubject}ã®æˆç¸¾ã‚’åŠ¹ç‡çš„ã«ä¸Šã’ã‚‹ãŸã‚ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **ç¾çŠ¶è¨ºæ–­**
   - ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¦‹ãˆã‚‹ç§ã®${selectedSubject}ã®ç‰¹å¾´
   - å¼·ã¿ã¨å¼±ã¿ã®åˆ†æ

2. **é‡ç‚¹å¯¾ç­–åˆ†é‡**ï¼ˆ3ã¤ï¼‰
   - å„ªå…ˆåº¦ã®é«˜ã„é †ã«
   - ãªãœãã®åˆ†é‡ã‚’é‡è¦–ã™ã¹ãã‹

3. **å…·ä½“çš„ãªå­¦ç¿’ãƒ—ãƒ©ãƒ³**
   - 1æ—¥ã®${selectedSubject}å­¦ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¾‹
   - 1é€±é–“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ¡ˆ

4. **æ•™æãƒ»å‹‰å¼·æ³•ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹**
   - ç¾åœ¨ä½¿ç”¨ä¸­ã®æ•™æã¸ã®è©•ä¾¡
   - è¿½åŠ ã§ä½¿ã†ã¹ãæ•™æãŒã‚ã‚Œã°

5. **ç›®æ¨™é”æˆã¸ã®é“ç­‹**
   - æ®‹ã‚Š${daysUntil}æ—¥ã§${subjectGoal ? `+${subjectGoal.gap}pt` : 'ç›®æ¨™'}é”æˆã™ã‚‹ãŸã‚ã«`;
      
      return p;
    }
    
    // ==========================================
    // ç›´å‰æœŸå¯¾ç­–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generateLastSpurtPrompt(a) {
      const { profile, daysUntil, weekMinutes, totalMinutes, streak, studyDays,
              redbookAnalysis, goalAnalysis, risks, subjectAnalysis } = a;
      
      const avgDailyMinutes = studyDays > 0 ? Math.round(totalMinutes / studyDays) : 0;
      const remainingStudyTime = avgDailyMinutes * daysUntil;
      
      let p = `ã‚ãªãŸã¯å¤§å­¦å—é¨“ã®ç›´å‰æœŸå¯¾ç­–ã®ã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆã§ã™ã€‚æ®‹ã‚Šæ—¥æ•°ã‚’è€ƒæ…®ã—ãŸç¾å®Ÿçš„ãªå¯¾ç­–ãƒ—ãƒ©ãƒ³ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

---

# â° æ®‹ã‚Šæ™‚é–“

**è©¦é¨“ã¾ã§**: âš ï¸ **${daysUntil}æ—¥**ï¼ˆç´„${Math.ceil(daysUntil / 7)}é€±é–“ï¼‰
**æ¨å®šå¯èƒ½å­¦ç¿’æ™‚é–“**: ç´„${formatMinutes(remainingStudyTime)}
ï¼ˆ1æ—¥å¹³å‡${formatMinutes(avgDailyMinutes)}ã§è¨ˆç®—ï¼‰

---

# ğŸ“‹ å—é¨“ç”Ÿã®çŠ¶æ³

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}`;
      if (profile['ç¬¬2å¿—æœ›']) p += `
**ä½µé¡˜æ ¡**: ${profile['ç¬¬2å¿—æœ›']}${profile['ç¬¬3å¿—æœ›'] ? 'ã€' + profile['ç¬¬3å¿—æœ›'] : ''}`;
      p += `

**ã“ã‚Œã¾ã§ã®å®Ÿç¸¾**:
- ç´¯è¨ˆå­¦ç¿’æ™‚é–“: ${formatMinutes(totalMinutes)}
- å­¦ç¿’æ—¥æ•°: ${studyDays}æ—¥
- é€£ç¶šå­¦ç¿’: ${streak}æ—¥
- ç›´è¿‘1é€±é–“: ${formatMinutes(weekMinutes)}

`;
      
      if (goalAnalysis.length > 0) {
        p += `# ğŸ¯ ç›®æ¨™ã¨ç¾çŠ¶\n\n`;
        p += `| ç§‘ç›® | ç¾çŠ¶ | ç›®æ¨™ | å¿…è¦ãªä¼¸ã³ | é”æˆé›£æ˜“åº¦ |\n`;
        p += `|------|------|------|------------|------------|\n`;
        goalAnalysis.forEach(g => {
          const difficulty = g.feasibility === 'likely' ? 'â˜…â˜†â˜†' : 
                            g.feasibility === 'possible' ? 'â˜…â˜…â˜†' : 'â˜…â˜…â˜…';
          p += `| ${g.subject} | ${g.current}% | ${g.target}% | +${g.gap}pt | ${difficulty} |\n`;
        });
        p += `\n`;
      }
      
      if (redbookAnalysis.totalAttempts > 0) {
        p += `# ğŸ“ éå»å•æ¼”ç¿’ã®ç¾çŠ¶\n\n`;
        p += `- æ¼”ç¿’å›æ•°: ${redbookAnalysis.totalAttempts}å›\n`;
        p += `- å¹³å‡å¾—ç‚¹ç‡: **${redbookAnalysis.avgScore}%**\n`;
        p += `- å¾—ç‚¹å‚¾å‘: ${redbookAnalysis.scoreTrend === 'improving' ? 'ğŸ“ˆ ä¸Šæ˜‡ä¸­ï¼ˆè‰¯ã„å‚¾å‘ï¼‰' : redbookAnalysis.scoreTrend === 'declining' ? 'ğŸ“‰ ä¸‹é™æ°—å‘³ï¼ˆè¦å¯¾ç­–ï¼‰' : 'â¡ï¸ å®‰å®š'}\n\n`;
        
        if (Object.keys(redbookAnalysis.scoresBySubject).length > 0) {
          p += `**ç§‘ç›®åˆ¥å¹³å‡**:\n`;
          Object.entries(redbookAnalysis.scoresBySubject).forEach(([cat, score]) => {
            const icon = score >= 70 ? 'ğŸŸ¢' : score >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
            p += `- ${cat}: ${icon} ${score}%\n`;
          });
          p += `\n`;
        }
        
        if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
          p += `**ç¹°ã‚Šè¿”ã—é–“é•ãˆã‚‹åˆ†é‡ï¼ˆç›´å‰æœŸã§å¿…ãšå¯¾ç­–ï¼‰**:\n`;
          Object.entries(redbookAnalysis.weakAreasSummary)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .forEach(([area, count]) => {
              p += `- ğŸ”´ ${area}ï¼ˆ${count}å›ï¼‰\n`;
            });
          p += `\n`;
        }
      }
      
      if (risks.length > 0) {
        p += `# âš ï¸ ç¾åœ¨ã®ãƒªã‚¹ã‚¯è¦å› \n\n`;
        risks.forEach(r => {
          const icon = r.severity === 'high' ? 'ğŸ”´' : r.severity === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
          p += `- ${icon} ${r.message}\n`;
        });
        p += `\n`;
      }
      
      p += `# ğŸ“Š ç§‘ç›®åˆ¥ã®ä»•ä¸ŠãŒã‚Šåº¦\n\n`;
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        if (data.totalMinutes > 0) {
          const score = redbookAnalysis.scoresBySubject[cat] || 'æœªæ¸¬å®š';
          const goalData = goalAnalysis.find(g => g.subject === cat);
          const status = typeof score === 'number' 
            ? (goalData && score >= goalData.target ? 'ğŸŸ¢ ç›®æ¨™åœå†…' : score >= 50 ? 'ğŸŸ¡ ã‚‚ã†ä¸€æ¯' : 'ğŸ”´ è¦å¼·åŒ–')
            : 'âšª è¦æ¼”ç¿’';
          p += `- **${cat}**: ${status}ï¼ˆéå»å•å¹³å‡: ${score}${typeof score === 'number' ? '%' : ''}ï¼‰\n`;
        }
      });
      
      p += `
---

# ğŸ¯ ç›¸è«‡å†…å®¹

æ®‹ã‚Š${daysUntil}æ—¥ã§åˆæ ¼ã‚’å‹ã¡å–ã‚‹ãŸã‚ã®**ç›´å‰æœŸå¯¾ç­–ãƒ—ãƒ©ãƒ³**ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **ã‚„ã‚‹ã“ã¨ãƒ»ã‚„ã‚‰ãªã„ã“ã¨ã®åˆ¤æ–­**
   - æ®‹ã‚Šæ™‚é–“ã§å„ªå…ˆã™ã¹ãã“ã¨
   - æ€ã„åˆ‡ã£ã¦æ¨ã¦ã‚‹ã¹ãã“ã¨

2. **ç›´å‰æœŸã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**
   - ã€œ1é€±é–“å‰: ã‚„ã‚‹ã¹ãã“ã¨
   - ç›´å‰3æ—¥é–“: ã‚„ã‚‹ã¹ãã“ã¨
   - å‰æ—¥: ã‚„ã‚‹ã¹ãã“ã¨

3. **ç§‘ç›®åˆ¥ã®æ™‚é–“é…åˆ†**
   - 1æ—¥ã‚ãŸã‚Šã®ç†æƒ³çš„ãªé…åˆ†

4. **å¼±ç‚¹ã¸ã®å¯¾å‡¦æ³•**
   - ä»Šã‹ã‚‰é–“ã«åˆã†å¯¾ç­–
   - æœ¬ç•ªã§é¿ã‘ã‚‹ã¹ãå•é¡Œ

5. **è©¦é¨“æœ¬ç•ªã®æˆ¦ç•¥**
   - æ™‚é–“é…åˆ†
   - è§£ãé †ç•ª
   - ãƒ‘ãƒ‹ãƒƒã‚¯æ™‚ã®å¯¾å‡¦æ³•

6. **ãƒ¡ãƒ³ã‚¿ãƒ«ç®¡ç†**
   - ä¸å®‰ã¨ã®ä»˜ãåˆã„æ–¹
   - ç›´å‰æœŸã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ç¶­æŒ`;
      
      return p;
    }
    
    // ==========================================
    // ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generateMotivationPrompt(a) {
      const { profile, daysUntil, totalMinutes, studyDays, streak, weekMinutes,
              subjectAnalysis, strengths, redbookAnalysis } = a;
      
      const totalHours = Math.floor(totalMinutes / 60);
      
      // ãƒã‚¸ãƒ†ã‚£ãƒ–ãªå®Ÿç¸¾ã‚’æŠ½å‡º
      const achievements = [];
      if (streak >= 3) achievements.push(`${streak}æ—¥é€£ç¶šã§å­¦ç¿’ã‚’ç¶™ç¶š`);
      if (totalHours >= 50) achievements.push(`ç´¯è¨ˆ${totalHours}æ™‚é–“ä»¥ä¸Šã®å­¦ç¿’`);
      if (studyDays >= 14) achievements.push(`${studyDays}æ—¥é–“ã‚³ãƒ„ã‚³ãƒ„åŠªåŠ›`);
      if (redbookAnalysis.scoreTrend === 'improving') achievements.push('éå»å•ã®å¾—ç‚¹ãŒä¸Šæ˜‡å‚¾å‘');
      
      // è‹¦æˆ¦ã—ã¦ã„ã‚‹éƒ¨åˆ†
      const struggles = [];
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        const badRate = data.sessionCount > 0
          ? (data.moodBreakdown.bad + data.moodBreakdown.terrible) / data.sessionCount
          : 0;
        if (badRate > 0.4) struggles.push(`${cat}ã§è‹¦æˆ¦ã™ã‚‹ã“ã¨ãŒå¤šã„`);
      });
      
      let p = `ã‚ãªãŸã¯å—é¨“ç”Ÿã®ãƒ¡ãƒ³ã‚¿ãƒ«ã‚µãƒãƒ¼ãƒˆã®å°‚é–€å®¶ã§ã™ã€‚æ¸©ã‹ãã€ã§ã‚‚ç¾å®Ÿçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã§ç§ã‚’åŠ±ã¾ã—ã¦ãã ã•ã„ã€‚

---

# ğŸ‘¤ ç§ã«ã¤ã„ã¦

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}
**è©¦é¨“ã¾ã§**: ã‚ã¨${daysUntil}æ—¥

---

# ğŸ“Š ã“ã‚Œã¾ã§ã®åŠªåŠ›

**æ•°å­—ã§è¦‹ã‚‹ç§ã®é ‘å¼µã‚Š**:
- ğŸ• ç´¯è¨ˆå­¦ç¿’æ™‚é–“: **${totalHours}æ™‚é–“${totalMinutes % 60}åˆ†**
- ğŸ“… å­¦ç¿’ã—ãŸæ—¥æ•°: **${studyDays}æ—¥**
- ğŸ”¥ é€£ç¶šå­¦ç¿’æ—¥æ•°: **${streak}æ—¥**
- ğŸ“ˆ ç›´è¿‘1é€±é–“: ${formatMinutes(weekMinutes)}

`;
      
      if (achievements.length > 0) {
        p += `**ç§ã®å®Ÿç¸¾**:\n`;
        achievements.forEach(a => p += `- âœ¨ ${a}\n`);
        p += `\n`;
      }
      
      if (strengths.length > 0) {
        p += `**å¼·ã¿**:\n`;
        strengths.forEach(s => p += `- ğŸ’ª ${s.message}\n`);
        p += `\n`;
      }
      
      p += `---

# ğŸ˜” ä»Šã®æ°—æŒã¡

æ­£ç›´ã«è¨€ã†ã¨ã€æœ€è¿‘ã“ã‚“ãªæ°—æŒã¡ãŒã‚ã‚Šã¾ã™ï¼š

- è©¦é¨“ãŒè¿‘ã¥ã„ã¦ãã¦ã€æ¼ ç„¶ã¨ã—ãŸä¸å®‰ãŒã‚ã‚‹
- æœ¬å½“ã«è‡ªåˆ†ãŒåˆæ ¼ã§ãã‚‹ã®ã‹è‡ªä¿¡ãŒæŒã¦ãªã„
- å‘¨ã‚Šã®å—é¨“ç”Ÿã¨æ¯”ã¹ã¦ç„¦ã£ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚‹
- å‹‰å¼·ã—ã¦ã‚‚æˆæœãŒè¦‹ãˆã«ããã¦ã€ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸‹ãŒã‚‹æ™‚ãŒã‚ã‚‹
`;
      
      if (struggles.length > 0) {
        p += `- ${struggles.join('\n- ')}\n`;
      }
      
      p += `
ã§ã‚‚ã€${profile['ç¬¬1å¿—æœ›'] || 'å¿—æœ›æ ¡'}ã«çµ¶å¯¾ã«åˆæ ¼ã—ãŸã„ã¨ã„ã†æ°—æŒã¡ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚

---

# ğŸ¯ ãŠé¡˜ã„

ä»Šã¾ã§ã®åŠªåŠ›ã‚’èªã‚ã¦ã»ã—ã„ã§ã™ã€‚ãã—ã¦ã€æ®‹ã‚Š${daysUntil}æ—¥ã‚’ä¹—ã‚Šåˆ‡ã‚‹ãŸã‚ã®åŠ›ã‚’ãã ã•ã„ã€‚

## å›ç­”ã«å«ã‚ã¦ã»ã—ã„ã“ã¨

1. **ç§ã®åŠªåŠ›ã¸ã®è©•ä¾¡**
   - ${totalHours}æ™‚é–“ã¨ã„ã†æ•°å­—ã®æ„å‘³
   - ${streak}æ—¥é€£ç¶šã¨ã„ã†ç¶™ç¶šã®ä¾¡å€¤
   - å…·ä½“çš„ã«è¤’ã‚ã¦ã»ã—ã„

2. **æ¸©ã‹ã„åŠ±ã¾ã—ã®è¨€è‘‰**
   - ä¸å®‰ã‚’å’Œã‚‰ã’ã‚‹è¨€è‘‰
   - è‡ªä¿¡ã‚’æŒã¦ã‚‹ã‚ˆã†ãªè¨€è‘‰

3. **ä¸å®‰ã¨ã®å‘ãåˆã„æ–¹**
   - å—é¨“ç”Ÿãªã‚‰èª°ã‚‚ãŒæ„Ÿã˜ã‚‹ä¸å®‰ã§ã‚ã‚‹ã“ã¨
   - å…·ä½“çš„ãªãƒ¡ãƒ³ã‚¿ãƒ«ç®¡ç†ã®ã‚³ãƒ„

4. **æ®‹ã‚Š${daysUntil}æ—¥ã®éã”ã—æ–¹**
   - ç„¡ç†ãªãç¶šã‘ã‚‰ã‚Œã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹
   - ç„¦ã‚‰ãªã„ãŸã‚ã®è€ƒãˆæ–¹

5. **åˆæ ¼ã—ãŸæœªæ¥ã®ã‚¤ãƒ¡ãƒ¼ã‚¸**
   - å¿—æœ›æ ¡ã«é€šã†è‡ªåˆ†ã‚’æƒ³åƒã•ã›ã¦ã»ã—ã„
   - æœ€å¾Œã«ã€åŠ›å¼·ã„å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’`;
      
      return p;
    }
    
    // ==========================================
    // å¾—ç‚¹äºˆæ¸¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    // ==========================================
    
    function generatePredictionPrompt(a) {
      const { profile, daysUntil, totalMinutes, studyDays, weekMinutes,
              subjectAnalysis, redbookAnalysis, goalAnalysis, redbookLogs } = a;
      
      // ç§‘ç›®åˆ¥ã®éå»å•ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†
      const subjectScoreHistory = {};
      redbookLogs.forEach(log => {
        const cat = categorizeSubject(log.subject);
        if (!subjectScoreHistory[cat]) {
          subjectScoreHistory[cat] = [];
        }
        subjectScoreHistory[cat].push({
          date: log.date,
          university: log.university,
          year: log.year,
          score: log.score,
          weakAreas: log.weakAreas
        });
      });
      
      // å„ç§‘ç›®ã®æˆé•·ç‡ã‚’è¨ˆç®—
      const growthAnalysis = {};
      Object.entries(subjectScoreHistory).forEach(([cat, scores]) => {
        if (scores.length >= 2) {
          // æ™‚ç³»åˆ—é †ã«ã‚½ãƒ¼ãƒˆï¼ˆå¤ã„é †ï¼‰
          const sorted = [...scores].sort((a, b) => new Date(a.date) - new Date(b.date));
          const firstHalf = sorted.slice(0, Math.ceil(sorted.length / 2));
          const secondHalf = sorted.slice(Math.ceil(sorted.length / 2));
          
          const firstAvg = firstHalf.reduce((s, l) => s + l.score, 0) / firstHalf.length;
          const secondAvg = secondHalf.reduce((s, l) => s + l.score, 0) / secondHalf.length;
          const growth = secondAvg - firstAvg;
          
          growthAnalysis[cat] = {
            firstAvg: Math.round(firstAvg),
            secondAvg: Math.round(secondAvg),
            growth: Math.round(growth),
            trend: growth > 3 ? 'improving' : growth < -3 ? 'declining' : 'stable',
            sampleSize: scores.length
          };
        }
      });
      
      // å­¦ç¿’æ™‚é–“ã¨ç§‘ç›®ã®é–¢ä¿‚
      const studyTimeBySubject = {};
      Object.entries(subjectAnalysis).forEach(([cat, data]) => {
        studyTimeBySubject[cat] = {
          total: data.totalMinutes,
          weekly: data.weekMinutes,
          sessionCount: data.sessionCount
        };
      });
      
      // å…±é€šãƒ†ã‚¹ãƒˆã®é…ç‚¹ã‚’æƒ³å®šï¼ˆä¸€èˆ¬çš„ãªæ–‡ç³»ã®å ´åˆï¼‰
      const commonTestStructure = {
        'è‹±èª': { reading: 100, listening: 100, total: 200 },
        'æ•°å­¦': { math1A: 100, math2B: 100, total: 200 },
        'å›½èª': { modern: 110, classic: 90, total: 200 },
        'ç†ç§‘': { total: 100 },
        'ç¤¾ä¼š': { total: 100 }
      };
      
      let p = `ã‚ãªãŸã¯å¤§å­¦å—é¨“ã®ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ãƒ†ã‚£ã‚¹ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’çµ±è¨ˆçš„ã«åˆ†æã—ã€å…±é€šãƒ†ã‚¹ãƒˆã§ã®å¾—ç‚¹ã‚’å®¢è¦³çš„ã«äºˆæ¸¬ã—ã¦ãã ã•ã„ã€‚

âš ï¸ **é‡è¦**: äºˆæ¸¬ã¯æ¥½è¦³çš„ã«ãªã‚Šã™ããšã€ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸç¾å®Ÿçš„ãªæ•°å€¤ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚å—é¨“ç”Ÿã®ä»Šå¾Œã®å­¦ç¿’è¨ˆç”»ã«å½±éŸ¿ã™ã‚‹ãŸã‚ã€æ ¹æ‹ ã®ãªã„å¸Œæœ›çš„è¦³æ¸¬ã¯é¿ã‘ã¦ãã ã•ã„ã€‚

---

# ğŸ“‹ åŸºæœ¬æƒ…å ±

**å¿—æœ›æ ¡**: ${profile['ç¬¬1å¿—æœ›'] || 'æœªè¨­å®š'}
**è©¦é¨“ã¾ã§**: ${daysUntil}æ—¥
**ç´¯è¨ˆå­¦ç¿’æ™‚é–“**: ${formatMinutes(totalMinutes)}
**å­¦ç¿’æ—¥æ•°**: ${studyDays}æ—¥
**ç›´è¿‘1é€±é–“**: ${formatMinutes(weekMinutes)}

`;
      
      if (goalAnalysis.length > 0) {
        p += `# ğŸ¯ ç›®æ¨™è¨­å®š\n\n`;
        p += `| ç§‘ç›® | ç¾çŠ¶ï¼ˆè‡ªå·±è©•ä¾¡ï¼‰ | ç›®æ¨™ | æœ€ä½ãƒ©ã‚¤ãƒ³ |\n`;
        p += `|------|------------------|------|------------|\n`;
        goalAnalysis.forEach(g => {
          p += `| ${g.subject} | ${g.current}% | ${g.target}% | ${g.must}% |\n`;
        });
        p += `\n`;
      }
      
      p += `# ğŸ“Š éå»å•ãƒ»æ¨¡è©¦ã®å…¨è¨˜éŒ²\n\n`;
      
      if (redbookLogs.length === 0) {
        p += `â€»éå»å•ãƒ»æ¨¡è©¦ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚äºˆæ¸¬ã®ç²¾åº¦ãŒä½ããªã‚Šã¾ã™ã€‚\n\n`;
      } else {
        // ç§‘ç›®åˆ¥ã«æ•´ç†ã—ã¦è¡¨ç¤º
        Object.entries(subjectScoreHistory).forEach(([cat, scores]) => {
          if (scores.length > 0) {
            p += `## ${cat}\n\n`;
            p += `| æ—¥ä»˜ | å¤§å­¦/æ¨¡è©¦ | å¹´åº¦ | å¾—ç‚¹ç‡ | é–“é•ãˆãŸåˆ†é‡ |\n`;
            p += `|------|-----------|------|--------|-------------|\n`;
            scores.forEach(s => {
              p += `| ${s.date} | ${s.university} | ${s.year} | **${s.score}%** | ${s.weakAreas || '-'} |\n`;
            });
            
            // çµ±è¨ˆã‚µãƒãƒªãƒ¼
            const avg = Math.round(scores.reduce((sum, s) => sum + s.score, 0) / scores.length);
            const max = Math.max(...scores.map(s => s.score));
            const min = Math.min(...scores.map(s => s.score));
            const latest = scores[0].score;
            
            p += `\n**çµ±è¨ˆ**: å¹³å‡${avg}% / æœ€é«˜${max}% / æœ€ä½${min}% / ç›´è¿‘${latest}%\n`;
            
            if (growthAnalysis[cat]) {
              const ga = growthAnalysis[cat];
              const trendIcon = ga.trend === 'improving' ? 'ğŸ“ˆ' : ga.trend === 'declining' ? 'ğŸ“‰' : 'â¡ï¸';
              p += `**æˆé•·**: å‰åŠå¹³å‡${ga.firstAvg}% â†’ å¾ŒåŠå¹³å‡${ga.secondAvg}%ï¼ˆ${ga.growth >= 0 ? '+' : ''}${ga.growth}ptï¼‰${trendIcon}\n`;
            }
            p += `\n`;
          }
        });
        
        // å…¨ä½“çµ±è¨ˆ
        p += `## å…¨ç§‘ç›®ç·åˆ\n\n`;
        p += `- æ¼”ç¿’å›æ•°: ${redbookAnalysis.totalAttempts}å›\n`;
        p += `- å…¨ä½“å¹³å‡: **${redbookAnalysis.avgScore}%**\n`;
        p += `- å¾—ç‚¹å‚¾å‘: ${redbookAnalysis.scoreTrend === 'improving' ? 'ğŸ“ˆ ä¸Šæ˜‡å‚¾å‘' : redbookAnalysis.scoreTrend === 'declining' ? 'ğŸ“‰ ä¸‹é™å‚¾å‘' : 'â¡ï¸ æ¨ªã°ã„'}\n\n`;
      }
      
      p += `# ğŸ“š å­¦ç¿’æ™‚é–“ãƒ‡ãƒ¼ã‚¿\n\n`;
      p += `| ç§‘ç›® | ç´¯è¨ˆæ™‚é–“ | ä»Šé€± | å­¦ç¿’å›æ•° |\n`;
      p += `|------|----------|------|----------|\n`;
      Object.entries(studyTimeBySubject).forEach(([cat, data]) => {
        if (data.total > 0) {
          p += `| ${cat} | ${formatMinutes(data.total)} | ${formatMinutes(data.weekly)} | ${data.sessionCount}å› |\n`;
        }
      });
      
      if (Object.keys(redbookAnalysis.weakAreasSummary).length > 0) {
        p += `\n# âš ï¸ ç¹°ã‚Šè¿”ã—é–“é•ãˆã‚‹åˆ†é‡\n\n`;
        const sorted = Object.entries(redbookAnalysis.weakAreasSummary)
          .sort((a, b) => b[1] - a[1]);
        p += `| åˆ†é‡ | å‡ºç¾å›æ•° | æ·±åˆ»åº¦ |\n`;
        p += `|------|----------|--------|\n`;
        sorted.forEach(([area, count]) => {
          const severity = count >= 3 ? 'ğŸ”´ é«˜' : count >= 2 ? 'ğŸŸ¡ ä¸­' : 'ğŸŸ¢ ä½';
          p += `| ${area} | ${count}å› | ${severity} |\n`;
        });
        p += `\n`;
      }
      
      p += `# ğŸ“ˆ æ®‹ã‚ŠæœŸé–“ã§ã®ä¼¸ã³ã—ã‚è¦å› \n\n`;
      p += `**ãƒ—ãƒ©ã‚¹è¦å› **:\n`;
      if (daysUntil >= 30) p += `- æ®‹ã‚Š${daysUntil}æ—¥ã‚ã‚Šã€å¯¾ç­–ã®æ™‚é–“ãŒã‚ã‚‹\n`;
      if (redbookAnalysis.scoreTrend === 'improving') p += `- å¾—ç‚¹ãŒä¸Šæ˜‡å‚¾å‘ã«ã‚ã‚‹\n`;
      if (weekMinutes >= 1200) p += `- é€±20æ™‚é–“ä»¥ä¸Šã®å­¦ç¿’é‡ã‚’ç¢ºä¿\n`;
      
      p += `\n**ãƒã‚¤ãƒŠã‚¹è¦å› **:\n`;
      if (daysUntil < 30) p += `- æ®‹ã‚Š${daysUntil}æ—¥ã¨æ™‚é–“ãŒé™ã‚‰ã‚Œã¦ã„ã‚‹\n`;
      if (redbookAnalysis.scoreTrend === 'declining') p += `- å¾—ç‚¹ãŒä¸‹é™å‚¾å‘ã«ã‚ã‚‹\n`;
      if (Object.keys(redbookAnalysis.weakAreasSummary).length >= 5) p += `- è‹¦æ‰‹åˆ†é‡ãŒè¤‡æ•°ã‚ã‚‹\n`;
      if (weekMinutes < 600) p += `- é€±ã®å­¦ç¿’æ™‚é–“ãŒ10æ™‚é–“æœªæº€\n`;
      
      p += `
---

# ğŸ¯ äºˆæ¸¬ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

ä¸Šè¨˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€**å…±é€šãƒ†ã‚¹ãƒˆæœ¬ç•ªã§ã®å¾—ç‚¹ç‡**ã‚’äºˆæ¸¬ã—ã¦ãã ã•ã„ã€‚

## å›ç­”å½¢å¼

### 1. ç§‘ç›®åˆ¥ã®å¾—ç‚¹äºˆæ¸¬

å„ç§‘ç›®ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®3ãƒ‘ã‚¿ãƒ¼ãƒ³ã§äºˆæ¸¬ã—ã¦ãã ã•ã„ï¼š

| ç§‘ç›® | æ‚²è¦³çš„ | ç¾å®Ÿçš„ | æ¥½è¦³çš„ | äºˆæ¸¬æ ¹æ‹  |
|------|--------|--------|--------|----------|
| è‹±èª | â—‹â—‹% | â—‹â—‹% | â—‹â—‹% | ... |
| æ•°å­¦ | â—‹â—‹% | â—‹â—‹% | â—‹â—‹% | ... |
| å›½èª | â—‹â—‹% | â—‹â—‹% | â—‹â—‹% | ... |
| ... | ... | ... | ... | ... |

- **æ‚²è¦³çš„**: è‹¦æ‰‹åˆ†é‡ãŒå‡ºé¡Œã•ã‚ŒãŸå ´åˆã€ä½“èª¿ä¸è‰¯ã®å ´åˆãªã©
- **ç¾å®Ÿçš„**: ç¾åœ¨ã®å®ŸåŠ›ãŒãã®ã¾ã¾ç™ºæ®ã•ã‚ŒãŸå ´åˆ
- **æ¥½è¦³çš„**: å¾—æ„åˆ†é‡ãŒå‡ºé¡Œã•ã‚Œã€å®ŸåŠ›ä»¥ä¸Šã‚’ç™ºæ®ã—ãŸå ´åˆ

### 2. ç·åˆå¾—ç‚¹ã®äºˆæ¸¬

- æ‚²è¦³çš„ã‚·ãƒŠãƒªã‚ª: â—‹â—‹â—‹ç‚¹ / â—‹â—‹â—‹ç‚¹ï¼ˆâ—‹â—‹%ï¼‰
- ç¾å®Ÿçš„ã‚·ãƒŠãƒªã‚ª: â—‹â—‹â—‹ç‚¹ / â—‹â—‹â—‹ç‚¹ï¼ˆâ—‹â—‹%ï¼‰
- æ¥½è¦³çš„ã‚·ãƒŠãƒªã‚ª: â—‹â—‹â—‹ç‚¹ / â—‹â—‹â—‹ç‚¹ï¼ˆâ—‹â—‹%ï¼‰

### 3. äºˆæ¸¬ã®æ ¹æ‹ 

- ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹å‚¾å‘
- æ®‹ã‚Š${daysUntil}æ—¥ã§ã®ä¼¸ã³ã—ã‚ã®æ¨å®š
- äºˆæ¸¬ã®ä¿¡é ¼åº¦ï¼ˆãƒ‡ãƒ¼ã‚¿é‡ã«åŸºã¥ãï¼‰

### 4. ç›®æ¨™é”æˆã®å¯èƒ½æ€§

- ç›®æ¨™å¾—ç‚¹ç‡ã¸ã®åˆ°é”å¯èƒ½æ€§ï¼ˆ%ï¼‰
- æœ€ä½ãƒ©ã‚¤ãƒ³çªç ´ã®å¯èƒ½æ€§ï¼ˆ%ï¼‰
- é”æˆã«å¿…è¦ãªæ¡ä»¶

### 5. ä¸ŠæŒ¯ã‚Œãƒ»ä¸‹æŒ¯ã‚Œè¦å› 

**ä¸ŠæŒ¯ã‚Œã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆ**:
- ...

**ä¸‹æŒ¯ã‚Œã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆ**:
- ...

### 6. æ®‹ã‚Š${daysUntil}æ—¥ã§ç‚¹æ•°ã‚’ä¸Šã’ã‚‹ãŸã‚ã®ææ¡ˆ

å„ªå…ˆåº¦ã®é«˜ã„é †ã«ã€å…·ä½“çš„ãªå¯¾ç­–ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚`;
      
      return p;
    }
    
    async function copyPrompt() {
      const prompt = document.getElementById('promptPreview').textContent;
      
      try {
        await navigator.clipboard.writeText(prompt);
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼AIã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
        closeAIModal();
      } catch {
        const textarea = document.createElement('textarea');
        textarea.value = prompt;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        closeAIModal();
      }
    }
    
    function formatMinutes(minutes) {
      if (minutes < 60) return `${minutes}åˆ†`;
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return mins > 0 ? `${hours}æ™‚é–“${mins}åˆ†` : `${hours}æ™‚é–“`;
    }
    
    function formatDateShort(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return `${date.getMonth() + 1}/${date.getDate()}`;
    }
    
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('active');
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }
    
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>
