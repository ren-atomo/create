<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¦ç¿’è¨˜éŒ²ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@300;400;500;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Zen Kaku Gothic New', 'DM Sans', sans-serif;
      background: linear-gradient(180deg, #fafafa 0%, #f3f3f3 100%);
      min-height: 100vh;
      color: #1a1a1a;
      line-height: 1.6;
    }

    /* ============================================
       Header
       ============================================ */
    .header {
      background: white;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      padding: 20px 40px;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.95);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 20px;
      font-weight: 700;
      color: #111;
      letter-spacing: -0.5px;
    }

    .logo span {
      color: #2563eb;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #888;
      padding: 6px 12px;
      background: #f5f5f5;
      border-radius: 20px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
    }

    .status-dot.offline {
      background: #f59e0b;
    }

    .status-dot.error {
      background: #ef4444;
    }

    .header-date {
      font-size: 14px;
      color: #888;
    }

    /* ============================================
       Navigation
       ============================================ */
    .nav-tabs {
      display: flex;
      gap: 8px;
      padding: 16px 40px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .tab-btn {
      padding: 12px 24px;
      border: none;
      background: transparent;
      color: #666;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 12px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .tab-btn:hover {
      background: rgba(0,0,0,0.04);
      color: #333;
    }

    .tab-btn.active {
      background: #111;
      color: white;
    }

    /* ============================================
       Main Container
       ============================================ */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px 40px 100px;
    }

    /* ============================================
       Cards
       ============================================ */
    .card {
      background: white;
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.03);
      border: 1px solid rgba(0,0,0,0.04);
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.06), 0 8px 24px rgba(0,0,0,0.05);
    }

    .card-title {
      font-size: 13px;
      font-weight: 500;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    /* ============================================
       Stats
       ============================================ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 28px;
    }

    .stat-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      border: 1px solid rgba(0,0,0,0.04);
    }

    .stat-label {
      font-size: 12px;
      color: #888;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #111;
      font-family: 'DM Sans', sans-serif;
    }

    .stat-value span {
      font-size: 16px;
      font-weight: 400;
      color: #666;
    }

    .stat-sub {
      font-size: 13px;
      color: #10b981;
      margin-top: 4px;
      font-weight: 500;
    }

    .stat-sub.warning {
      color: #f59e0b;
    }

    /* ============================================
       Grids
       ============================================ */
    .grid-2 {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      margin-bottom: 24px;
    }

    /* ============================================
       Charts
       ============================================ */
    .chart-container {
      position: relative;
      height: 280px;
    }

    /* ============================================
       Weekly Goal
       ============================================ */
    .weekly-goal {
      background: linear-gradient(135deg, #111 0%, #333 100%);
      color: white;
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 24px;
    }

    .weekly-goal .card-title {
      color: rgba(255,255,255,0.6);
    }

    .weekly-progress {
      display: flex;
      align-items: flex-end;
      gap: 16px;
      margin-top: 16px;
    }

    .weekly-current {
      font-size: 48px;
      font-weight: 700;
      font-family: 'DM Sans', sans-serif;
      line-height: 1;
    }

    .weekly-target {
      font-size: 18px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 8px;
    }

    .weekly-bar {
      height: 8px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
      margin-top: 20px;
      overflow: hidden;
    }

    .weekly-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #34d399);
      border-radius: 4px;
      transition: width 0.8s ease;
    }

    /* ============================================
       Progress Bars
       ============================================ */
    .progress-bar {
      height: 10px;
      background: #f0f0f0;
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      border-radius: 5px;
      transition: width 0.8s ease;
    }

    .progress-marker {
      position: absolute;
      top: -4px;
      height: 18px;
      width: 3px;
      border-radius: 2px;
    }

    /* ============================================
       Subject Tags
       ============================================ */
    .subject-tag {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }

    .subject-tag.english { background: #dbeafe; color: #1d4ed8; }
    .subject-tag.math { background: #d1fae5; color: #047857; }
    .subject-tag.japanese { background: #fee2e2; color: #b91c1c; }

    /* ============================================
       Records
       ============================================ */
    .records-list {
      margin-top: 16px;
    }

    .record-row {
      display: grid;
      grid-template-columns: 80px 100px 1fr 80px 50px;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid #f5f5f5;
    }

    .record-row:last-child {
      border-bottom: none;
    }

    .record-date {
      font-size: 13px;
      color: #888;
      font-family: 'DM Sans', sans-serif;
    }

    .record-detail {
      font-size: 14px;
      color: #333;
    }

    .record-book {
      font-size: 12px;
      color: #999;
      margin-top: 2px;
    }

    .record-time {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      font-family: 'DM Sans', sans-serif;
    }

    .record-feeling {
      font-size: 18px;
    }

    /* ============================================
       Akabon
       ============================================ */
    .akabon-card {
      background: linear-gradient(135deg, #fff 0%, #fafafa 100%);
      border: 1px solid #eee;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
    }

    .akabon-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .akabon-univ {
      font-size: 16px;
      font-weight: 600;
      color: #111;
    }

    .akabon-meta {
      font-size: 13px;
      color: #888;
      margin-top: 4px;
    }

    .akabon-score {
      font-size: 24px;
      font-weight: 700;
      color: #dc2626;
      font-family: 'DM Sans', sans-serif;
    }

    .akabon-memo {
      font-size: 13px;
      color: #666;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f0f0f0;
    }

    /* ============================================
       Legend
       ============================================ */
    .legend {
      display: flex;
      gap: 20px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #666;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    /* ============================================
       Tabs
       ============================================ */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ============================================
       FAB Button
       ============================================ */
    .fab-button {
      position: fixed;
      bottom: 32px;
      right: 32px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #111 0%, #333 100%);
      color: white;
      border: none;
      font-size: 32px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .fab-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 28px rgba(0,0,0,0.4);
    }

    .fab-button.active {
      transform: rotate(45deg);
    }

    /* ============================================
       Modal
       ============================================ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-radius: 24px 24px 0 0;
      padding: 32px;
      z-index: 1001;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal.active {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #111;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: #f5f5f5;
      color: #666;
      font-size: 20px;
      cursor: pointer;
    }

    /* ============================================
       Form
       ============================================ */
    .form-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid #eee;
      padding-bottom: 16px;
    }

    .form-tab {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: #888;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 10px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .form-tab:hover {
      background: #f5f5f5;
    }

    .form-tab.active {
      background: #111;
      color: white;
    }

    .form-content {
      display: none;
    }

    .form-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #666;
      margin-bottom: 8px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #eee;
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s ease;
      background: white;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #111;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .button-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .button-option {
      padding: 10px 16px;
      border: 2px solid #eee;
      border-radius: 10px;
      background: white;
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .button-option:hover {
      border-color: #ccc;
    }

    .button-option.selected {
      border-color: #111;
      background: #111;
      color: white;
    }

    .feeling-group {
      display: flex;
      gap: 12px;
    }

    .feeling-option {
      width: 48px;
      height: 48px;
      border: 2px solid #eee;
      border-radius: 12px;
      background: white;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .feeling-option:hover {
      transform: scale(1.05);
    }

    .feeling-option.selected {
      border-color: #111;
      background: #f5f5f5;
      transform: scale(1.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .submit-button {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, #111 0%, #333 100%);
      color: white;
      font-size: 16px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 8px;
    }

    .submit-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }

    .submit-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .submit-button.success {
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
    }

    /* ============================================
       Toast
       ============================================ */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #111;
      color: white;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1002;
    }

    .toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success { background: #059669; }
    .toast.error { background: #dc2626; }

    /* ============================================
       Loading
       ============================================ */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: #888;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f0f0f0;
      border-top-color: #111;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ============================================
       Responsive
       ============================================ */
    @media (max-width: 1024px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .grid-2 { grid-template-columns: 1fr; }
      .grid-3 { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      .header { padding: 16px 20px; }
      .nav-tabs { padding: 12px 20px; overflow-x: auto; }
      .container { padding: 16px 20px 100px; }
      .stats-grid { gap: 12px; }
      .stat-card { padding: 16px; }
      .stat-value { font-size: 24px; }
      .form-row { grid-template-columns: 1fr; }
      .fab-button {
        bottom: 24px;
        right: 24px;
        width: 56px;
        height: 56px;
      }
    }

    /* éš ã—iframe */
    .hidden-iframe {
      display: none;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">Study<span>Track</span></div>
      <div class="header-right">
        <div class="connection-status">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">èª­ã¿è¾¼ã¿ä¸­...</span>
        </div>
        <div class="header-date" id="currentDate"></div>
      </div>
    </div>
  </header>

  <!-- Navigation -->
  <nav class="nav-tabs">
    <button class="tab-btn active" data-tab="overview">æ¦‚è¦</button>
    <button class="tab-btn" data-tab="records">å­¦ç¿’è¨˜éŒ²</button>
    <button class="tab-btn" data-tab="akabon">èµ¤æœ¬ãƒ»å…±ãƒ†æ¼”ç¿’</button>
    <button class="tab-btn" data-tab="progress">ç›®æ¨™é€²æ—</button>
  </nav>

  <!-- Main Content -->
  <main class="container">

    <!-- Overview Tab -->
    <div class="tab-content active" id="tab-overview">
      
      <!-- Weekly Goal -->
      <div class="weekly-goal">
        <div class="card-title">ä»Šé€±ã®å­¦ç¿’æ™‚é–“</div>
        <div class="weekly-progress">
          <div class="weekly-current"><span id="weeklyHours">0</span><span style="font-size: 20px; font-weight: 400;">h</span></div>
          <div class="weekly-target">/ <span id="weeklyTarget">30</span>h ç›®æ¨™</div>
        </div>
        <div class="weekly-bar">
          <div class="weekly-bar-fill" id="weeklyBarFill" style="width: 0%"></div>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">ä»Šæ—¥ã®å­¦ç¿’</div>
          <div class="stat-value" id="todayStudy">0<span>åˆ†</span></div>
          <div class="stat-sub" id="todayDiff">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">é€£ç¶šå­¦ç¿’æ—¥æ•°</div>
          <div class="stat-value" id="streak">0<span>æ—¥</span></div>
          <div class="stat-sub">ğŸ”¥ ç¶™ç¶šä¸­</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æœ€ã‚‚å­¦ç¿’ã—ãŸç§‘ç›®</div>
          <div class="stat-value" id="topSubject" style="font-size: 24px;">--</div>
          <div class="stat-sub" id="topSubjectTime">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å¹³å‡æ‰‹å¿œãˆ</div>
          <div class="stat-value" id="avgFeeling" style="font-size: 36px;">ğŸ˜</div>
          <div class="stat-sub" id="avgFeelingText">--</div>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid-2">
        <div class="card">
          <div class="card-title">æ—¥åˆ¥å­¦ç¿’æ™‚é–“ï¼ˆç›´è¿‘7æ—¥ï¼‰</div>
          <div class="chart-container">
            <canvas id="dailyChart"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-title">ç§‘ç›®åˆ¥å‰²åˆ</div>
          <div class="chart-container">
            <canvas id="subjectChart"></canvas>
          </div>
          <div class="legend" id="subjectLegend"></div>
        </div>
      </div>

      <!-- Recent Records -->
      <div class="card">
        <div class="card-title">æœ€è¿‘ã®å­¦ç¿’è¨˜éŒ²</div>
        <div class="records-list" id="recentRecords">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
    </div>

    <!-- Records Tab -->
    <div class="tab-content" id="tab-records">
      <div class="card">
        <div class="card-title">å…¨å­¦ç¿’è¨˜éŒ²</div>
        <div class="records-list" id="allRecords">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
    </div>

    <!-- Akabon Tab -->
    <div class="tab-content" id="tab-akabon">
      <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
        <div class="stat-card">
          <div class="stat-label">æ¼”ç¿’å›æ•°</div>
          <div class="stat-value" id="akabonCount">0<span>å›</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å¹³å‡å¾—ç‚¹ç‡</div>
          <div class="stat-value" id="akabonAvg">--<span>%</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æœ€é«˜å¾—ç‚¹</div>
          <div class="stat-value" id="akabonBest">--<span>%</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">æ¼”ç¿’å±¥æ­´</div>
        <div id="akabonList">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
    </div>

    <!-- Progress Tab -->
    <div class="tab-content" id="tab-progress">
      <div class="grid-3">
        <div class="card">
          <div class="card-title">å›½èª</div>
          <div class="stat-value" id="japaneseScore">50<span>%</span></div>
          <div style="margin-top: 16px;">
            <div class="progress-bar">
              <div class="progress-fill" id="japaneseFill" style="width: 50%; background: linear-gradient(90deg, #dc2626, #f87171);"></div>
              <div class="progress-marker" style="left: 65%; background: #f59e0b;"></div>
              <div class="progress-marker" style="left: 80%; background: #111;"></div>
            </div>
          </div>
          <div class="legend" style="margin-top: 12px;">
            <div class="legend-item"><div class="legend-dot" style="background: #f59e0b"></div>ãƒã‚¹ãƒˆ 65%</div>
            <div class="legend-item"><div class="legend-dot" style="background: #111"></div>ç›®æ¨™ 80%</div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">æ•°å­¦</div>
          <div class="stat-value" id="mathScore">50<span>%</span></div>
          <div style="margin-top: 16px;">
            <div class="progress-bar">
              <div class="progress-fill" id="mathFill" style="width: 50%; background: linear-gradient(90deg, #059669, #34d399);"></div>
              <div class="progress-marker" style="left: 65%; background: #f59e0b;"></div>
              <div class="progress-marker" style="left: 80%; background: #111;"></div>
            </div>
          </div>
          <div class="legend" style="margin-top: 12px;">
            <div class="legend-item"><div class="legend-dot" style="background: #f59e0b"></div>ãƒã‚¹ãƒˆ 65%</div>
            <div class="legend-item"><div class="legend-dot" style="background: #111"></div>ç›®æ¨™ 80%</div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">è‹±èª</div>
          <div class="stat-value" id="englishScore">58<span>%</span></div>
          <div style="margin-top: 16px;">
            <div class="progress-bar">
              <div class="progress-fill" id="englishFill" style="width: 58%; background: linear-gradient(90deg, #2563eb, #60a5fa);"></div>
              <div class="progress-marker" style="left: 65%; background: #f59e0b;"></div>
              <div class="progress-marker" style="left: 80%; background: #111;"></div>
            </div>
          </div>
          <div class="legend" style="margin-top: 12px;">
            <div class="legend-item"><div class="legend-dot" style="background: #f59e0b"></div>ãƒã‚¹ãƒˆ 65%</div>
            <div class="legend-item"><div class="legend-dot" style="background: #111"></div>ç›®æ¨™ 80%</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ç§‘ç›®åˆ¥è©³ç´°ï¼ˆä»Šé€±ã®å­¦ç¿’æ™‚é–“ï¼‰</div>
        <div class="chart-container" style="height: 320px;">
          <canvas id="detailChart"></canvas>
        </div>
      </div>
    </div>

  </main>

  <!-- FAB Button -->
  <button class="fab-button" id="fabButton" onclick="toggleModal()">+</button>

  <!-- Modal Overlay -->
  <div class="modal-overlay" id="modalOverlay" onclick="toggleModal()"></div>

  <!-- Input Modal -->
  <div class="modal" id="inputModal">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ“ è¨˜éŒ²ã‚’è¿½åŠ </h2>
      <button class="modal-close" onclick="toggleModal()">Ã—</button>
    </div>

    <div class="form-tabs">
      <button class="form-tab active" data-form="study" onclick="switchFormTab('study')">å­¦ç¿’è¨˜éŒ²</button>
      <button class="form-tab" data-form="akabon" onclick="switchFormTab('akabon')">èµ¤æœ¬ãƒ»å…±ãƒ†æ¼”ç¿’</button>
    </div>

    <!-- Study Form -->
    <div class="form-content active" id="form-study">
      <div class="form-group">
        <label class="form-label">ç§‘ç›®</label>
        <div class="button-group" id="subjectButtons">
          <button type="button" class="button-option" data-value="ç¾ä»£æ–‡">ç¾ä»£æ–‡</button>
          <button type="button" class="button-option" data-value="å¤æ–‡">å¤æ–‡</button>
          <button type="button" class="button-option" data-value="æ¼¢æ–‡">æ¼¢æ–‡</button>
          <button type="button" class="button-option" data-value="æ•°å­¦1A">æ•°å­¦1A</button>
          <button type="button" class="button-option" data-value="æ•°å­¦2B">æ•°å­¦2B</button>
          <button type="button" class="button-option" data-value="å˜èª">å˜èª</button>
          <button type="button" class="button-option" data-value="æ–‡æ³•">æ–‡æ³•</button>
          <button type="button" class="button-option" data-value="é•·æ–‡">é•·æ–‡</button>
          <button type="button" class="button-option" data-value="éŸ³èª­">éŸ³èª­</button>
          <button type="button" class="button-option" data-value="ãƒªã‚¹ãƒ‹ãƒ³ã‚°">ãƒªã‚¹ãƒ‹ãƒ³ã‚°</button>
          <button type="button" class="button-option" data-value="ãã®ä»–æ¼”ç¿’">ãã®ä»–</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">å­¦ç¿’æ™‚é–“</label>
        <div class="button-group" id="timeButtons">
          <button type="button" class="button-option" data-value="15">15åˆ†</button>
          <button type="button" class="button-option" data-value="30">30åˆ†</button>
          <button type="button" class="button-option" data-value="45">45åˆ†</button>
          <button type="button" class="button-option" data-value="50">50åˆ†</button>
          <button type="button" class="button-option" data-value="60">1æ™‚é–“</button>
          <button type="button" class="button-option" data-value="90">1.5æ™‚é–“</button>
          <button type="button" class="button-option" data-value="120">2æ™‚é–“</button>
          <button type="button" class="button-option" data-value="150">2æ™‚é–“è¶…</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">æ‰‹å¿œãˆ</label>
        <div class="feeling-group" id="feelingButtons">
          <button type="button" class="feeling-option" data-value="1">ğŸ˜«</button>
          <button type="button" class="feeling-option" data-value="2">ğŸ˜•</button>
          <button type="button" class="feeling-option" data-value="3">ğŸ˜</button>
          <button type="button" class="feeling-option" data-value="4">ğŸ™‚</button>
          <button type="button" class="feeling-option" data-value="5">ğŸ˜Š</button>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">å‚è€ƒæ›¸åï¼ˆä»»æ„ï¼‰</label>
          <input type="text" class="form-input" id="bookName" placeholder="ä¾‹: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1900">
        </div>
        <div class="form-group">
          <label class="form-label">æ—¥ä»˜</label>
          <input type="date" class="form-input" id="studyDate">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <textarea class="form-textarea" id="studyMemo" placeholder="ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šãªã©..."></textarea>
      </div>

      <button class="submit-button" id="submitStudy" onclick="submitStudyRecord()">è¨˜éŒ²ã‚’ä¿å­˜</button>
    </div>

    <!-- Akabon Form -->
    <div class="form-content" id="form-akabon">
      <div class="form-group">
        <label class="form-label">å¤§å­¦åãƒ»è©¦é¨“</label>
        <select class="form-select" id="akabonUniv">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="å…±é€šãƒ†ã‚¹ãƒˆ">å…±é€šãƒ†ã‚¹ãƒˆ</option>
          <option value="å…±é€šãƒ†ã‚¹ãƒˆ(äºˆæƒ³å•é¡Œ)">å…±é€šãƒ†ã‚¹ãƒˆ(äºˆæƒ³å•é¡Œ)</option>
          <option value="ç«‹æ•™å¤§å­¦">ç«‹æ•™å¤§å­¦</option>
          <option value="é’å±±å­¦é™¢å¤§å­¦">é’å±±å­¦é™¢å¤§å­¦</option>
          <option value="æ³•æ”¿å¤§å­¦">æ³•æ”¿å¤§å­¦</option>
          <option value="ä¸­å¤®å¤§å­¦">ä¸­å¤®å¤§å­¦</option>
          <option value="æ˜æ²»å­¦é™¢å¤§å­¦">æ˜æ²»å­¦é™¢å¤§å­¦</option>
          <option value="æˆåŸå¤§å­¦">æˆåŸå¤§å­¦</option>
          <option value="æ±æ´‹å¤§å­¦">æ±æ´‹å¤§å­¦</option>
          <option value="æ—¥æœ¬å¤§å­¦">æ—¥æœ¬å¤§å­¦</option>
          <option value="å°‚ä¿®å¤§å­¦">å°‚ä¿®å¤§å­¦</option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ç§‘ç›®</label>
          <div class="button-group" id="akabonSubjectButtons">
            <button type="button" class="button-option" data-value="è‹±èª">è‹±èª</button>
            <button type="button" class="button-option" data-value="è‹±èª(ãƒªã‚¹ãƒ‹ãƒ³ã‚°)">è‹±èª(L)</button>
            <button type="button" class="button-option" data-value="ç¾ä»£æ–‡">ç¾ä»£æ–‡</button>
            <button type="button" class="button-option" data-value="å¤æ–‡">å¤æ–‡</button>
            <button type="button" class="button-option" data-value="æ¼¢æ–‡">æ¼¢æ–‡</button>
            <button type="button" class="button-option" data-value="å›½èª(ç·åˆ)">å›½èª(ç·åˆ)</button>
            <button type="button" class="button-option" data-value="æ•°å­¦1A">æ•°å­¦1A</button>
            <button type="button" class="button-option" data-value="æ•°å­¦2B">æ•°å­¦2B</button>
            <button type="button" class="button-option" data-value="æ•°å­¦(ç·åˆ)">æ•°å­¦(ç·åˆ)</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">å¹´åº¦</label>
          <select class="form-select" id="akabonYear">
            <option value="2024">2024å¹´åº¦</option>
            <option value="2023">2023å¹´åº¦</option>
            <option value="2022">2022å¹´åº¦</option>
            <option value="2021">2021å¹´åº¦</option>
            <option value="2020">2020å¹´åº¦</option>
            <option value="2019">2019å¹´åº¦</option>
            <option value="2018">2018å¹´åº¦</option>
            <option value="2017">2017å¹´åº¦</option>
            <option value="2016">2016å¹´åº¦</option>
            <option value="2015ä»¥å‰">2015å¹´åº¦ä»¥å‰</option>
            <option value="ã‚ªãƒªã‚¸ãƒŠãƒ«">ã‚ªãƒªã‚¸ãƒŠãƒ«å•é¡Œ</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">å¾—ç‚¹ç‡ï¼ˆ%ï¼‰</label>
          <input type="number" class="form-input" id="akabonScore" min="0" max="100" placeholder="72">
        </div>
        <div class="form-group">
          <label class="form-label">æ—¥ä»˜</label>
          <input type="date" class="form-input" id="akabonDate">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¢ãƒ»æŒ¯ã‚Šè¿”ã‚Š</label>
        <textarea class="form-textarea" id="akabonMemo" placeholder="é›£ã—ã‹ã£ãŸã¨ã“ã‚ã€æ¬¡å›ã®å¯¾ç­–ãªã©..."></textarea>
      </div>

      <button class="submit-button" id="submitAkabon" onclick="submitAkabonRecord()">è¨˜éŒ²ã‚’ä¿å­˜</button>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Hidden iframe for form submission -->
  <iframe name="hiddenFrame" class="hidden-iframe"></iframe>

  <script>
    // ============================================
    // è¨­å®š
    // ============================================
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDï¼ˆå…¬é–‹å¾Œã®IDã‚’å…¥åŠ›ï¼‰
    const SPREADSHEET_ID = '1_9lhRz4OQY3QOANMl5Ig1E8d4ri_rXNy5taMrFbmhLU';
    
    // Google Apps Script URLï¼ˆãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿ç”¨ï¼‰
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwB7BxnYVeeSMAW2jhV7akTDCiqXIr2IQw7LKsnCzcU2Y2-aqNJ6R78nPAz7z_rLlchpg/exec';
    
    // ã‚·ãƒ¼ãƒˆå
    const SHEETS = {
      RECORDS: 'å­¦ç¿’è¨˜éŒ²',
      AKABON: 'èµ¤æœ¬è¨˜éŒ²',
      TARGETS: 'ç›®æ¨™è¨­å®š',
      SETTINGS: 'è¨­å®š',
    };

    // ============================================
    // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿
    // ============================================
    const demoData = {
      records: [
        { date: '2024/11/26', subject: 'æ–‡æ³•', time: 45, feeling: 4, book: 'NextStage', memo: '' },
        { date: '2024/11/26', subject: 'ãƒªã‚¹ãƒ‹ãƒ³ã‚°', time: 30, feeling: 4, book: 'å…±é€šãƒ†ã‚¹ãƒˆå¯¾ç­–', memo: '' },
        { date: '2024/11/25', subject: 'å˜èª', time: 30, feeling: 5, book: 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1900', memo: '900èªåˆ°é”' },
        { date: '2024/11/25', subject: 'æ•°å­¦1A', time: 50, feeling: 4, book: 'é’ãƒãƒ£ãƒ¼ãƒˆ', memo: '' },
        { date: '2024/11/25', subject: 'å¤æ–‡', time: 45, feeling: 3, book: 'å¤æ–‡ä¸Šé”', memo: '' },
        { date: '2024/11/24', subject: 'é•·æ–‡', time: 60, feeling: 4, book: 'ã‚„ã£ã¦ãŠããŸã„500', memo: '' },
        { date: '2024/11/24', subject: 'éŸ³èª­', time: 30, feeling: 4, book: '', memo: 'ã‚·ãƒ£ãƒ‰ãƒ¼ã‚¤ãƒ³ã‚°' },
        { date: '2024/11/24', subject: 'ç¾ä»£æ–‡', time: 45, feeling: 3, book: 'å…¥è©¦ç¾ä»£æ–‡ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹', memo: '' },
        { date: '2024/11/23', subject: 'å˜èª', time: 30, feeling: 4, book: 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1900', memo: '' },
        { date: '2024/11/23', subject: 'æ¼¢æ–‡', time: 40, feeling: 3, book: 'æ¼¢æ–‡æ—©è¦šãˆ', memo: '' },
        { date: '2024/11/23', subject: 'æ•°å­¦2B', time: 60, feeling: 3, book: 'é’ãƒãƒ£ãƒ¼ãƒˆ', memo: '' },
        { date: '2024/11/22', subject: 'æ–‡æ³•', time: 45, feeling: 3, book: 'NextStage', memo: '' },
        { date: '2024/11/22', subject: 'æ•°å­¦1A', time: 60, feeling: 4, book: 'é’ãƒãƒ£ãƒ¼ãƒˆ', memo: 'ç¢ºç‡ãƒã‚¹ã‚¿ãƒ¼' },
        { date: '2024/11/22', subject: 'é•·æ–‡', time: 50, feeling: 4, book: 'ã‚„ã£ã¦ãŠããŸã„500', memo: '' },
        { date: '2024/11/21', subject: 'ç¾ä»£æ–‡', time: 50, feeling: 3, book: 'å…¥è©¦ç¾ä»£æ–‡ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹', memo: '' },
        { date: '2024/11/21', subject: 'å¤æ–‡', time: 45, feeling: 2, book: 'å¤æ–‡ä¸Šé”', memo: 'åŠ©å‹•è©ãŒè‹¦æ‰‹' },
        { date: '2024/11/21', subject: 'ãƒªã‚¹ãƒ‹ãƒ³ã‚°', time: 30, feeling: 5, book: 'å…±é€šãƒ†ã‚¹ãƒˆå¯¾ç­–', memo: '' },
        { date: '2024/11/20', subject: 'é•·æ–‡', time: 60, feeling: 4, book: 'ã‚„ã£ã¦ãŠããŸã„500', memo: 'æ™‚é–“é…åˆ†OK' },
        { date: '2024/11/20', subject: 'å˜èª', time: 30, feeling: 4, book: 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1900', memo: '' },
        { date: '2024/11/20', subject: 'æ•°å­¦2B', time: 45, feeling: 3, book: 'é’ãƒãƒ£ãƒ¼ãƒˆ', memo: 'ãƒ™ã‚¯ãƒˆãƒ«å¾©ç¿’' },
      ],
      akabon: [
        { date: '2024/11/25', university: 'ä¸­å¤®å¤§å­¦', subject: 'è‹±èª', year: '2023', score: 70, memo: '' },
        { date: '2024/11/22', university: 'ç«‹æ•™å¤§å­¦', subject: 'è‹±èª', year: '2023', score: 72, memo: 'é•·æ–‡2å•ç›®ãŒé›£ã—ã‹ã£ãŸ' },
        { date: '2024/11/20', university: 'é’å±±å­¦é™¢å¤§å­¦', subject: 'è‹±èª', year: '2023', score: 68, memo: 'æ™‚é–“é…åˆ†ãƒŸã‚¹' },
        { date: '2024/11/18', university: 'ç«‹æ•™å¤§å­¦', subject: 'å›½èª', year: '2022', score: 65, memo: 'å¤æ–‡ã§å¤±ç‚¹' },
        { date: '2024/11/15', university: 'æ³•æ”¿å¤§å­¦', subject: 'è‹±èª', year: '2022', score: 70, memo: 'ã¾ã‚ã¾ã‚ã®å‡ºæ¥' },
      ],
      targets: {
        å›½èª: { current: 50, target: 80, must: 65 },
        æ•°å­¦: { current: 50, target: 80, must: 65 },
        è‹±èª: { current: 58, target: 80, must: 65 },
      },
      settings: {
        weeklyGoal: 1800,
        streak: 12,
      },
    };

    // ============================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // ============================================
    let appData = null;
    let dailyChart = null;
    let subjectChart = null;
    let detailChart = null;
    const feelingEmoji = ['', 'ğŸ˜«', 'ğŸ˜•', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜Š'];
    const formState = {
      study: { subject: null, time: null, feeling: null },
      akabon: { subject: null },
    };

    // ============================================
    // åˆæœŸåŒ–
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      // æ—¥ä»˜è¡¨ç¤º
      const today = new Date();
      document.getElementById('currentDate').textContent = 
        `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã®æ—¥ä»˜ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
      const dateStr = today.toISOString().split('T')[0];
      document.getElementById('studyDate').value = dateStr;
      document.getElementById('akabonDate').value = dateStr;

      // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
        });
      });

      // ãƒœã‚¿ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      setupButtonGroups();

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      loadData();
    });

    // ============================================
    // ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®š
    // ============================================
    function setupButtonGroups() {
      document.querySelectorAll('.button-group').forEach(group => {
        group.querySelectorAll('.button-option').forEach(btn => {
          btn.addEventListener('click', () => {
            group.querySelectorAll('.button-option').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            const value = btn.dataset.value;
            if (group.id === 'subjectButtons') formState.study.subject = value;
            if (group.id === 'timeButtons') formState.study.time = parseInt(value);
            if (group.id === 'akabonSubjectButtons') formState.akabon.subject = value;
          });
        });
      });

      document.querySelectorAll('.feeling-option').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.feeling-option').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          formState.study.feeling = parseInt(btn.dataset.value);
        });
      });
    }

    // ============================================
    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    // ============================================
    async function loadData() {
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');

      if (SPREADSHEET_ID) {
        try {
          statusText.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
          
          // CSVã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const [records, akabon, targets, settings] = await Promise.all([
            fetchSheetCSV(SHEETS.RECORDS),
            fetchSheetCSV(SHEETS.AKABON),
            fetchSheetCSV(SHEETS.TARGETS),
            fetchSheetCSV(SHEETS.SETTINGS),
          ]);

          appData = {
            records: parseRecords(records),
            akabon: parseAkabon(akabon),
            targets: parseTargets(targets),
            settings: parseSettings(settings),
          };

          statusDot.classList.remove('offline', 'error');
          statusText.textContent = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºä¸­';
        } catch (error) {
          console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          statusDot.classList.add('error');
          statusText.textContent = 'ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼‰';
          appData = demoData;
        }
      } else {
        statusDot.classList.add('offline');
        statusText.textContent = 'ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰';
        appData = demoData;
      }

      renderAll();
    }

    // ============================================
    // CSVå–å¾—
    // ============================================
    async function fetchSheetCSV(sheetName) {
      const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return await response.text();
    }

    // ============================================
    // CSVãƒ‘ãƒ¼ã‚¹
    // ============================================
    function parseCSV(csv) {
      const lines = csv.split('\n');
      const headers = parseCSVLine(lines[0]);
      const data = [];
      
      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const values = parseCSVLine(lines[i]);
        const row = {};
        headers.forEach((h, idx) => {
          row[h] = values[idx] || '';
        });
        data.push(row);
      }
      return data;
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    function parseRecords(csv) {
      const data = parseCSV(csv);
      return data.map(row => ({
        date: row['æ—¥ä»˜'] || '',
        subject: row['ç§‘ç›®'] || '',
        time: parseInt(row['æ™‚é–“']) || 0,
        feeling: parseInt(row['æ‰‹å¿œãˆ']) || 3,
        book: row['å‚è€ƒæ›¸å'] || '',
        memo: row['ãƒ¡ãƒ¢'] || '',
      })).filter(r => r.date && r.subject);
    }

    function parseAkabon(csv) {
      const data = parseCSV(csv);
      return data.map(row => ({
        date: row['æ—¥ä»˜'] || '',
        university: row['å¤§å­¦å'] || '',
        subject: row['ç§‘ç›®'] || '',
        year: row['å¹´åº¦'] || '',
        score: parseInt(row['å¾—ç‚¹ç‡']) || 0,
        memo: row['ãƒ¡ãƒ¢'] || '',
      })).filter(r => r.date && r.university);
    }

    function parseTargets(csv) {
      const data = parseCSV(csv);
      const targets = {};
      data.forEach(row => {
        const subject = row['ç§‘ç›®'];
        if (subject) {
          targets[subject] = {
            current: parseInt(row['ç¾çŠ¶']) || 50,
            target: parseInt(row['ç›®æ¨™']) || 80,
            must: parseInt(row['ãƒã‚¹ãƒˆ']) || 65,
          };
        }
      });
      return targets;
    }

    function parseSettings(csv) {
      const data = parseCSV(csv);
      const settings = { weeklyGoal: 1800, streak: 0 };
      data.forEach(row => {
        if (row['é …ç›®'] === 'é€±é–“ç›®æ¨™') settings.weeklyGoal = parseInt(row['å€¤']) || 1800;
        if (row['é …ç›®'] === 'é€£ç¶šæ—¥æ•°') settings.streak = parseInt(row['å€¤']) || 0;
      });
      return settings;
    }

    // ============================================
    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    // ============================================
    function renderAll() {
      renderStats();
      renderCharts();
      renderRecords();
      renderAkabon();
      renderProgress();
    }

    function renderStats() {
      // ä»Šé€±ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¨ˆç®—
      const today = new Date();
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);
      
      const weekRecords = appData.records.filter(r => {
        const d = new Date(r.date.replace(/\//g, '-'));
        return d >= weekAgo && d <= today;
      });

      const weeklyMinutes = weekRecords.reduce((sum, r) => sum + r.time, 0);
      const weeklyHours = Math.floor(weeklyMinutes / 60);
      const weeklyTarget = appData.settings.weeklyGoal;
      const weeklyPercent = Math.min(100, (weeklyMinutes / weeklyTarget) * 100);

      document.getElementById('weeklyHours').textContent = weeklyHours;
      document.getElementById('weeklyTarget').textContent = Math.floor(weeklyTarget / 60);
      document.getElementById('weeklyBarFill').style.width = `${weeklyPercent}%`;

      // ä»Šæ—¥ã®å­¦ç¿’
      const todayStr = formatDateForCompare(today);
      const todayRecords = appData.records.filter(r => formatDateForCompare(new Date(r.date.replace(/\//g, '-'))) === todayStr);
      const todayMinutes = todayRecords.reduce((sum, r) => sum + r.time, 0);
      document.getElementById('todayStudy').innerHTML = `${todayMinutes}<span>åˆ†</span>`;

      // æ˜¨æ—¥ã¨ã®æ¯”è¼ƒ
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = formatDateForCompare(yesterday);
      const yesterdayRecords = appData.records.filter(r => formatDateForCompare(new Date(r.date.replace(/\//g, '-'))) === yesterdayStr);
      const yesterdayMinutes = yesterdayRecords.reduce((sum, r) => sum + r.time, 0);
      const diff = todayMinutes - yesterdayMinutes;
      const diffEl = document.getElementById('todayDiff');
      if (diff > 0) {
        diffEl.textContent = `â†‘ æ˜¨æ—¥ã‚ˆã‚Š${diff}åˆ†å¤šã„`;
        diffEl.className = 'stat-sub';
      } else if (diff < 0) {
        diffEl.textContent = `â†“ æ˜¨æ—¥ã‚ˆã‚Š${Math.abs(diff)}åˆ†å°‘ãªã„`;
        diffEl.className = 'stat-sub warning';
      } else {
        diffEl.textContent = 'æ˜¨æ—¥ã¨åŒã˜';
        diffEl.className = 'stat-sub';
      }

      // é€£ç¶šæ—¥æ•°
      document.getElementById('streak').innerHTML = `${appData.settings.streak}<span>æ—¥</span>`;

      // æœ€ã‚‚å­¦ç¿’ã—ãŸç§‘ç›®
      const subjectTotals = {};
      weekRecords.forEach(r => {
        const main = getMainSubject(r.subject);
        subjectTotals[main] = (subjectTotals[main] || 0) + r.time;
      });
      const sorted = Object.entries(subjectTotals).sort((a, b) => b[1] - a[1]);
      if (sorted.length > 0) {
        document.getElementById('topSubject').textContent = sorted[0][0];
        const mins = sorted[0][1];
        document.getElementById('topSubjectTime').textContent = `${Math.floor(mins / 60)}æ™‚é–“${mins % 60}åˆ†`;
      }

      // å¹³å‡æ‰‹å¿œãˆ
      const feelings = weekRecords.map(r => r.feeling).filter(f => f > 0);
      const avgFeeling = feelings.length > 0 ? feelings.reduce((a, b) => a + b, 0) / feelings.length : 3;
      document.getElementById('avgFeeling').textContent = feelingEmoji[Math.round(avgFeeling)];
      document.getElementById('avgFeelingText').textContent = `å¹³å‡ ${avgFeeling.toFixed(1)} / 5.0`;
    }

    function renderCharts() {
      // æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
      const dailyMap = {};
      const today = new Date();
      
      for (let i = 6; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const key = formatDateShort(d);
        dailyMap[key] = { å›½èª: 0, æ•°å­¦: 0, è‹±èª: 0 };
      }

      appData.records.forEach(r => {
        const d = new Date(r.date.replace(/\//g, '-'));
        const key = formatDateShort(d);
        if (dailyMap[key]) {
          const main = getMainSubject(r.subject);
          if (dailyMap[key][main] !== undefined) {
            dailyMap[key][main] += r.time;
          }
        }
      });

      const dailyLabels = Object.keys(dailyMap);
      const dailyData = Object.values(dailyMap);

      // æ—¥åˆ¥ãƒãƒ£ãƒ¼ãƒˆ
      const dailyCtx = document.getElementById('dailyChart').getContext('2d');
      if (dailyChart) dailyChart.destroy();
      
      dailyChart = new Chart(dailyCtx, {
        type: 'bar',
        data: {
          labels: dailyLabels,
          datasets: [
            { label: 'å›½èª', data: dailyData.map(d => d.å›½èª), backgroundColor: '#fecaca', borderRadius: 4 },
            { label: 'æ•°å­¦', data: dailyData.map(d => d.æ•°å­¦), backgroundColor: '#a7f3d0', borderRadius: 4 },
            { label: 'è‹±èª', data: dailyData.map(d => d.è‹±èª), backgroundColor: '#bfdbfe', borderRadius: 4 },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { stacked: true, grid: { display: false } },
            y: { stacked: true, grid: { color: '#f0f0f0' }, ticks: { callback: v => `${v}åˆ†` } },
          },
          plugins: { legend: { display: false } },
        },
      });

      // ç§‘ç›®åˆ¥ãƒãƒ£ãƒ¼ãƒˆ
      const subjectTotals = { è‹±èª: 0, æ•°å­¦: 0, å›½èª: 0 };
      appData.records.forEach(r => {
        const d = new Date(r.date.replace(/\//g, '-'));
        const weekAgo = new Date(today);
        weekAgo.setDate(weekAgo.getDate() - 7);
        if (d >= weekAgo) {
          const main = getMainSubject(r.subject);
          if (subjectTotals[main] !== undefined) {
            subjectTotals[main] += r.time;
          }
        }
      });

      const subjectCtx = document.getElementById('subjectChart').getContext('2d');
      if (subjectChart) subjectChart.destroy();

      const subjectColors = { è‹±èª: '#2563eb', æ•°å­¦: '#059669', å›½èª: '#dc2626' };
      
      subjectChart = new Chart(subjectCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(subjectTotals),
          datasets: [{
            data: Object.values(subjectTotals),
            backgroundColor: Object.keys(subjectTotals).map(k => subjectColors[k]),
            borderWidth: 0,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '65%',
          plugins: { legend: { display: false } },
        },
      });

      // å‡¡ä¾‹
      document.getElementById('subjectLegend').innerHTML = Object.entries(subjectTotals)
        .map(([name, mins]) => `
          <div class="legend-item">
            <div class="legend-dot" style="background: ${subjectColors[name]}"></div>
            ${name} (${Math.floor(mins / 60)}h${mins % 60}m)
          </div>
        `).join('');

      // è©³ç´°ãƒãƒ£ãƒ¼ãƒˆ
      renderDetailChart();
    }

    function renderDetailChart() {
      const today = new Date();
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);

      const details = {};
      appData.records.forEach(r => {
        const d = new Date(r.date.replace(/\//g, '-'));
        if (d >= weekAgo) {
          details[r.subject] = (details[r.subject] || 0) + r.time;
        }
      });

      const sorted = Object.entries(details).sort((a, b) => b[1] - a[1]);
      const colorMap = {
        'é•·æ–‡': '#1d4ed8', 'å˜èª': '#2563eb', 'æ–‡æ³•': '#3b82f6', 'ãƒªã‚¹ãƒ‹ãƒ³ã‚°': '#60a5fa', 'éŸ³èª­': '#93c5fd', 'ãã®ä»–æ¼”ç¿’': '#bfdbfe',
        'æ•°å­¦1A': '#047857', 'æ•°å­¦2B': '#059669',
        'ç¾ä»£æ–‡': '#b91c1c', 'å¤æ–‡': '#dc2626', 'æ¼¢æ–‡': '#ef4444',
      };

      const detailCtx = document.getElementById('detailChart').getContext('2d');
      if (detailChart) detailChart.destroy();

      detailChart = new Chart(detailCtx, {
        type: 'bar',
        data: {
          labels: sorted.map(s => s[0]),
          datasets: [{
            data: sorted.map(s => s[1]),
            backgroundColor: sorted.map(s => colorMap[s[0]] || '#888'),
            borderRadius: 6,
          }],
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { grid: { color: '#f0f0f0' }, ticks: { callback: v => `${v}åˆ†` } },
            y: { grid: { display: false } },
          },
          plugins: { legend: { display: false } },
        },
      });
    }

    function renderRecords() {
      const getSubjectClass = (subject) => {
        const main = getMainSubject(subject);
        if (main === 'è‹±èª') return 'english';
        if (main === 'æ•°å­¦') return 'math';
        if (main === 'å›½èª') return 'japanese';
        return '';
      };

      const renderRow = (r) => `
        <div class="record-row">
          <span class="record-date">${formatDateShort(new Date(r.date.replace(/\//g, '-')))}</span>
          <span class="subject-tag ${getSubjectClass(r.subject)}">${r.subject}</span>
          <div class="record-detail">
            ${r.book || r.memo || '-'}
            ${r.book && r.memo ? `<div class="record-book">${r.memo}</div>` : ''}
          </div>
          <span class="record-time">${r.time}åˆ†</span>
          <span class="record-feeling">${feelingEmoji[r.feeling] || ''}</span>
        </div>
      `;

      document.getElementById('recentRecords').innerHTML = appData.records.slice(0, 5).map(renderRow).join('') || '<p style="color:#888">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
      document.getElementById('allRecords').innerHTML = appData.records.map(renderRow).join('') || '<p style="color:#888">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    }

    function renderAkabon() {
      const akabon = appData.akabon;
      
      document.getElementById('akabonCount').innerHTML = `${akabon.length}<span>å›</span>`;
      
      if (akabon.length > 0) {
        const scores = akabon.map(a => a.score);
        const avg = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
        const best = Math.max(...scores);
        document.getElementById('akabonAvg').innerHTML = `${avg}<span>%</span>`;
        document.getElementById('akabonBest').innerHTML = `${best}<span>%</span>`;
      }

      document.getElementById('akabonList').innerHTML = akabon.map(a => `
        <div class="akabon-card">
          <div class="akabon-header">
            <div>
              <div class="akabon-univ">${a.university}</div>
              <div class="akabon-meta">${a.subject} / ${a.year}å¹´åº¦ / ${formatDateShort(new Date(a.date.replace(/\//g, '-')))}</div>
            </div>
            <div class="akabon-score">${a.score}%</div>
          </div>
          ${a.memo ? `<div class="akabon-memo">ğŸ“ ${a.memo}</div>` : ''}
        </div>
      `).join('') || '<p style="color:#888">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    }

    function renderProgress() {
      const targets = appData.targets;
      
      if (targets['å›½èª']) {
        document.getElementById('japaneseScore').innerHTML = `${targets['å›½èª'].current}<span>%</span>`;
        document.getElementById('japaneseFill').style.width = `${targets['å›½èª'].current}%`;
      }
      if (targets['æ•°å­¦']) {
        document.getElementById('mathScore').innerHTML = `${targets['æ•°å­¦'].current}<span>%</span>`;
        document.getElementById('mathFill').style.width = `${targets['æ•°å­¦'].current}%`;
      }
      if (targets['è‹±èª']) {
        document.getElementById('englishScore').innerHTML = `${targets['è‹±èª'].current}<span>%</span>`;
        document.getElementById('englishFill').style.width = `${targets['è‹±èª'].current}%`;
      }
    }

    // ============================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ============================================
    function getMainSubject(subject) {
      if (!subject) return '';
      if (['å˜èª', 'æ–‡æ³•', 'é•·æ–‡', 'éŸ³èª­', 'ãƒªã‚¹ãƒ‹ãƒ³ã‚°', 'ãã®ä»–æ¼”ç¿’'].includes(subject)) return 'è‹±èª';
      if (['æ•°å­¦1A', 'æ•°å­¦2B'].includes(subject)) return 'æ•°å­¦';
      if (['ç¾ä»£æ–‡', 'å¤æ–‡', 'æ¼¢æ–‡'].includes(subject)) return 'å›½èª';
      return subject;
    }

    function formatDateShort(date) {
      return `${date.getMonth() + 1}/${date.getDate()}`;
    }

    function formatDateForCompare(date) {
      return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
    }

    // ============================================
    // ãƒ¢ãƒ¼ãƒ€ãƒ«
    // ============================================
    function toggleModal() {
      const modal = document.getElementById('inputModal');
      const overlay = document.getElementById('modalOverlay');
      const fab = document.getElementById('fabButton');
      
      modal.classList.toggle('active');
      overlay.classList.toggle('active');
      fab.classList.toggle('active');
    }

    function switchFormTab(tab) {
      document.querySelectorAll('.form-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.form-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`.form-tab[data-form="${tab}"]`).classList.add('active');
      document.getElementById(`form-${tab}`).classList.add('active');
    }

    // ============================================
    // ãƒˆãƒ¼ã‚¹ãƒˆ
    // ============================================
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ============================================
    // ãƒ‡ãƒ¼ã‚¿é€ä¿¡
    // ============================================
    async function submitStudyRecord() {
      const button = document.getElementById('submitStudy');
      
      if (!formState.study.subject) {
        showToast('ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      if (!formState.study.time) {
        showToast('å­¦ç¿’æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const record = {
        type: 'study',
        date: document.getElementById('studyDate').value,
        subject: formState.study.subject,
        time: formState.study.time,
        feeling: formState.study.feeling || 3,
        book: document.getElementById('bookName').value,
        memo: document.getElementById('studyMemo').value,
      };

      button.disabled = true;
      button.textContent = 'ä¿å­˜ä¸­...';

      try {
        if (GAS_URL) {
          await submitViaIframe(record);
        }
        
        // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ ï¼ˆè¡¨ç¤ºç”¨ï¼‰
        appData.records.unshift({
          ...record,
          date: record.date.replace(/-/g, '/'),
        });

        button.textContent = 'âœ“ ä¿å­˜ã—ã¾ã—ãŸï¼';
        button.classList.add('success');
        showToast('å­¦ç¿’è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');

        setTimeout(() => {
          resetStudyForm();
          toggleModal();
          renderAll();
        }, 1000);
      } catch (error) {
        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        button.disabled = false;
        button.textContent = 'è¨˜éŒ²ã‚’ä¿å­˜';
      }
    }

    async function submitAkabonRecord() {
      const button = document.getElementById('submitAkabon');
      const univ = document.getElementById('akabonUniv').value;
      const score = document.getElementById('akabonScore').value;
      
      if (!univ) {
        showToast('å¤§å­¦åãƒ»è©¦é¨“ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      if (!formState.akabon.subject) {
        showToast('ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      if (!score) {
        showToast('å¾—ç‚¹ç‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const record = {
        type: 'akabon',
        date: document.getElementById('akabonDate').value,
        university: univ,
        subject: formState.akabon.subject,
        year: document.getElementById('akabonYear').value,
        score: parseInt(score),
        memo: document.getElementById('akabonMemo').value,
      };

      button.disabled = true;
      button.textContent = 'ä¿å­˜ä¸­...';

      try {
        if (GAS_URL) {
          await submitViaIframe(record);
        }

        appData.akabon.unshift({
          ...record,
          date: record.date.replace(/-/g, '/'),
        });

        button.textContent = 'âœ“ ä¿å­˜ã—ã¾ã—ãŸï¼';
        button.classList.add('success');
        showToast('æ¼”ç¿’è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');

        setTimeout(() => {
          resetAkabonForm();
          toggleModal();
          renderAll();
        }, 1000);
      } catch (error) {
        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        button.disabled = false;
        button.textContent = 'è¨˜éŒ²ã‚’ä¿å­˜';
      }
    }

    function submitViaIframe(data) {
      return new Promise((resolve) => {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = GAS_URL;
        form.target = 'hiddenFrame';
        
        Object.entries(data).forEach(([key, value]) => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = key;
          input.value = value;
          form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
        
        setTimeout(resolve, 1000);
      });
    }

    function resetStudyForm() {
      formState.study = { subject: null, time: null, feeling: null };
      document.querySelectorAll('#form-study .button-option, #form-study .feeling-option').forEach(b => b.classList.remove('selected'));
      document.getElementById('bookName').value = '';
      document.getElementById('studyMemo').value = '';
      document.getElementById('studyDate').value = new Date().toISOString().split('T')[0];
      const btn = document.getElementById('submitStudy');
      btn.disabled = false;
      btn.textContent = 'è¨˜éŒ²ã‚’ä¿å­˜';
      btn.classList.remove('success');
    }

    function resetAkabonForm() {
      formState.akabon = { subject: null };
      document.querySelectorAll('#form-akabon .button-option').forEach(b => b.classList.remove('selected'));
      document.getElementById('akabonUniv').value = '';
      document.getElementById('akabonScore').value = '';
      document.getElementById('akabonMemo').value = '';
      document.getElementById('akabonDate').value = new Date().toISOString().split('T')[0];
      const btn = document.getElementById('submitAkabon');
      btn.disabled = false;
      btn.textContent = 'è¨˜éŒ²ã‚’ä¿å­˜';
      btn.classList.remove('success');
    }

    // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && document.getElementById('inputModal').classList.contains('active')) {
        toggleModal();
      }
    });
  </script>

</body>
</html>
